<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Kubestronaut 之路 (1/5) - CKAD 考照筆記 - Ich bin yiwen.</title><meta name="Description" content="An ordinary space for storing and groups pieces of articles."><meta property="og:url" content="http://wysiwyz.github.io/posts/cncf-kubestronaut-03ckad/">
  <meta property="og:site_name" content="Ich bin yiwen.">
  <meta property="og:title" content="Kubestronaut 之路 (1/5) - CKAD 考照筆記">
  <meta property="og:description" content="11/12 註：因為上個月考過 CKAD 了，想說作為紀錄把這筆記 draft 改成 false，另外 Ｓequoia MacOS 開 PSI Secure Browser 沒辦法看到 CKA 題目，目前正在等 Linux Foundation Ticket Assignee 回覆（好像要等超過三天，這辦事效率，唉）
下週一就可以去領護照了呀！準備考試 … total 001 ~ 185
Introduction 001. Introduction Pre-Requisites Lab environment Kubernetes Architecture Master and Worker Nodes Pods, ReplicaSets, Deployments Command Line - kubectl Understanding yaml Services Namespaces Course Objectives ñCore Concepts K8s Architecture Create and configure pods Configuration ConfigMaps SecurityContexts Resource Requirements Secrets ServiceAccounts Multi-Container Pods Ambassador pattern Adapter pattern Sidecar pattern Observability Readiness and Liveness Probes Container Logging Monitor and Debug Applications Pod Design Labels, Selectors and Annotations Rolling Updates and Rollbacks in Deployments Jobs and CronJobs Services and Networking Understand Services Network Policies State Persistence Persistent Volumes Persistent Volume Claims Core Concepts 009.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-18T13:48:44+08:00">
    <meta property="article:modified_time" content="2024-09-18T13:48:44+08:00">
    <meta property="article:tag" content="Cloud Native">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="CKAD">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kubestronaut 之路 (1/5) - CKAD 考照筆記">
  <meta name="twitter:description" content="11/12 註：因為上個月考過 CKAD 了，想說作為紀錄把這筆記 draft 改成 false，另外 Ｓequoia MacOS 開 PSI Secure Browser 沒辦法看到 CKA 題目，目前正在等 Linux Foundation Ticket Assignee 回覆（好像要等超過三天，這辦事效率，唉）
下週一就可以去領護照了呀！準備考試 … total 001 ~ 185
Introduction 001. Introduction Pre-Requisites Lab environment Kubernetes Architecture Master and Worker Nodes Pods, ReplicaSets, Deployments Command Line - kubectl Understanding yaml Services Namespaces Course Objectives ñCore Concepts K8s Architecture Create and configure pods Configuration ConfigMaps SecurityContexts Resource Requirements Secrets ServiceAccounts Multi-Container Pods Ambassador pattern Adapter pattern Sidecar pattern Observability Readiness and Liveness Probes Container Logging Monitor and Debug Applications Pod Design Labels, Selectors and Annotations Rolling Updates and Rollbacks in Deployments Jobs and CronJobs Services and Networking Understand Services Network Policies State Persistence Persistent Volumes Persistent Volume Claims Core Concepts 009.">
<meta name="application-name" content="Ich bin yiwen.">
<meta name="apple-mobile-web-app-title" content="Ich bin yiwen."><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/moon_icon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://wysiwyz.github.io/posts/cncf-kubestronaut-03ckad/" /><link rel="prev" href="http://wysiwyz.github.io/posts/cncf-kubestronaut/" /><link rel="next" href="http://wysiwyz.github.io/posts/kong-hq-academy/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubestronaut 之路 (1/5) - CKAD 考照筆記",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/wysiwyz.github.io\/posts\/cncf-kubestronaut-03ckad\/"
        },"genre": "posts","keywords": "Cloud Native, Kubernetes, CKAD","wordcount":  14288 ,
        "url": "http:\/\/wysiwyz.github.io\/posts\/cncf-kubestronaut-03ckad\/","datePublished": "2024-09-18T13:48:44+08:00","dateModified": "2024-09-18T13:48:44+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kubestronaut 之路 (1/5) - CKAD 考照筆記</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Author</a></span>&nbsp;<span class="post-category">included in <a href="/categories/studynote/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>StudyNote</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-09-18">2024-09-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;14288 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;68 minutes&nbsp;<span id="/posts/cncf-kubestronaut-03ckad/" class="leancloud_visitors" data-flag-title="Kubestronaut 之路 (1/5) - CKAD 考照筆記">
                        <i class="far fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#001-introduction">001. Introduction</a></li>
      </ul>
    </li>
    <li><a href="#core-concepts">Core Concepts</a>
      <ul>
        <li><a href="#009-recap---k8s-architecture">009. Recap - K8s Architecture</a></li>
        <li><a href="#010-docker-vs-containerd">010. Docker v.s. ContainerD</a></li>
        <li><a href="#039-command-args-in-docker">039. Command, Args in Docker</a></li>
        <li><a href="#040-command-and-args-in-kubernetes">040. Command and Args in Kubernetes</a></li>
        <li><a href="#044-environment-variables">044. Environment Variables</a></li>
        <li><a href="#045-configmaps">045. ConfigMaps</a></li>
        <li><a href="#048-secrets">048. Secrets</a></li>
        <li><a href="#053-encrypt-secret-data-at-rest">053. Encrypt Secret Data at rest</a></li>
        <li><a href="#054-docker-security">054. Docker Security</a></li>
        <li><a href="#064-taints-and-tolerations">064. Taints and Tolerations</a></li>
        <li><a href="#067-node-selectors">067. Node Selectors</a></li>
        <li><a href="#068-node-affinity">068. Node Affinity</a></li>
        <li><a href="#075-multi-container-pods">075. Multi-Container Pods</a></li>
        <li><a href="#081-readiness-and-liveness-probes">081. Readiness and Liveness Probes</a></li>
        <li><a href="#082-liveness-probe">082. Liveness Probe</a></li>
        <li><a href="#085-container-logging">085. Container Logging</a></li>
        <li><a href="#088-monitoring-k8s">088. Monitoring K8s</a></li>
        <li><a href="#091-labels-selectors-and-annotations">091. Labels, Selectors and Annotations</a></li>
        <li><a href="#094-rolling-updates--rollbacks-in-deployments">094. Rolling Updates &amp; Rollbacks in Deployments</a></li>
        <li><a href="#099-deployment-strategy---blue-green">099. Deployment Strategy - Blue Green</a></li>
        <li><a href="#100-deployment-strategy---canary">100. Deployment Strategy - Canary</a></li>
        <li><a href="#102-deployment-strategies">102. Deployment strategies</a></li>
        <li><a href="#103-jobs">103. Jobs</a></li>
        <li><a href="#107-service">107. Service</a></li>
        <li><a href="#111-ingress-networking">111. Ingress Networking</a></li>
        <li><a href="#114-ingress-networking">114. Ingress Networking</a></li>
        <li><a href="#118-network-policies">118. Network Policies</a></li>
        <li><a href="#120-lab---network-policies">120. Lab - Network Policies</a></li>
      </ul>
    </li>
    <li><a href="#-state-persistence">㈧ State Persistence</a></li>
    <li><a href="#122-volumes">122. Volumes</a>
      <ul>
        <li></li>
        <li><a href="#123-persistent-volumes">123. Persistent Volumes</a></li>
        <li><a href="#124-persistent-volume-claim">124. Persistent Volume Claim</a></li>
        <li><a href="#127-lab-solution---pv-and-pvc">127. Lab Solution - PV and PVC</a></li>
        <li><a href="#129-storage-class">129. Storage Class</a></li>
        <li><a href="#131-why-stateful-sets">131. Why Stateful Sets?</a></li>
        <li><a href="#132-stateful-set">132. Stateful Set</a></li>
        <li><a href="#133-headless-service">133. Headless Service</a></li>
        <li><a href="#139-kubeconfig">139. KubeConfig</a></li>
        <li><a href="#142-api-groups">142. API Groups</a></li>
        <li><a href="#143-authorization-授權">143. Authorization 授權</a></li>
        <li><a href="#144-rbac">144. RBAC</a></li>
        <li><a href="#146-rbac-practice-test">146. RBAC Practice Test</a></li>
        <li><a href="#147-cluster-roles">147. Cluster Roles</a></li>
        <li><a href="#150-admission-controller">150. Admission Controller</a></li>
        <li><a href="#153-validatign-and-mutation-admission-controllers">153. Validatign and Mutation Admission Controllers</a></li>
        <li><a href="#155-lab---validate-and-mutate-admission-controllers-驗證與異動准入控制器">155. Lab - Validate and Mutate Admission Controllers (驗證與異動准入控制器)</a></li>
        <li><a href="#159-lab---api-versions">159. Lab - API versions</a></li>
        <li><a href="#160-crd---custom-resource-definition">160. CRD - Custom Resource Definition</a></li>
        <li><a href="#162-custom-controller">162. Custom Controller</a></li>
        <li><a href="#163-operator-framework">163. Operator Framework</a></li>
      </ul>
    </li>
    <li><a href="#helm-fundamentals">Helm Fundamentals</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#-helm-foundamentals">㈩ Helm Foundamentals</a>
      <ul>
        <li><a href="#164-helm-introduction">164. Helm Introduction</a></li>
        <li><a href="#165-install-helm">165. Install Helm</a></li>
        <li><a href="#172-time-management">172. Time Management</a></li>
        <li><a href="#lightning-lab-1">Lightning Lab 1</a></li>
        <li><a href="#lightning-lab-2">Lightning Lab 2</a></li>
        <li><a href="#180-mock-exam-1">180. Mock Exam 1</a></li>
        <li><a href="#182-mock-exam-2">182. Mock Exam 2</a></li>
      </ul>
    </li>
    <li><a href="#killer_sh_simulator_ckad">Killer_sh_simulator_ckad</a>
      <ul>
        <li><a href="#question-1">Question 1</a></li>
        <li><a href="#question-2">Question 2</a></li>
        <li><a href="#question-3">Question 3</a></li>
        <li><a href="#question-4">Question 4</a></li>
        <li><a href="#question-5">Question 5</a></li>
        <li><a href="#question-6">Question 6</a></li>
        <li><a href="#question-7">Question 7</a></li>
        <li><a href="#question-8">Question 8</a></li>
        <li><a href="#question-9">Question 9</a></li>
        <li><a href="#question-10">Question 10</a></li>
        <li><a href="#question-11">Question 11</a></li>
        <li><a href="#question-12">Question 12</a></li>
        <li><a href="#question-13">Question 13</a></li>
        <li><a href="#question-14">Question 14</a></li>
        <li><a href="#question-15">Question 15</a></li>
        <li><a href="#question-16">Question 16</a></li>
        <li><a href="#question-17">Question 17</a></li>
        <li><a href="#question-18">Question 18:</a></li>
        <li><a href="#question-19">Question 19</a></li>
        <li><a href="#question-20">Question 20</a></li>
        <li><a href="#question-21">Question 21</a></li>
        <li><a href="#question-22">Question 22</a></li>
      </ul>
    </li>
    <li><a href="#useful-links">Useful Links</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><blockquote>
<p>11/12 註：因為上個月考過 CKAD 了，想說作為紀錄把這筆記 draft 改成 false，另外 Ｓequoia MacOS 開 PSI Secure Browser 沒辦法看到 CKA 題目，目前正在等 Linux Foundation Ticket Assignee 回覆（好像要等超過三天，這辦事效率，唉）</p>
</blockquote>
<p>下週一就可以去領護照了呀！準備考試 &hellip; total 001 ~ 185</p>
<h2 id="introduction">Introduction</h2>
<h3 id="001-introduction">001. Introduction</h3>
<h4 id="pre-requisites">Pre-Requisites</h4>
<ul>
<li>Lab environment</li>
<li>Kubernetes Architecture</li>
<li>Master and Worker Nodes</li>
<li>Pods, ReplicaSets, Deployments</li>
<li>Command Line - <code>kubectl</code></li>
<li>Understanding <code>yaml</code></li>
<li>Services</li>
<li>Namespaces</li>
</ul>
<h4 id="course-objectives">Course Objectives</h4>
<ul>
<li>ñCore Concepts
<ul>
<li>K8s Architecture</li>
<li>Create and configure pods</li>
</ul>
</li>
<li>Configuration
<ul>
<li>ConfigMaps</li>
<li>SecurityContexts</li>
<li>Resource Requirements</li>
<li>Secrets</li>
<li>ServiceAccounts</li>
</ul>
</li>
<li>Multi-Container Pods
<ul>
<li>Ambassador pattern</li>
<li>Adapter pattern</li>
<li>Sidecar pattern</li>
</ul>
</li>
<li>Observability
<ul>
<li>Readiness and Liveness Probes</li>
<li>Container Logging</li>
<li>Monitor and Debug Applications</li>
</ul>
</li>
<li>Pod Design
<ul>
<li>Labels, Selectors and Annotations</li>
<li>Rolling Updates and Rollbacks in Deployments</li>
<li>Jobs and CronJobs</li>
</ul>
</li>
<li>Services and Networking
<ul>
<li>Understand Services</li>
<li>Network Policies</li>
</ul>
</li>
<li>State Persistence
<ul>
<li>Persistent Volumes</li>
<li>Persistent Volume Claims</li>
</ul>
</li>
</ul>
<h2 id="core-concepts">Core Concepts</h2>
<h3 id="009-recap---k8s-architecture">009. Recap - K8s Architecture</h3>
<p>Node - a virtual/physical machines, also known as minion in the past. Need to have more than 1 node.</p>
<p>Cluster - a set of nodes grouped together</p>
<p>Master - Another node. The master watches over the nodes in the cluster, and is responsible for the actual orchestration of containers on the worker nodes.</p>
<h4 id="components--">Components -</h4>
<ul>
<li>
<p>API Server: act as frontend of Kubernetes, users, management devices, command line interfaces all talk to the API server to interact with K8s cluster.</p>
</li>
<li>
<p>etcd: distributed, reliable key-value store. It&rsquo;s responsible for implementing locks to ensure no conflicts between the master</p>
</li>
<li>
<p>Scheduler: responsible for distributing work or containers across multiple nodes. It looks for newly created containers and assign them to nodes.</p>
</li>
<li>
<p>Controller: responsible for noticing and responding when nodes, containers or endpoints goes down. The controller makes decision to bring up new containers in such cases.</p>
<ul>
<li>
<p>Container Runtime: The underlying software that is used to run containers. (e.g. Docker)</p>
</li>
<li>
<p>kublet: The agent that runs on each node in the cluster. The agent is responsible for making sure that the container is running on the node as expected.</p>
</li>
</ul>
</li>
</ul>
<h4 id="master-vs-worker-nodes">Master vs Worker Nodes</h4>
<p>The worker node (or minion) is where the containers are hosted. It&rsquo;s got container runtime (e.g. rkt, cri-o or docker).</p>
<p>The master node has the kub-apiserver, and the worker node has kublet that is responsible for interacting with a master to provide heath information of the worker node, and carry out actions requested by the master on the worker nodes.</p>
<p>All the information gathered are store in <code>etcd</code> (key-value store) and it&rsquo;s based on the popular etcd framework.</p>
<p>The master also has the controller-manager and the scheduler.</p>
<h4 id="kubectl">kubectl</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl run hello-minikube
</span></span><span class="line"><span class="cl">kubectl cluster-info
</span></span><span class="line"><span class="cl">kubectl get nodes
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="010-docker-vs-containerd">010. Docker v.s. ContainerD</h3>
<p><code>ctr</code>, <code>nerdctl</code>, <code>crictl</code></p>
<p>In the beginning, there&rsquo;s just Docker, and docker&rsquo;s UX is better than <code>rkt</code>. But as K8s grew, other container runtime wanted in, so K8s introduced an interface cal CRI (container runtime interface), any vender can work as a container runtime for K8s</p>
<p>Passed &hellip; hand-written notes</p>
<h3 id="039-command-args-in-docker">039. Command, Args in Docker</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># runs an ubuntu image and exit it</span>
</span></span><span class="line"><span class="cl">docker run ubuntu 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># exited (only lives as long as the process inside is alive )</span>
</span></span><span class="line"><span class="cl">docker ps -a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># docker run ubuntu [COMMAND]</span>
</span></span><span class="line"><span class="cl">docker run ubuntu sleep <span class="m">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Different ways of specifying commands</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># CMD command param1</span>
</span></span><span class="line"><span class="cl">CMD sleep <span class="m">5</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># CMD [&#34;command&#34;, &#34;param1&#34;]</span>
</span></span><span class="line"><span class="cl">CMD <span class="o">[</span><span class="s2">&#34;sleep&#34;</span>, <span class="s2">&#34;5&#34;</span><span class="o">]</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Remove <code>sleep</code> command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1st </span>
</span></span><span class="line"><span class="cl">cat Dockerfile
</span></span><span class="line"><span class="cl">FROM Ubuntu
</span></span><span class="line"><span class="cl">CMD sleep <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="c1"># overide the `sleep 5` cmd</span>
</span></span><span class="line"><span class="cl">docker run ubuntu-sleeper sleep <span class="m">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2nd</span>
</span></span><span class="line"><span class="cl">cat Dockerfile
</span></span><span class="line"><span class="cl">FROM Ubuntu
</span></span><span class="line"><span class="cl">ENTRYPOINT <span class="o">[</span><span class="s2">&#34;sleep&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># this 10 will be appended to entrypoint</span>
</span></span><span class="line"><span class="cl">docker run ubuntu-sleeper <span class="m">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3rd</span>
</span></span><span class="line"><span class="cl">cat Dockerfile
</span></span><span class="line"><span class="cl">FROM Ubuntu
</span></span><span class="line"><span class="cl">ENTRYPOINT <span class="o">[</span><span class="s2">&#34;sleep&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">CMD <span class="o">[</span><span class="s2">&#34;5&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># use of both entrypoint and cmd</span>
</span></span><span class="line"><span class="cl">docker run ubuntu-sleeper <span class="c1"># use default</span>
</span></span><span class="line"><span class="cl">docker run ubuntu-sleeper <span class="m">100</span> <span class="c1"># override defaults</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4th</span>
</span></span><span class="line"><span class="cl"><span class="c1"># modify entrypoint during runtime by overriding with </span>
</span></span><span class="line"><span class="cl">docker run --entrypoint sleep2.0 ubuntu-sleeper <span class="m">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="040-command-and-args-in-kubernetes">040. Command and Args in Kubernetes</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-sleeper-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-sleeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-sleeper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="c"># overrides the ENTRYPOINT instruction @Dockerfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sleep&#34;</span><span class="p">]</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="c"># overrides the CMD instruction @Dockerfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;10&#34;</span><span class="p">]</span><span class="w">  
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="044-environment-variables">044. Environment Variables</h3>
<p>Three ways to define environment variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">APP_COLOR </span><span class="w"> </span><span class="c"># 1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">pink</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CM_COLOR  </span><span class="w"> </span><span class="c"># 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">SC_COLOR  </span><span class="w"> </span><span class="c"># 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        	</span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="045-configmaps">045. ConfigMaps</h3>
<p>Imperative: from literal or from file</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create configmap cm-test <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --from-literal<span class="o">=</span><span class="nv">APP_COLOR</span><span class="o">=</span>blue <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --from-literal<span class="o">=</span><span class="nv">APP_MODE</span><span class="o">=</span>prod
</span></span></code></pre></td></tr></table>
</div>
</div><p>Declarative :</p>
<pre tabindex="0"><code>apiVersion: v1
kind: ConfigMap
metadata:
	name: webapp-config-map
data:
	APP_COLOR: &#34;dark-blue&#34;
</code></pre><p>To inject:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="c">############################# 1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">APP_COLOR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webapp-config-map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">APP_COLOR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="c">############################# 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">envFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">configMapRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="c">############################# 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-config-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/path/to/your/config/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-config-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="048-secrets">048. Secrets</h3>
<p>Secrets are used to store confidential like password and keys.</p>
<p>Two ways:</p>
<ol>
<li>
<p>imperative</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k create secret generic &lt;secret-name&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --from-literal<span class="o">=</span>&lt;key&gt;<span class="o">=</span>&lt;value&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --from-literal<span class="o">=</span>&lt;key&gt;<span class="o">=</span>&lt;value&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --from-literal<span class="o">=</span>&lt;key&gt;<span class="o">=</span>&lt;value&gt; <span class="se">\
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k create secret generic &lt;secret-name&gt; --from-file<span class="o">=</span>&lt;path-to-file&gt;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>declarative</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k create -f secret-def.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># must be encoded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">DB_Host</span><span class="p">:</span><span class="w"> </span><span class="l">bXlzcWw=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">DB_User</span><span class="p">:</span><span class="w"> </span><span class="l">cm9vdA==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">DB_Password</span><span class="p">:</span><span class="w"> </span><span class="l">cGFzd3Jk</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Base64 encode</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;mysql&#39;</span> <span class="p">|</span> base64
</span></span><span class="line"><span class="cl"><span class="nv">bXlzcWw</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;root&#39;</span> <span class="p">|</span> base64
</span></span><span class="line"><span class="cl"><span class="nv">cm9vdA</span><span class="o">==</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;paswrd&#39;</span> <span class="p">|</span> base64
</span></span><span class="line"><span class="cl">cGFzd3Jk
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>k get secrets</code> , <code>k describe secrets</code>, <code>k get secret app-secret -o yaml</code></p>
</li>
<li>
<p>Base64 decode</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;bXlzcWw=&#39;</span> <span class="p">|</span> base64 --decode
</span></span><span class="line"><span class="cl">mysql
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;cm9vdA==&#39;</span> <span class="p">|</span> base64 --decode
</span></span><span class="line"><span class="cl">root
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;cGFzd3Jk&#39;</span> <span class="p">|</span> base64 --decode
</span></span><span class="line"><span class="cl">paswrd
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<ol>
<li>
<p>First way to inject secret as environment variable into pods</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">envFrom</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-secret</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Second way: inject as <strong>single environment variable</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">DB_Password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">DB_Password</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Third way: inject the whole secret as files in a <strong>volume</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-secret-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">app-secret</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ol>
<h4 id="notes">Notes:</h4>
<ul>
<li>
<p>Secrets are not encrypted, only encoded.</p>
</li>
<li>
<p>Don&rsquo;t push Secret yaml file to GitHub.</p>
</li>
<li>
<p>Secrets are not encrypted in ETCD (refer to <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" target="_blank" rel="noopener noreffer ">encrypt secret at rest</a>)</p>
</li>
<li>
<p>Anyone able to create pods/deployments in the same ns can access the secrets</p>
<ul>
<li>Configure least-privilege access to Secrets - RBAC</li>
</ul>
</li>
<li>
<p>Consider 3rd party secrets store providers: AWS, Azure, GCP, Vault</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=MTnQW9MxnRI" target="_blank" rel="noopener noreffer ">Secret Store CSI Driver</a></p>
<ul>
<li>SecretProviderClass</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get secrets
</span></span><span class="line"><span class="cl">k replace --force -f /tmp/kubectl-edit-122395794.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="053-encrypt-secret-data-at-rest">053. Encrypt Secret Data at rest</h3>
<p>Reference: <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" target="_blank" rel="noopener noreffer ">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k create secret generic my-secret --from-literal <span class="nv">key1</span><span class="o">=</span>supersecret
</span></span><span class="line"><span class="cl">k get secret
</span></span><span class="line"><span class="cl">k describe secret my-secret
</span></span><span class="line"><span class="cl">k get secret my-secret -o yaml
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s2">&#34;c3ViZXJzZWNyZXQ=&#34;</span> <span class="p">|</span> base64 --decode
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># how is data stored in etcd</span>
</span></span><span class="line"><span class="cl">apt-get install etcd-client
</span></span><span class="line"><span class="cl">ectdctl 
</span></span><span class="line"><span class="cl">kubectl get po -n kube-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ls /etc/kubernetes/pki/etcd/
</span></span><span class="line"><span class="cl">k get secret
</span></span><span class="line"><span class="cl">NAME				TYPE		 DATA		AGE
</span></span><span class="line"><span class="cl">my-secret   Opaque	 1			4m58s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --cacert<span class="o">=</span>/etc/kubernetes/pki/etcd/ca.crt   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --cert<span class="o">=</span>/etc/kubernetes/pki/etcd/server.crt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   --key<span class="o">=</span>/etc/kubernetes/pki/etcd/server.key  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   get /registry/secrets/default/my-secret <span class="p">|</span> hexdump -C
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">ps -aux <span class="p">|</span> grep kube-api
</span></span><span class="line"><span class="cl">ls /etc/kubernetes/manifests
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>Verify that encryption at rest is not enabled by looking into */manifests/kube-apiserver.yaml`</p>
</li>
<li>
<p>Create a <code>EncryptionConfiguration</code> and pass it with <code>--encryption-provider-config</code></p>
</li>
<li>
<p>Generate a 32-byte random key and base64 encode it</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">head -c <span class="m">32</span> /dev/urandom <span class="p">|</span> base64 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Pass the key to the place of <code>&lt;BASE64 ENCODED SECRET&gt;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiserver.config.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">EncryptionConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span>- <span class="l">secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">providers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">aescbc</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      		</span><span class="nt">keys</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      			</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">key1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      				</span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;BASE64 ENCODED SECRET&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">identity</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Add the <code>--encryption-provider-config</code> to spec.containers.command</p>
</li>
<li>
<p>Add spec.containers.volumeMounts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">enc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		    </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/enc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		    </span><span class="nt">readyonly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">enc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  	</span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/enc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  	</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>驗證再次使用 <code>ETCDCTL_API=3...&lt;secret-created-after-encryption-at-rest-is-enabled&gt; | hexdump -C| </code> 可以看到密碼是密文看不見了</p>
</li>
</ol>
<h3 id="054-docker-security">054. Docker Security</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run ubuntu sleep <span class="m">3600</span>
</span></span><span class="line"><span class="cl">ps aux
</span></span></code></pre></td></tr></table>
</div>
</div><p>Containers are not completely isolated from their host. Containers and the hosts share the same kernel. Containers are isolated using namespaces in Linux.</p>
<p>The host has a namespace and the containers have their own namespaces.</p>
<h4 id="linux-capabilities">Linux Capabilities</h4>
<p>Docker uses Linux Capabilities to implement limiting the abilities of the root user within the container. ( refer to <code>/usr/include/linux/capability.h</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># override default behavior and provide additional privileges than what is available</span>
</span></span><span class="line"><span class="cl">docker run --cap-add MAC_ADMIN ubuntu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># drop privileges</span>
</span></span><span class="line"><span class="cl">docker run --cap-drop KILL ubuntu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># run container with all privileges enabled</span>
</span></span><span class="line"><span class="cl">docker run --privileged ubuntu
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="064-taints-and-tolerations">064. Taints and Tolerations</h3>
<p>Taints and tolerations are used to set restrictions on what pods can be scheduled on a node.</p>
<p>Example:  If a node has <code>taint=blue</code>, the scheduler can not place on this node unless it has <code>toleration=blue</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl taint nodes &lt;node-name&gt; <span class="nv">key</span><span class="o">=</span>value:taint-effect
</span></span><span class="line"><span class="cl"><span class="c1"># key=value app=blue: </span>
</span></span><span class="line"><span class="cl"><span class="c1">#   dedicate the node to pods in application blue</span>
</span></span><span class="line"><span class="cl"><span class="c1"># taint-effect: </span>
</span></span><span class="line"><span class="cl"><span class="c1">#   what happens to pods that don&#39;t tolerate this taint</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3 taint-effects: </span>
</span></span><span class="line"><span class="cl"><span class="c1">#   NoSchedule | PreferNoSchedule | NoExecute</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Taints are added to nodes; tolerations are add to pods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;app&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;blue&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoSchedule&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="taint---noexecute">Taint - NoExecute</h4>
<p>既有的 pod 如果沒有對應的 toleration 也會被逐出，新的 pod 如果沒有對應 toleration，Scheduler 也沒辦法將新 pod 排程近這個 node</p>
<p>當你架好一個 K8s cluster，master node 就自動會加上一個 taint 避免有 pod 被排程進 master node。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl describe node kubemaster <span class="p">|</span> grep Taint
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="un-taint">Un-taint</h4>
<p>把 controlplane 預設自動建立的 taint 拔掉</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl describe no controlplane
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Taints: node-role.kubernetes.io/master:NoSchedule
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">kubectl taint node controlplane node-role.kubernetes.io/control-plane:NoSchedule-
</span></span><span class="line"><span class="cl"><span class="c1"># put a minus at the end of the taint </span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="067-node-selectors">067. Node Selectors</h3>
<p>Set a limitations on the pods so that it only gos to certain nodes. Two ways - first is <code>nodeSelector</code></p>
<h4 id="pod-definitions">Pod definitions</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">data-processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="c"># from labels assigned to the nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">Large</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="label-nodes">Label Nodes</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;<span class="o">=</span>&lt;label-value&gt;
</span></span><span class="line"><span class="cl">k label node node01 <span class="nv">size</span><span class="o">=</span>Large
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="limitations-of-node-selector">Limitations of node selector</h4>
<p>What if we need <code>NOT small</code> or <code>either Large or Medium is fine</code>? In these cases, node affinity and anti-affinity features to the rescue!</p>
<h3 id="068-node-affinity">068. Node Affinity</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">data-processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  	</span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">size</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">							</span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="c"># operator: NotIn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="c"># operator: Exists </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">							</span><span class="nt">values</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">							</span>- <span class="l">Large </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">							</span>- <span class="l">Medium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="c"># - Small</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="node-affinity-types">Node Affinity Types</h4>
<p>Available</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># type 1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="l">... or</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># type 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="l">... or</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">requiredDuringSchedulingRequiredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c">#planning</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The first two are available, while the last one is still at planning&hellip;</p>
<table>
<thead>
<tr>
<th></th>
<th>During Scheduling</th>
<th>During Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Type 1</td>
<td>Required (Don&rsquo;t schedule pod if matching node is not found)</td>
<td>Ignored</td>
</tr>
<tr>
<td>Type 2</td>
<td>Preferred (if you cannot find one, just place it anywhere)</td>
<td>Ignored</td>
</tr>
</tbody>
</table>
<p>If an administrator removes the node selector from the node, the pod in execution won&rsquo;t get effected (ignoring the change during execution)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k describe no node01
</span></span><span class="line"><span class="cl">k label nodes node01 <span class="nv">color</span><span class="o">=</span>blue
</span></span><span class="line"><span class="cl">k create deploy blue --image<span class="o">=</span>nginx --replicas<span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">k describe no node01 <span class="p">|</span> grep Taints
</span></span><span class="line"><span class="cl">k describe no controlplane <span class="p">|</span> gret Taints
</span></span><span class="line"><span class="cl">k edit deploy blue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># on the pod spec, set affinity.nodeAffinity</span>
</span></span><span class="line"><span class="cl">spec.template.spec.affinity:
</span></span><span class="line"><span class="cl">	nodeAffinity:
</span></span><span class="line"><span class="cl">		requiredDuringSchedulingIgnoredDuring Execution:
</span></span><span class="line"><span class="cl">			nodeSelectorTerms:
</span></span><span class="line"><span class="cl">			- matchExpressions:
</span></span><span class="line"><span class="cl">			  - key: color
</span></span><span class="line"><span class="cl">			  	operator: In
</span></span><span class="line"><span class="cl">			  	values:
</span></span><span class="line"><span class="cl">			  	- blue
</span></span><span class="line"><span class="cl"><span class="c1"># Vim Tips: Press V (visual-line), select lines you want to ident by pressing J(down) or K(up), and hit shift+.(&gt;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">k get po -o wide
</span></span><span class="line"><span class="cl">k describe no controlplane
</span></span><span class="line"><span class="cl"><span class="c1"># Labels node-role.kubernetes/master=</span>
</span></span><span class="line"><span class="cl">k create deploy red --image<span class="o">=</span>nginx --replicas<span class="o">=</span><span class="m">2</span> --dry-run<span class="o">=</span>client -o yaml &gt; red.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># spec.template.spec, add affinity (see below)</span>
</span></span><span class="line"><span class="cl">cat red.yaml ...
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">	template:
</span></span><span class="line"><span class="cl">		spec:
</span></span><span class="line"><span class="cl">			affinity:	
</span></span><span class="line"><span class="cl">				nodeAffinity:
</span></span><span class="line"><span class="cl">					requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">						nodeSelectorTerms:
</span></span><span class="line"><span class="cl">						- matchExpression
</span></span><span class="line"><span class="cl">						  - key: node-role.kubernetes/master
</span></span><span class="line"><span class="cl">						    operator: Exists
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># Vim Tips: :set number at command mode 顯示行數</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="075-multi-container-pods">075. Multi-Container Pods</h3>
<p>Ambassador | Adapter | Sidecar</p>
<h4 id="design-patterns">Design Patterns</h4>
<ol>
<li>Sidecar: Deploy a logging agent with a web server, forward logs to log server</li>
<li>Adapter: Process the logs (could have various format) before sending them to centralized log server</li>
<li>Ambassador: Modify database connectivity based on various environment (dev, test, prod)</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k describe po red
</span></span><span class="line"><span class="cl">k run yellow --image<span class="o">=</span>busybox --dry-run<span class="o">=</span>client -o yaml &gt; yellow.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># At spec.containers, modify the first container and add the second container (names and images)</span>
</span></span><span class="line"><span class="cl">k get po -n elastic-stack
</span></span><span class="line"><span class="cl">k -n elastic-stack <span class="nb">exec</span> -it app -- cat /log/app.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">k edit po app -n elastic-stack
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">	containers:
</span></span><span class="line"><span class="cl">	<span class="c1"># info of actual app</span>
</span></span><span class="line"><span class="cl">	- image ... 
</span></span><span class="line"><span class="cl">	<span class="c1"># info of the additional container </span>
</span></span><span class="line"><span class="cl">	- image: kodekloud/filebeat-configured
</span></span><span class="line"><span class="cl">	  name: sidecar
</span></span><span class="line"><span class="cl">	  volumeMounts:
</span></span><span class="line"><span class="cl">	  - mountPath: /var/log/event-simulator/
</span></span><span class="line"><span class="cl">	  	name: log-volume
</span></span><span class="line"><span class="cl">	  	
</span></span><span class="line"><span class="cl"><span class="c1"># use this command when k8s forbids you to update</span>
</span></span><span class="line"><span class="cl">k replace --force -f /tmp/kubectl-edit-3922970489.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>InitContainer:</p>
<ul>
<li>Run tasks that is only required once at time when the pod is first created</li>
<li>Wait for an external service or database to be up before the actual app starts</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k get po red -o yaml &gt; red.yaml
</span></span><span class="line"><span class="cl">k delete po red
</span></span><span class="line"><span class="cl">vi red.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># add an initContainer</span>
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  initContainers:
</span></span><span class="line"><span class="cl">  - image: busiboy:1.28
</span></span><span class="line"><span class="cl">    name: red-initcontainer
</span></span><span class="line"><span class="cl">    command: 
</span></span><span class="line"><span class="cl">      - <span class="s2">&#34;sleep&#34;</span>
</span></span><span class="line"><span class="cl">      - <span class="s2">&#34;20&#34;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">k apply -f red.yaml
</span></span><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k describe po orange
</span></span><span class="line"><span class="cl"><span class="c1"># check logs and and commands might needs to be fixed</span>
</span></span><span class="line"><span class="cl">k get po orange -o yaml &gt; orange.yaml
</span></span><span class="line"><span class="cl">k delete po orange
</span></span><span class="line"><span class="cl"><span class="c1"># fix up the commands in the initContainer section</span>
</span></span><span class="line"><span class="cl">k apply -f orange.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="081-readiness-and-liveness-probes">081. Readiness and Liveness Probes</h3>
<h4 id="readiness-probe">Readiness Probe</h4>
<ul>
<li>
<p>POD status: Pending &ndash;&gt; ContainerCreating &ndash;&gt; Running</p>
<blockquote>
<p>At any point of time, a pod can only gives you one of these thre status.</p>
</blockquote>
</li>
<li>
<p><strong>POD conditions</strong>: PodScheduled | Initialized | ContainersReady | Ready (true/false)</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># HTTP Test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/api/ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="c"># warm-up (initial delay before running the test)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c"># how often to probe (frequency)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="c"># by default it&#39;s three attempts (if not specifed in this additional options)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># TCP Test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Exec Command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span>- <span class="l">cat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span>- <span class="l">/app/is_ready</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="082-liveness-probe">082. Liveness Probe</h3>
<p>Use liveness probe to periodically test that the pod is healthy.</p>
<p>The livenessProbe is configured in the pod definition file as you did with readiness probe, except here you use liveness instead of readiness.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k get svc
</span></span><span class="line"><span class="cl">k get po -o yaml &gt; webapp.yaml
</span></span><span class="line"><span class="cl">k delete po --all <span class="c1"># delete both pod webapp-1 and web-app-2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="085-container-logging">085. Container Logging</h3>
<h4 id="logs---docker">Logs - Docker</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -d kodekloud/event-simulator <span class="c1"># detached</span>
</span></span><span class="line"><span class="cl">docker logs -f &lt;container-id&gt; <span class="c1"># -f see live log trail</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="logs---kubernetes">Logs - Kubernetes</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k create -f event-simulator.yaml
</span></span><span class="line"><span class="cl">k logs -f event-simulator-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># multiple containers in a pod: Must specify which container in the logs command, otherwise it would fail</span>
</span></span><span class="line"><span class="cl">k logs -f event-simulator-pod &lt;name-of-the-1st-container&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="logging-lab">Logging lab</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k logs -f webapp-1
</span></span><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">NAME			READY		STATUS		RESTARTS		AGE
</span></span><span class="line"><span class="cl">webapp-1	1/1			Running		0						110s
</span></span><span class="line"><span class="cl">webapp-2	2/2			Running		0						9s
</span></span><span class="line"><span class="cl"><span class="c1"># Must specify which container that you want to check logs</span>
</span></span><span class="line"><span class="cl">k logs -f webapp-2 simple-webapp
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="088-monitoring-k8s">088. Monitoring K8s</h3>
<p>Kubernetes does not come with a full featured built-in monitoring solution, but there are a number of open source solutions avaiable today, such as Metrics Server, Prometheus, ElasticStack, DataDog, Dynatrace. Only Metrics Server will be discussed in CKAD.</p>
<h4 id="heapster-vs-metrics-server">Heapster vs Metrics Server</h4>
<p>Heapster is depracted and a slim-down version was formed, known as Metrics Server.</p>
<p>Metrics server is only an in-memory monitoring solution, and it doesn&rsquo;t store the metrics on the disc.  As a result, you can&rsquo;t see historical performance data.</p>
<p>Kubelet on worker nodes has a sub component known as the <code>cAdvisor</code> or <code>Container Advisor</code>. <code>cAdvisor</code> is responsible for retrieving performance metrics from pods, and exposing them through the Kubelet API to make the metrics available for the Metrics Server.</p>
<h4 id="metrics-server---getting-started">Metrics Server - Getting Started</h4>
<p>If you are using minikube, run below cmd:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube addons <span class="nb">enable</span> metrics-server
</span></span></code></pre></td></tr></table>
</div>
</div><p>For others, clone it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/kubernetes-incubator/metrics-server.git
</span></span><span class="line"><span class="cl">k create -f &lt;path-to-yaml-files&gt;
</span></span><span class="line"><span class="cl">k top node
</span></span><span class="line"><span class="cl">k top pod
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="monitoring-lab">Monitoring Lab</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">git clone https://github.com/kodekloudhub/kubernetes-metrics-server.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> kubernetes-metrics-server
</span></span><span class="line"><span class="cl">k create -f .
</span></span><span class="line"><span class="cl">k top node
</span></span><span class="line"><span class="cl">k top pod
</span></span><span class="line"><span class="cl">k top pod --sort-by<span class="o">=</span>cpu
</span></span><span class="line"><span class="cl">k top pod --sort-by<span class="o">=</span>memory
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="091-labels-selectors-and-annotations">091. Labels, Selectors and Annotations</h3>
<p>Labels are standards to group things together (e.g. sort by color, sort by kind, sort by class, or multiple factors).</p>
<p>Labels and Selectors in K8s can filter and group by object type, or application, or functionality.</p>
<h4 id="labels">Labels</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">App1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l">Frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c"># you can set as many labels as you want</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="select">Select</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get po --selector <span class="nv">app</span><span class="o">=</span>App1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="replicaset">ReplicaSet</h4>
<p>labels defined in two places</p>
<p><code>selector</code> work the same for other objects like services.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">labels: # 1stPlace</span><span class="p">:</span><span class="w"> </span><span class="l">labels configured on the ReplicaSet itself</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">App1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l">Frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># connect the ReplicaSet to the Pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">App1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">labels: # 2ndPlace</span><span class="p">:</span><span class="w"> </span><span class="l">labels configured on the POD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">App1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">function</span><span class="p">:</span><span class="w"> </span><span class="l">Frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span>- <span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="annotations">Annotations</h4>
<p>While labels and selectors are used to group and select objects, annotations are used to record other details for informatory purpose.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simple-webapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">buildversion</span><span class="p">:</span><span class="w"> </span><span class="m">1.34</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c"># name, version, build info, contact details, email ids, etc.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">labels</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="label-selctor-lab">Label Selctor Lab</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k get po --selector <span class="nv">env</span><span class="o">=</span>dev
</span></span><span class="line"><span class="cl">k get po --selector <span class="nv">env</span><span class="o">=</span>dev --no-headers <span class="p">|</span> wc -l
</span></span><span class="line"><span class="cl">k get po --selector <span class="nv">bu</span><span class="o">=</span>finance --no-headers <span class="p">|</span> wc -l
</span></span><span class="line"><span class="cl">k get all --selector <span class="nv">env</span><span class="o">=</span>prod --no-headers <span class="p">|</span> wc -l
</span></span><span class="line"><span class="cl">k get all --selector <span class="nv">env</span><span class="o">=</span>prod,bu<span class="o">=</span>finance,tier<span class="o">=</span>frontend
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="094-rolling-updates--rollbacks-in-deployments">094. Rolling Updates &amp; Rollbacks in Deployments</h3>
<h4 id="rollout-and-versioning">Rollout and Versioning</h4>
<p>Use below command to see the status of your rollouts</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl rollout status deployment/myapp-deployment
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use below command to see the revision and history of rollout</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl rollout <span class="nb">history</span> deployment/myapp-deployment
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="deployment-strategy">Deployment Strategy</h4>
<ol>
<li>Recreate Strategy
<ul>
<li>Causing application down-time</li>
<li>Destroy all pods and create new version of application instances</li>
</ul>
</li>
<li>Rolling Update Strategy
<ul>
<li>Take down older version and bring up newer version one-by-one</li>
<li>Seamless upgrade; application never goes down</li>
<li>Default deployment strategy</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">set</span> image <span class="o">(</span>-f FILENAME <span class="p">|</span> TYPE NAME<span class="o">)</span> <span class="nv">CONTAINER_NAME_1</span><span class="o">=</span>CONTAINER_IMAGE_1 ... <span class="nv">CONTAINER_NAME_N</span><span class="o">=</span>CONTAINER_IMAGE_N
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="summarize-commands">Summarize Commands</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f deploy-def.yaml
</span></span><span class="line"><span class="cl">kubectl get deploy
</span></span><span class="line"><span class="cl">kubectl apply -f deploy-def.yaml
</span></span><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deployment/myapp-deployment <span class="nv">nginx</span><span class="o">=</span>nginx:1.9.1
</span></span><span class="line"><span class="cl">kubectl rollout status deployment/myapp-deployment
</span></span><span class="line"><span class="cl">kubectl rollout <span class="nb">history</span> deployment/myapp-deployment
</span></span><span class="line"><span class="cl"><span class="c1"># to undo a change</span>
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment/myapp-deployment
</span></span><span class="line"><span class="cl">kubectl get replicasets 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="use-of-flags">Use of flags</h4>
<p><code>--revision</code>: Check the status of each revision individually</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl rollout <span class="nb">history</span> deployment nginx --revision<span class="o">=</span><span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>--record</code>: Save the command used to create/update a deployment against the revision number</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deployment nginx <span class="nv">nginx</span><span class="o">=</span>nginx:1.17 --record
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>--to-revision</code>: Roll back to the first revision (the first image used to created a deployment)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl rollout undo deployment nginx --to-revision<span class="o">=</span><span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">or</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>RollingUpdateStrategy:	25% max unavailable, 25% max surge</p>
<h3 id="099-deployment-strategy---blue-green">099. Deployment Strategy - Blue Green</h3>
<p>The old version is called blue; the newer version is called green. The new version is deployed along old version. 100% of traffic is still routed to the old version. At this point of time, tests are run on old version, and once all tests are passed, we switched traffic to the new version all at once. This strategy is best implemented with service meshes like Istio.</p>
<h4 id="how-blue-green-deployment-works">How Blue Green deployment works</h4>
<ol>
<li>The original version of our application is deployed as service, named BLUE deployment.</li>
<li>We create a service to route traffic to it.</li>
<li>To associate service to the pods in the deployment, we set a label on the pod, called <code>version: v1</code>.</li>
<li>We use the same label as selector on the service.</li>
<li>We deploy a second deployment; we called it green deployment.</li>
<li>For the new deployment, we set the label <code>version: v2</code>.</li>
<li>Now switch the label specified under the selector of the service to v2, and the service switch the traffic to green deployment.</li>
</ol>
<h3 id="100-deployment-strategy---canary">100. Deployment Strategy - Canary</h3>
<p>We deploy new version and route only a small percentage of traffic to it. The majority of traffic is routed to the older version, but we have a small percentage routed to the new version.</p>
<p>At this point, we run tests, and if everything looks good, we upgrade the original deployment with the newer version of the application. Let&rsquo;s say that could be done with a rolling update strategy, then we get rid of the canary deployment.</p>
<h3 id="102-deployment-strategies">102. Deployment strategies</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get deploy
</span></span><span class="line"><span class="cl">k describe deploy frontend
</span></span><span class="line"><span class="cl"><span class="c1"># check StrategyType</span>
</span></span><span class="line"><span class="cl">k scale deploy --replicas<span class="o">=</span><span class="m">1</span> frontend-v2
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="103-jobs">103. Jobs</h3>
<p>Besides deployment and services, there are other kinds of workloads, such as batch processing, analytics, or reporting that are meant to carry out a specific task and then finish. For example, performing a computation, processing an image, performing some kind of analytics on a large dataset, generating a report and sending an email, etc.</p>
<h4 id="docker">Docker</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run ubuntu expr <span class="m">3</span> + <span class="m">2</span>
</span></span><span class="line"><span class="cl">docker ps -a
</span></span><span class="line"><span class="cl">....................	STATUS	
</span></span><span class="line"><span class="cl">											Exited <span class="o">(</span>0<span class="o">)</span> <span class="m">41</span> seconds ago
</span></span><span class="line"><span class="cl">											<span class="c1"># (0) being the return code 0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kubernetes">Kubernetes</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">cat pod-def.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">math-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">math-add</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kubectl create -f pod-def.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">k get po</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NAME			READY		STATUS			RESTARTS		AGE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">math-pod	0/1			Completed		...					...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Kubernetes keeps bringing up the math-pod. Why? Kubernetes wants your application to live forever. The default behavior of the pods is to attempt to restart the container in an effort to keep it running. This behavior is deflined by the property <code>restartPolicy</code> set on the pod, which is by default set to always. That is why the pod always recreates the container when it exits. You can override this behavior by setting this property to <code>Never</code> or <code>OnFailure</code>.</p>
<h4 id="kubernetes-jobs">Kubernetes Jobs</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">math-add-job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">math-add</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>kubectl create cronjob my-cronjob --image=ubuntu --schedule='30 21 * * *'</code></p>
<h3 id="107-service">107. Service</h3>
<p>Example of a NodePort</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w"> </span><span class="c"># ClusterIP | LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">trype</span><span class="p">:</span><span class="w"> </span><span class="l">front-end</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># the port of pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># the port on the service object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30008</span><span class="w"> </span><span class="c"># NodePort, valid range 30000 - 32767</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="111-ingress-networking">111. Ingress Networking</h3>
<p>Ingress still needs to be exposed to outside. Ingress is for routing traffic to different services within your cluster, as well as implementing SSL.</p>
<h4 id="ingress-controller">Ingress Controller</h4>
<p>Commonly used ingress controller are: GCP HTTP(S) Load Balancer, NGINX, Contour, HAPROXY, traffic, Istio.</p>
<h5 id="nginx-ingress-deploymention-definition">Nginx-ingress-deploymention definition:</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.21.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="l">/nginx-ingress-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- --<span class="l">configmap=$(POD_NAMESPACE)/nginx-configuration </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				  </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				  	</span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				  		</span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAMESPACE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">							</span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="configmap-for-nginx-configuration">ConfigMap for nginx-configuration:</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c"># for storing details like err-log-path, keep-alive, ssl-protocols</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="a-service-to-expose-the-ingress-controller-to-external-world">A Service to expose the ingress-controller to external world:</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="a-service-account-to-moniter-the-k8s-cluster-for-ingress-resources">A Service Account to moniter the K8s cluster for ingress resources:</h5>
<p>Service account with the correct roles, cluster roles and role bindings.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-ingress-serviceaccount</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ingress-resource">Ingress Resource</h4>
<p>An ingress resource is a set of rules and configurations applied on the Ingress controller, e.g. how to route user, based on the URL, or route user based on the domain name itself.</p>
<h5 id="split-traffic-by-url">Split traffic by URL</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-wear-watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/wear</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	      </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	        </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wear-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	      </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	        </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">video-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="split-traffic-by-domain-name---using-host-field">Split traffic by domain name - using host field</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-wear-watch-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">wear.my-online-store.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	        </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">wear-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">watch.my-online-store.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	    </span>- <span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	        </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">watch-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="114-ingress-networking">114. Ingress Networking</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 22  create ingress</span>
</span></span><span class="line"><span class="cl">k create ingress ingress-pay -n critical-space --rule<span class="o">=</span><span class="s2">&#34;/pay=pay-service:8282&#34;</span> --dry-run<span class="o">=</span>client -o yaml &gt; paying.yaml
</span></span><span class="line"><span class="cl">vi paying.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat paying.yaml
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    nginx.ingress.kubernetes.io/rewrite-target: /
</span></span><span class="line"><span class="cl">    nginx.ingress.kubernetes.io/ssl-redirect: <span class="s2">&#34;false&#34;</span>
</span></span><span class="line"><span class="cl">  name: test-ingress
</span></span><span class="line"><span class="cl">  namespace: critical-space
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - http:
</span></span><span class="line"><span class="cl">      paths:
</span></span><span class="line"><span class="cl">      - backend:
</span></span><span class="line"><span class="cl">          service:
</span></span><span class="line"><span class="cl">            name: pay-service
</span></span><span class="line"><span class="cl">            port:
</span></span><span class="line"><span class="cl">              number: <span class="m">8282</span>
</span></span><span class="line"><span class="cl">        path: /pay
</span></span><span class="line"><span class="cl">        pathType: Prefix
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">k get ing -n critical-space
</span></span><span class="line"><span class="cl">cat 
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="117-lab-ingress-2">117. Lab ingress-2</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">k</span><span class="o">=</span>kubectl
</span></span><span class="line"><span class="cl">k get pod -A
</span></span><span class="line"><span class="cl">k create ns ingress-space
</span></span><span class="line"><span class="cl">k create cm nginx-configuration -n ingress-space
</span></span><span class="line"><span class="cl">k create sa ingress-serviceaccount -n ingress-space
</span></span><span class="line"><span class="cl">k get roles -n ingress-space
</span></span><span class="line"><span class="cl">k get rolebindings -n ingress-space
</span></span><span class="line"><span class="cl">k describe role ingress-role -n ingress-space
</span></span><span class="line"><span class="cl">k expose deploy ingress-controller -n ingress-space --name ingress --port<span class="o">=</span><span class="m">80</span> --target-port<span class="o">=</span><span class="m">80</span> --type NodePort 
</span></span><span class="line"><span class="cl">k get svc -n ingress-space
</span></span><span class="line"><span class="cl"><span class="c1"># notice that the nodeport (PORT(S)) is not 30080</span>
</span></span><span class="line"><span class="cl">k edit svc ingress -n <span class="nv">ingress</span><span class="o">=</span>space
</span></span><span class="line"><span class="cl"><span class="c1"># edit the spec.ports.nodePort property</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ingress resource for /watch /wear</span>
</span></span><span class="line"><span class="cl">k create ing ingress-wear-watch -n app-space --rule<span class="o">=</span><span class="s2">&#34;/wear=wear-service:8080&#34;</span> --rule<span class="o">=</span><span class="s2">&#34;/watch=video-service:8080&#34;</span>
</span></span><span class="line"><span class="cl">k get ing -n app-space
</span></span><span class="line"><span class="cl">k describe ing -n app-space ing-wear-watch
</span></span><span class="line"><span class="cl">k get pod -n app-sapce
</span></span><span class="line"><span class="cl">k logs webapp-video-xxxxxxxxxx-xxxxx -n app-service
</span></span><span class="line"><span class="cl">k logs webapp-wear-xxxxxxxxxx-xxxxx -n app-service
</span></span><span class="line"><span class="cl"><span class="c1"># notice that the requests were not hitting above pods</span>
</span></span><span class="line"><span class="cl">k get po -n ingress-space
</span></span><span class="line"><span class="cl"><span class="c1"># k logs this ingress-controller</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Due to too many redirects, we failed to access the pods.</span>
</span></span><span class="line"><span class="cl">k edit ingress ingress-wear-watch -n app-space
</span></span><span class="line"><span class="cl"><span class="c1"># add annotation to metadata</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">	annotations:
</span></span><span class="line"><span class="cl">		nginx.ingress.kubernetes.io/rewrite-target: /
</span></span><span class="line"><span class="cl">		nginx.ingress.kubernetes.io/ssl-redirect: <span class="s2">&#34;false&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="118-network-policies">118. Network Policies</h3>
<h4 id="ingress-and-egress">Ingress and Egress</h4>
<table>
<thead>
<tr>
<th>Subject</th>
<th>Ingress</th>
<th>Egress</th>
</tr>
</thead>
<tbody>
<tr>
<td>WebServer</td>
<td>User</td>
<td>API Server</td>
</tr>
<tr>
<td>APIServer</td>
<td>WebServer</td>
<td>Database</td>
</tr>
<tr>
<td>Database</td>
<td>API Server</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Only look at the traffic originated from when defining ingress or egress. The response to user doesn&rsquo;t really matter.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Put together</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 要保護的 pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 要定義哪一種網絡政策: ingress or egress or both</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">Egress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Define specifics of that policy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># ipBlock allows u to specify a range of IP addresses from which you could allow traffic to hit the db pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    			</span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.10</span><span class="l">/32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Define what port on the db-pod is the traffic allowed to go to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">to</span><span class="p">:</span><span class="w"> </span><span class="c"># from for ingress; to for egress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ipBlock</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.10</span><span class="l">/32 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># podSelector / NSselector are also applicable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Network policies are enforced by the network solutions implemented on Kubernetes cluster, and not all network solutions supports network policies.</p>
<table>
<thead>
<tr>
<th>Netpol support 🙆🏻‍♀️</th>
<th>Netpol support 🙅🏻‍♀️</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kube-router, Calico, Romana, Weave-net</td>
<td>Flannel</td>
</tr>
</tbody>
</table>
<p>Three selectors under the from section ingress:</p>
<ol>
<li>podSeclector</li>
<li>namespaceSelector (select ns by labels)</li>
<li>ipBlock selector</li>
</ol>
<h4 id="roles--elements-with-or-without--">Roles / Elements: with or without <code>-</code></h4>
<p>Two rules (an/or): 第一條規則中，要同時符合 pod/ns selector 才能通過。第二條規則 ipBock (POD <strong>AND</strong> NS OR IpBlock)</p>
<p>如果在 namespaceSelector 加上 - 就歸類成有三種 roles (POD <strong>OR</strong> NS or IpBlock)</p>
<h3 id="120-lab---network-policies">120. Lab - Network Policies</h3>
<p>第十題 (最後一題) 難的, 沒有辦法用 imperative way create netpol &hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">alias</span> <span class="nv">k</span><span class="o">=</span>kubectl
</span></span><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k get svc
</span></span><span class="line"><span class="cl">k get netpol 
</span></span><span class="line"><span class="cl">k get po --selector<span class="o">=</span><span class="nv">name</span><span class="o">=</span>payroll 
</span></span><span class="line"><span class="cl">k describe netpol payroll-policy
</span></span><span class="line"><span class="cl"><span class="c1"># Allowing ingress traffic:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># To Port: 8080/TCP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># From:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   PodSelector: name=internal</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Not affecting egress traffic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Q06: The internal pod cannot ping payroll pod, because we have only allowed the TCP rule, ICMP rule (ping) is not allowed yet.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Q10: Create a netpol</span>
</span></span><span class="line"><span class="cl">cat test-network-policy.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>Go to K8s.io and find a template to start with</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">internal-policy</span><span class="w"> </span><span class="c"># Policy Name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">internal</span><span class="w"> </span><span class="c"># name </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Egress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w"> </span><span class="c"># need two rules</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">payroll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      	</span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>Verify Q# 10</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k describe netpol internal-policy
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="-state-persistence">㈧ State Persistence</h2>
<h2 id="122-volumes">122. Volumes</h2>
<p>A volume needs a storage.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">random-number-generateor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;shuf -i 0-100 -n 1 &gt;&gt; /opt/number.out;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="nt">monntPath</span><span class="p">:</span><span class="w"> </span><span class="l">/opt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  	</span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  	</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Directory</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="volume-storage-options">Volume Storage Options</h4>
<p>Kubernetes supports various storage options, such as NFS, GlusterFS, Flocker, Fiber Channel, Ceph, Scaleio, or public cloud solutions like AWS EBS, Azure Disk/File, or Google persistent disk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">	</span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">awsElasticBlockStore</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">volumeID</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;volume-id&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="123-persistent-volumes">123. Persistent Volumes</h3>
<p>A persistent volume is a cluster wide pool of storage volumes, configured by an administrator to be used by users deploying applications on the cluster.  The users can not select storage from this pool using persistent volume claims. (比配置在 pod 裡面的 volumes 更能夠集中管理維護)</p>
<h4 id="pv-definitionyaml">pv-definition.yaml</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv-voll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#	hostPath:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#		path: /tmp/d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">awsElasticBlockStore</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">volumeID</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;volume-id&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="124-persistent-volume-claim">124. Persistent Volume Claim</h3>
<p>An administrator creates a set of PV and a user create PVCs to use the storage. Every persistent volume claim is bound to a single persistent volume. You could still used labels and selector to bind to the right volumes.</p>
<h4 id="pvc-definitionyaml">pvc-definition.yaml</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVerson</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Persistt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">myclaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">accesssModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">500Mi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>When a persistent volume claim, Kubernetes looks at the volume created previously. The access modes match. The capacity requested is 500 megabytes, but the volume is configured with on GB of storage. Since there are no other volumes available, the persistent volume claim is bond to the persistent volume.</p>
<p>When we run the get volumes (<code>kubectl get persistentvolumeclaim</code>) commonds again, we see the claim is bound to the persistent volume we created.</p>
<p>What happens to the underlying persistent volume when the claim is deleted? You can choose what is to happen to the volume. By default, it is set to retain, meaning the PV will remain until it&rsquo;s manually deleted by the administrator. It is not available for reuse by any other claims.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>(Below) The PV can be deleted automatically. This way, as soon as the claim is deleted, the volume will be deleted as well. Thus freeing up storage on the end storage device.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>(Below) A third option is to recycle. In this case, the data is the data volume will be scrubbed before making it available to other claims.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Recycle</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="127-lab-solution---pv-and-pvc">127. Lab Solution - PV and PVC</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k <span class="nb">exec</span> webapp -- cat /log/app.log
</span></span><span class="line"><span class="cl">k edit po webapp
</span></span><span class="line"><span class="cl"><span class="c1"># Question 4</span>
</span></span><span class="line"><span class="cl"><span class="c1"># At spec.volumes[0], add below:</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  volumes:
</span></span><span class="line"><span class="cl">  - name: log-volume
</span></span><span class="line"><span class="cl">    hostPath:
</span></span><span class="line"><span class="cl">      path: /var/log/webapp
</span></span><span class="line"><span class="cl"><span class="c1"># At spec.containers[0].volumeMounts[0], add below:</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - volumeMounts:
</span></span><span class="line"><span class="cl">    - mountPath: /log
</span></span><span class="line"><span class="cl">    	name: log-volume
</span></span><span class="line"><span class="cl"><span class="c1"># Verify by entering cd /var/log/webapp in controlplane terminal</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Question 5 </span>
</span></span><span class="line"><span class="cl">cat pv.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">	name: pv-log
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">	capacity:
</span></span><span class="line"><span class="cl">		storage: 100Mi
</span></span><span class="line"><span class="cl">	volumeMode:
</span></span><span class="line"><span class="cl">	accessModes:
</span></span><span class="line"><span class="cl">	  - ReadWriteMany
</span></span><span class="line"><span class="cl">	persistentVolumeReclaimPolicy: Retain
</span></span><span class="line"><span class="cl">	hostPath:
</span></span><span class="line"><span class="cl">		path: /pv/log
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="c1"># Question 6</span>
</span></span><span class="line"><span class="cl">cat pvc.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolumeClaim..yaml
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">	name: claim-log-1
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">	resources:
</span></span><span class="line"><span class="cl">		requests:
</span></span><span class="line"><span class="cl">			storage: 50Mi
</span></span><span class="line"><span class="cl">	accessModes:
</span></span><span class="line"><span class="cl">	  - ReadWriteOnce
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Question 12 Mount PVC to a pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># At spec.volumes[0], replace volume log-volume hostpath as below:</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">	volumes:
</span></span><span class="line"><span class="cl">	- name: log-volume
</span></span><span class="line"><span class="cl">		persistentVolumeClaim:
</span></span><span class="line"><span class="cl">    	claimName: claim-log-1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="129-storage-class">129. Storage Class</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv-v0l1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">500Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">gcePersistentDisk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">pdName</span><span class="p">:</span><span class="w"> </span><span class="l">pd-disk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l">ext4</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Before creating above persistent volume, we need to proceed static provisioning of Google persistent disk.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud beta compute disks create <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --size 1GB
</span></span></code></pre></td></tr></table>
</div>
</div><p>Static provisioning volume: Manually provision disks on Google Cloud and manually provision persistent volume</p>
<p>Storage Class: The volume gets provisioned automatically when the application requires it.</p>
<h4 id="dynamic-provisioning">Dynamic Provisioning</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># sc-definition.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">google-storage</span><span class="w"> </span><span class="c"># 🔗</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/gce-pd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pd-standard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">replication-type</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w"> </span><span class="c"># regional-pd | none</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We now have a storage class, so the PV definition is no longer required. Because the PV and any associated storage is going to be created automatically when the storage class is created. For the PVC to use the StorageClass we defined, we specified the storageClassName in the PVC definition yaml file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># pvc-definition.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myclaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">google-storage</span><span class="w"> </span><span class="c"># 🔗</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">500Mi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><pre tabindex="0"><code>Provisioner:           kubernetes.io/no-provisioner
</code></pre><h3 id="131-why-stateful-sets">131. Why Stateful Sets?</h3>
<p>How do we replicate the data from orignal MySQL to new servers for HA?</p>
<p>There are different topologies available, and the most straightforward one being a <strong>single master multi-slave topology</strong>, where all rights come into the master server, and reads can be served by either the master or any of the slave servers. So the master server should be set up first before deploying the slaves.</p>
<p>Once the slaves are deployed, perform an initial clone of the database from the master server to the first slave.</p>
<p>After the initial copy, enable continuous replication from the master to that slave, so that the database on the slave node is always in sync with the DB on the master.</p>
<p>Everytime we do the initial clone, it&rsquo;s going to impact the resources on the master, especially the network interface. It is better to just copy the data from the first slave instead of the master. Then we enable continuous replication from master node to slave-2, and make sure both slaves are configured with the address of the master node.</p>
<p>In this scenario, the IP address of master needs to be static, and a random name is not applicable here.</p>
<p>Stateful sets are similar to deployment sets. They create pods based on templates, they can scale up and scale down, and they can perform rolling updates and rollbacks. But there are some differences, with stateful sets, pod are created in sequential order. After the first pod is deployed, it must be in running and ready state before the next pod is deployed, so that helps to ensure the master is deployed first, and then slave-1 and slave-2.</p>
<h3 id="132-stateful-set">132. Stateful Set</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  	</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">mysql-h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># podManagementPolicy: Parallel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Service name must be a headless service.</p>
<p>Ordered graceful deployment: when you create a StatefulSet, it creates pods one after the other.</p>
<p>Each pod gets a stable, unique network DNS record on the network that any other application can use to access a pod.</p>
<p>When you scale the StatefulSet, it scales in an ordered graceful fashion, where each po comes up, becomes ready and only then the next one comes up. It works in the reverse order when you scale it down. The last instance is removed first, followed by the second last one. The same is true on termination.</p>
<p>These behaviors can be overridden to cause Stateful Set to not follow an ordered launch, but still have the other benefits of StatefulSet such as a stable and unique network ID. For that, you could set the podManagementPolicy field to <code>Parallel</code>. The default value for this field is <code>OrderedReady</code>.</p>
<h3 id="133-headless-service">133. Headless Service</h3>
<p>A headless service is created like a normal service, but it does not have an IP of its own like a cluster IP for a normal service, it does not perform any load balancing. All it does is creating DNS entries for each pod using the pod name and a sub-domain.</p>
<p>When you create a headless service, say with the name <code>mysql-h</code>, each pod gets a DNS record created in the form <code>pod-name.the-name-of-the-headless-service</code>. So it would be:</p>
<table>
<thead>
<tr>
<th>mysql-0.mysql-h.default.svc.cluster.local</th>
<th>mysql-1.mysql-h.default.svc.cluster.local</th>
<th>mysql-2.mysql-h.default.svc.cluster.local</th>
</tr>
</thead>
</table>
<p>The web application can now point to the DNS entry for the master mysql server at <code>mysql-0.mysql-h.default.svc.cluster.local</code>. That DNS entry will always point to the master pod in the mysql deployment.</p>
<h4 id="headless-service-definitionyaml">headless-service-definition.yaml</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql-h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3306</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w"> </span><span class="c"># this differentiate a headless service from a normal service</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>When the headless service is created, the DNS entries are created for pods, only if the two conditions are met while creating the pod. Under the spec section of a pod definition file, you have two optional fields - hostName and subDomain. You must specify the subdomain to a value the same as the name of the service. When you do that, it creates a DNS record for the name of the service to the pod.  But it still doesn&rsquo;t create <code>A records</code> for individual pods. For that, you must specify the <code>hostname</code> option in the pod definition file. Only then does it create a DNS record with a pod name as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># pod-definition.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">subdomain</span><span class="p">:</span><span class="w"> </span><span class="l">mysql-h</span><span class="w"> </span><span class="c"># must be the same name as the headless service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">mysql-pod</span><span class="w"> </span><span class="c"># hostname for dns record</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="how-to-configure-deployment-that-connect-headless-service-with-separate-dns-records-for-each-pod">How to configure deployment that connect headless service with separate DNS records for each pod?</h4>
<p>如果按照 deployment + subdomain + hostname 設定所產生的 DNS record，三個 replicas pod 都會長一樣 (<code>mysql-pod.mysql-h.default.svc.cluster.local</code>) &ndash;&gt; 改成 StatefulSet 不用 subdomain / hostname</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># deployment-definition.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># kind: Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">mysql-h</span><span class="w"> </span><span class="c"># should be the name of the headless service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#			subdomain: mysql-h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#			hostname: mysql-pod</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="volumeclaimtemplate">volumeClaimTemplate</h4>
<p>在 pod definition 裡面會定義對應的 pvc，同樣的情況定義在 statefulSet 的話，會造成 statefulset 形成的 replicated pod (可能一到多個) 有多個 POD 一起存取相同的 pvc。如果業務情境不適合多個 pod 共用同一個 pvc，可以使用 pvc 的 template，放在 statefulset 就是位於 spec.volumeClaimTemplates (a field under spec section of type array)。如果 statefulset 的其中一個 pod 重啟了，statefulset 會確保新長出來的 pod 會重新連上之前連接上的相同 PVC (from volumeClaimTemplates) ，以確保 pod 儲存的穩定性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  </span><span class="nt">volumeMount</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">volumeClaimTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">google-storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">				</span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">					</span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">500Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">google-storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/gcd-pd</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="139-kubeconfig">139. KubeConfig</h3>
<p>下面這三個 fields 對應的 value 都是指定一個完整路徑：</p>
<ul>
<li>clusters[*].cluster.certificate-authority</li>
<li>users[*].user.client-certificate</li>
<li>users[*].user.client-key</li>
</ul>
<p>除此之外也有其他方法可以指定 <code>credentials certificate-authority-data</code>，需要將 certificate 做 base64 encoding (<code>cat ca.crt | base64</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Config
</span></span><span class="line"><span class="cl">current-context: dev-user@google
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">clusters:
</span></span><span class="line"><span class="cl">- name: my-kube-playground 
</span></span><span class="line"><span class="cl">	cluster:
</span></span><span class="line"><span class="cl">		certificate-authority-data:
</span></span><span class="line"><span class="cl">	<span class="c1"># certificate-authority: /etc/kubernetes/pki/ca.crt </span>
</span></span><span class="line"><span class="cl">		server: https://some.random.url:fake-port
</span></span><span class="line"><span class="cl">- name: development <span class="o">(</span>values hidden...<span class="o">)</span>
</span></span><span class="line"><span class="cl">- name: production
</span></span><span class="line"><span class="cl">- name: google
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">contexts:
</span></span><span class="line"><span class="cl">- name: my-kube-admin@my-kube-playground <span class="o">(</span>values hidden...<span class="o">)</span>
</span></span><span class="line"><span class="cl">- name: dev-user@google
</span></span><span class="line"><span class="cl">- name: prod-user@production
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">users:
</span></span><span class="line"><span class="cl">- name: my-kube-admin
</span></span><span class="line"><span class="cl">	user:
</span></span><span class="line"><span class="cl">		client-certificate: /etc/kubernetes/pki/users/admin.crt
</span></span><span class="line"><span class="cl">		client-key: /etc/kubernetes/pki/users/admin.key
</span></span><span class="line"><span class="cl">- name: admin <span class="o">(</span>values hidden...<span class="o">)</span>
</span></span><span class="line"><span class="cl">- name: dev-user
</span></span><span class="line"><span class="cl">- name: prod-user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl config view
</span></span><span class="line"><span class="cl">kubectl config --kubeconfig<span class="o">=</span>/root/my-kube-config use-context research
</span></span><span class="line"><span class="cl"><span class="c1"># 以 my-kube-config 檔案 override ～/.kube/config 的內容 且改用 research context</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl config use-context prod-user@production
</span></span><span class="line"><span class="cl">kubectl config -h
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="142-api-groups">142. API Groups</h3>
<p>Here are some examples of API curl command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl https://kube-master:6443/version
</span></span><span class="line"><span class="cl">curl https://kube-master:6443/api/v1/pods
</span></span><span class="line"><span class="cl">curl http://localhost:6443 -k
</span></span></code></pre></td></tr></table>
</div>
</div><p>See the uri <code>/version</code> and <code>pods</code>? The Kubernetes API is grouped into multiple such groups based on their purposes</p>
<table>
<thead>
<tr>
<th>API group</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/metrics</code></td>
<td>For monitoring the healthy of the cluster</td>
</tr>
<tr>
<td><code>/healthz</code></td>
<td>For monitoring the healthy of the cluster</td>
</tr>
<tr>
<td><code>/version</code></td>
<td>For viewing version of the cluster</td>
</tr>
<tr>
<td><code>/api</code></td>
<td>core group, e.g. ns, po, rc, events, endpoints, nodes, bindings, pv, pvc, configmaps, secrets, services</td>
</tr>
<tr>
<td><code>/apis</code></td>
<td>named group. grouped in <code>/apps</code>, <code>/extensions</code>, <code>/networking.k8s.io</code>, <code>/storage.k8s.io</code>, <code>/authentication.k8s.io</code>, <code>/certificates.k8s.io</code> (newer features, more organized)</td>
</tr>
<tr>
<td><code>/logs</code></td>
<td>For integrating with 3rd party logging applications</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl proxy
</span></span><span class="line"><span class="cl">Starting to serve on 127.0.0.1:8001
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kube-proxy--kubectl-proxy">Kube proxy ≠ kubectl proxy</h4>
<p>Kube proxy is used to <strong>enable connectivity between pods and services across different nodes in the cluster</strong>.</p>
<p>The <code>kubectl proxy</code> is an ACTP proxy service created by kubectl utility to <strong>access the cube-api-server</strong>.</p>
<h3 id="143-authorization-授權">143. Authorization 授權</h3>
<p>As an admin, we are able to perform any operation. But soon, we will have others accessing the cluster as well, such as the other administrators, developers, testers, or other applications like monitoring applications, or continuous delivery applications like Jenkins, etc.</p>
<p>We will be creating accounts for them to access the cluster by creating user name and passwords, or tokens, or signed TLS certificates, or service accounts as we saw in the previous lectures. But we don&rsquo;t want them (developers or service accounts) to have the same access level as us.</p>
<p>There are different authorization mechanisms supported by K8s, such as Node authorization, attribute based authorization (ABAC), role-based authorization (RBAC) and Webhook.</p>
<h4 id="node">Node</h4>
<p>The kubelets should be part of the system nodes group and have a name prefixed with system node, so a user with the name <strong>system node</strong> and part of the system nodes group is authorized by the node authorizer, and re granted the privileges required for a kubelet.</p>
<h4 id="external-access-to-the-api---abac">External Access to the API - ABAC</h4>
<p>Attribute based authorization is where you associate a user or a group of users with a set of permissions. This is implemented by creating a policy definition file for each user or group. But you will have to manually edit this policy file and restart the kube-api-server, making the ABAC configuration difficult to manage.</p>
<h4 id="rbac">RBAC</h4>
<p>Instead of directly associating a user or a group with a set of permissions, we define a role. For example, we create a role with the set of permissions required for developers. Then, we associate all the developers to that role. Similarly, we create a rolle for security users with the right set of permissions required for them.</p>
<p>Whenever a change needs to be made to the user&rsquo;s access, we simple modify the role, and it will reflect on all developers immediately. (Standard approach)</p>
<h4 id="webhook">Webhook</h4>
<p>Outsourcing authorizations such as Open Policy Agent is a 3rd party tool that helps with admission control and authorization. You can have K8s make an API call to the Open Policy Agent with the information about the user and his access requirements, and have the Open Policy Agent decide if the user should be permitted or not.</p>
<p>Remainder two authorization modes: <strong>AlwaysAllow</strong>, <strong>AlwaysDeny</strong></p>
<p>The authorization modes are set using the authorization mode option on the kube api-server. If you don&rsquo;t specify this option, it is set to always allow by default.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span>--<span class="l">authorization-mode=AlwaysAllow \\</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>You may provide a comma separated list of multiple modes that you wish to use.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span>--<span class="l">authorization-mode=Node,RBAC,Webhook \\</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>When you have multiple modes configured, your request is authorized using <strong>each one in the order it is specified.</strong> (如果第一個 module 拒絕請求，就由第二個 module 負責處理授權的請求，再不過就讓第三個 module 處理，只要有其中一個 mode 許可，就不用再讓下一個 mode k )</p>
<h3 id="144-rbac">144. RBAC</h3>
<p>Note that roles and rolebindings fall under the scope of namespaces.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create role developer --resource<span class="o">=</span>pods,deployments --verb<span class="o">=</span>list,get
</span></span><span class="line"><span class="cl">kubectl create role developer --resource<span class="o">=</span>pods,deployments --verb<span class="o">=</span>list --verb<span class="o">=</span>get --verb<span class="o">=</span>update
</span></span><span class="line"><span class="cl">cat developer-role.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Role
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">	name: developer
</span></span><span class="line"><span class="cl">	namespace: blue <span class="c1"># if not specifies, it would be default ns.</span>
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups:
</span></span><span class="line"><span class="cl">	- <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">  - pods
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - create
</span></span><span class="line"><span class="cl">- apiGroups: <span class="o">[</span><span class="s2">&#34;&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  resources: <span class="o">[</span><span class="s2">&#34;ConfigMap&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  verbs: <span class="o">[</span><span class="s2">&#34;create&#34;</span>, <span class="s2">&#34;get&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">kubectl create rolebinding dev-user-binding --role<span class="o">=</span>developer --user<span class="o">=</span>dev-user
</span></span><span class="line"><span class="cl">cat dev-user-binding.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: RoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">	name: dev-user-binding
</span></span><span class="line"><span class="cl">	namespace: blue <span class="c1"># if not specifies, it would be default ns.</span>
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- kind: user
</span></span><span class="line"><span class="cl">  name: dev-user
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">	kind: Role	
</span></span><span class="line"><span class="cl">	name: developer
</span></span><span class="line"><span class="cl">	apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">k get roles
</span></span><span class="line"><span class="cl">k get rolebindings
</span></span><span class="line"><span class="cl">k describe role developer
</span></span><span class="line"><span class="cl">k describe rolebinding dev-user-binding
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="check-access">Check Access</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl auth can-i create deployments
</span></span><span class="line"><span class="cl">yes
</span></span><span class="line"><span class="cl">kubectl auth can-i delete nodes
</span></span><span class="line"><span class="cl">no
</span></span><span class="line"><span class="cl">kubectl auth can-i create pods --as dev-user
</span></span><span class="line"><span class="cl">yes
</span></span><span class="line"><span class="cl">kubectl auth can-i create pods --as dev-user -n <span class="nb">test</span>
</span></span><span class="line"><span class="cl">no
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="limit-access-by-resourcenames">Limit access by resourceNames</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">developer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;blue&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;orange&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># can only get details of pod named blue or orange</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="146-rbac-practice-test">146. RBAC Practice Test</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat /etc/kubernetes/manifests/api-server.yaml
</span></span><span class="line"><span class="cl">ps -aux <span class="p">|</span> grep authorization-mode
</span></span><span class="line"><span class="cl">k get roles -A --no-headers <span class="p">|</span> wc -l
</span></span><span class="line"><span class="cl">k describe role kube-proxy -n kube-system
</span></span><span class="line"><span class="cl">k get rolebinding -n kube-system
</span></span><span class="line"><span class="cl">k describe rolebinding kube-proxy -n kube-system
</span></span><span class="line"><span class="cl"><span class="c1"># Check that kube-proxy role is assigned to account Group:system:bootstrappers:kubeadm:default-node-token</span>
</span></span><span class="line"><span class="cl">k get po --as dev-user
</span></span><span class="line"><span class="cl"><span class="c1"># Question 9</span>
</span></span><span class="line"><span class="cl">k create role developer --resource<span class="o">=</span>pods --verb<span class="o">=</span>list,create,delete
</span></span><span class="line"><span class="cl">k create rolebinding dev-user-binding --role<span class="o">=</span>developer --user<span class="o">=</span>dev-user
</span></span><span class="line"><span class="cl"><span class="c1"># Question 10 dark-blue app</span>
</span></span><span class="line"><span class="cl">k --as dev-user get pod dark-blue-app -n blue
</span></span><span class="line"><span class="cl">k get role -n blue
</span></span><span class="line"><span class="cl">k get rolebinding -n blue
</span></span><span class="line"><span class="cl">k describe role developer -n blue
</span></span><span class="line"><span class="cl">k edit role developer -n blue
</span></span><span class="line"><span class="cl"><span class="c1"># Change rules[0].resoureNames[0] from blue-app to dark-blue-app and save</span>
</span></span><span class="line"><span class="cl">k --as dev-user get pod dark-blue-app -n blue
</span></span><span class="line"><span class="cl">k --as dev-user create deploy nginx --image nginx -n blue
</span></span><span class="line"><span class="cl">k edit role developer -n blue
</span></span><span class="line"><span class="cl"><span class="c1"># Add a new rule</span>
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups: <span class="o">(</span>values hidden<span class="o">)</span>
</span></span><span class="line"><span class="cl">- apiGroups: <span class="o">[</span><span class="s2">&#34;apps&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  resources: <span class="o">[</span><span class="s2">&#34;deployments&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  verbs: <span class="o">[</span><span class="s2">&#34;create&#34;</span>, <span class="s2">&#34;get&#34;</span>, <span class="s2">&#34;watch&#34;</span><span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="147-cluster-roles">147. Cluster Roles</h3>
<ul>
<li>
<p>Namespaced Objects: Pods, ReplicaSets, Jobs, Deployments, Services, Secrets, Roles, RoleBindings, ConfigMaps, PVC, etc.</p>
</li>
<li>
<p>Cluster Scoped Objects: Nodes, PersistentVolume, ClusterRoles, ClusterRoleBindings, CertificateSigningRequests, Namespaces, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Get namespaced objects</span>
</span></span><span class="line"><span class="cl">kubectl api-resources --namespaced<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Get cluster scoped objects</span>
</span></span><span class="line"><span class="cl">kbuectl api-resrouces --namespaced<span class="o">=</span><span class="nb">false</span>	
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="clusterroles">ClusterRoles</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-administrator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resrouces</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;nodes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;create&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="clusterrolebinding">ClusterRoleBinding</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin-role-binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-administrator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Cluster roles and bindings are used for cluster scoped resources, but that&rsquo;s not a hard rule. You can create a cluster role for namespaced resources as well. When you do that, the user will have access to these resources across all namespaces.</p>
</blockquote>
<h3 id="150-admission-controller">150. Admission Controller</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k get po -n kube-system
</span></span><span class="line"><span class="cl">k <span class="nb">exec</span> -it kube-apierver-controlplane -n kube-system -- kube-apiserver -h <span class="p">|</span> grep <span class="s1">&#39;enable-admission-plugins&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># check --enable-admission-plugins ... default enabled ones (NamespaceLifeCycle, Limit Ranger, ServiceAccount, TaintNodesByCondition, Priority, DefaultTolerationSeconds, DefaultStorageClass, StorageObjectInUseProtection, PersistentVolumeClaimResize, RuntimeClass, CertificateApproval, CertificatesSigning, CertificateSubjectRestriction, DefaultIngressClass, MutatingAdmissionWebhook, ValidatingAdmissionWebhook, ResourceQuota)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="153-validatign-and-mutation-admission-controllers">153. Validatign and Mutation Admission Controllers</h3>
<p>[kubectl request] &ndash;&gt; Authentication &ndash;&gt; Authorization &ndash;&gt; AdmissionControllers &ndash;&gt; create object</p>
<p>Some built-in admission controllers (part of kubernetes source code)</p>
<ul>
<li>AlwaysPullImages</li>
<li>DefaultStorageClass</li>
<li>EventRateLimit</li>
<li>NamespaceAutoProvision</li>
<li>NamespaceExists</li>
<li>many more &hellip;</li>
</ul>
<p>Customizable Admission Controller:</p>
<ol>
<li>MutatingAdmissionWebhook</li>
<li>ValidationAdmissionWebhook</li>
</ol>
<p>Steps:</p>
<ol>
<li>
<p>Deploy our admission webhook server with our own logic</p>
<ul>
<li>The admission webhook server can be written in any language</li>
<li>The only requirement is that it must accept mutate and validate API, and repsond with JSON object that the web server expects</li>
<li>webhook-deployment &amp; webhook-service</li>
</ul>
</li>
<li>
<p>Configure a webhook by creating a K8S webhook configuration object</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">admissionregistration.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ValidatingWebhookConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># kind: MutatingWebhookConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pod-policy.example.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pod-policy.example.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># clientConfig:  # admission webhook service 在外部</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 	url: &#34;https://external-server.example.com&#34; </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clientConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="c"># admission webhook service 在K8s cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  		</span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;webhook-namespace&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  		</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;webhook-service&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;xxxxx.....xxxx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">apiGroups:	 [&#34;&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="nt">apiVersions</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;v1&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="l">operations:	 [&#34;CREATE&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="l">resources:	 [&#34;pods&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="nt">scope</span><span class="p">:</span><span class="w"> 			 </span><span class="s2">&#34;Namespaced&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="155-lab---validate-and-mutate-admission-controllers-驗證與異動准入控制器">155. Lab - Validate and Mutate Admission Controllers (驗證與異動准入控制器)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># NamespaceAutoProvision; Admission controller is mutating; </span>
</span></span><span class="line"><span class="cl"><span class="c1"># NamespaceExists; validating to see if a namespace exists.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Invocation flow of admission controller: first mutating then validating</span>
</span></span><span class="line"><span class="cl">k create ns webhook-demo
</span></span><span class="line"><span class="cl"><span class="c1"># Question 4 TLS secret create</span>
</span></span><span class="line"><span class="cl">k create secret tls webhook-server-tls <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --cert<span class="o">=</span><span class="s2">&#34;path-to-server-tls.crt&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --key<span class="o">=</span><span class="s2">&#34;path-to-server-tls.key&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get po pod-with-defaults -o yaml <span class="p">|</span> grep -A2 <span class="s2">&#34; securityContext:&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 找到的行數＋後兩行(after), 如果是 grep -B2 就是找到的行數+前兩行</span>
</span></span><span class="line"><span class="cl">cat pod-with-override.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat pod-with-conflict.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-with-conflict
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: pod-with-conflict
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  restartPolicy: OnFailure
</span></span><span class="line"><span class="cl">  securityContext:
</span></span><span class="line"><span class="cl">    runAsNonRoot: <span class="nb">true</span> <span class="c1"># against the mutating webook</span>
</span></span><span class="line"><span class="cl">    runAsUser: <span class="m">0</span>
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">    - name: busybox
</span></span><span class="line"><span class="cl">      image: busybox
</span></span><span class="line"><span class="cl">      command: <span class="o">[</span><span class="s2">&#34;sh&#34;</span>, <span class="s2">&#34;-c&#34;</span>, <span class="s2">&#34;echo I am running as user </span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">&#34;</span><span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="159-lab---api-versions">159. Lab - API versions</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl api-resources <span class="c1"># check short names</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1.20.2 (major.minor.patch) kubectl api version</span>
</span></span><span class="line"><span class="cl">kubectl explain job
</span></span><span class="line"><span class="cl"><span class="c1"># VERSION:  {group}/{version}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl proxy 8001<span class="p">&amp;</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># &amp; stands for running this command in the background</span>
</span></span><span class="line"><span class="cl">curl localhost:8001/apis/authorization.k8s.io
</span></span><span class="line"><span class="cl"><span class="c1"># you will see the preferredVersion in responses</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cp /etc/kubernetes/manifests/kube-apiserver.yaml /root/kube-apiserver.yaml.backup
</span></span><span class="line"><span class="cl">ls <span class="c1"># check that the backup is saved</span>
</span></span><span class="line"><span class="cl">vi /etc/kubernetes/manifests/kube-apiserver.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># At spec.containers[0].command[*], add runtime-config argument</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - command:
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    - --runtime-config<span class="o">=</span>rbac.authorization.k8s.io/v1alpha1 <span class="c1">#=true</span>
</span></span><span class="line"><span class="cl">k get po -n kube-system
</span></span><span class="line"><span class="cl"><span class="c1"># Check that a new kube-apiserver pod is set up</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Install kubectl convert plugin</span>
</span></span><span class="line"><span class="cl">curl -LO <span class="s2">&#34;https://dl.k8s.io/release/</span><span class="k">$(</span>curl -L -s https://dl.k8s.io/release/stable.txt<span class="k">)</span><span class="s2">/bin/linux/amd64/kubectl-convert&#34;</span>
</span></span><span class="line"><span class="cl">chmod +x kubectl-convert
</span></span><span class="line"><span class="cl">mv kubectl-convert /usr/local/bin/
</span></span><span class="line"><span class="cl">kubectl convert --help
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl convert -f /root/ingress-old.yaml --output-version networking.k8s.io/v1 &gt; ingress-new.yaml
</span></span><span class="line"><span class="cl">k create -f ingress-new.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="160-crd---custom-resource-definition">160. CRD - Custom Resource Definition</h3>
<p>Custom Resouce: FlightTicket (kind: FightTIcket)</p>
<p>Custom Controller: flightticket controller written in GO to moniter status of each FlightTicket resource</p>
<h4 id="custom-resource-definition">Custom Resource Definition</h4>
<p>The custom resource definition allows you to create any kind of object type on kubernetes, to specify a schema and add validations. But it&rsquo;s only going to let you create these resource and store them in ETCD data stores, it&rsquo;s not going to anything about these resources because we haven&rsquo;t built a custom controller yet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiextensions.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CustomResourceDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">flighttickets.flights.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">Namespaced</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">flights.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">FlightTicket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l">flightticket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l">flighttickets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">shortNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ft</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">versions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		</span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		  </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	</span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	</span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	  </span><span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	  </span><span class="nt">to</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	  </span><span class="nt">number</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">integer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	    </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    		    	    </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="162-custom-controller">162. Custom Controller</h3>
<p>Constantly monitor and change custom resources stored in ETCD data store.</p>
<p>Please refer to <code>kubernetes / sample-controller</code> <a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener noreffer ">GitHub repo</a> and make business logic related edits.</p>
<pre tabindex="0"><code class="language- go" data-lang=" go">package flightticket

var controllerKind = apps.SchemaGroupVersion.WithKind(&#34;Flightticket&#34;)
// &lt; Code hidden &gt;

// Run begins watching and syncing.
func (dc *FlightTicketController) Run(workers int, stopCh &lt;-chan struct{})

// &lt; Code hidden &gt;
// Call BookFlightAPIReplicaSet
func (dc *FlightTicketController) callBookFlightAPI(obj interface{})

// &lt; A lot of code hidden &gt;
</code></pre><p>Package your controller in docker and deploy it on K8s in pods or deployments.</p>
<h3 id="163-operator-framework">163. Operator Framework</h3>
<p>CRD and Custom Controller can be packaged together to be deployed as a single entity using the Operator Framework.</p>
<h4 id="etcd-operator">ETCD operator</h4>
<p>It&rsquo;s one of the most popular operators, used to deploy and manage ETCD cluster within k8s.</p>
<table>
<thead>
<tr>
<th>CRD</th>
<th>CustomController</th>
</tr>
</thead>
<tbody>
<tr>
<td>EtcdCluster</td>
<td>ETCD Controller</td>
</tr>
<tr>
<td>EtcdBackup</td>
<td>Backup Operator</td>
</tr>
<tr>
<td>EtcdRestore</td>
<td>Restore Operator</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><a href="https://operatorhub.io/" target="_blank" rel="noopener noreffer ">Operator Hub</a>, where all operators are available. You can look for operators like MySQL, Prometheus, Grafana, ArgoCD, Istio, etc.</p>
<h2 id="helm-fundamentals">Helm Fundamentals</h2>
<h4 id="helm-chart">Helm Chart</h4>
<p>All the templates file regarding an app. A single Helm Chart may include Templates, <code>values.yaml</code>, <code>Chart.yaml</code>
Chart.yaml: name and version of the chart, description of the chart, keywords associatd with the application and information about the maintainers
<a href="https://artifacthub.io/" target="_blank" rel="noopener noreffer ">https://artifacthub.io/</a> - Repository that stores helm char</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm search hub wordpress
</span></span></code></pre></td></tr></table>
</div>
</div><p>Bitnami Helm Repositor</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">https://bitnami.com/stacks/helm
</span></span><span class="line"><span class="cl">helm repo add bitname https://charts.bitnami.com/bitnami
</span></span><span class="line"><span class="cl">helm search repo wordpress
</span></span><span class="line"><span class="cl">helm repo list
</span></span></code></pre></td></tr></table>
</div>
</div><p>Releas</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install &lt;release-name&gt; &lt;chart-name&gt;
</span></span><span class="line"><span class="cl">helm install bravo bitnami/drupal
</span></span></code></pre></td></tr></table>
</div>
</div><p>Command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm list
</span></span><span class="line"><span class="cl">helm uninstall my-release
</span></span><span class="line"><span class="cl"><span class="c1"># download package under the /root directory (not installing)</span>
</span></span><span class="line"><span class="cl">helm pull --untar bitnami/wordpress
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">helm repo list
</span></span><span class="line"><span class="cl"><span class="c1"># after editing values.yaml, run below command to install (法1)</span>
</span></span><span class="line"><span class="cl">helm install mywebapp ./apache
</span></span><span class="line"><span class="cl"><span class="c1"># in the apache directory (法2,目錄內)</span>
</span></span><span class="line"><span class="cl">helm install mywebapp .
</span></span><span class="line"><span class="cl">helm list
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="-helm-foundamentals">㈩ Helm Foundamentals</h2>
<h3 id="164-helm-introduction">164. Helm Introduction</h3>
<p>部署一個 WordPress 就要 Deployment, pv, sec, pac, secret，要維護/客製化很多 yaml 很麻煩，而且時間久了可能會有東西找不對或者話很多時間搜尋的問題。Helm changes the paradigm</p>
<p>Helm looks at those objects as part of a big package, so it&rsquo;s sometimes considered as package manager of Kubernetes.</p>
<p>Whenever we need to perform an action, we don&rsquo;t tell Helm the objects it should touch. We just tell it what package we want it to act on (e.g. WordPress app package). Based on the package name, Helm knows what objects it should change and how, even if there are hundred of objects that belong to that package.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># install the whole app with a single command</span>
</span></span><span class="line"><span class="cl">helm install wordpress ...
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="file-valueyaml">File: value.yaml</h4>
<p>The file <code>value.yaml</code> is where we can change the size of our persistent volumes, choose the name of our WordPress website, the admin password, settings for the DB engine and so on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># update the applicatoin with a single command</span>
</span></span><span class="line"><span class="cl">helm upgrade wordpress ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># rollback to previous version</span>
</span></span><span class="line"><span class="cl">helm rollback wordpress ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">helm uninstall wordpress ...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="165-install-helm">165. Install Helm</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># on linux system</span>
</span></span><span class="line"><span class="cl">sudo snap install helm --classic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># on apt-based (Debian or Ubuntu)</span>
</span></span><span class="line"><span class="cl">curl https://baltocdn.com/helm/signing.asc <span class="p">|</span> sudo apt-key add -
</span></span><span class="line"><span class="cl">sudo apt-get install apt-transport-https --yes
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;deb https://baltocdn.com/helm/stable/debian/ all main&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
</span></span><span class="line"><span class="cl">sudo apt-get update
</span></span><span class="line"><span class="cl">sudo apt-get install helm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># on package-based system</span>
</span></span><span class="line"><span class="cl">pkg install helm
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="lab">Lab</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Identify the name of OS</span>
</span></span><span class="line"><span class="cl">cat /etc/*release*
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="172-time-management">172. Time Management</h3>
<p>How to answer 17 ~ 20 questions within 2 hours? You only need to solve enough. It&rsquo;s very important to <strong>(1) attempt all the questions</strong>.</p>
<p><strong>(2) Do not stuck on any questions</strong>, even the ones that looked simple.</p>
<p><strong>(3) Get really good with YAML file</strong>. If for each question, you&rsquo;re having to go through each line of your yaml file and fix indentation errors, you are not going to make it through all questions. &ndash;&gt; 這我，設定 Ingress 跟 networkPolicy object 超不熟</p>
<p><strong>(4) Use Shortcuts / Aliases</strong></p>
<table>
<thead>
<tr>
<th>alias</th>
<th>object</th>
</tr>
</thead>
<tbody>
<tr>
<td>po</td>
<td>POD</td>
</tr>
<tr>
<td>rs</td>
<td>ReplicaSet</td>
</tr>
<tr>
<td>deploy</td>
<td>Deployment</td>
</tr>
<tr>
<td>svc</td>
<td>Service</td>
</tr>
<tr>
<td>ns</td>
<td>Namespace</td>
</tr>
<tr>
<td>netpol</td>
<td>NetworkPolicy</td>
</tr>
<tr>
<td>pv</td>
<td>PersistentVolume</td>
</tr>
<tr>
<td>pvc</td>
<td>PersistentVolumeClaim</td>
</tr>
<tr>
<td>sa</td>
<td>ServiceAccount</td>
</tr>
</tbody>
</table>
<p><a href="https://bit.ly/3Lx76XH" target="_blank" rel="noopener noreffer ">https://bit.ly/3Lx76XH</a> 總共有四個 Lab Challenges，上完課程來寫這個，再去 killer.sh 用完兩個 attempts，CKAD ($197.5) 應該就穩了吧</p>
<h3 id="lightning-lab-1">Lightning Lab 1</h3>
<h4 id="1">1</h4>
<p>Create a Persistent Volume called <code>log-volume</code>. It should make use of a <code>storage class</code> name <code>manual</code>. It should use <code>RWX</code> as the access mode and have a size of <code>1Gi</code>. The volume should use the hostPath <code>/opt/volume/nginx</code></p>
<p>Next, create a PVC called <code>log-claim</code> requesting a minimum of <code>200Mi</code> of storage. This PVC should bind to <code>log-volume</code>.</p>
<p>Mount this in a pod called <code>logger</code> at the location <code>/var/www/nginx</code>. This pod should use the image <code>nginx:alpine</code>.</p>
<h5 id="answer">Answer</h5>
<p>Solution manifest file to create a Persistent Volume called <code>log-volume</code> as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">manual</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/opt/volume/nginx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>then create a Persistent Volume Claim called <code>log-claim</code> as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log-claim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">200Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">manual</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Check the bind status of PV and PVC by running the following command:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@controlplane:~$ kubectl get pv,pvc
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, create a new pod called <code>logger</code> with <code>nginx:alpine</code> image as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">logger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># pod name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/www/nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">log-claim</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2">2</h4>
<p>We have deployed a new pod called <code>secure-pod</code> and a service called <code>secure-service</code>. Incoming or Outgoing connections to this pod are not working.
Troubleshoot why this is happening.</p>
<p>Make sure that incoming connection from the pod <code>webapp-color</code> are successful.</p>
<p>Important: Don&rsquo;t delete any current objects deployed.</p>
<h5 id="answer-1">Answer</h5>
<p>Incoming or outgoing connections are not working because of network policy. In the default namespace, we deployed a <code>default-deny</code> network policy which is interrupting the incoming or outgoing connections.</p>
<p>Now, create a network policy called <code>test-network-policy</code> to allow the connections, as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secure-netpol</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">secure-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">from</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webapp-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>then check the connectivity from the <code>webapp-color</code> pod to the <code>secure-pod</code>:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@controlplane:~$ kubectl <span class="nb">exec</span> -it webapp-color -- sh
</span></span><span class="line"><span class="cl">/opt <span class="c1"># nc -v -z -w 5 secure-service 80</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3">3</h4>
<p>Create a pod called <code>time-check</code> in the <code>dvl1987</code> namespace. This pod should run a container called <code>time-check</code> that uses the <code>busybox</code> image.</p>
<ol>
<li>Create a config map called <code>time-config</code> with the data <code>TIME_FREQ=10</code> in the same namespace.</li>
<li>The <code>time-check</code> container should run the command: <code>while true; do date; sleep $TIME_FREQ;done</code> and write the result to the location <code>/opt/time/time-check.log</code>.</li>
<li>The path <code>/opt/time</code> on the pod should mount a volume that lasts the lifetime of this pod.</li>
</ol>
<h5 id="answer-2">Answer</h5>
<p>Create a namespace called <code>dvl1987</code> by using the below command:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl create namespace dvl1987
</span></span></code></pre></td></tr></table>
</div>
</div><p>Solution manifest file to create a configMap called <code>time-config</code> in the given namespace as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">TIME_FREQ</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">time-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dvl1987</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now, create a pod called <code>time-check</code> in the same namespace as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">time-check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">time-check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dvl1987</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">time-check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TIME_FREQ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">time-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">TIME_FREQ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/opt/time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;/bin/sh&#34;</span><span class="w">  </span><span class="c"># 第三次還是要查一下文件...這樣不行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;-c&#34;</span><span class="w">       </span><span class="c"># &gt; /opt/time/time-check.log 放的位置 實驗</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;while true; do date; sleep $TIME_FREQ;done &gt; /opt/time/time-check.log&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4">4</h4>
<p>Create a new deployment called <code>nginx-deploy</code>, with one single container called <code>nginx</code>, image <code>nginx:1.16</code> and <code>4</code> replicas.
The deployment should use <code>RollingUpdate</code> strategy with <code>maxSurge=1</code>, and <code>maxUnavailable=2</code>.</p>
<p>Next upgrade the deployment to version <code>1.17</code>.</p>
<p>Finally, once all pods are updated, undo the update and go back to the previous version.</p>
<h5 id="answer-3">Answer</h5>
<p>Run the following command to create a manifest for deployment <code>nginx-deploy</code> and save it into a file:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create deployment nginx-deploy --image<span class="o">=</span>nginx:1.16 --replicas<span class="o">=</span><span class="m">4</span> --dry-run<span class="o">=</span>client -oyaml &gt; nginx-deploy.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>and add the <code>strategy</code> field under the <code>spec</code> section as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>So final manifest file for deployment called <code>nginx-deploy</code> should looks like below:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy:   # 這裡第三次玩lab好像因為多了個 spec.strategy</span><span class="p">:</span><span class="w"> </span>{}<span class="w"> </span><span class="l">所以判定失敗了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>then run the <code>kubectl apply -f nginx-deploy.yaml</code> to create a deployment resource.</p>
<p>Now, upgrade the deployment&rsquo;s image version using the <code>kubectl set image</code> command:-</p>
<pre tabindex="0"><code>kubectl set image deployment nginx-deploy nginx=nginx:1.17
</code></pre><p>Run the <code>kubectl rollout</code> command to undo the update and go back to the previous version:-</p>
<pre tabindex="0"><code>kubectl rollout undo deployment nginx-deploy
</code></pre><h4 id="5">5</h4>
<p>Create a <code>redis</code> deployment with the following parameters:</p>
<p>Name of the deployment should be <code>redis</code> using the <code>redis:alpine</code> image. It should have exactly <code>1</code> replica.</p>
<p>The container should request for <code>.2</code> CPU. It should use the label <code>app=redis</code>.</p>
<p>It should mount exactly 2 volumes.</p>
<p>a. An Empty directory volume called <code>data</code> at path <code>/redis-master-data</code>.</p>
<p>b. A configmap volume called <code>redis-config</code> at path <code>/redis-master</code>.</p>
<p>c. The container should expose the port <code>6379</code>.</p>
<p>The configmap has already been created.</p>
<h5 id="answer-4">Answer</h5>
<p>Solution manifest file to create a deployment <code>redis</code> as follows:-</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">redis:alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/redis-master-data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/redis-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redis-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.2&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="lightning-lab-2">Lightning Lab 2</h3>
<h4 id="1-1">1.</h4>
<p>We have deployed a few pods in this cluster in various namespaces. Inspect them and identify the pod which is not in a <code>Ready</code> state. Troubleshoot and fix the issue.</p>
<p>Next, add a check to restart the container on the same pod if the command <code>ls /var/www/html/file_check</code> fails. This check should start after a delay of <code>10 seconds</code> and run <code>every 60 seconds</code>.</p>
<p>You may delete and recreate the object. Ignore the warnings from the probe.</p>
<h5 id="solution">Solution</h5>
<p>The pod <code>nginx1401</code> is not in a <code>Ready</code> state as the <code>Readiness Probe</code> has failed. Here is the solution YAML file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx1401</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev1401</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kodekloud/nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9080</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">ls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">/var/www/html/file_check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-1">2</h4>
<h5 id="task">Task</h5>
<p>Create a cronjob called <code>dice</code> that runs every <code>one minute</code>. Use the Pod template located at <code>/root/throw-a-dice</code>. The image <code>throw-dice</code> randomly returns a value between 1 and 6. The result of 6 is considered <code>success</code> and all others are <code>failure</code>.</p>
<p>The job should be <code>non-parallel</code> and complete the task <code>once</code>. Use a <code>backoffLimit</code> of <code>25</code>.</p>
<p>If the task is not completed within <code>20 seconds</code> the job should fail and pods should be terminated.</p>
<p>You don&rsquo;t have to wait for the job completion. As long as the cronjob has been created as per the requirements.</p>
<h5 id="solution-1">Solution</h5>
<p>Use the following YAML file to create the cronjob:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*/1 * * * *&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="w"> </span><span class="c"># This is so the job does not quit before it succeeds.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kodekloud/throw-dice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-1">3</h4>
<p>Create a pod called <code>my-busybox</code> in the <code>dev2406</code> namespace using the <code>busybox</code> image. The container should be called <code>secret</code> and should sleep for <code>3600</code> seconds.</p>
<p>The container should mount a <code>read-only</code> secret volume called <code>secret-volume</code> at the path <code>/etc/secret-volume</code>. The secret being mounted has already been created for you and is called <code>dotfile-secret</code>.</p>
<p>Make sure that the pod is scheduled on <code>controlplane</code> and no other node in the cluster.</p>
<h5 id="solution-2">Solution</h5>
<p>Use the following YAML file to create the pod:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev2406</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">dotfile-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">                   </span><span class="c"># 第三次了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/hostname</span><span class="p">:</span><span class="w"> </span><span class="l">controlplane</span><span class="w"> </span><span class="c"># 少這兩行啦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">sleep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;3600&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/secret-volume&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-1">4</h4>
<p>Create a single ingress resource called <code>ingress-vh-routing</code>. The resource should route HTTP traffic to multiple hostnames as specified below:</p>
<ol>
<li>The service <code>video-service</code> should be accessible on <code>http://watch.ecom-store.com:30093/video</code></li>
<li>The service <code>apparels-service</code> should be accessible on <code>http://apparels.ecom-store.com:30093/wear</code></li>
</ol>
<p>To ensure that the path is correctly rewritten for the backend service, add the following <code>annotation</code> to the resource:</p>
<pre tabindex="0"><code>nginx.ingress.kubernetes.io/rewrite-target: /
</code></pre><p>Here <code>30093</code> is the port used by the <code>Ingress Controller</code></p>
<h5 id="solution-passed-1st-attempt">Solution [passed 1st attempt]</h5>
<h4 id="5-1">5</h4>
<p>A pod called <code>dev-pod-dind-878516</code> has been deployed in the default namespace. Inspect the logs for the container called <code>log-x</code> and redirect the warnings to <code>/opt/dind-878516_logs.txt</code> on the <code>controlplane</code> node</p>
<h5 id="solution-3">Solution</h5>
<h3 id="180-mock-exam-1">180. Mock Exam 1</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k run nginx-448839 --image<span class="o">=</span>nginx:alpine
</span></span><span class="line"><span class="cl">k create ns
</span></span><span class="line"><span class="cl">k create deploy httpd-frontend --image<span class="o">=</span>http:2.4-alpine --replicas<span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">k run messaging --image<span class="o">=</span>redis:alpine -l <span class="nv">tier</span><span class="o">=</span>msg <span class="c1"># set a label</span>
</span></span><span class="line"><span class="cl">k get rs
</span></span><span class="line"><span class="cl">k describe rs rs-d33393
</span></span><span class="line"><span class="cl"><span class="c1"># modify typo of the container image</span>
</span></span><span class="line"><span class="cl">k edit rs rs-d33393
</span></span><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k get po --show-labels <span class="c1"># see if they have the same label</span>
</span></span><span class="line"><span class="cl">k delete po -l <span class="nv">name</span><span class="o">=</span>busybox-pod
</span></span><span class="line"><span class="cl">k get rs
</span></span><span class="line"><span class="cl">k expose deploy redis --port<span class="o">=</span><span class="m">6379</span> --name messaging-service --namespace marketing
</span></span><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k describe po webapp-color <span class="c1"># check environment variable</span>
</span></span><span class="line"><span class="cl">k get po webapp-color -o yaml &gt; webapp-color.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># search for env and change value to green</span>
</span></span><span class="line"><span class="cl">k replace --force -f webapp-color.yaml 
</span></span><span class="line"><span class="cl">k create cm cm-3392845 --from-literal<span class="o">=</span><span class="nv">DB_NAME</span><span class="o">=</span>SQL3322 --from-literal<span class="o">=</span><span class="nv">DB_PORT</span><span class="o">=</span><span class="m">3306</span>
</span></span><span class="line"><span class="cl">k describe cm cm-3392845
</span></span><span class="line"><span class="cl">k create secret generic db-secret-xxdf --from-literal<span class="o">=</span><span class="nv">DB_USER</span><span class="o">=</span>root --from-literal<span class="o">=</span><span class="nv">DB_PASSWORD</span><span class="o">=</span>passswrd
</span></span><span class="line"><span class="cl">k get po
</span></span><span class="line"><span class="cl">k get po app-sec-kff3345 -o yaml &gt; app-sec.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># search for securityContext under spec, add below</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  securityContest:
</span></span><span class="line"><span class="cl">    runAsUser: <span class="m">0</span>  
</span></span><span class="line"><span class="cl"><span class="c1"># add securityContext under spec.containers[0], add SYS_TIME</span>
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - image: ubuntu
</span></span><span class="line"><span class="cl">    securityContext:
</span></span><span class="line"><span class="cl">      capabilities:
</span></span><span class="line"><span class="cl">        add: <span class="o">[</span><span class="s2">&#34;SYS_TIME&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">k replace --force -f app-sec.yaml
</span></span><span class="line"><span class="cl">k get po -A
</span></span><span class="line"><span class="cl">k logs -n e-commerce e-com-1123 &gt; /opt/output/e-com-1123.log
</span></span><span class="line"><span class="cl">vi pv.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pv-analytics
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  capacity:
</span></span><span class="line"><span class="cl">    storage: 100Mi
</span></span><span class="line"><span class="cl">  accessModes:
</span></span><span class="line"><span class="cl">    - ReadWriteMany
</span></span><span class="line"><span class="cl">  hostPath:
</span></span><span class="line"><span class="cl">    path: /pv/data-analytics
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">k apply -f pv.yaml
</span></span><span class="line"><span class="cl">k create deploy --image redis:alpine --replicas <span class="m">1</span> -l --dry-run<span class="o">=</span>client -o yaml &gt; deploy.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># check content (label=app=redis)</span>
</span></span><span class="line"><span class="cl">k create -f deploy.yaml
</span></span><span class="line"><span class="cl">k expose deployment redis --name<span class="o">=</span>redis --port<span class="o">=</span><span class="m">6379</span> --targetPort<span class="o">=</span><span class="m">6379</span>
</span></span><span class="line"><span class="cl">vi netpol.yaml
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: NetworkPolicy
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: redis-access
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  podSelector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: redis
</span></span><span class="line"><span class="cl">  policyTypes:
</span></span><span class="line"><span class="cl">    - Ingress
</span></span><span class="line"><span class="cl">  ingress:
</span></span><span class="line"><span class="cl">    from:
</span></span><span class="line"><span class="cl">      podSelector:
</span></span><span class="line"><span class="cl">        matchLabels:
</span></span><span class="line"><span class="cl">          access: redis
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">      protocol: TCP
</span></span><span class="line"><span class="cl">      port: <span class="m">6379</span>
</span></span><span class="line"><span class="cl">k create -f netpol.yaml
</span></span><span class="line"><span class="cl">k run sega --image busybox --dry-run<span class="o">=</span>client -o yaml &gt; sega.yaml
</span></span><span class="line"><span class="cl">vi sega.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: sega
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">    - name: tails
</span></span><span class="line"><span class="cl">      image: busybox
</span></span><span class="line"><span class="cl">      command:
</span></span><span class="line"><span class="cl">        - sleep
</span></span><span class="line"><span class="cl">        - <span class="s2">&#34;3600&#34;</span>
</span></span><span class="line"><span class="cl">    - name: sonic
</span></span><span class="line"><span class="cl">      image: nginx
</span></span><span class="line"><span class="cl">      env:
</span></span><span class="line"><span class="cl">        - name: NGINX_PORT
</span></span><span class="line"><span class="cl">          value: <span class="s2">&#34;8080&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="182-mock-exam-2">182. Mock Exam 2</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">k create deploy my-webapp --image nginx --replicas <span class="m">2</span> --dry-run<span class="o">=</span>client -o yaml &gt; my-webapp.yaml
</span></span><span class="line"><span class="cl">k create -f my-webapp.yaml
</span></span><span class="line"><span class="cl">k get deployment
</span></span><span class="line"><span class="cl">k expose deployment my-webapp --name<span class="o">=</span>front-end-service --port<span class="o">=</span><span class="m">80</span> --type<span class="o">=</span>NodePort --dry-run<span class="o">=</span>client -o yaml &gt; my-webapp-nodeport.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># add spec.ports[0].nodePort: 30083</span>
</span></span><span class="line"><span class="cl">k apply -f my-webapp-nodeport.yaml
</span></span><span class="line"><span class="cl">k get svc
</span></span><span class="line"><span class="cl">k taint no node01 <span class="nv">app_type</span><span class="o">=</span>alpha:NoSchedule
</span></span><span class="line"><span class="cl">k describe no node01
</span></span><span class="line"><span class="cl">k run alpha --image redis --dry-run<span class="o">=</span>client -o yaml &gt; alpha.yaml
</span></span><span class="line"><span class="cl">vi alpha.yaml
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  tolerations:
</span></span><span class="line"><span class="cl">    - effect: NoSchedule
</span></span><span class="line"><span class="cl">      key: <span class="s2">&#34;app_type&#34;</span>
</span></span><span class="line"><span class="cl">      operator: <span class="s2">&#34;Equal&#34;</span>
</span></span><span class="line"><span class="cl">      value: <span class="s2">&#34;alpha&#34;</span>
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">k get po -o wide <span class="c1"># pod was deployed on node01</span>
</span></span><span class="line"><span class="cl">k label no controlplance <span class="nv">app_type</span><span class="o">=</span>beta
</span></span><span class="line"><span class="cl">k get no controlplane --show-labels
</span></span><span class="line"><span class="cl">k create deploy beta-app --image nginx --replicas <span class="m">3</span> --dry-run<span class="o">=</span>client -o yaml &gt; deploy.yaml
</span></span><span class="line"><span class="cl">vi deploy.yaml
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      affinity:
</span></span><span class="line"><span class="cl">        nodeAffinity:
</span></span><span class="line"><span class="cl">          requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">            nodeSelectorTerms:
</span></span><span class="line"><span class="cl">            - matchExpressions:
</span></span><span class="line"><span class="cl">              - key: app_type
</span></span><span class="line"><span class="cl">                operator: In
</span></span><span class="line"><span class="cl">                values: <span class="o">[</span><span class="s2">&#34;beta&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">k apply -f deploy.yaml
</span></span><span class="line"><span class="cl">k get po -o wide <span class="c1"># check all pods are deployed on controplane node</span>
</span></span><span class="line"><span class="cl">k get svc
</span></span><span class="line"><span class="cl">k create ing my-video --rule<span class="o">=</span><span class="s1">&#39;ckad-mock-exam-solution.com/video*=my-video-service:8080&#39;</span>
</span></span><span class="line"><span class="cl">k get ing
</span></span><span class="line"><span class="cl">k get po pod-with-rprobe -o yaml &gt; rprobe.yaml
</span></span><span class="line"><span class="cl">vi rprobe.yaml
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">spec: 
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - env:
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    readinessProbe:
</span></span><span class="line"><span class="cl">      httpGet:
</span></span><span class="line"><span class="cl">        path: /ready
</span></span><span class="line"><span class="cl">        port: <span class="m">8080</span>
</span></span><span class="line"><span class="cl">k replace --force -f rprobe.yaml
</span></span><span class="line"><span class="cl">k run nginx1401 -n default --image nginx --dry-run<span class="o">=</span>client -o yaml &gt; nginx1401.yaml
</span></span><span class="line"><span class="cl">vi nginx1401.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: nginx1401
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">    - name: nginx1401
</span></span><span class="line"><span class="cl">      image: nginx
</span></span><span class="line"><span class="cl">      livenessProbe:
</span></span><span class="line"><span class="cl">        exec:
</span></span><span class="line"><span class="cl">          command: <span class="o">[</span><span class="s2">&#34;ls /var/www/html/probe&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        initialDelaySeconds: <span class="m">10</span>
</span></span><span class="line"><span class="cl">        periodSeconds: <span class="m">60</span>
</span></span><span class="line"><span class="cl">k create -f nginx1401.yaml
</span></span><span class="line"><span class="cl">k create job whalesay --image docker/whalesay --dry-run<span class="o">=</span>client -o yaml &gt; whale.yaml
</span></span><span class="line"><span class="cl">vi whale.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># define completions, backoffLimit and container commands</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  completions: <span class="m">10</span>
</span></span><span class="line"><span class="cl">  backoffLimit: <span class="m">6</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - image: docker/whalesay
</span></span><span class="line"><span class="cl">      <span class="c1"># command:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - sh</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - -c</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - &#34;cowsay I am going to ace CKAD!&#34;</span>
</span></span><span class="line"><span class="cl">        command: <span class="o">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        args: <span class="o">[</span><span class="s2">&#34;-c&#34;</span>, <span class="s2">&#34;cowsay I am going to ace CKAD!&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">k get <span class="nb">jobs</span> <span class="c1"># check pods and wait till all jobs are completed</span>
</span></span><span class="line"><span class="cl">k run multi-pod --image nginx --dry-run<span class="o">=</span>client -o yaml &gt; multi.yaml
</span></span><span class="line"><span class="cl">vi multi.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">medatada:
</span></span><span class="line"><span class="cl">  name: multi-pod
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">    - name: jupitor
</span></span><span class="line"><span class="cl">      image: nginx
</span></span><span class="line"><span class="cl">      env:
</span></span><span class="line"><span class="cl">        - name: <span class="nb">type</span>
</span></span><span class="line"><span class="cl">          value: planet
</span></span><span class="line"><span class="cl">    - name: europa
</span></span><span class="line"><span class="cl">      image: busybox
</span></span><span class="line"><span class="cl">      command: <span class="o">[</span><span class="s2">&#34;/bin/sh&#34;</span>, <span class="s2">&#34;-c&#34;</span>, <span class="s2">&#34;sleep 4000&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">      env:
</span></span><span class="line"><span class="cl">        - name: <span class="nb">type</span>
</span></span><span class="line"><span class="cl">          value: moon
</span></span><span class="line"><span class="cl">vi pv.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: custom-volume
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  capacity:
</span></span><span class="line"><span class="cl">    storage: 50Mi
</span></span><span class="line"><span class="cl">  hostPath:
</span></span><span class="line"><span class="cl">    path: /opt/data
</span></span><span class="line"><span class="cl">  accessModes:
</span></span><span class="line"><span class="cl">    - ReadWriteMany
</span></span><span class="line"><span class="cl">  persistentVolumeReclaimPolicy: Retain
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="killer_sh_simulator_ckad">Killer_sh_simulator_ckad</h2>
<h3 id="question-1">Question 1</h3>
<p>The DevOps team would like to get the list of all Namespaces in the cluster. Get the list and save it to &ldquo;/opt/course/1/namespaces&rdquo; on &ldquo;ckad5601&rdquo;.</p>
<p>Keyword: <code>-o=jsonpath</code></p>
<h3 id="question-2">Question 2</h3>
<p>Create a single Pod of image httpd:2.4.41-alpine in Namespace default. The Pod should be named pod1 and the container should be named pod1-container.</p>
<p>Your manager would like to run a command manually on occasion to output the status of that exact Pod. Please write a command that does this into /opt/course/2/pod1-status-command.sh on ckad5601. The command should use kubectl.</p>
<p>Keyword:</p>
<h3 id="question-3">Question 3</h3>
<p>Team Neptune needs a Job template located at /opt/course/3/job.yaml. This Job should run image busybox:1.31.0 and execute sleep 2 &amp;&amp; echo done. It should be in namespace neptune, run a total of 3 times and should execute 2 runs in parallel.</p>
<p>Start the Job and check its history. Each pod created by the Job should have the label id: awesome-job. The job should be named neb-new-job and the container neb-new-job-container.</p>
<h3 id="question-4">Question 4</h3>
<p>Team Mercury asked you to perform some operations using Helm, all in Namespace mercury:</p>
<p>Delete release internal-issue-report-apiv1</p>
<p>Upgrade release internal-issue-report-apiv2 to any newer version of chart bitnami/nginx available Install a new release internal-issue-report-apache of chart bitnami/apache. The Deployment should have two replicas, set these via Helm-values during install</p>
<p>There seems to be a broken release, stuck in pending-install state. Find it and delete it</p>
<h3 id="question-5">Question 5</h3>
<p>Team Neptune has its own ServiceAccount named neptune-sa-v2 in Namespace neptune. A coworker needs the token from the Secret that belongs to that ServiceAccount. Write the base64 decoded token to file /opt/course/5/token on ckad7326.</p>
<h3 id="question-6">Question 6</h3>
<p>Create a single Pod named pod6 in Namespace default of image busybox:1.31.0. The Pod should have a readiness-probe executing cat /tmp/ready. It should initially wait 5 and periodically wait 10 seconds. This will set the container ready only if the file /tmp/ready exists.</p>
<p>The Pod should run the command touch /tmp/ready &amp;&amp; sleep 1d, which will create the necessary file to be ready and then idles. Create the Pod and confirm it starts.</p>
<h3 id="question-7">Question 7</h3>
<p>The board of Team Neptune decided to take over control of one e-commerce webserver from Team Saturn. The administrator who once setup this webserver is not part of the organisation any longer. All information you could get was that the e-commerce system is called my-happy-shop.</p>
<p>Search for the correct Pod in Namespace saturn and move it to Namespace neptune. It doesn&rsquo;t matter if you shut it down and spin it up again, it probably hasn&rsquo;t any customers anyways.</p>
<h3 id="question-8">Question 8</h3>
<p>There is an existing Deployment named api-new-c32 in Namespace neptune. A developer did make an update to the Deployment but the updated version never came online. Check the Deployment history and find a revision that works, then rollback to it. Could you tell Team Neptune what the error was so it doesn&rsquo;t happen again?</p>
<h3 id="question-9">Question 9</h3>
<p>In Namespace pluto there is single Pod named holy-api. It has been working okay for a while now but Team Pluto needs it to be more reliable.</p>
<p>Convert the Pod into a Deployment named holy-api with 3 replicas and delete the single Pod once done. The raw Pod template file is available at /opt/course/9/holy-api-pod.yaml.</p>
<p>In addition, the new Deployment should set allowPrivilegeEscalation: false and privileged: false for the security context on container level.</p>
<p>Please create the Deployment and save its yaml under /opt/course/9/holy-api-deployment.yaml.</p>
<h3 id="question-10">Question 10</h3>
<p>Team Pluto needs a new cluster internal Service. Create a ClusterIP Service named project-plt-6cc-svc in Namespace pluto. This Service should expose a single Pod named project-plt-6cc-api of image nginx:1.17.3-alpine, create that Pod as well. The Pod should be identified by label project: plt-6cc-api. The Service should use tcp port redirection of 3333:80.</p>
<p>Finally use for example curl from a temporary nginx:alpine Pod to get the response from the Service. Write the response into /opt/course/10/service_test.html on ckad9043. Also check if the logs of Pod project-plt-6cc-api show the request and write those into /opt/course/10/service_test.log on ckad9043.</p>
<h3 id="question-11">Question 11</h3>
<p>During the last monthly meeting you mentioned your strong expertise in container technology. Now the Build&amp;Release team of department Sun is in need of your insight knowledge. There are files to build a container image located at /opt/course/11/image. The container will run a Golang application which outputs information to stdout. You&rsquo;re asked to perform the following tasks:</p>
<p>NOTE: Make sure to run all commands as user candidate, for docker use sudo docker</p>
<ol>
<li>Change the Dockerfile. The value of the environment variable SUN_CIPHER_ID should be set to the hardcoded value 5b9c1065-e39d-4a43-a04a-e59bcea3e03f</li>
<li>Build the image using Docker, named registry.killer.sh:5000/sun-cipher, tagged as latest and v1-docker, push these to the registry</li>
<li>Build the image using Podman, named registry.killer.sh:5000/sun-cipher, tagged as v1-podman, push it to the registry</li>
<li>Run a container using Podman, which keeps running in the background, named sun-cipher using image registry.killer.sh:5000/sun-cipher:v1-podman.</li>
<li>Run the container from candidate@ckad9043 and not root@ckad9043 Write the logs your container sun-cipher produced into /opt/course/11/logs. Then write a list of all running Podman containers into /opt/course/11/containers on ckad9043</li>
</ol>
<h3 id="question-12">Question 12</h3>
<p>Create a new PersistentVolume named earth-project-earthflower-pv. It should have a capacity of 2Gi, accessMode ReadWriteOnce, hostPath /Volumes/Data and no storageClassName defined.</p>
<p>Next create a new PersistentVolumeClaim in Namespace earth named earth-project-earthflower-pvc . It should request 2Gi storage, accessMode ReadWriteOnce and should not define a storageClassName. The PVC should bound to the PV correctly.</p>
<p>Finally create a new Deployment project-earthflower in Namespace earth which mounts that volume at /tmp/project-data. The Pods of that Deployment should be of image httpd:2.4.41-alpine.</p>
<h3 id="question-13">Question 13</h3>
<p>Team Moonpie, which has the Namespace moon, needs more storage. Create a new PersistentVolumeClaim named moon-pvc-126 in that namespace. This claim should use a new StorageClass moon-retain with the provisioner set to moon-retainer and the reclaimPolicy set to Retain. The claim should request storage of 3Gi, an accessMode of ReadWriteOnce and should use the new StorageClass.</p>
<p>The provisioner moon-retainer will be created by another team, so it&rsquo;s expected that the PVC will not boot yet. Confirm this by writing the log message from the PVC into file /opt/course/13/pvc-126-reason.</p>
<h3 id="question-14">Question 14</h3>
<p>You need to make changes on an existing Pod in Namespace moon called secret-handler. Create a new Secret secret1 which contains user=test and pass=pwd. The Secret&rsquo;s content should be available in Pod secret-handler as environment variables SECRET1_USER and SECRET1_PASS. The yaml for Pod secret-handler is available at /opt/course/14/secret-handler.yaml.</p>
<p>There is existing yaml for another Secret at /opt/course/14/secret2.yaml, create this Secret and mount it inside the same Pod at /tmp/secret2. Your changes should be saved under /opt/course/14/secret-handler-new.yaml on ckad9043. Both Secrets should only be available in Namespace moon.</p>
<h3 id="question-15">Question 15</h3>
<p>Team Moonpie has a nginx server Deployment called &lsquo;web-moon&rsquo; in Namespace &lsquo;moon&rsquo;. Someone started configuring it but it was never completed. To complete please create a ConfigMap called &lsquo;configmap-web-moon-html&rsquo; containing the content of file &lsquo;/opt/course/15/web-moon.html&rsquo; under the data key-name index.html.</p>
<p>The Deployment &lsquo;web-moon&rsquo; is already configured to work with this ConfigMap and serve its content. Test the nginx configuration for example using curl from a temporary &rsquo;nginx:alpine&rsquo; Pod.</p>
<h3 id="question-16">Question 16</h3>
<p>The Tech Lead of Mercury2D decided it&rsquo;s time for more logging, to finally fight all these missing data incidents. There is an existing container named cleaner-con in Deployment cleaner in Namespace mercury. This container mounts a volume and writes logs into a file called cleaner.log.</p>
<p>The yaml for the existing Deployment is available at /opt/course/16/cleaner.yaml. Persist your changes at /opt/course/16/cleaner-new.yaml on ckad7326 but also make sure the Deployment is running.</p>
<p>Create a sidecar container named logger-con, image busybox:1.31.0 , which mounts the same volume and writes the content of cleaner.log to stdout, you can use the tail -f command for this. This way it can be picked up by kubectl logs.</p>
<p>Check if the logs of the new container reveal something about the missing data incidents.</p>
<h3 id="question-17">Question 17</h3>
<p>Last lunch you told your coworker from department Mars Inc how amazing InitContainers are. Now he would like to see one in action. There is a Deployment yaml at /opt/course/17/test-init-container.yaml. This Deployment spins up a single Pod of image nginx:1.17.3-alpine and serves files from a mounted volume, which is empty right now.</p>
<p>Create an InitContainer named init-con which also mounts that volume and creates a file index.html with content check this out! in the root of the mounted volume. For this test we ignore that it doesn&rsquo;t contain valid html.</p>
<p>The InitContainer should be using image busybox:1.31.0. Test your implementation for example using curl from a temporary nginx:alpine Pod.</p>
<h3 id="question-18">Question 18:</h3>
<p>There seems to be an issue in Namespace mars where the ClusterIP service manager-api-svc should make the Pods of Deployment manager-api-deployment available inside the cluster.</p>
<p>You can test this with curl manager-api-svc.mars:4444 from a temporary nginx:alpine Pod. Check for the misconfiguration and apply a fix.</p>
<h3 id="question-19">Question 19</h3>
<p>In Namespace jupiter you&rsquo;ll find an apache Deployment (with one replica) named jupiter-crew-deploy and a ClusterIP Service called jupiter-crew-svc which exposes it. Change this service to a NodePort one to make it available on all nodes on port 30100.</p>
<p>Test the NodePort Service using the internal IP of all available nodes and the port 30100 using curl, you can reach the internal node IPs directly from your main terminal. On which nodes is the Service reachable? On which node is the Pod running?</p>
<h3 id="question-20">Question 20</h3>
<p>In Namespace venus you&rsquo;ll find two Deployments named api and frontend. Both Deployments are exposed inside the cluster using Services. Create a NetworkPolicy named np1 which restricts outgoing tcp connections from Deployment frontend and only allows those going to Deployment api. Make sure the NetworkPolicy still allows outgoing traffic on UDP/TCP ports 53 for DNS resolution.</p>
<p>Test using: wget <a href="https://www.google.com" target="_blank" rel="noopener noreffer ">www.google.com</a> and wget api:2222 from a Pod of Deployment frontend.</p>
<h3 id="question-21">Question 21</h3>
<p>Team Neptune needs 3 Pods of image httpd:2.4-alpine, create a Deployment named neptune-10ab for this. The containers should be named neptune-pod-10ab. Each container should have a memory request of 20Mi and a memory limit of 50Mi.</p>
<p>Team Neptune has it&rsquo;s own ServiceAccount neptune-sa-v2 under which the Pods should run. The Deployment should be in Namespace neptune.</p>
<h3 id="question-22">Question 22</h3>
<p>Team Sunny needs to identify some of their Pods in namespace sun. They ask you to add a new label protected: true to all Pods with an existing label type: worker or type: runner. Also add an annotation protected: do not delete this pod to all Pods having the new label protected: true.</p>
<hr>
<h2 id="useful-links">Useful Links</h2>
<table>
<thead>
<tr>
<th>#</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreffer ">ConfigMaps</a></td>
</tr>
<tr>
<td>2</td>
<td><a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/" target="_blank" rel="noopener noreffer ">Resource Management for Pods  and Containers</a></td>
</tr>
<tr>
<td>3</td>
<td><a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreffer ">Secrets</a></td>
</tr>
<tr>
<td>4</td>
<td><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/" target="_blank" rel="noopener noreffer ">Assigning Pods to Nodes</a></td>
</tr>
<tr>
<td>5</td>
<td><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreffer ">Ingress</a></td>
</tr>
<tr>
<td>6</td>
<td><a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" target="_blank" rel="noopener noreffer ">Network Policies</a></td>
</tr>
<tr>
<td>7</td>
<td><a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreffer ">Service</a></td>
</tr>
<tr>
<td>8</td>
<td><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" target="_blank" rel="noopener noreffer ">Persistent Volumes</a></td>
</tr>
<tr>
<td>9</td>
<td><a href="https://kubernetes.io/docs/concepts/storage/volumes/" target="_blank" rel="noopener noreffer ">Volumes</a></td>
</tr>
<tr>
<td>10</td>
<td><a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/" target="_blank" rel="noopener noreffer ">CronJob</a></td>
</tr>
<tr>
<td>11</td>
<td><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreffer ">Deployments</a></td>
</tr>
<tr>
<td>12</td>
<td><a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/" target="_blank" rel="noopener noreffer ">Jobs</a></td>
</tr>
<tr>
<td>13</td>
<td><a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreffer ">Pods</a></td>
</tr>
<tr>
<td>14</td>
<td><a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener noreffer ">Init Containers</a></td>
</tr>
<tr>
<td>15</td>
<td><a href="https://kubernetes.io/docs/reference/kubectl/generated/kubectl_set/kubectl_set_image/" target="_blank" rel="noopener noreffer ">kubectl set image</a></td>
</tr>
<tr>
<td>16</td>
<td><a href="https://kubernetes.io/docs/reference/labels-annotations-taints/" target="_blank" rel="noopener noreffer ">Well-Known Labels, Annotations  and Taints</a></td>
</tr>
<tr>
<td>17</td>
<td><a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/" target="_blank" rel="noopener noreffer ">Assign CPU Resources to  Containers and Pods</a></td>
</tr>
<tr>
<td>18</td>
<td><a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/" target="_blank" rel="noopener noreffer ">Assign Pods to Nodes</a></td>
</tr>
<tr>
<td>19</td>
<td><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" target="_blank" rel="noopener noreffer ">Configure Liveness, Readiness  and Startup Probes</a></td>
</tr>
<tr>
<td>20</td>
<td><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/" target="_blank" rel="noopener noreffer ">Configure a Pod to Use a  PersistentVolume for Storage</a></td>
</tr>
<tr>
<td>21</td>
<td><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" target="_blank" rel="noopener noreffer ">Configure a Pod to Use a  ConfigMap</a></td>
</tr>
<tr>
<td>22</td>
<td><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-volume-storage/" target="_blank" rel="noopener noreffer ">Configure a Pod to Use a  Volume for Storage</a></td>
</tr>
<tr>
<td>23</td>
<td><a href="https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/" target="_blank" rel="noopener noreffer ">Define a Command and Arguments  for a Container</a></td>
</tr>
<tr>
<td>24</td>
<td><a href="https://kubernetes.io/docs/reference/kubectl/jsonpath/" target="_blank" rel="noopener noreffer ">https://kubernetes.io/docs/reference/kubectl/jsonpath/</a></td>
</tr>
<tr>
<td>25</td>
<td><a href="https://helm.sh/docs/helm/helm_uninstall/" target="_blank" rel="noopener noreffer ">https://helm.sh/docs/helm/helm_uninstall/</a></td>
</tr>
<tr>
<td></td>
<td><a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/" target="_blank" rel="noopener noreffer ">https://kubernetes.io/docs/concepts/security/pod-security-standards/</a></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>26</td>
<td><a href="https://www.reddit.com/r/kubernetes/comments/10qvm6u/my_vim_configuration_helps_you_reduce_pain_during/" target="_blank" rel="noopener noreffer ">On ~/.vimrc setting</a></td>
</tr>
<tr>
<td>27</td>
<td></td>
</tr>
</tbody>
</table>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-09-18</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://wysiwyz.github.io/posts/cncf-kubestronaut-03ckad/" data-hashtag="Cloud Native"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://wysiwyz.github.io/posts/cncf-kubestronaut-03ckad/" data-title="Kubestronaut 之路 (1/5) - CKAD 考照筆記"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/cloud-native/">Cloud Native</a>,&nbsp;<a href="/tags/kubernetes/">Kubernetes</a>,&nbsp;<a href="/tags/ckad/">CKAD</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cncf-kubestronaut/" class="prev" rel="prev" title="當不成 Astronaut, 試試 Kubestronaut"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>當不成 Astronaut, 試試 Kubestronaut</a>
            <a href="/posts/kong-hq-academy/" class="next" rel="next" title="Kong Academy 網關學習筆記">Kong Academy 網關學習筆記<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">strict with yourself; lenient with others.</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><script type="text/javascript" src="https://.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{"valine":{"appId":"","appKey":"","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"en","pageSize":10,"placeholder":"Your comment ...","recordIP":true,"visitor":true}},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-CCS3QPVY5N', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-CCS3QPVY5N" async></script></body>
</html>
