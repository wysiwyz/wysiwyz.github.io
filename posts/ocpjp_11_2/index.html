<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>1Z0-819 曾師筆記 (2/duology) - Ich bin yiwen.</title><meta name="Description" content="An ordinary space for storing and groups pieces of articles."><meta property="og:title" content="1Z0-819 曾師筆記 (2/duology)" />
<meta property="og:description" content="# 01 泛型和集合物件 泛型 Java 5 之後加入泛型，使型別使用多了另一種彈性。
集合物件（用來裝填物件）＋泛型，可以限制裝填物件的型別。
使用泛型的效益 提供更彈性的「型別安全 type safety」檢查機制，原本在執行時才能發現的型別錯誤，現在在編譯時期就可以預發現 在集合物件 Collections 裡大量使用，限制內涵物件之型別 減少轉型 casting 需要，使程式碼更簡潔 使用泛型設計類別 可以將程式碼裡的符號 T換成 String( 即 UseString())，或換成 Shirt (即 UseShirt()) 常見的符號及表示方式如下： T -「型別（type）」 E -「成員（element）」 K -「鍵 - 值對裡的鍵（key）」 V -「鍵 - 值對裡的值（value）」 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 class UseAny&lt;T&gt; { private T t; public void add(T t) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://wysiwyz.github.io/posts/ocpjp_11_2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-05T17:50:34+08:00" />
<meta property="article:modified_time" content="2023-02-05T17:50:34+08:00" /><meta property="og:site_name" content="Ich bin yiwen." />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="1Z0-819 曾師筆記 (2/duology)"/>
<meta name="twitter:description" content="# 01 泛型和集合物件 泛型 Java 5 之後加入泛型，使型別使用多了另一種彈性。
集合物件（用來裝填物件）＋泛型，可以限制裝填物件的型別。
使用泛型的效益 提供更彈性的「型別安全 type safety」檢查機制，原本在執行時才能發現的型別錯誤，現在在編譯時期就可以預發現 在集合物件 Collections 裡大量使用，限制內涵物件之型別 減少轉型 casting 需要，使程式碼更簡潔 使用泛型設計類別 可以將程式碼裡的符號 T換成 String( 即 UseString())，或換成 Shirt (即 UseShirt()) 常見的符號及表示方式如下： T -「型別（type）」 E -「成員（element）」 K -「鍵 - 值對裡的鍵（key）」 V -「鍵 - 值對裡的值（value）」 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 class UseAny&lt;T&gt; { private T t; public void add(T t) { this."/>
<meta name="application-name" content="Ich bin yiwen.">
<meta name="apple-mobile-web-app-title" content="Ich bin yiwen."><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/moon_icon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://wysiwyz.github.io/posts/ocpjp_11_2/" /><link rel="prev" href="http://wysiwyz.github.io/posts/encrypt_decrypt/" /><link rel="next" href="http://wysiwyz.github.io/posts/lesson_00_linux/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "1Z0-819 曾師筆記 (2/duology)",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/wysiwyz.github.io\/posts\/ocpjp_11_2\/"
        },"genre": "posts","keywords": "Java, 1Z0-819","wordcount":  19205 ,
        "url": "http:\/\/wysiwyz.github.io\/posts\/ocpjp_11_2\/","datePublished": "2023-02-05T17:50:34+08:00","dateModified": "2023-02-05T17:50:34+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "celine"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">1Z0-819 曾師筆記 (2/duology)</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>celine</a></span>&nbsp;<span class="post-category">included in <a href="/categories/studynote/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>StudyNote</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-02-05">2023-02-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;19205 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;91 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#泛型">泛型</a>
      <ul>
        <li><a href="#使用泛型的效益">使用泛型的效益</a></li>
        <li><a href="#使用泛型設計類別">使用泛型設計類別</a></li>
      </ul>
    </li>
    <li><a href="#集合物件">集合物件</a>
      <ul>
        <li><a href="#collection-定義與種類">Collection 定義與種類</a></li>
        <li><a href="#list">List</a></li>
        <li><a href="#arraylist--list-最常使用的一種實作類別"><code>ArrayList</code> : List 最常使用的一種實作類別</a></li>
        <li><a href="#自動裝箱-boxing和開箱-unboxing">自動裝箱 <code>Boxing</code>和開箱 <code>Unboxing</code></a></li>
        <li><a href="#set">Set</a></li>
        <li><a href="#deque-queue">Deque (Queue)</a></li>
      </ul>
    </li>
    <li><a href="#map">Map</a></li>
    <li><a href="#集合物件成員的排序">集合物件成員的排序</a>
      <ul>
        <li><a href="#排序作法">排序作法</a></li>
        <li><a href="#使用-comparable-介面排序">使用 <code>Comparable</code> 介面排序</a></li>
        <li><a href="#使用-comparator-介面排序">使用 <code>Comparator</code> 介面排序</a></li>
      </ul>
    </li>
    <li><a href="#使用-of-與-copyof-方法建立-listset-與-map-物件">使用 <code>of()</code> 與 <code>copyOf()</code> 方法建立 <code>List</code>、<code>Set</code> 與 <code>Map</code> 物件</a>
      <ul>
        <li><a href="#使用of方法建立-list-set-map-物件">使用<code>of()</code>方法建立 List, Set, Map 物件</a></li>
        <li><a href="#使用copyof方法建立-list-set-map-物件">使用<code>copyOf()</code>方法建立 List, Set, Map 物件</a></li>
        <li><a href="#使用-arraysaslist建立-list-物件">使用 <code>Arrays.asList()</code>建立 List 物件</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#例外">例外</a>
      <ul>
        <li><a href="#使用try-catch程式碼區塊">使用<code>try-catch</code>程式碼區塊</a></li>
        <li><a href="#使用-try-with-resources-程式碼區塊和-autocloseable-介面">使用 <code>try-with-resources</code> 程式碼區塊和 <code>AutoCloseable</code> 介面</a></li>
        <li><a href="#suppressed-exceptions">Suppressed Exceptions</a></li>
        <li><a href="#使用-multi-catch-敘述">使用 <code>multi-catch</code> 敘述</a></li>
        <li><a href="#使用-throws-宣告">使用 <code>throws</code> 宣告</a></li>
        <li><a href="#建立客製的-exception">建立客製的 <code>Exception</code></a></li>
      </ul>
    </li>
    <li><a href="#斷言">斷言</a>
      <ul>
        <li><a href="#assertions-的簡介和語法">Assertions 的簡介和語法</a></li>
        <li><a href="#assertions-的使用">Assertions 的使用</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#io-基礎">I/O 基礎</a>
      <ul>
        <li><a href="#何謂-io">何謂 I/O</a></li>
        <li><a href="#處理串流的類別">處理串流的類別</a></li>
        <li><a href="#串流類別的串接">串流類別的串接</a></li>
        <li><a href="#使用-javaiofile-類別">使用 <code>java.io.File</code> 類別</a></li>
      </ul>
    </li>
    <li><a href="#由主控台讀寫資料">由主控台讀寫資料</a>
      <ul>
        <li><a href="#主控台的-io">主控台的 I/O</a></li>
        <li><a href="#使用標準輸出方法">使用標準輸出方法</a></li>
        <li><a href="#javaioconsole-類別介紹"><code>java.io.Console</code> 類別介紹</a></li>
      </ul>
    </li>
    <li><a href="#channel-io">Channel I/O</a></li>
    <li><a href="#使用序列化技術讀寫物件">使用序列化技術讀寫物件</a>
      <ul>
        <li><a href="#java-裡的資料保存-persistence">Java 裡的資料保存 <em>Persistence</em></a></li>
        <li><a href="#序列化和物件圖譜">序列化和物件圖譜</a></li>
        <li><a href="#不需要參加序列化的欄位">不需要參加序列化的欄位</a></li>
        <li><a href="#定義物件保存的版本號碼">定義物件保存的版本號碼</a></li>
        <li><a href="#序列化和反序列化範例">序列化和反序列化範例</a></li>
        <li><a href="#3-serialization-and-de-serialization">3. Serialization and De-serialization</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#nio2-基礎"><code>NIO.2</code> 基礎</a>
      <ul>
        <li><a href="#javajofile限制"><code>java.jo.File</code>限制</a></li>
        <li><a href="#java-io-套件發展歷史">Java I/O 套件發展歷史</a></li>
        <li><a href="#檔案系統路徑和檔案">檔案系統、路徑和檔案</a></li>
        <li><a href="#symbolic-link-檔案">Symbolic Link 檔案</a></li>
        <li><a href="#nio2-的基本架構"><code>NIO.2</code> 的基本架構</a></li>
      </ul>
    </li>
    <li><a href="#使用-path-介面操作檔案目錄">使用 Path 介面操作檔案/目錄</a>
      <ul>
        <li><a href="#path-介面">Path 介面</a></li>
        <li><a href="#path-介面主要功能">Path 介面主要功能</a></li>
        <li><a href="#移除路徑裡的多餘組成">移除路徑裡的多餘組成</a></li>
        <li><a href="#建立子路徑---subpath">建立子路徑 - <code>subpath()</code></a></li>
        <li><a href="#結合-2-個路徑---resolve">結合 2 個路徑 - <code>resolve()</code></a></li>
        <li><a href="#建立連接-2-個路徑的路徑---relativize">建立連接 2 個路徑的路徑 - <code>relativize()</code></a></li>
        <li><a href="#hard-link">Hard Link</a></li>
        <li><a href="#處理-symbolic-link">處理 Symbolic Link</a></li>
      </ul>
    </li>
    <li><a href="#使用-files-類別對檔案目錄進行檢查刪除複製移動">使用 Files 類別對檔案/目錄進行檢查、刪除、複製、移動</a>
      <ul>
        <li><a href="#處理檔案">處理檔案</a></li>
        <li><a href="#檢查檔案--目錄是否存在">檢查檔案 / 目錄是否存在</a></li>
        <li><a href="#檢查檔案--目錄屬性">檢查檔案 / 目錄屬性</a></li>
        <li><a href="#建立檔案--目錄">建立檔案 / 目錄</a></li>
        <li><a href="#刪除檔案--目錄">刪除檔案 / 目錄</a></li>
        <li><a href="#複製和移動檔案--目錄">複製和移動檔案 / 目錄</a></li>
        <li><a href="#stream-和-path-互相複製">Stream 和 Path 互相複製</a></li>
        <li><a href="#列出目錄內容">列出目錄內容</a></li>
        <li><a href="#讀取和寫入檔案">讀取和寫入檔案</a></li>
      </ul>
    </li>
    <li><a href="#使用-files-類別操作-channel-io-和-stream-io-讀寫檔案">使用 Files 類別操作 Channel I/O 和 Stream I/O 讀寫檔案</a>
      <ul>
        <li><a href="#介面-channel-和類別-bytebuffer">介面 Channel 和類別 <code>ByteBuffer</code></a></li>
        <li><a href="#隨機存取檔案">隨機存取檔案</a></li>
        <li><a href="#對文字檔提供-buffered-io-方法">對文字檔提供 Buffered I/O 方法</a></li>
        <li><a href="#取得位元串流物件的方法">取得位元串流物件的方法</a></li>
      </ul>
    </li>
    <li><a href="#讀寫檔案目錄的屬性">讀寫檔案/目錄的屬性</a>
      <ul>
        <li><a href="#使用-files-管理檔案的屬性資料">使用 Files 管理檔案的屬性資料</a></li>
        <li><a href="#讀取檔案屬性">讀取檔案屬性</a></li>
        <li><a href="#修改檔案屬性">修改檔案屬性</a></li>
        <li><a href="#dos-之外的-file-attribute-views">DOS 之外的 File Attribute Views</a></li>
        <li><a href="#posix-檔案系統的權限"><code>POSIX</code> 檔案系統的權限</a></li>
      </ul>
    </li>
    <li><a href="#遞迴存取目錄結構">遞迴存取目錄結構</a>
      <ul>
        <li><a href="#對檔案目錄進行遞迴操作">對檔案目錄進行遞迴操作</a></li>
      </ul>
    </li>
    <li><a href="#使用-pathmatcher-類別找尋符合的檔案">使用 <code>PathMatcher</code> 類別找尋符合的檔案</a>
      <ul>
        <li><a href="#搜尋檔案">搜尋檔案</a></li>
        <li><a href="#glob-樣式語法介紹"><code>glob</code> 樣式語法介紹</a></li>
      </ul>
    </li>
    <li><a href="#其它">其它</a>
      <ul>
        <li><a href="#filestore-類別"><code>FileStore</code> 類別</a></li>
        <li><a href="#使用-watchservice">使用 <code>WatchService</code></a></li>
        <li><a href="#由基礎-io-轉換至-nio2">由基礎 I/O 轉換至 NIO.2</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#介紹">介紹</a>
      <ul>
        <li><a href="#名詞說明">名詞說明</a></li>
        <li><a href="#多執行緒的重要性">多執行緒的重要性</a></li>
        <li><a href="#執行緒類別">執行緒類別</a></li>
      </ul>
    </li>
    <li><a href="#執行緒常見問題">執行緒常見問題</a>
      <ul>
        <li><a href="#使用-shared-data-可能造成的問題">使用 <code>Shared Data</code> 可能造成的問題</a></li>
        <li><a href="#使用-non-atomic-functions-可能造成的問題">使用 <code>Non-Atomic Functions</code> 可能造成的問題</a></li>
        <li><a href="#使用-cached-data-可能造成的問題">使用 <code>Cached Data</code> 可能造成的問題</a></li>
      </ul>
    </li>
    <li><a href="#執行緒的-synchronized-與等待">執行緒的 synchronized 與等待</a>
      <ul>
        <li><a href="#使用-synchronized-關鍵字">使用 <code>synchronized</code> 關鍵字</a></li>
        <li><a href="#使用-synchronized-的時機">使用 <code>synchronized</code> 的時機</a></li>
        <li><a href="#縮小-synchronized-的程式區塊">縮小 synchronized 的程式區塊</a></li>
        <li><a href="#其它執行等待的情況">其它執行等待的情況</a></li>
      </ul>
    </li>
    <li><a href="#其它執行緒方法介紹">其它執行緒方法介紹</a>
      <ul>
        <li><a href="#使用-interrupt-方法">使用 <code>interrupt()</code> 方法</a></li>
        <li><a href="#使用-sleep-方法">使用 <code>sleep()</code> 方法</a></li>
        <li><a href="#使用其它方法">使用其它方法</a></li>
        <li><a href="#不建議使用的方法">不建議使用的方法</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#使用並行-api">使用並行 API</a>
      <ul>
        <li><a href="#並行-api-介紹">並行 API 介紹</a></li>
        <li><a href="#atomicinteger-類別"><code>AtomicInteger</code> 類別</a></li>
        <li><a href="#reentrantreadwritelock-類別"><code>ReentrantReadWriteLock</code> 類別</a></li>
        <li><a href="#執行緒安全的集合物件">執行緒安全的集合物件</a></li>
        <li><a href="#常用的同步器工具類別">常用的同步器工具類別</a></li>
      </ul>
    </li>
    <li><a href="#使用-executorservice-介面同時執行多樣工作">使用 <code>ExecutorService</code> 介面同時執行多樣工作</a>
      <ul>
        <li><a href="#使用更高階的多執行緒執行方案">使用更高階的多執行緒執行方案</a></li>
        <li><a href="#executorservice概觀"><code>ExecutorService</code>概觀</a></li>
        <li><a href="#使用-javautilconcurrentcallable">使用 <code>java.util.concurrent.Callable</code></a></li>
        <li><a href="#使用-javautilconcurrentfuture">使用 <code>java.util.concurrent.Future</code></a></li>
        <li><a href="#關閉-executorservice">關閉 <code>ExecutorService</code></a></li>
        <li><a href="#executorservice完整範例"><code>ExecutorService</code>完整範例</a></li>
        <li><a href="#executorservice-進階範例"><code>ExecutorService</code> 進階範例</a></li>
      </ul>
    </li>
    <li><a href="#使用-fork-join-框架同時執行多樣工作">使用 Fork-Join 框架同時執行多樣工作</a>
      <ul>
        <li><a href="#平行處理的策略">平行處理的策略</a></li>
        <li><a href="#套用-fork-join-框架">套用 <code>Fork-Join</code> 框架</a></li>
        <li><a href="#fork-join-框架的使用建議"><code>Fork-Join</code> 框架的使用建議</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#了解-databasedbms-和-sql">了解 Database、DBMS 和 SQL</a>
      <ul>
        <li></li>
        <li><a href="#使用sql存取資料庫">使用<code>SQL</code>存取資料庫</a></li>
        <li><a href="#derby-資料庫介紹">Derby 資料庫介紹</a></li>
        <li><a href="#操作-derby-資料庫">操作 Derby 資料庫</a></li>
      </ul>
    </li>
    <li><a href="#eclipse-連線並存取資料庫">Eclipse 連線並存取資料庫</a>
      <ul>
        <li><a href="#連線資料庫">連線資料庫</a></li>
        <li><a href="#存取資料表">存取資料表</a></li>
      </ul>
    </li>
    <li><a href="#使用-jdbc">使用 <code>JDBC</code></a>
      <ul>
        <li><a href="#jdbc-api--概觀"><code>JDBC API</code>  概觀</a></li>
        <li><a href="#專案引用資料庫驅動函式庫">專案引用資料庫驅動函式庫</a></li>
        <li><a href="#認識-jdbc-驅動函式庫-jar-的組成">認識 <code>JDBC</code> 驅動函式庫 JAR 的組成</a></li>
        <li><a href="#開發-jdbc-程式">開發 JDBC 程式</a></li>
        <li><a href="#結束-jdbc-相關物件的使用">結束 <code>JDBC</code> 相關物件的使用</a></li>
        <li><a href="#開發可攜式的-jdbc-程式碼">開發可攜式的 <code>JDBC</code> 程式碼</a></li>
        <li><a href="#使用-javasqlsqlexception-類別">使用 <code>java.sql.SQLException</code> 類別</a></li>
        <li><a href="#statement-介面與-sql-敘述的執行">Statement 介面與 <code>SQL</code> 敘述的執行</a></li>
        <li><a href="#使用-resultsetmetadata-介面">使用 <code>ResultSetMetaData</code> 介面</a></li>
        <li><a href="#取得查詢結果的資料筆數">取得查詢結果的資料筆數</a></li>
        <li><a href="#控制-resultset-每次由資料庫取回的筆數">控制 <code>ResultSet</code> 每次由資料庫取回的筆數</a></li>
        <li><a href="#使用-preparedstatement">使用 <code>PreparedStatement</code></a></li>
      </ul>
    </li>
    <li><a href="#使用-jdbc-進行交易">使用 <code>JDBC</code> 進行交易</a>
      <ul>
        <li><a href="#何謂資料庫交易">何謂資料庫交易</a></li>
        <li><a href="#使用-jdbc-的交易">使用 JDBC 的交易</a></li>
      </ul>
    </li>
    <li><a href="#使用-jdbc-41-的-rowsetprovider-和-rowsetfactory">使用 JDBC 4.1 的 RowSetProvider 和 RowSetFactory</a>
      <ul>
        <li><a href="#jdbcrowset介面示範"><code>JdbcRowSet</code>介面示範</a></li>
      </ul>
    </li>
    <li><a href="#回顧-dao-設計模式">回顧 DAO 設計模式</a></li>
  </ul>

  <ul>
    <li><a href="#了解-java-的軟體區域化作法">了解 Java 的軟體區域化作法</a>
      <ul>
        <li><a href="#使用-locale-類別">使用 Locale 類別</a></li>
        <li><a href="#建立多國語系文字檔">建立多國語系文字檔</a></li>
        <li><a href="#使用-resourcebundle-類別">使用 <code>ResourceBundle</code> 類別</a></li>
      </ul>
    </li>
    <li><a href="#使用-dateformat-類別提供日期的區域化顯示">使用 <code>DateFormat</code> 類別提供日期的區域化顯示</a>
      <ul>
        <li><a href="#日期格式選項">日期格式選項</a></li>
      </ul>
    </li>
    <li><a href="#使用-numberformat-類別提供幣別區域化顯示">使用 <code>NumberFormat</code> 類別提供幣別區域化顯示</a></li>
  </ul>

  <ul>
    <li><a href="#使用-lambda-表示式">使用 Lambda 表示式</a>
      <ul>
        <li><a href="#匿名類別與功能性介面回顧">匿名類別與功能性介面回顧</a></li>
        <li><a href="#lambda-表示式語法回顧">Lambda 表示式語法回顧</a></li>
      </ul>
    </li>
    <li><a href="#使用內建的功能性介面">使用內建的功能性介面</a>
      <ul>
        <li><a href="#評斷型功能性介面-predicate">評斷型功能性介面 Predicate</a></li>
        <li><a href="#消費型功能性介面-consumer">消費型功能性介面 Consumer</a></li>
        <li><a href="#功能型功能性介面-function">功能型功能性介面 Function</a></li>
        <li><a href="#供應型功能介面-supplier">供應型功能介面 Supplier</a></li>
      </ul>
    </li>
    <li><a href="#在泛型內使用萬用字元">在泛型內使用萬用字元</a>
      <ul>
        <li><a href="#在泛型裡使用多型">在泛型裡使用多型</a></li>
        <li><a href="#存取使用--的泛型的集合物件">存取使用 <code>&lt;?&gt;</code> 的泛型的集合物件</a></li>
      </ul>
    </li>
    <li><a href="#使用其它內建功能性介面">使用其它內建功能性介面</a>
      <ul>
        <li></li>
        <li><a href="#基於4個基礎功能性介面的基本型別變形版">基於4個基礎功能性介面的基本型別變形版</a></li>
        <li><a href="#基於-binary二運算元相關以及其基本型別變形版">基於 Binary（二運算元相關）以及其基本型別變形版</a></li>
        <li><a href="#基於-unary單運算元相關及其基本型別變形版">基於 Unary（單運算元相關）及其基本型別變形版</a></li>
      </ul>
    </li>
    <li><a href="#使用方法參照">使用方法參照</a>
      <ul>
        <li></li>
        <li><a href="#方法參照---使用類別方法">方法參照 - 使用類別方法</a></li>
        <li><a href="#方法參照---使用物件方法且物件參考來自-lambda-表示式之外">方法參照 - 使用物件方法，且物件參考來自 Lambda 表示式之外</a></li>
        <li><a href="#方法參照---使用物件方法且物件參考來自-lambda-表示式之內">方法參照 - 使用物件方法，且物件參考來自 Lambda 表示式之內</a></li>
        <li><a href="#使用-new-呼叫建構子且建構子不帶參數">使用 new 呼叫建構子，且建構子不帶參數</a></li>
        <li><a href="#使用-new-呼叫建構子且建構子帶少量參數">使用 new 呼叫建構子且建構子帶少量參數</a></li>
        <li><a href="#使用-new-呼叫建構子且建構子帶多參數">使用 new 呼叫建構子且建構子帶多參數</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#建構者設計模式和方法鏈結">建構者設計模式和方法鏈結</a></li>
    <li><a href="#使用-optional-類別">使用 Optional 類別</a>
      <ul>
        <li><a href="#使用-null-造成的困擾">使用 null 造成的困擾</a></li>
        <li><a href="#類別-optional-的使用情境">類別 Optional 的使用情境</a></li>
        <li><a href="#類別-optional-的常用方法">類別 Optional 的常用方法</a></li>
      </ul>
    </li>
    <li><a href="#stream-api-介紹">Stream API 介紹</a>
      <ul>
        <li><a href="#介面-iterable-和-collection-的擴充">介面 Iterable 和 Collection 的擴充</a></li>
        <li><a href="#stream-api">Stream API</a></li>
      </ul>
    </li>
    <li><a href="#stream-api-操作">Stream API 操作</a>
      <ul>
        <li><a href="#中間作業">中間作業</a></li>
        <li><a href="#終端作業">終端作業</a></li>
        <li><a href="#終端作業-collect-與-collectors-api">終端作業 <code>collect()</code> 與 Collectors API</a></li>
        <li><a href="#短路型終端作業">短路型終端作業</a></li>
      </ul>
    </li>
    <li><a href="#stream-api-和-nio2">Stream API 和 NIO.2</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#stream-api-操作平行化">Stream API 操作平行化</a>
      <ul>
        <li><a href="#平行化的前提">平行化的前提</a></li>
        <li><a href="#平行化的作法">平行化的作法</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li></li>
        <li><a href="#reduction-操作">Reduction 操作</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#date--time-相關類別演進">Date &amp; Time 相關類別演進</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#當地日期與時間">當地日期與時間</a>
      <ul>
        <li><a href="#類別-localdate">類別 <code>LocalDate</code></a></li>
        <li><a href="#類別-localtime">類別 <code>LocalTime</code></a></li>
        <li><a href="#類別-localdatetime">類別 <code>LocalDateTime</code></a></li>
      </ul>
    </li>
    <li><a href="#時區和日光節約時間">時區和日光節約時間</a></li>
    <li><a href="#描述日期與時間的數量">描述日期與時間的數量</a>
      <ul>
        <li><a href="#時區和日光節約時間簡介">時區和日光節約時間簡介</a></li>
        <li><a href="#java-在時區和日光節約時間的應用">Java 在時區和日光節約時間的應用</a></li>
      </ul>
    </li>
    <li><a href="#描述日期與時間的數量-1">描述日期與時間的數量</a>
      <ul>
        <li><a href="#類別-instant">類別 Instant</a></li>
        <li><a href="#類別-period-和-duration">類別 Period 和 Duration</a></li>
        <li><a href="#使用流暢fluent的程式風格">使用流暢（fluent）的程式風格</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#認識標註型別">認識標註型別</a></li>
    <li><a href="#建立自定義標註型別">建立自定義標註型別</a></li>
    <li><a href="#標註型別的應用">標註型別的應用</a></li>
    <li><a href="#自定義標註型別時使用的內建標註型別">自定義標註型別時使用的內建標註型別</a></li>
    <li><a href="#開發一般程式碼經常使用的內建標註型別">開發一般程式碼經常使用的內建標註型別</a></li>
  </ul>

  <ul>
    <li><a href="#認識-java-模組化">認識 Java 模組化</a></li>
    <li><a href="#建立和執行模組化程式">建立和執行模組化程式</a></li>
    <li><a href="#建立相依模組程式">建立相依模組程式</a></li>
    <li><a href="#認識-module-infojava-的宣告關鍵字">認識 <code>module-info.java</code> 的宣告關鍵字</a></li>
    <li><a href="#在命令列-command-line-使用模組指令選項">在命令列 <code>command line</code> 使用模組指令選項</a></li>
  </ul>

  <ul>
    <li><a href="#回顧模組指令">回顧模組指令</a></li>
    <li><a href="#比較模組類型">比較模組類型</a></li>
    <li><a href="#分析-jdk-依賴關係">分析 JDK 依賴關係</a></li>
    <li><a href="#模組化既有應用程式">模組化既有應用程式</a></li>
    <li><a href="#模組化-java-服務結構">模組化 Java 服務結構</a></li>
  </ul>

  <ul>
    <li><a href="#設計安全物件">設計安全物件</a></li>
    <li><a href="#注入-injection-攻擊與輸入-input-驗證">注入 <em>injection</em> 攻擊與輸入 <em>input</em> 驗證</a></li>
    <li><a href="#處理機敏資訊">處理機敏資訊</a></li>
    <li><a href="#序列化與反序列化物件">序列化與反序列化物件</a></li>
    <li><a href="#建立保護機敏資料的安全物件">建立保護機敏資料的安全物件</a></li>
    <li><a href="#避免服務阻斷-denial-of-service-攻擊">避免服務阻斷 <em>denial of service</em> 攻擊</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><pre><code># 01 泛型和集合物件
</code></pre>
<h2 id="泛型">泛型</h2>
<p>Java 5 之後加入泛型，使型別使用多了另一種彈性。</p>
<p>集合物件（用來裝填物件）＋泛型，可以限制裝填物件的型別。</p>
<h3 id="使用泛型的效益">使用泛型的效益</h3>
<ol>
<li>提供更彈性的「型別安全 type safety」檢查機制，原本在執行時才能發現的型別錯誤，現在在編譯時期就可以預發現</li>
<li>在集合物件 Collections 裡大量使用，限制內涵物件之型別</li>
<li>減少轉型 casting 需要，使程式碼更簡潔</li>
</ol>
<h3 id="使用泛型設計類別">使用泛型設計類別</h3>
<ul>
<li>可以將程式碼裡的符號 <code>T</code>換成 <code>String</code>( 即 UseString())，或換成 <code>Shirt</code> (即 UseShirt())</li>
<li>常見的符號及表示方式如下：
<ol>
<li><strong>T</strong> -「型別（type）」</li>
<li><strong>E</strong> -「成員（element）」</li>
<li><strong>K</strong> -「鍵 - 值對裡的鍵（key）」</li>
<li><strong>V</strong> -「鍵 - 值對裡的值（value）」</li>
</ol>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">UseAny</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">T</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">UseString</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">UseShirt</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Shirt</span> <span class="n">shirt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Shirt</span> <span class="n">shirt</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">shirt</span> <span class="o">=</span> <span class="n">shirt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Shirt</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">shirt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Java 7 開始，取消「參考型別」和「建構子」都必須在&lt;&gt;符號內加上置換型別的規定，因為等號右側可以由前者推斷（inference）而知其型別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">UseAny</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">shirt2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UseAny</span><span class="o">&lt;</span><span class="n">Shirt</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">UseAny</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">msg2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UseAny</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// see below for simplified code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UseAny</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">shirt2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UseAny</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">UseAny</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">msg2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UseAny</span><span class="o">&lt;&gt;();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="集合物件">集合物件</h2>
<h3 id="collection-定義與種類">Collection 定義與種類</h3>
<p>集合物件 <em>Collection</em> 相較陣列具備更多管理功能：</p>
<ol>
<li>以 interface Collection 為代表</li>
<li>集合內物件 <code>elements</code>，簡寫為 <code>E</code></li>
<li>集合內物件必須為參考型別或基本型別的包裹類別 <em>wrapper class</em></li>
<li>有多種常見資料結構，例如 <code>stack</code>、<code>queue</code>、<code>dynamic array</code> 等</li>
<li>大量使用泛型 <code>generic</code></li>
<li>都屬於 <code>java.util.*</code> package</li>
<li>interface Collection 繼承了 interface Iterable，因此所有集合物件都具備使用 Iterator (疊代器) 的能力</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/Dm02pU2.png"
        data-srcset="https://i.imgur.com/Dm02pU2.png, https://i.imgur.com/Dm02pU2.png 1.5x, https://i.imgur.com/Dm02pU2.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/Dm02pU2.png"
        title="image-20221214143907275" /></p>
<h3 id="list">List</h3>
<p>集合物件底下最常使用的介面，具備 index 能依照放入先後區分順序 <em>order</em></p>
<ol>
<li>新增 element，使用 index 指定插入位置</li>
<li>新增 element，直接加到尾端</li>
<li>取得 element index</li>
<li>使用 index 移除或覆寫成員</li>
<li>取得 List 長度</li>
</ol>
<h3 id="arraylist--list-最常使用的一種實作類別"><code>ArrayList</code> : List 最常使用的一種實作類別</h3>
<ul>
<li>特色：
<ol>
<li>行為和陣列 <em>array</em> 相近，但長度可以自動成長，又稱為「動態陣列」(dynamic array)</li>
<li>使用 index 新增 / 存取 / 修改 element</li>
<li>可以用 index 區分，所以允許重複成員</li>
</ol>
</li>
<li>未搭配泛型設計的 List
<ol>
<li>使用 Iterator 取出的物件必須轉型</li>
<li>錯放成員時，在執行時期才能知道 (e.g. add Integer, add Integer, and then add String)</li>
</ol>
</li>
</ul>
<h3 id="自動裝箱-boxing和開箱-unboxing">自動裝箱 <code>Boxing</code>和開箱 <code>Unboxing</code></h3>
<ol>
<li>
<p>Primitive → Wrapper Class : 把基本型別裝箱 <em>Boxing</em></p>
</li>
<li>
<p>Wrapper Class → Primitive : 將基本型別由包裹類別的箱子裡取出，開箱 <em>Unboxing</em></p>
</li>
<li>
<p>在迴圈內使用 boxing / unboxing 會讓效能耗損增幅</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Integer</span> <span class="n">partNumObj</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">partNum</span> <span class="o">=</span> <span class="n">partNumObj</span><span class="o">.</span><span class="na">intValue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// see below for concised code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">partNum</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="set">Set</h3>
<ol>
<li>
<p>其成員 element 必須為獨一無二（unique），不能重複</p>
</li>
<li>
<p>沒有 index</p>
</li>
<li>
<p>若放入重複 element，不會出錯，但無效</p>
</li>
<li>
<p>常使用 <code>HashSet</code> 實作類別。<code>TreeSet</code> 類別會依物件特性自動排序</p>
</li>
<li>
<p>element 是否唯一，或是排序先後，取決於方法 <code>equals()</code> 和 <code>hashCode()</code> 的覆寫結果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSet</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testHashSet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;uno&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;deux&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;trois&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;trois&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;item: &#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// only prints &#34;trois&#34; once
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="nf">testTreeSet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;uno&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;deux&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;trois&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;trois&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;turban&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;item: &#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// only prints &#34;trois&#34; once
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// print by String alphabetical order: d, tr-, tu-, u
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="deque-queue">Deque (Queue)</h3>
<p>Interface Deque 繼承了介面 Queue，特色如下：</p>
<ol>
<li>
<p><strong>Double-Ended Queue</strong> : 具備兩端點的 Queue</p>
</li>
<li>
<p>可同時使用於 Stack 和 Queue 兩種資料結構，只要呼叫不同方法</p>
<ul>
<li>使用<code>add()</code>、<code>remove()</code>時：Deque 物件表現出 Queue 資料結構的行為 (FIFO)</li>
<li>使用<code>push()</code>、<code>pop()</code>時：Deque 物件表現出 Stack 資料結構的行為 (FILO)<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/U7FO4qK.png"
        data-srcset="https://i.imgur.com/U7FO4qK.png, https://i.imgur.com/U7FO4qK.png 1.5x, https://i.imgur.com/U7FO4qK.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/U7FO4qK.png"
        title="image-20221214161745531" /></li>
</ul>
</li>
<li>
<p><code>Deque&lt;String&gt; deque = new ArrayDeque&lt;&gt;(); </code></p>
</li>
</ol>
<h2 id="map">Map</h2>
<ul>
<li>
<p>Map 是 key - value 成對集合，但不屬於 Collection 集合物件家族</p>
<ol>
<li><strong>key 物件</strong> : 用來尋找 value 物件，每個 key 物件須為獨特而不重複的</li>
<li><strong>value 物件</strong> : 和 key 物件有關連性（associative）</li>
</ol>
</li>
<li>
<p>在其它語言中，Map 又稱「關聯性陣列 associative arrays」，key 可構成一陣列，value 可構成另一個陣列，兩陣列有著關聯性</p>
</li>
<li>
<p>Map 泛型 &lt;<code>K</code>, <code>V</code>&gt;</p>
</li>
<li>
<p>Map 基本用法</p>
<ul>
<li><code>map.values()</code> 取得 <code>Collection&lt;T of V&gt;</code></li>
<li><code>map.keySet()</code> 取得 <code>Set&lt;T of K&gt;</code> (因為 keys 不能重複，回傳 Set 而非 Collection)</li>
</ul>
</li>
<li>
<p>Map 並未繼承於 Collection interface，Map family 如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/talB7Y5.png"
        data-srcset="https://i.imgur.com/talB7Y5.png, https://i.imgur.com/talB7Y5.png 1.5x, https://i.imgur.com/talB7Y5.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/talB7Y5.png"
        title="image-20221214165500408" /></p>
</li>
<li>
<p>Map family 常用類別：</p>
<ol>
<li>
<p><strong>TreeMap</strong> : keys 自動依順序排序</p>
</li>
<li>
<p><strong>HashTable</strong> : <em>執行緒安全</em>，且 <em>keys 和 values 不允許為 null</em></p>
</li>
<li>
<p><strong>HashMap</strong> : <em><strong>非</strong>執行緒安全</em>，且 <em>keys 和 values <strong>可</strong>為 null</em></p>
<blockquote>
<p>執行緒安全 :</p>
<p>一個物件被一個執行緒使用和同時被多個執行緒使用時，行為或結果都一致，不會產生非預期結果</p>
</blockquote>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>LittleTips</strong> : <code>Set</code> 和 <code>Map</code> 兩者都有可以支援排序的分支</p>
<ol>
<li>支援排序的分支起源皆以 <code>Sorted</code> 作為前綴。例：<strong>Sorted</strong>Map 、 <strong>Sorted</strong>Set (interface)</li>
<li>實作類別都是以 <code>Tree</code> 為開頭。例：<strong>Tree</strong>Map 、 <strong>Tree</strong>Set</li>
</ol>
</blockquote>
<h2 id="集合物件成員的排序">集合物件成員的排序</h2>
<h3 id="排序作法">排序作法</h3>
<p>如何排序物件類別，如何定義順序，一個類別可以定義多個排序標準嗎？有以下兩個介面可選擇</p>
<ol>
<li>Comparable 介面 - 實作 <code>compareTo()</code> 方法</li>
<li>Comparator 介面 - 實作 <code>compare()</code> 方法</li>
</ol>
<p>兩種方法都回傳一個整數，表示比較結果：</p>
<ol>
<li>回傳整數 <code>= 0</code>：兩者相等</li>
<li>回傳整數 <code>&lt; 0</code>：表示「自己（this）」**小於（數值上）**或 <strong>先於（順序上）</strong>「方法參數物件」</li>
<li>回傳整數 <code>&gt; 0</code>：表示「自己（this）」**大於（數值上）**或 <strong>後於（順序上）</strong>「方法參數物件」</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Calendar</span> <span class="n">today</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Calendar</span> <span class="n">tomorrow</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">tomorrow</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Calendar</span><span class="o">.</span><span class="na">DATE</span><span class="o">,</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">today</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">tomorrow</span><span class="o">));</span>   <span class="c1">// 字串 today 先於 tomorrow，所以回傳-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;A&#34;</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="s">&#34;B&#34;</span><span class="o">));</span>          <span class="c1">// 字串&#34;A&#34;早於字串&#34;B&#34;，所以回傳-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">5</span><span class="o">).</span><span class="na">compareTo</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">6</span><span class="o">)));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-comparable-介面排序">使用 <code>Comparable</code> 介面排序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">T</span> <span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>特色：</p>
<ol>
<li>
<p>支援泛型設計</p>
</li>
<li>
<p>必須實作 <code>compareTo()</code> 方法，比較自己（this）和方法參數物件</p>
</li>
<li>
<p>一個 class 只能實作一次 Comparable 介面，所以只能提供單一方式排序，可用於 <code>TreeSet</code> 和 <code>TreeMap</code> 等實作類別，或需要物件之間比較的地方</p>
</li>
<li>
<p>決定該物件類別要以哪一個條件決定 Student 物件的排序先後，再讓該類別實作 Comparable 介面</p>
<ol>
<li>必須提供 <code>compareTo()</code> 方法的內容</li>
<li>只能提供一種排序選擇</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">implements</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">Student</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// use method delegation 方法委派 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">sortById</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">).</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sortByName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sortByScome</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">score</span><span class="o">).</span><span class="na">compareTO</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">score</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sortById</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="使用-comparator-介面排序">使用 <code>Comparator</code> 介面排序</h3>
<ul>
<li>
<p>實作 <code>Comparable</code> interface 的類別只有提供一次 <code>compareTo()</code> 方法內容的機會，故只有一種排序能力</p>
</li>
<li>
<p>使用 <code>Comparator</code> interface 則可以提供多種選擇</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Comparator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">T</span> <span class="n">o1</span><span class="o">,</span> <span class="n">T</span> <span class="n">o2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>特色：</p>
<ol>
<li>
<p>支援泛型設計</p>
</li>
<li>
<p>需實作 <code>compare()</code>，用以比較「第一個參數物件」和「第二個參數物件」</p>
</li>
<li>
<p>可藉由提供多種 Comparator 類別，達成多種排序方式。</p>
<ul>
<li>
<p>常用於搭配以下方法，以幫助 List 成員排序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">sort</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">NameSorter</span> <span class="kd">implements</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Student</span> <span class="n">s1</span><span class="o">,</span> <span class="n">Student</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s1</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ScoreSorter</span> <span class="kd">implements</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Student</span> <span class="n">s1</span><span class="o">,</span> <span class="n">Student</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="na">getScore</span><span class="o">()).</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getScore</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestComparator</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">showList</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">studentList</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">studentList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;index#&#34;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">studentList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">studentList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">studentList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&#34;Thomas&#34;</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">3</span><span class="o">.</span><span class="na">8</span><span class="o">));</span> 
</span></span><span class="line"><span class="cl">        <span class="n">studentList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">.</span><span class="na">9</span><span class="o">));</span> 
</span></span><span class="line"><span class="cl">        <span class="n">studentList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&#34;George&#34;</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">3</span><span class="o">.</span><span class="na">4</span><span class="o">));</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n------ Original ------&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">showList</span><span class="o">(</span><span class="n">studentList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n----- Sort by name -----&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">sortName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NameSorter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">studentList</span><span class="o">,</span> <span class="n">sortName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">showList</span><span class="o">(</span><span class="n">studentList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\n----- Sort by score -----&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">sortScore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScoreSorter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">studentList</span><span class="o">,</span> <span class="n">sortScore</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">showList</span><span class="o">(</span><span class="n">studentList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="使用-of-與-copyof-方法建立-listset-與-map-物件">使用 <code>of()</code> 與 <code>copyOf()</code> 方法建立 <code>List</code>、<code>Set</code> 與 <code>Map</code> 物件</h2>
<h3 id="使用of方法建立-list-set-map-物件">使用<code>of()</code>方法建立 List, Set, Map 物件</h3>
<ul>
<li>
<p>自 Java 9 開始，除了傳統使用 new 呼叫子類別建構子以建立 List, Set, Map 物件外</p>
<ul>
<li>
<p>導入靜態工廠方法 <code>of()</code> 來建立不可改變（immutable）的物件</p>
<ul>
<li>
<p><code>List.of()</code> | <code>Set.of()</code> | <code>Map.of()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">t1</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="o">...);</span>
</span></span><span class="line"><span class="cl"><span class="n">Set</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">t1</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="o">...);</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">key1</span><span class="o">,</span> <span class="n">value1</span><span class="o">,</span> <span class="n">key2</span><span class="o">,</span> <span class="n">value2</span><span class="o">,</span> <span class="o">...);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>line 5, 15, 26 : 以 <code>of()</code> 建立物件後，若再嘗試新增成員（<code>list.add(...)</code>、<code>set.add(...)</code>、<code>map.put(...)</code>），都會拋出 <em><strong>java.lang.UnsupportOperationException</strong></em></p>
</li>
<li>
<p>line 9, 19, 30 : 如果要將不可更改的物件轉換為可更改物件，可將其作為 <code>ArrayList</code>、<code>HashSet</code>、<code>HashMap</code> 等建構子的參數，重新建立可更改物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createImmutablesByOf</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// List.of()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;i1&#34;</span><span class="o">,</span> <span class="s">&#34;i2&#34;</span><span class="o">,</span> <span class="s">&#34;i3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">list1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;i4&#34;</span><span class="o">);</span> <span class="c1">// line 5 : UnsupportedException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">list1</span><span class="o">);</span>  <span class="c1">// line 9 : mutable w/ ArrayList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">list2</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;i4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Set.of()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">set1</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;i1&#34;</span><span class="o">,</span> <span class="s">&#34;i2&#34;</span><span class="o">,</span> <span class="s">&#34;i3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">set1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;i4&#34;</span><span class="o">);</span> <span class="c1">// line 15 : UnsupportedException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">set2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">set1</span><span class="o">);</span>  <span class="c1">// line 19 : mutable w/ HashSet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">set2</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;i4&#34;</span><span class="o">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Map.of()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Employee</span><span class="o">&gt;</span> <span class="n">map1</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;jim&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;jim&#34;</span><span class="o">),</span> <span class="s">&#34;duke&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;duke&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">map1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;bill&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;bill&#34;</span><span class="o">));</span> <span class="c1">// line 26 : UnsupportedException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Employee</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">map1</span><span class="o">);</span>  <span class="c1">// line 30 : mutable w/ HashMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;bill&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;bill&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="使用copyof方法建立-list-set-map-物件">使用<code>copyOf()</code>方法建立 List, Set, Map 物件</h3>
<ul>
<li>
<p>從 Java 10 開始，又導入另一個靜態工廠方法 <code>copyOf()</code>，可以建立「<strong>不可改變</strong>」的「<strong>副本物件</strong>」</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createImmutablesByCopyOf</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// List.copyOf()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;i1&#34;</span><span class="o">,</span> <span class="s">&#34;i2&#34;</span><span class="o">,</span> <span class="s">&#34;i3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">list1</span><span class="o">);</span>     <span class="c1">// immutable copy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">list2</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;i4&#34;</span><span class="o">);</span>     <span class="c1">// UnsupportedOperationException 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Set.copyOf()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">set1</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;i1&#34;</span><span class="o">,</span> <span class="s">&#34;i2&#34;</span><span class="o">,</span> <span class="s">&#34;i3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">set2</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">set1</span><span class="o">);</span>     <span class="c1">// immutable copy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">set2</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;i4&#34;</span><span class="o">);</span>     <span class="c1">// UnsupportedOperationException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Map.copyOf()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Employee</span><span class="o">&gt;</span> <span class="n">map1</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;jim&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;jim&#34;</span><span class="o">),</span> <span class="s">&#34;duke&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;duke&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Employee</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">map1</span><span class="o">);</span>     <span class="c1">// immutable copy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;bill&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Employee</span><span class="o">(</span><span class="s">&#34;bill&#34;</span><span class="o">));</span>     <span class="c1">// UnsupportedOperationException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="使用-arraysaslist建立-list-物件">使用 <code>Arrays.asList()</code>建立 List 物件</h3>
<p>List 另一種以「單個元素成員」作為參數建立 List 物件的方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">t1</span><span class="o">,</span> <span class="n">t2</span><span class="o">,</span> <span class="o">...);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>Arrays.asList()</code> 建立的 List 物件和陣列（Array）相似，特性：</p>
<ol>
<li>
<p>長度固定，不可以新增/刪除成員（參考 line 6）</p>
</li>
<li>
<p>可以修改成員（參考 line 4）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;i1&#34;</span><span class="o">,</span> <span class="s">&#34;i2&#34;</span><span class="o">,</span> <span class="s">&#34;i3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">list1</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="s">&#34;iil&#34;</span><span class="o">);</span>    <span class="c1">// line 4 : element updatable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">list1</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>        <span class="c1">// line 6 : removing or adding not permitted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">list1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">list2</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<hr>
<h1 id="02-例外與斷言">02 例外與斷言</h1>
<h2 id="例外">例外</h2>
<p>值得信賴的程式會優雅的處理例外狀況：</p>
<ol>
<li>處理目標是「exception（例外）」，非預期狀況</li>
<li>例外必須處理以建立可信賴的程式</li>
<li>發生原因可能是程式 bugs</li>
<li>發生原因可能是程式無法處理的狀況
<ul>
<li>資料庫無法連線</li>
<li>硬碟毀損</li>
</ul>
</li>
</ol>
<p>C語言發生錯誤的話，通常以<strong>回傳負值</strong>表示，例如 <code>int x = printf(&quot;hi&quot;)</code></p>
<p>Java 則在出現錯誤時，由 JVM 拋出例外物件，不同種類的例外，有不同處理方式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/BHInvNP.png"
        data-srcset="https://i.imgur.com/BHInvNP.png, https://i.imgur.com/BHInvNP.png 1.5x, https://i.imgur.com/BHInvNP.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/BHInvNP.png"
        title="image-20221215142633549" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/xYQBNxF.png"
        data-srcset="https://i.imgur.com/xYQBNxF.png, https://i.imgur.com/xYQBNxF.png 1.5x, https://i.imgur.com/xYQBNxF.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/xYQBNxF.png"
        title="image-20221215160311402" /></p>
<ul>
<li>當類別方法呼叫其他類別方法時，如果被呼叫的方法已宣告有拋出 <strong>checked exception</strong> 的風險，編譯器會要求呼叫者方法必須處理（handle）或是也宣告（declare）可能發生的問題：
<ol>
<li><strong>Handling Exception</strong>：表示必須有程式碼區塊來處理異常狀況，此時使用「try-catch」敘述</li>
<li><strong>Declaring Exception</strong>：在方法上註記執行可能出現的錯誤，提醒使用的方法必須處理，此時使用「throws」宣告</li>
</ol>
</li>
</ul>
<h3 id="使用try-catch程式碼區塊">使用<code>try-catch</code>程式碼區塊</h3>
<h4 id="一般例外狀況">一般例外狀況</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">tryCatchTest</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Opening a file...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&#34;lostFile.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;File is opened&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>catch</code>程式碼區塊必須傳入 <code>java.lang.Exception</code> 或 <code>java.lang.Throwable</code> 的子類別參考</p>
</li>
<li>
<p>其中<code>java.lang.Throwable</code> 是例外始祖，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>把 catch 當成一種方法，則後面的 () 代表要傳入的參數</p>
</li>
<li>
<p>傳入大分類的型別（父類別或介面）為多型的應用，但不適用於此，例外處理應該對症下藥</p>
</li>
<li>
<p>catch 方法只讓 Java 在程式遇到錯誤時呼叫 / 傳入例外物件</p>
</li>
<li>
<p>捕捉例外後：</p>
<ol>
<li>紀錄錯誤訊息</li>
<li>重試一次</li>
<li>嘗試其它替代方案</li>
<li>離開（return）或結束程式（exit）</li>
</ol>
</li>
</ul>
<h4 id="複雜例外狀況">複雜例外狀況</h4>
<ul>
<li>
<p>一個程式碼區塊 / 方法，必須同時處理多種可能的例外狀況：</p>
<ol>
<li>
<p>單一「try」搭配多個「catch」：例外子類別排序應該在父類別上面，避免所有例外一開始就被例外父類別（Exception, Throwable）攔截</p>
</li>
<li>
<p>捕捉（catch）物件 Exception 時，盡可能捕捉最特定（specific type）的例外子類別</p>
</li>
<li>
<p>Java Persistence API（JPA）例外大部分繼承 RuntimeException，屬 unchecked exception</p>
<ul>
<li>
<p>慣例上為不用處理的意外，但正式環境裡還是應該處理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryCatch</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Opening a file...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&#34;lostFile.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;File is opened&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="紀錄logging錯誤內容">紀錄（Logging）錯誤內容</h4>
<ul>
<li>正式環境中，應移除 <code>printStackTrace()</code> 或 <code>System.out.println(e.getMessage())</code>此類程式碼</li>
<li>執行錯誤時，應該寫入紀錄 / 日誌檔（log file），相關函式庫
<ol>
<li>Simple logging facade for Java SLF4J</li>
<li>Apache&rsquo;s Log4j</li>
<li>Built-in java.util logging framework</li>
</ol>
</li>
</ul>
<h4 id="使用finally敘述">使用<code>finally</code>敘述</h4>
<ul>
<li>
<p>使用外部資源，例如開啟檔案或連線資料庫，應該在不使用時關閉資源</p>
</li>
<li>
<p>如果在 try 區塊中關閉資源，可能因為執行錯誤而導致資源開了來不及關，此時可用 finally 敘述</p>
<ol>
<li>
<p>不管是 try 或者 catch 執行結束，都一定會進入 finally 程式碼區塊</p>
</li>
<li>
<p>有時在 finally 區的程式碼也可能出錯，因此需要巢狀 try-catch 區塊來處理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryCatchFinally</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Opening a file...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&#34;lostFile.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;File is opened&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>   <span class="c1">// try to close file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Failed to close file&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="使用-try-with-resources-程式碼區塊和-autocloseable-介面">使用 <code>try-with-resources</code> 程式碼區塊和 <code>AutoCloseable</code> 介面</h3>
<h4 id="使用-try-with-resources-敘述">使用 <code>try-with-resources</code> 敘述</h4>
<ul>
<li>
<p>Java 7 提供新的 <code>try-with-resources</code> 敘述，可自動關閉被開啟的「資源（resources）」</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">(</span> <span class="n">宣告並開啟資源</span> <span class="o">[;</span> <span class="n">宣告並開啟其它資源</span> <span class="o">...]</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 在 try 程式碼區塊之後，資源將自動關閉
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>這裡定義的資源，必須為實作 <code>java.lang.AutoCloseable</code> 介面的類別</p>
</li>
<li>
<p>如果要開多個資源，可以使用「<strong>;</strong>」做區隔</p>
</li>
<li>
<p>自動關閉的順序將和使用資源的開啟順序相反</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryWithResource</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Opening a file...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&#34;lostFile.txt&#34;</span><span class="o">))</span> <span class="o">{</span> <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;File is opened&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<p>比較 <code>tryCatchFinally</code> 與 <code>tryWithResource</code>，可以發現：</p>
<ol>
<li>移除 <code>finally</code> 程式碼區塊，如前範例行 16 - 23</li>
<li>使用 <code>try-with-resource</code> 宣告要開啟的資源</li>
</ol>
<h4 id="認識-autocloseable介面">認識 <code>AutoCloseable</code>介面</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">InputStream</span> <span class="kd">implements</span> <span class="n">Closeable</span> <span class="o">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Closeable</span> <span class="kd">extends</span> <span class="n">AutoCloseable</span> <span class="o">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>資源（resource）要藉由 `try-with-resources‵ 敘述開啟和自動關閉，必須實作以下兩者任一</p>
<ol>
<li>
<p>介面 <em>java.lang.AutoCloseable</em></p>
<ul>
<li>
<p>Java 7 新增</p>
</li>
<li>
<p>唯一的抽象方法 <code>close()</code> 會拋出 Exception 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AutoCloseable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>介面 <em>java.io.Closeable</em></p>
<ul>
<li>
<p>早期的 Java 版本就存在，在 Java 7 中修改使其繼承介面 <code>AutoCloseable</code></p>
</li>
<li>
<p>唯一的抽象方法 <code>close()</code> 會拋出 <code>IOException</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Closeable</span> <span class="kd">extends</span> <span class="n">AutoCloseable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
</li>
</ul>
<p><strong>Idempotent method</strong> - 即使重複執行多次，也不會有副作用（side effects）產生</p>
<ul>
<li>
<p><code>java.io.Closeable</code> 的 close() 方法必須滿足 idempotent 要求</p>
</li>
<li>
<p><code>java.lang.AutoCloseable</code> 並未一致要求實作之 close() 必須比照辦理</p>
<ul>
<li>
<p>即便如此仍應該要做到反覆執行多次都沒有副作用產生</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 若資源為關閉（以resource == null 判定）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">If</span> <span class="o">(</span><span class="n">resource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 關閉資源，並使 resource = null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="suppressed-exceptions">Suppressed Exceptions</h3>
<p>使用 try-with-resource 也衍伸出新的例外 exception 處理問題必須注意：</p>
<ol>
<li>Java 開啟資源時拋出例外，未成功開啟資源
<ul>
<li>程式碼直接跳到 catch 區，只拋出一個例外</li>
</ul>
</li>
<li>Java 成功開啟資源，但在 try 區拋出例外，在背景關閉資源時又拋出例外
<ul>
<li>共產生 2 個例外</li>
<li>catch 區必須同時接收 2 個例外物件 <strong>衍伸問題</strong></li>
</ul>
</li>
<li>Java 成功開啟資源，try 區塊內任務成功執行，但在關閉資源時出錯
<ul>
<li>和一般情況一樣，只拋出 1 個例外</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>當有兩個例外類別被先後拋出，Java會將 <strong>後發生，同時和關閉資源有關</strong> 的例外物件，隱匿/擠壓（suppressed）到「先發生、也是在 try 區塊造成」的例外物件裡，使其可被保留</p>
</li>
<li>
<p>Java 會將資源相關的例外隱匿 / 擠壓進程式碼的例外裡，只要知道如何將 suppressed 例外物件取出（參以下 line 3 ~ line 5）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">getSuppressed</span><span class="o">())</span> <span class="o">{</span>  <span class="c1">// line 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                        <span class="c1">// line 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>對例外物件呼叫 <code>e.getSuppressed()</code> 方法時，可回傳一個 Throwable 陣列</p>
<ul>
<li>在背景被擠壓 / 隱匿的例外，即使再多都能被保存並取出</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TryException</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">FinallyException</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SuppressedExceptions</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">before7</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">after7</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">before7</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">TryException</span><span class="o">();</span>   <span class="c1">// This is lost.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">FinallyException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before 7: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">after7</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Throwable</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// 保留第一個拋出的例外物件 TryException (1/2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">TryException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>  <span class="c1">// 保留第一個拋出的例外物件 TryException (2/2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">FinallyException</span> <span class="n">fe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FinallyException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">t</span><span class="o">.</span><span class="na">addSuppressed</span><span class="o">(</span><span class="n">fe</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">                    <span class="c1">// 將 finallyException 隱匿至 t, 再拋出 tryException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">throw</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="n">fe</span><span class="o">;</span> <span class="c1">// 若無 tryException, 單獨拋出 finallyException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after7: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">getSuppressed</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after7: &#34;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-multi-catch-敘述">使用 <code>multi-catch</code> 敘述</h3>
<p>不建議直接捕捉例外的父類別，如 Exception 或 Throwable，因為：</p>
<ol>
<li>每種意外的處理方式應該不同</li>
<li>要清楚知道究竟有多少個例外可能產生</li>
</ol>
<p>如果每種例外處理方式皆相同，則可以使用 Java 7 <code>multi-catch</code> 敘述，優點：</p>
<ol>
<li>可清楚知道究竟有多少例外可能拋出</li>
<li>多種例外，同一種方式處理，簡潔化程式碼</li>
<li><strong>不同例外以「|」區隔時，前後例外必須「沒有繼承關係」</strong>
<ul>
<li>例如 Exception class 不能和以 multi-catch 敘述聚集的例外類別放一起</li>
</ul>
</li>
</ol>
<h3 id="使用-throws-宣告">使用 <code>throws</code> 宣告</h3>
<ul>
<li>
<p>在類別方法上宣告 <code>throws ExceptionTypes</code>，讓呼叫該方法的 caller 處理</p>
</li>
<li>
<p>覆寫子類別方法時，若父類別方法宣告拋出例外</p>
<ol>
<li>
<p><strong>checked exception</strong>，子類別覆寫方法拋出的例外必須：</p>
<ul>
<li>例外型別必須相同，或者為其子類別（覆寫後有精進）</li>
<li>數量相同或更少（表示問題已被處理 improved）</li>
</ul>
</li>
<li>
<p><strong>unchecked exception</strong>：子類別覆寫方法時可不予理會，例如 <code>RuntimeException</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Father</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">fatherMethod1</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">fatherMethod2</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RuntimeException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">fatherMethod3</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Child</span> <span class="kd">extends</span> <span class="n">Father</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">fatherMethod1</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">FileNotFoundException</span> <span class="o">{</span>		
</span></span><span class="line"><span class="cl">	<span class="o">}</span>  <span class="c1">// FileNotFoundException 為 IOException 子類別，未超出 IOException 範圍
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">fatherMethod2</span><span class="o">()</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="c1">// 父類別 RuntimeException-UncheckException，子類別可以不處理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">fatherMethod3</span><span class="o">()</span> <span class="o">{</span>		
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="c1">// SQLException 在方法內使用 try-catch 敘述，妥善處理不再拋出例外
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="建立客製的-exception">建立客製的 <code>Exception</code></h3>
<h4 id="客製化的例外類別">客製化的例外類別</h4>
<p>建立客製化的例外子類別 DAOException，繼承 class Exception</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DAOException</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DAOException</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DAOException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>標準 Java 不會主動拋出客製化例外子類別，必須先捕捉標準的例外類別，再拋出客製化例外子類別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// some codes that might cause error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">DAOException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="客製化包裹例外類別wrapper-exception">客製化包裹例外類別（Wrapper Exception）</h4>
<ul>
<li>
<p>如果希望再拋出的客製化例外子類別也能保留最初被捕捉的例外類別訊息，可使用 wrapper 例外類別，將最初的例外類別包裹在客製例外類別中</p>
<ul>
<li>
<p>設計客製例外類別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DAOException</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DAOException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DAOException</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>將捕捉真實例外類別作為客製例外類別的建構子參數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// some codes might error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">DAOException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>getCause()</code> 方法取出被包裹的原始例外物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// some codes might cause error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DAOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Throwable</span> <span class="n">t</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用包裹例外型別提供解決範例</p>
<ol>
<li>
<p>先設計介面的抽象方法並宣告拋出 <code>DAOException</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="n">Employee</span> <span class="nf">findById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">DAOException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>File-based 的方法實作方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Employee</span> <span class="nf">findById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">DAOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">DAOException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>JDBC-based 的方法實作方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Employee</span> <span class="nf">findById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">DAOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getEmployeeFromDatabase</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">DAOException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="斷言">斷言</h2>
<h3 id="assertions-的簡介和語法">Assertions 的簡介和語法</h3>
<ul>
<li>斷言若失敗被認為是嚴重的問題，表示程式執行結果和預期有出入</li>
<li>程式會拋出 AssertionError 並中斷程式執行，AssertionError 為 unchecked exception。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Syntax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">assert</span> <span class="o">&lt;</span><span class="n">boolean_expression</span><span class="o">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="o">&lt;</span><span class="n">boolean_expression</span><span class="o">&gt;</span> <span class="o">:</span> <span class="o">&lt;</span><span class="n">detail_expression</span><span class="o">&gt;;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>&lt;boolean_expression&gt; 若為 false，將拋出 <code>AssertionError</code></li>
<li>&lt;detail_expression&gt; 為捕捉 <code>AssertionError</code> 後呼叫 <code>getMessage()</code> 方法回傳的子串</li>
</ol>
<h4 id="assertions-使用情境">Assertions 使用情境</h4>
<ul>
<li>使用 Assertions 來驗證假設和方法的不變量（不會改變的數值或結果，invariant），通常情況：
<ol>
<li>內部的不變量（internal invariants）</li>
<li>流程控管的不變量（control flow invariants）</li>
<li>事後的狀態和類別不變量（post-conditions &amp; class invariants）</li>
</ol>
</li>
</ul>
<h4 id="assertions-的使用注意事項">Assertions 的使用注意事項</h4>
<ul>
<li>
<p>Assertions 的檢查預設關閉（disabled），使用前必須開啟</p>
</li>
<li>
<p>要避免不當的使用方式：</p>
<ol>
<li>
<p>不可用於類別方法的參數輸入檢查</p>
</li>
<li>
<p>不可影響程式正常流程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 將物件的生成放在 assertion 的判斷敘述中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SomeType</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SomeType</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="assertions-的使用">Assertions 的使用</h3>
<h4 id="內部的不變量-internal-invariants">內部的不變量 <em>internal invariants</em></h4>
<ul>
<li>
<p>在 else block 加上 <code>assert == 0</code>，使 x 無負值的可能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do if x &gt; 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="流程控管的不變量-control-flow-invariants">流程控管的不變量 <em>control flow invariants</em></h4>
<ul>
<li>
<p>為始 switch case 不可能進入 default block，直接在 default block 裡使用 assert false</p>
<ul>
<li>
<p>表示程式進到此不用再以 boolean 表達式判斷，而是馬上拋出 <code>AssertError</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">controlFlowInvariants</span><span class="o">(</span><span class="n">Gender</span> <span class="n">g</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="o">(</span><span class="n">g</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">MALE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="n">FEMALE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="kc">false</span><span class="o">:</span> <span class="s">&#34;Unknown gender!!&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h4 id="事後的狀態和類別不變量-post-conditions--class-invariants">事後的狀態和類別不變量 <em>post-conditions &amp; class invariants</em></h4>
<ul>
<li>
<p>無論類別欄位經過任何改變，都應該能通過方法 rule() 的檢驗</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyTime</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">hours</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">minutes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">seconds</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">rule</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="o">(</span><span class="n">0</span> <span class="o">&lt;=</span> <span class="n">hours</span> <span class="o">&amp;&amp;</span> <span class="n">hours</span> <span class="o">&lt;</span> <span class="n">24</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">0</span> <span class="o">&lt;=</span> <span class="n">minutes</span> <span class="o">&amp;&amp;</span> <span class="n">minutes</span> <span class="o">&lt;</span> <span class="n">60</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">0</span> <span class="o">&lt;=</span> <span class="n">seconds</span> <span class="o">&amp;&amp;</span> <span class="n">seconds</span> <span class="o">&lt;</span> <span class="n">60</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="assertions-的開啟與關閉">Assertions 的開啟與關閉</h4>
<ul>
<li>
<p>Assertions 預設是關閉，關閉後<strong>完全不會執行</strong>，和註解（comment）類似，不影響效能</p>
<pre tabindex="0"><code class="language-terminal" data-lang="terminal">java -enableassertions HelloWord
java -ea HelloWorld
</code></pre></li>
<li>
<p><code>-ea</code>即是 <code>-enableassertions</code>之縮寫</p>
</li>
<li>
<p>若在 <code>-ea</code> 後加上其它選項，可控制 <strong>Assertions 的啟用只在某個 package 或 class</strong></p>
<p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/language/assert.html#enable-disable" target="_blank" rel="noopener noreffer ">Enable and Disable Assertions</a></p>
</li>
</ul>
<hr>
<h1 id="03-輸入與輸出">03 輸入與輸出</h1>
<h2 id="io-基礎">I/O 基礎</h2>
<ul>
<li>當輸入/輸出行為發生時，好比串流（stream）的流動，流入或流出某個地方</li>
<li>串流需要有來源及目的，ex. 主控台視窗（console）、檔案、資料庫、網路、其它程式</li>
</ul>
<h3 id="何謂-io">何謂 I/O</h3>
<p>基本認知：</p>
<ol>
<li>資料的進出像是水流 / 串流
<ul>
<li>來源流向目的，具有方向性，Java 中稱之為 <code>stream (串流)</code></li>
<li>流動內容主要分為「位元（byte）」和「字元（character）」</li>
</ul>
</li>
<li>水流的流動，若提供管道，稱為 <code>channel</code>，若使用 <code>channel</code> 支援 I/O 會更有效率</li>
</ol>
<h4 id="以-java-程式為區分基準">以 Java 程式為區分基準</h4>
<ol>
<li>
<p>輸入串流 | 來源串流（input stream, source stream）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/hz0S8PM.png"
        data-srcset="https://i.imgur.com/hz0S8PM.png, https://i.imgur.com/hz0S8PM.png 1.5x, https://i.imgur.com/hz0S8PM.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/hz0S8PM.png"
        title="image-20221218122158764" /></p>
</li>
<li>
<p>輸出串流 | 目的串流（output stream, sink stream）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/2OgU1l1.png"
        data-srcset="https://i.imgur.com/2OgU1l1.png, https://i.imgur.com/2OgU1l1.png 1.5x, https://i.imgur.com/2OgU1l1.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/2OgU1l1.png"
        title="image-20221218122209539" /></p>
</li>
</ol>
<h4 id="以程式開發最常用三種端點區分">以程式開發最常用三種端點區分</h4>
<ol>
<li>檔案（files）和目錄（directories）</li>
<li>主控台（console）：標準輸入（standard-in）和標準輸出（standard-out）</li>
<li>Socket 程式（連線遠端系統，需指定 port 通訊）</li>
</ol>
<h3 id="處理串流的類別">處理串流的類別</h3>
<p>依串流內的資料分類、流動方向、處理類別分為四個抽象類別：</p>
<table>
<thead>
<tr>
<th>方向\串流內容</th>
<th>位元（byte）</th>
<th>字元（character）</th>
</tr>
</thead>
<tbody>
<tr>
<td>輸入 Java</td>
<td><code>InputStream</code></td>
<td><code>Reader</code></td>
</tr>
<tr>
<td>輸出 Java</td>
<td><code>OutputStream</code></td>
<td><code>Writer</code></td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-inputstream">Class <code>InputStream</code></h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>int read()</code></td>
<td>每次讀取 1 個 byte</td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer)</code></td>
<td>每次讀取一個 byte[]</td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer, int offset, int length)</code></td>
<td>每次讀取一個 byte[]，可以指定偏移量（offset）和讀取長度（length）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>int available()</code></td>
<td>有多少的 bytes 可供讀取</td>
</tr>
<tr>
<td>-</td>
<td><code>long skip(long n)</code></td>
<td>讀取時略過 n 個 <strong>bytes</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>boolean markSupported()</code><!-- raw HTML omitted --><code>void mark(int readlimit)</code><!-- raw HTML omitted --><code>void reset()</code></td>
<td>合併用於改變檔案中的讀取位置，特別是回到過去某個指定的讀取位置<!-- raw HTML omitted -->又稱 push-back 操作</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-outputstream">Class <code>OutputStream</code></h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>void write(int c)</code></td>
<td>將 int 寫入 <code>OutputStream</code></td>
</tr>
<tr>
<td>-</td>
<td><code>void write(byte[] buffer)</code></td>
<td>將 byte[] 寫入 <code>OutputStream</code></td>
</tr>
<tr>
<td>-</td>
<td><code>void write(byte[] buffer, int offset, int length)</code></td>
<td>寫入 byte[] 到 <code>OutputStream</code>，指定長度（length）和偏移量（offset）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>void flush()</code></td>
<td>強制將 <code>OutputStream</code> 中的資料寫入目的地</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-reader">Class <code>Reader</code></h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>int read()</code></td>
<td>每次讀取 1 個 <strong>char</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer)</code></td>
<td>每次讀取一個 char[]</td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer, int offset, int length)</code></td>
<td>每次讀取一個 char[]，可以指定偏移量（offset）和讀取長度（length）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>boolean ready()</code></td>
<td>確認 stream 是否已經準備好進行資料讀取</td>
</tr>
<tr>
<td>-</td>
<td><code>long skip(long n)</code></td>
<td>讀取時略過 n 個 <strong>chars</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>boolean markSupported()</code><!-- raw HTML omitted --><code>void mark(int readAheadLimit)</code><!-- raw HTML omitted --><code>void reset()</code></td>
<td>合併用於改變檔案中的讀取位置，特別是回到過去某個指定的讀取位置<!-- raw HTML omitted -->又稱 push-back 操作</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-writer">Class Writer</h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>void write(int c)</code></td>
<td>將 int 寫入 <strong>Writer</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>void write(char[] buffer)</code></td>
<td>將整個 char[] 寫入 Writer</td>
</tr>
<tr>
<td>-</td>
<td><code>void write(char[] buffer, int offset, int length)</code></td>
<td>寫入 char[] 到 Writer，且指定長度（length）和偏移量（offset）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>void flush()</code></td>
<td>強制將 Writer 中的資料寫入目的地</td>
</tr>
</tbody>
</table>
<h3 id="串流類別的串接">串流類別的串接</h3>
<table>
<thead>
<tr>
<th>功能\串流內容</th>
<th>字元串流　<em>Character Streams</em></th>
<th>位元串流 <em>Byte Streams</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>Buffering（緩衝）</td>
<td><code>BufferReader</code><!-- raw HTML omitted --><code>BufferedWriter</code></td>
<td><code>BufferedInputStream</code><!-- raw HTML omitted --><code>BufferedOutputStream</code></td>
</tr>
<tr>
<td>Filtering（過濾）</td>
<td><code>FilterReader</code><!-- raw HTML omitted --><code>FilterWriter</code></td>
<td><code>FilterInputStream</code><!-- raw HTML omitted --><code>FilterOutputStream</code></td>
</tr>
<tr>
<td>Conversion（位元轉換為字元）</td>
<td><code>InputStreamReader</code><!-- raw HTML omitted --><code>OutputStreamWriter</code></td>
<td></td>
</tr>
<tr>
<td>Object serialization（物件序列化）</td>
<td></td>
<td><code>ObjectInputStream</code><!-- raw HTML omitted --><code>ObjectOutputStream</code></td>
</tr>
<tr>
<td>Data conversion（資料型態轉換）</td>
<td></td>
<td><code>DataInputStream</code><!-- raw HTML omitted --><code>DataOutputStream</code></td>
</tr>
<tr>
<td>Counting（計算行數）</td>
<td><code>LineNumberReader</code></td>
<td><code>LineNumberInputStream</code></td>
</tr>
<tr>
<td>Printing（列印）</td>
<td><code>PrintWriter</code></td>
<td><code>PrintStream</code></td>
</tr>
</tbody>
</table>
<h3 id="使用-javaiofile-類別">使用 <code>java.io.File</code> 類別</h3>
<p><code>java.io.File</code> 常用方法：</p>
<table>
<thead>
<tr>
<th>method</th>
<th>return type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getName()</code></td>
<td>String</td>
<td>取得檔案或目錄的名稱</td>
</tr>
<tr>
<td><code>getParent()</code></td>
<td>String</td>
<td>取得父目錄的名稱</td>
</tr>
<tr>
<td><code>getParentFile()</code></td>
<td>File</td>
<td>取得代表父目錄的 File 物件</td>
</tr>
<tr>
<td><code>getPath()</code></td>
<td>String</td>
<td>取得檔案或目錄的路徑</td>
</tr>
<tr>
<td><code>isAbsolute()</code></td>
<td>boolean</td>
<td>是否為絕對路徑</td>
</tr>
<tr>
<td><code>getAbsolutePath()</code></td>
<td>String</td>
<td>取得絕對路徑</td>
</tr>
<tr>
<td><code>canRead()</code></td>
<td>boolean</td>
<td>是否可讀取</td>
</tr>
<tr>
<td><code>canWrite()</code></td>
<td>boolean</td>
<td>是否可修改</td>
</tr>
<tr>
<td><code>exists()</code></td>
<td>boolean</td>
<td>是否存在</td>
</tr>
<tr>
<td><code>isDirectory()</code></td>
<td>boolean</td>
<td>是否為目錄</td>
</tr>
<tr>
<td><code>isFile()</code></td>
<td>boolean</td>
<td>是否為檔案</td>
</tr>
<tr>
<td><code>lastModified()</code></td>
<td>long</td>
<td>取得最後一次修改時間</td>
</tr>
<tr>
<td><code>length()</code></td>
<td>long</td>
<td>取得檔案大小</td>
</tr>
<tr>
<td><code>delete()</code></td>
<td>boolean</td>
<td>刪除檔案或目錄並回傳成功與否</td>
</tr>
<tr>
<td><code>list()</code></td>
<td>String[]</td>
<td>列舉目錄下的檔案與子目錄</td>
</tr>
<tr>
<td><code>listFiles()</code></td>
<td>File[]</td>
<td>列舉目錄下的檔案與子目錄的 File 物件</td>
</tr>
<tr>
<td><code>mkdir()</code></td>
<td>boolean</td>
<td>建立目錄</td>
</tr>
<tr>
<td><code>mkdirs()</code></td>
<td>boolean</td>
<td>建立目錄 + 不存在但是需要一併建立的父目錄</td>
</tr>
<tr>
<td><code>renameTo(File)</code></td>
<td>boolean</td>
<td>重新命名</td>
</tr>
<tr>
<td><code>createTempFIle()</code></td>
<td>File</td>
<td>建立暫存檔案，有多載版本</td>
</tr>
<tr>
<td><code>setLastModified(long)</code></td>
<td>boolean</td>
<td>設定最後一次修改時間</td>
</tr>
<tr>
<td><code>setReadOnly()</code></td>
<td>boolean</td>
<td>設定成唯讀</td>
</tr>
</tbody>
</table>
<h2 id="由主控台讀寫資料">由主控台讀寫資料</h2>
<h3 id="主控台的-io">主控台的 I/O</h3>
<p><code>java.lang.System</code> 類別裡的三個 static 欄位</p>
<table>
<thead>
<tr>
<th>「欄位</th>
<th>欄位型別</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>System.out</code></td>
<td><code>PrintStream</code></td>
<td>將訊息輸出至 console，又稱 <strong>標準輸出</strong>（standard output）<!-- raw HTML omitted -->可接受由主控台再經<code>&gt;</code> 或 <code>&gt;&gt;</code> 的「重新導向指令」，將輸出內容導向至另外一個檔案</td>
</tr>
<tr>
<td><code>System.in</code></td>
<td><code>InputStream</code></td>
<td>由 console 接收來自鍵盤或其他來源的訊息輸入<!-- raw HTML omitted -->又稱 <strong>標準輸入</strong>（standard input）</td>
</tr>
<tr>
<td><code>System.err</code></td>
<td><code>PrintStream</code></td>
<td>和 <code>System.out</code> 一樣都是輸出訊息至 console<!-- raw HTML omitted -->但主要用於輸出錯誤訊息，較為急迫必須立即顯示，因此「重新導向指令」無效，依然顯示在 console <!-- raw HTML omitted -->使用 Eclipse IDE 的話，輸出顏色為紅色（警示用）</td>
</tr>
</tbody>
</table>
<h3 id="使用標準輸出方法">使用標準輸出方法</h3>
<ul>
<li><code>println()</code> 輸出換行符、<code>print()</code>不輸出換行符號</li>
<li>以上兩方法對大部分基本型別以及參考型別都有多載方法支援
<ul>
<li>boolean, char, int, long, float, double、char[], <code>Object</code>, <code>String</code></li>
<li>其它參考型別則呼叫該物件的 <code>toString()</code> 方法</li>
</ul>
</li>
</ul>
<h3 id="javaioconsole-類別介紹"><code>java.io.Console</code> 類別介紹</h3>
<ul>
<li>
<p>除了使用前述 <code>System.in</code> 取得主控台標準輸入外，也可以用 <code>java.io.Console</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsoleInput</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span> <span class="n">cons</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">console</span><span class="o">();</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用 System.console() 方法取得 Console 物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">boolean</span> <span class="n">userValid</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cons</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">account</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">passwd</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">account</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="na">readLine</span><span class="o">(</span><span class="s">&#34;%s&#34;</span><span class="o">,</span> <span class="s">&#34;Account: &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// readline() 可取得指令列輸入的資料
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">passwd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">cons</span><span class="o">.</span><span class="na">readPassword</span><span class="o">(</span><span class="s">&#34;%s&#34;</span><span class="o">,</span> <span class="s">&#34;Password: &#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// readPassword() 除了可以取得指令列輸入的資料，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 還能隱藏使用者輸入內容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;joanna&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">passwd</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&#34;password&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Correct! System quits!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">userValid</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Wrong! Try again!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">userValid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 後測式迴圈：先輸入再驗證，失敗繼續，成功終止
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/Q8HsrVi.png"
        data-srcset="https://i.imgur.com/Q8HsrVi.png, https://i.imgur.com/Q8HsrVi.png 1.5x, https://i.imgur.com/Q8HsrVi.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/Q8HsrVi.png"
        title="image-20221218141013717" /></p>
</li>
</ul>
<h2 id="channel-io">Channel I/O</h2>
<ul>
<li>Channel : 可以指兩個設備之間傳送資訊經過的通路或連接
<ul>
<li>導入於 JDK 1.4，屬於 <code>java.nio</code> package</li>
<li>可以一次大量讀入位元和字元，不需要以迴圈每次讀取少量內容</li>
<li>程式更簡潔，程式效能更好</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CopyByteChannel</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">String</span> <span class="n">source</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">,</span> <span class="n">target</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">(</span><span class="n">FileChannel</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">source</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="n">FileChannel</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">target</span><span class="o">).</span><span class="na">getChannel</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ByteBuffer</span> <span class="n">buff</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">in</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 建立和 source 檔案 size 大小相同的 ByteBuffer 物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buff</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 將實體檔案一次全數讀入到 ByteBuffer 物件中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">buff</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">             <span class="c1">// 將 ByteBuffer 裡的標示位置移到最前面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buff</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="cm">/* 將 ByteBuffer 裡的資料全數輸出至 FileChannel out，再由其輸出為檔案
</span></span></span><span class="line"><span class="cl"><span class="cm">          因為 FileChannel 的 read() 和 write() 方法都是透過 ByteBuffer 物件一次搞定
</span></span></span><span class="line"><span class="cl"><span class="cm">          所以不用迴圈（loop）分次處理 */</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">f</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="使用序列化技術讀寫物件">使用序列化技術讀寫物件</h2>
<h3 id="java-裡的資料保存-persistence">Java 裡的資料保存 <em>Persistence</em></h3>
<p>將資料儲存於永久性的儲存硬體中，稱為「<strong>persistence</strong>」</p>
<ol>
<li>支援 persistence 的 Java 物件可儲存於本機硬體，或經由網路到另一個硬體裝置
<ul>
<li>未支援 persistence 的 Java 物件只能存活於執行中的 JVM</li>
</ul>
</li>
<li>序列化 <em>serialization</em>：Java 將記憶體中的物件狀態儲存於硬體，成為「<strong>實體檔案</strong>」的標準機制
<ul>
<li>未來可用來建構物件的副本或是還原物件狀態</li>
</ul>
</li>
<li>支援序列化的物件必須實作 <code>java.io.Serializable</code> 介面</li>
</ol>
<ul>
<li>該介面是一個「<strong>maker interface</strong>」，沒有任何需要實作的方法</li>
<li>類別實作此介面只是讓 Java 知道其物件有具備序列化的能力，具體序列化步驟由 Java 掌控</li>
</ul>
<h3 id="序列化和物件圖譜">序列化和物件圖譜</h3>
<ul>
<li>當物件被序列化時，只有「<strong>欄位值</strong>」會被保留
<ul>
<li>欄位值包含資料，也包含物件的狀態</li>
<li>若物件的該欄位是參考型別，且被參考的物件也支援序列化，則該欄位物件也會一併被序列化</li>
</ul>
</li>
<li><strong>物件圖譜 object graphs</strong>：
<ul>
<li>物件欄位參照其它物件，被參照的物件又可以再參照更多物件&hellip;所形成的樹狀結構</li>
</ul>
</li>
</ul>
<h3 id="不需要參加序列化的欄位">不需要參加序列化的欄位</h3>
<ul>
<li>
<p>物件序列化時，預設所有欄位都會一併進行序列化</p>
</li>
<li>
<p>如果欄位所屬類別沒有實作 <code>java.io.Serializable</code>，會中斷執行並丟出例外 <code>NotSerializableException</code></p>
</li>
<li>
<p>若物件欄位只是記錄當下系統狀態的某些資訊（ex. 目前時間），屬於「<strong>短暫 <em>transient</em></strong>」資訊</p>
<ul>
<li>不需要再序列化過程中被保留</li>
<li>重建副本時也不需要回復</li>
<li>此類欄位不需要參與序列化流程，可以加上「<strong>transient</strong>」宣告</li>
</ul>
</li>
<li>
<p>宣告「<strong>static</strong>」的欄位和物件狀態無關，其值在物件序列化過程中也不會被保留</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Shirt</span><span class="o">&gt;</span> <span class="n">shirts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticField</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>        <span class="c1">// static
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">transient</span> <span class="kt">int</span> <span class="n">transientField</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>  <span class="c1">// transient
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>宣告 <code>transient</code> 以及 <code>static</code> 的欄位在「反序列化 / 還原」程序時
<ol>
<li>static : 會得到類別內原本定義的宣告值</li>
<li>transient : 會得到該型態的預設值</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="定義物件保存的版本號碼">定義物件保存的版本號碼</h3>
<ul>
<li>
<p><strong>序列化</strong>：保留物件「<code>當下狀態（欄位值）</code>」，並未保留類別架構</p>
</li>
<li>
<p><strong>反序列化</strong>：將「<code>過去物件某個狀態</code>」，搭配「<code>目前類別架構</code>」進行還原</p>
<ul>
<li>
<p>若還原時發現「<strong>過去物件狀態</strong>」和「<strong>目前類別架構</strong>」不一致，可能產生不預期的問題或錯誤</p>
<ul>
<li>過去某欄位現在已經不存在</li>
<li>類別後來新增必要欄位，序列化卻沒有該欄位</li>
</ul>
</li>
<li>
<p>為了能夠使序列化後的檔案可以順利的被反序列化還原成物件：</p>
<ol>
<li>
<p>在可序列化之類別定義一個欄位 <code>serialVersionUID</code> 作為版本控管號碼</p>
<ul>
<li>
<p>每次增減類別內欄位時，都應該同步修改版本號碼並且記錄</p>
</li>
<li>
<p>版本控管號碼必須宣告為 <strong>static</strong> 且 <strong>long</strong></p>
<p><code>private static final long serialVersionUID = 1L;</code></p>
</li>
</ul>
</li>
<li>
<p><code>InvalidClassException</code> 預先保護機制</p>
<ul>
<li>假設目前版本號為 1，序列化後得到的檔案內存版本也會是 1</li>
<li>後來類別增減了欄位，版本修改為 2</li>
<li>如果以「版本#2的最新類別定義」來還原「序列化時版本#1的檔案」會拋出上述錯誤</li>
</ul>
</li>
<li>
<p>若類別實作 <code>Serializable</code> 介面，但未宣告<code>serialVersionUID</code></p>
<ul>
<li>
<p>Java 預設將主動宣告並提供欄位值，該值將考慮開發環境因素（IDE工具或Java版本）計算出一個複雜的長整數</p>
<p><code>private static final long serialVersionUID =3696676879791539369L;</code></p>
</li>
<li>
<p>此長整數在每次編譯階段，即使只是某方法內字串微調，也可能因為環境再改變而自動改變版本號碼</p>
</li>
<li>
<p>可能導致先前序列化的檔案因為版本號改變，而無法還原回物件</p>
</li>
<li>
<p>建議開發者應該自己宣告 <code>serialVersionUID</code> 欄位</p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<p>&hellip;</p>
<h3 id="序列化和反序列化範例">序列化和反序列化範例</h3>
<p>以下範例將物件序列化產出檔案，再將檔案還原回物件，特殊情境：</p>
<ul>
<li>class Order 底下含數個 class Shirt(s)，其中 Shirt(s) 類別內的價錢欄位會因時因地改變，序列化過程中不需要特別保存，<strong>以 transient 宣告</strong></li>
<li>Java 給物件可以控制自身序列化和反序列化的流程
<ul>
<li>序列化時可以額外寫入 <code>java.util.Date</code>物件，在反序列化的時候讀出，可知進行序列化時間點</li>
</ul>
</li>
<li>反序列化時，希望 Shirt(s) 類別內的價錢欄位可以參考成本價，再加上 50 元管銷費用</li>
</ul>
<h4 id="1-class-shirt">1. class Shirt</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Shirt</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">String</span> <span class="n">brand</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">double</span> <span class="n">cost</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">transient</span> <span class="kt">double</span> <span class="n">price</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="nf">Shirt</span><span class="o">(</span><span class="n">String</span> <span class="n">brand</span><span class="o">,</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">,</span> <span class="kt">double</span> <span class="n">cost</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">brand</span> <span class="o">=</span> <span class="n">brand</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">cost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">2</span> <span class="o">*</span> <span class="n">cost</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// This method is called post-serialization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 要修改Java反序列化(將物件自檔案中讀出)的流程，必須定義本方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">ois</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ois.defaultReadObject() 是物件原本的反序列化流程，仍須呼叫此
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ois</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// perform other initiliazation 將檔案還原成物件後，price欄位+50元
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">cost</span> <span class="o">+</span> <span class="n">50</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;Shirt: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">brand</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span> 
</span></span><span class="line"><span class="cl">				<span class="o">+</span> <span class="s">&#34;Quantity: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">quantity</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span> 
</span></span><span class="line"><span class="cl">				<span class="o">+</span> <span class="s">&#34;Cost: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">cost</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span>
</span></span><span class="line"><span class="cl">				<span class="o">+</span> <span class="s">&#34;Price: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span>
</span></span><span class="line"><span class="cl">				<span class="o">+</span> <span class="s">&#34;------------------\n&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-class-order">2. class Order</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Shirt</span><span class="o">&gt;</span> <span class="n">shirts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kt">int</span> <span class="n">staticField</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">transient</span> <span class="kt">int</span> <span class="n">transientField</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="nf">Order</span><span class="o">(</span><span class="n">Shirt</span><span class="o">...</span> <span class="n">shirts</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="o">(</span><span class="n">Shirt</span> <span class="n">s</span> <span class="o">:</span> <span class="n">shirts</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="o">.</span><span class="na">shirts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">staticField</span> <span class="o">=</span> <span class="n">99</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">transientField</span> <span class="o">=</span> <span class="n">99</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;--- Constructor is launched ---&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">ObjectOutputStream</span> <span class="n">oos</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用此方法修改Java序列化(物件寫入檔案)的流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">oos</span><span class="o">.</span><span class="na">defaultWriteObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// keep the serialization date
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">now</span><span class="o">);</span> <span class="c1">// 將日期物件寫入檔案
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\nSerialized at: &#34;</span> <span class="o">+</span> <span class="n">now</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// This method is called post-serialization (修改Java反序列化(檔案還原成物件)的流程)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">ois</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ois</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span> <span class="c1">// 進行物件原本的反序列化流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\nRestored from date: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">Date</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 讀出序列化時的日期物件，再轉型回Date型態
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Restored at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&#34;Order Summary ===\n&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="o">(</span><span class="n">Shirt</span> <span class="n">s</span> <span class="o">:</span> <span class="n">shirts</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;staticField = &#34;</span> <span class="o">+</span> <span class="n">staticField</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;\ntransientField = &#34;</span> <span class="o">+</span> <span class="n">transientField</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;\n------------------&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-serialization-and-de-serialization">3. Serialization and De-serialization</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SerializeOrder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;user.dir&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\\src\\course\\c03\\ser\\file\\Order.ser&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">serialization</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//	System.out.println(&#34;\n-----------------------------------------\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		
</span></span><span class="line"><span class="cl">	<span class="c1">//	deSerialization(output);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialization</span><span class="o">(</span><span class="n">String</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Create a shirts Order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Shirt</span> <span class="n">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Shirt</span><span class="o">(</span><span class="s">&#34;Brand1&#34;</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Shirt</span> <span class="n">s2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Shirt</span><span class="o">(</span><span class="s">&#34;Brand2&#34;</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">200</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Shirt</span> <span class="n">s3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Shirt</span><span class="o">(</span><span class="s">&#34;Brand3&#34;</span><span class="o">,</span> <span class="n">100</span><span class="o">,</span> <span class="n">300</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Order</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">,</span> <span class="n">s3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">Order</span><span class="o">.</span><span class="na">staticField</span> <span class="o">=</span> <span class="n">22</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Write out the Order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">try</span> <span class="o">(</span><span class="n">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">ObjectOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">out</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;=== Before Serialization, &#34;</span> <span class="o">+</span> <span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">deSerialization</span><span class="o">(</span><span class="n">String</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Read the Order back in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">try</span> <span class="o">(</span><span class="n">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">output</span><span class="o">);</span> <span class="n">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">fis</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Order</span> <span class="n">restoredOrder</span> <span class="o">=</span> <span class="o">(</span><span class="n">Order</span><span class="o">)</span> <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;=== After Serialization, &#34;</span> <span class="o">+</span> <span class="n">restoredOrder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">i</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li><strong>Shirt</strong> 物件生成時的 price 都是 cost 的 2 倍，還原時在 <code>readObject()</code> 方法被改成 <code>price = cost + 50</code></li>
<li><strong>Order</strong>物件序列化時，在<code>writeObject()</code>被特別寫入的日期，還原時在<code>readObject()</code>方法可一併輸出</li>
<li><strong>static 欄位</strong> 會得到類別內原本定義的宣告值</li>
<li><strong>transient 欄位</strong> 會得到該型態的預設值</li>
</ol>
</blockquote>
<hr>
<h1 id="04-nio2">04 <code>NIO.2</code></h1>
<h2 id="nio2-基礎"><code>NIO.2</code> 基礎</h2>
<h3 id="javajofile限制"><code>java.jo.File</code>限制</h3>
<p>基礎 I/O 存在一些不方便的地方：</p>
<ol>
<li>很多方法遇到錯誤時回傳 <em>false</em>，而非丟出例外</li>
<li>缺少很多存取檔案常用功能，ex. 複製 <em>copy</em>、移動 <em>move</em></li>
<li>不是每一個作業系統都支援重新命名</li>
<li>不支援 <em>symbolic link</em> 類型的檔案</li>
<li>對於「<code>metadata</code>（描述檔案的資料）」檔案的取得很有限
<ul>
<li>例如：檔案權限、檔案擁有者、安全性設定</li>
</ul>
</li>
<li>存取「<code>metadata</code>（描述檔案的資料）」檔案沒有效率
<ul>
<li>一次只能存取一個，每次呼叫都會轉呼叫系統指令 <code>system call</code></li>
</ul>
</li>
<li>很多方法遇到檔案較大時，會呈現卡住狀態（<em>hang</em>），久無回應甚至當掉</li>
<li>遞迴目錄結構時，遇到 <em>symbolic link</em> 類型的檔案無法適當處理</li>
<li>遇到新型態作業系統或新檔案型態時，不易擴充 <code>API</code></li>
</ol>
<h3 id="java-io-套件發展歷史">Java I/O 套件發展歷史</h3>
<table>
<thead>
<tr>
<th>功能</th>
<th><code>JSR</code></th>
<th>版本</th>
<th>套件（Package）</th>
<th>note</th>
</tr>
</thead>
<tbody>
<tr>
<td>I/O</td>
<td></td>
<td>Java 2</td>
<td><code>java.io.*</code></td>
<td></td>
</tr>
<tr>
<td>New I/O (<code>NIO</code>)</td>
<td>51</td>
<td>Java 4</td>
<td><code>java.nio.*</code></td>
<td>ex. Channel I/O</td>
</tr>
<tr>
<td>New I/O 2 (<code>NIO.2</code>)</td>
<td>203</td>
<td>Java 7</td>
<td><code>java.nio.file.*</code></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="檔案系統路徑和檔案">檔案系統、路徑和檔案</h3>
<p><code>NIO.2</code> 裡面的檔案 / 目錄都以路徑（path）來表達，可分為絕對路徑 <em>absolute path</em> 和相對路徑 <em>relative path</em></p>
<ol>
<li><strong>絕對路徑</strong>
<ul>
<li>包含根目錄，ex. 「<code>/</code>」或 Windows 的「<code>C:</code>」</li>
<li>定位檔案位置必須</li>
</ul>
</li>
<li><strong>相對路徑</strong>
<ul>
<li>必須再結合絕對路徑才能找到檔案真正位置</li>
</ul>
</li>
</ol>
<h3 id="symbolic-link-檔案">Symbolic Link 檔案</h3>
<ul>
<li>
<p>又稱為 <code>symlink</code> 或者 <code>soft link</code>，並不是捷徑（<em>short cut</em>）</p>
</li>
<li>
<p>執行時以系統管理員身分開啟 cmd，輸入指令</p>
<pre tabindex="0"><code class="language-TERMINAL" data-lang="TERMINAL">mklink $(連結檔案) $(連結來源檔案)
</code></pre><table>
<thead>
<tr>
<th>comparison</th>
<th><code>symlink</code></th>
<th><code>short cut</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>檔案類型不同</td>
<td>.symlink<!-- raw HTML omitted --><code>.sl</code></td>
<td>捷徑<!-- raw HTML omitted --><code>.sc</code></td>
</tr>
<tr>
<td>檔案大小不同</td>
<td>0 KB</td>
<td>2 KB</td>
</tr>
<tr>
<td>分別複製兩者時</td>
<td>複製 <strong>連結來源檔案</strong>，<!-- raw HTML omitted -->非 <code>symlink</code> 本身</td>
<td>複製捷徑本身</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3 id="nio2-的基本架構"><code>NIO.2</code> 的基本架構</h3>
<ul>
<li>Before JDK 7
<ul>
<li><code>java.io.File</code> 是所有檔案 / 目錄的操作基礎</li>
</ul>
</li>
<li>After JDK 7 (推出 <code>NIO.2</code>)
<ul>
<li>改為三個基礎
<ol>
<li><code>java.nio.file.Path</code> : 用來<strong>找出</strong>檔案 / 目錄</li>
<li><code>java.nio.file.Files</code> : 用來<strong>操作</strong>檔案 / 目錄</li>
<li><code>java.nio.file.FileSystem</code> : 用來<strong>建立</strong> Path 或其它存取檔案系統的物件</li>
</ol>
</li>
<li><code>NIO.2</code> 所有方法都丟出 <code>IOException</code> 或其子類別</li>
</ul>
</li>
</ul>
<h2 id="使用-path-介面操作檔案目錄">使用 Path 介面操作檔案/目錄</h2>
<h3 id="path-介面">Path 介面</h3>
<ul>
<li>
<p><code>java.nio.Path</code> 介面是 <code>NIO.2</code> 架構的進入點</p>
</li>
<li>
<p>取得 <code>Path</code> 物件有兩種方法，物件建立後不能修改狀態 (即不可變物件 immutable)</p>
<ol>
<li>
<p>藉由 <code>FileSystem</code> 物件的 <code>getPath()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FileSystem</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="na">getPath</span><span class="o">(</span><span class="s">&#34;D:\\labs\\resources\\myFile.txt&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>藉由 <code>java.nio.file.Paths</code> 類別的靜態 <code>get()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p0</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;C:\\fakeFile\\pseudoDir\\temp.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;C:/fakeFile/pseudoDir/temp.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;D:&#34;</span><span class="o">,</span> <span class="s">&#34;fakeFile&#34;</span><span class="o">,</span> <span class="s">&#34;pseudoDir&#34;</span><span class="o">,</span> <span class="s">&#34;temp.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;/temp/ferrero&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;file:///~/someTempFile&#34;</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Windows 檔案路徑接受以下兩種方向的斜線</p>
<ul>
<li>
<p><code>\\</code> ( <code>\</code> + escape character <code>\</code>)</p>
</li>
<li>
<p><code>/</code></p>
</li>
</ul>
</blockquote>
</li>
</ol>
</li>
</ul>
<h3 id="path-介面主要功能">Path 介面主要功能</h3>
<ul>
<li>
<p>Path 介面用來找出檔案 / 目錄，常用方法</p>
<table>
<thead>
<tr>
<th><strong>分解路徑</strong></th>
<th><strong>操作路徑</strong></th>
<th><strong>比較路徑</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>取得構成路徑的所有檔案 / 目錄。<!-- raw HTML omitted -->主要分成根目錄 <em>root</em> 和名稱 <em>name</em> 兩種路徑成員。<!-- raw HTML omitted -->root 路徑成員只有一個，name 路徑成員可以有多個。</td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>getFileName()</code><!-- raw HTML omitted --><code>getParent()</code><!-- raw HTML omitted --><code>getRoot()</code><!-- raw HTML omitted --><code>getNameCount()</code> - 不含 root</td>
<td><code>normalize()</code><!-- raw HTML omitted --><code>toUri()</code><!-- raw HTML omitted --><code>toAbsolutePath()</code><!-- raw HTML omitted --><code>subpath()</code><!-- raw HTML omitted --><code>resolve()</code><!-- raw HTML omitted --><code>relativize()</code></td>
<td><code>startsWith()</code><!-- raw HTML omitted --><code>endsWith()</code><!-- raw HTML omitted --><code>equals()</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>getNameCount()</strong> 只計算 name 路徑成員個數，不包含 root，且索引從 0 ~ 2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;D:/Temp/Foo/file1.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;getNameCount: %d%n&#34;</span><span class="o">,</span> <span class="n">p1</span><span class="o">.</span><span class="na">getNameCount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="c1">// getNameCount: 3
</span></span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th><strong>路徑組成</strong></th>
<th><code>D:</code></th>
<th><code>Temp</code></th>
<th><code>Foo</code></th>
<th><code>file1.txt</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>成員分類</strong></td>
<td>root</td>
<td>name<!-- raw HTML omitted -->0</td>
<td>name<!-- raw HTML omitted -->1</td>
<td>name<!-- raw HTML omitted -->2</td>
</tr>
</tbody>
</table>
</blockquote>
</li>
</ul>
<h3 id="移除路徑裡的多餘組成">移除路徑裡的多餘組成</h3>
<ul>
<li>
<p>檔案系統目錄</p>
<ol>
<li>「<code>.</code>」 當前目錄</li>
<li>「<code>..</code>」 上一層目錄</li>
</ol>
</li>
<li>
<p>多餘的組成 可以<strong>使用 normalize() 方法</strong> 移除多餘部分，像是「<code>./</code>」和「<code>directory/../</code>」</p>
<ul>
<li>/home/<strong>./</strong> pseudo/himmel</li>
<li>/home/<strong>acrawlingkitten/../</strong> pseudo/himmel</li>
</ul>
</li>
</ul>
<h3 id="建立子路徑---subpath">建立子路徑 - <code>subpath()</code></h3>
<p>使用 <code>subpath()</code> 可取得路徑裡的部分路徑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testSubPath</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;D:/Temp/finnish/schocolade&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">p1</span><span class="o">.</span><span class="na">subpath</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">3</span><span class="o">);</span>  <span class="c1">// immutable test
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p1</span><span class="o">);</span>  <span class="c1">// D:\Temp\finnish\schocolade
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="na">subpath</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">3</span><span class="o">);</span>   <span class="c1">// finnish\bar
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>subpath(1, 3)</code> 表示由 index=1 開始取，不含 index=3 的成員，即取出成員 1 和 2</p>
</blockquote>
<table>
<thead>
<tr>
<th>D:</th>
<th>Temp</th>
<th>finnish</th>
<th>schocolade</th>
</tr>
</thead>
<tbody>
<tr>
<td>root</td>
<td>0</td>
<td>1</td>
<td>2</td>
</tr>
</tbody>
</table>
<h3 id="結合-2-個路徑---resolve">結合 2 個路徑 - <code>resolve()</code></h3>
<p>使用 <code>resolve()</code> 結合兩個路徑</p>
<ol>
<li>
<p>傳入「<strong>相對路徑</strong>」- 將該「<strong>相對路徑</strong>」，連接在「<strong>原路徑</strong>」之後</p>
</li>
<li>
<p>傳入「<strong>絕對路徑</strong>」- 方法回傳該「<strong>絕對路徑</strong>」，忽略「<strong>原路徑</strong>」</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testResolve</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&#34;/home/clementine/fredrich&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">p</span><span class="o">).</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;bones&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p1</span><span class="o">);</span>  <span class="c1">// \home\clementine\fredrich\bones
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Path</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">p</span><span class="o">).</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;/home/clementine&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p2</span><span class="o">);</span>  <span class="c1">// \home\clementine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="建立連接-2-個路徑的路徑---relativize">建立連接 2 個路徑的路徑 - <code>relativize()</code></h3>
<p>使用 <code>relativize()</code> 建構兩個路徑間的路徑，由原路徑到 <code>relativize()</code> 方法所傳入的路徑範例如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testRelative</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;peon&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;julia&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">p1Top2</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="na">relative</span><span class="o">(</span><span class="n">p2</span><span class="o">);</span>  <span class="c1">// 由p1到p2的走法  ..\julia
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p1Top2</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">p2Top1</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="na">relative</span><span class="o">(</span><span class="n">p1</span><span class="o">);</span>  <span class="c1">// 由p2到p1的走法  ..\peon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p2Top1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="hard-link">Hard Link</h3>
<p><code>hard link</code>類型的檔案，相對於 <code>soft link</code> 或 <code>symbolic link</code> 有更多限制：</p>
<ol>
<li>目標檔案一定要存在</li>
<li>目標不可以是目錄，只能是檔案</li>
<li>目標不可以跨磁碟，例如不能在 C磁碟建立 D磁碟的檔案 hard links</li>
<li>行為、外觀、屬性和一般檔案相似，不容易判斷</li>
</ol>
<h3 id="處理-symbolic-link">處理 Symbolic Link</h3>
<p><code>NIO.2</code>類別可以感知 <em>link</em> 類型檔案的存在，稱為「<em>link aware</em>」。相關方法具備以下能力</p>
<ol>
<li>
<p>偵測是否遇到 symbolic link 檔案</p>
</li>
<li>
<p>設定遇到 symbolic link 檔案時的處理方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createSymbolicLink</span><span class="o">(</span><span class="n">Path</span> <span class="n">p1</span><span class="o">,</span> <span class="n">Path</span> <span class="n">p2</span><span class="o">,</span> <span class="n">FileAttribute</span><span class="o">&lt;?&gt;);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createLink</span><span class="o">(</span><span class="n">Path</span> <span class="n">p1</span><span class="o">,</span> <span class="n">Path</span> <span class="n">p2</span><span class="o">);</span>  <span class="c1">// 建立 hard link
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Files</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">(</span><span class="n">Path</span> <span class="n">p1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">readSymbolicLink</span><span class="o">(</span><span class="n">Path</span> <span class="n">p1</span><span class="o">);</span>     <span class="c1">// 找出 symbolic link 的 target
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
</li>
</ol>
<h2 id="使用-files-類別對檔案目錄進行檢查刪除複製移動">使用 Files 類別對檔案/目錄進行檢查、刪除、複製、移動</h2>
<h3 id="處理檔案">處理檔案</h3>
<p>先使用 Path 物件定位檔案 / 目錄。再用 Files 類別操作 Path 物件，以達成：</p>
<ol>
<li>檔案與目錄的：
<ul>
<li>檢查 check | 刪除 delete | 複製 copy | 移動 move</li>
</ul>
</li>
<li>管理屬性資料（<code>metadata</code>）</li>
<li>讀 / 寫和建立檔案</li>
<li>隨機存取檔案</li>
<li>讀取目錄（<code>directory</code>）內的檔案</li>
</ol>
<h3 id="檢查檔案--目錄是否存在">檢查檔案 / 目錄是否存在</h3>
<ul>
<li>
<p>Path 代表檔案 / 目錄位置</p>
</li>
<li>
<p>存取之前應該先使用 Files 類別檢查是否存在（<em>symbolic link</em> 也算檔案），方法如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">,</span> <span class="n">LinkOption</span><span class="o">...</span> <span class="n">option</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">notExists</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">,</span> <span class="n">LinkOption</span><span class="o">...</span> <span class="n">option</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>如果兩個方法測試結果都是 false，表示狀態無法確認（<code>unknown</code>），常見原因</p>
<ol>
<li>沒有權限</li>
<li>離線磁碟機（Off-line Drive），例如 CD-ROM</li>
</ol>
</li>
</ul>
<h3 id="檢查檔案--目錄屬性">檢查檔案 / 目錄屬性</h3>
<p>檢查權限的使用方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">isReadable</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">isWritable</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">isExecutable</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>檢查是否為同一檔案的方法（常用於 symbolic link）</p>
<p><code>isSameFile()</code>檢查一旦結束，就不再保證結果，因為檔案可能馬上被其它系統指令更改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">isSameFile</span><span class="o">(</span><span class="n">Path</span> <span class="n">p1</span><span class="o">,</span> <span class="n">Path</span> <span class="n">p2</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h3 id="建立檔案--目錄">建立檔案 / 目錄</h3>
<ul>
<li>
<p>建立檔案的方法 - <code>createFile()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createFile</span><span class="o">(</span><span class="n">Path</span> <span class="n">file</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>建立單一目錄的方法 - <code>createDirectory()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createDirectory</span><span class="o">(</span><span class="n">Path</span> <span class="n">dir</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>建立多重目錄的方法，通常用於將路徑裡缺少的 name 成員一次全部建立</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">Path</span> <span class="n">dir</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>假設只有 <code>D:/Temp</code> 目錄存在，則使用 <code>Path.get(...)</code> 可將缺少的目錄一次建立完成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;D:/Temp/foo/bar/example&#34;</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="刪除檔案--目錄">刪除檔案 / 目錄</h3>
<ul>
<li>
<p>刪除檔案 / 目錄使用的方法 <code>Files.delete(Path p);</code></p>
</li>
<li>
<p>失敗時可能丟出以下例外</p>
<ol>
<li><code>java.nio.NoSuchFileException</code> : 要刪除的檔案不存在</li>
<li><code>java.nio.file.DirectoryNotEmptyException</code> : 要刪除的目錄不為空</li>
<li><code>java.io.IOException</code> : 其它錯誤</li>
</ol>
</li>
<li>
<p>也可以刪除檔案 / 目錄前先確認是否存在 - <code>deleteIfExists()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">deleteIfExists</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>則檔案不存在就不會刪除，因此不會有 <code>NoSuchFileException</code></p>
</li>
</ul>
<h3 id="複製和移動檔案--目錄">複製和移動檔案 / 目錄</h3>
<ul>
<li>
<p>複製和移動檔案 / 目錄的方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">Path</span> <span class="n">source</span><span class="o">,</span> <span class="n">Path</span> <span class="n">target</span><span class="o">,</span> <span class="n">CopyOption</span><span class="o">...);</span> 
</span></span><span class="line"><span class="cl">      <span class="c1">// source 來源路徑 (目錄 or 檔案)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Files</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="n">Path</span> <span class="n">source</span><span class="o">,</span> <span class="n">Path</span> <span class="n">target</span><span class="o">,</span> <span class="n">CopyOption</span><span class="o">...);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// target 目標路徑 (目錄 or 檔案)
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>CopyOption</code> 介面，此傳入參數允許同時多個，有兩個列舉型別實作它</p>
<table>
<thead>
<tr>
<th>介面</th>
<th>列舉型別（<code>enum</code>）</th>
<th>列舉項目（<code>types</code>）</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CopyOption</code></td>
<td><code>LinkOption</code></td>
<td><code>NOFOLLOW_LINKS</code></td>
</tr>
<tr>
<td>-</td>
<td><code>StandCopyOption</code></td>
<td><code>REPLACE_EXISTING</code></td>
</tr>
<tr>
<td>-</td>
<td><code>StandCopyOption</code></td>
<td><code>COPY_ATTRIBUTES</code></td>
</tr>
<tr>
<td>-</td>
<td><code>StandCopyOption</code></td>
<td><code>ATOMIC_MOVE</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>比較 <strong>複製</strong> 與 <strong>移動</strong> 兩種操作的相同之處</p>
<ol>
<li>如果目標路徑已經存在，但操作前沒有使用 <code>StandardCopyOption.REPLACE_EXISTING</code> 指定可以覆蓋的話，將失敗</li>
<li>如果目標路徑不存在，則操作後將自動建立</li>
<li>在操作<strong>之前</strong>來源和目標「非一致」是檔案 / 目錄，將不影響結果</li>
</ol>
</li>
<li>
<p>定義 <strong>目標路徑</strong> 需要注意</p>
<ol>
<li>如果目標路徑是存在的「檔案」或「空目錄」，使用 <strong>REPLACE_EXISTING</strong> 或 <strong>ATOMIC_MOVE</strong>，可避免拋出 <code>java.nio.file.FileAlreadyExistsException</code></li>
<li>若目標路徑是存在的「非空目錄」，用 <strong>REPLACE_EXISTING</strong> 還不夠，還是會拋出 <code>java.nio.file.DirectoryNotEmptyException</code></li>
</ol>
</li>
<li>
<p>定義 <strong>來源路徑</strong> 需要注意</p>
<ol>
<li>必須為存在的「檔案」「目錄」，否則拋出 <code>java.nio.file.NoSuchFileException</code></li>
<li>來源路徑是「目錄」時
<ul>
<li>即便「複製」成功，也無法複製內含檔案，只會產生新目錄，過程不會出錯</li>
</ul>
</li>
<li>來源路徑是「目錄」時
<ul>
<li>如果「移動」成功，內含的檔案 / 目錄將一併搬家</li>
</ul>
</li>
</ol>
</li>
<li>
<p>複製或移動路徑時，可以在第三個參數開始傳入實作介面 <code>CopyOption</code> 的列舉型態，注意事項為</p>
<ol>
<li>「複製」檔案 / 目錄時的注意事項
<ul>
<li>來源路徑是 <code>symbolic link</code> 時，預設將複製「link 指向的檔案」</li>
<li>列舉型態「<code>StandardCopyOption.COPY_ATTRIBUTES</code>」用於將檔案屬性一併複製。大部分屬性將依檔案系統不同而可能不被複製，但檔案最後修改時間（last-modified）將被支援</li>
</ul>
</li>
<li>「移動」檔案 / 目錄時的注意事項
<ul>
<li>使用列舉型態 <code>StandardCopyOption.ATOMIC_MOVE</code>
<ul>
<li>若檔案系統不支援將丟出例外</li>
<li>若支援則可避免移動過程中有其它系統程序存取檔案</li>
<li>如果用於耗時較久的大檔案移動，可以保證接下來要存取該檔案的系統程序都可存取到完整的檔案</li>
</ul>
</li>
<li>若移動 symbolic link 檔案，不需要使用列舉型態 <code>LinkOption.NOFOLLOW_LINKS</code></li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="stream-和-path-互相複製">Stream 和 Path 互相複製</h3>
<ul>
<li>
<p>檔案複製來源或目標除了 Path 之外，也可以是基礎 I/O 提到的串流（Stream）物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">source</span><span class="o">,</span> <span class="n">Path</span> <span class="n">target</span><span class="o">,</span> <span class="n">CopyOption</span><span class="o">...</span> <span class="n">options</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">Path</span> <span class="n">source</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">target</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// source: 檔案複製來源，使用 InputStream
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// target: 檔案複製後的輸出，使用 OutputStream
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>以下示範如何將遠端網頁轉換成 <code>InputStream</code> 物件後，再複製為本機檔案</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CopyInputStreamTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">to</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/oracle.html/&#34;</span><span class="o">).</span><span class="na">toAboslutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;http://www.oracle.com/&#34;</span><span class="o">).</span><span class="na">toURL</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span> <span class="n">InputStream</span> <span class="n">from</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openStream</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">StadardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="列出目錄內容">列出目錄內容</h3>
<ul>
<li>
<p><code>DirectoryStream</code> 介面可以找出目錄下所有檔案 / 目錄，但只限制在目錄下第一層</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;D:/&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">(</span><span class="n">DirectoryStream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newDirectoryStream</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="s">&#34;*&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="n">Path</span> <span class="n">file</span> <span class="o">:</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getFileName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PatternSyntaxException</span> <span class="o">|</span> <span class="n">DirectoryIteratorException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="讀取和寫入檔案">讀取和寫入檔案</h3>
<ul>
<li>
<p>Files 類別</p>
<ul>
<li>
<p><code>readAllBytes()</code> 和 <code>readAllLines()</code> 可以一次讀取檔案全部內容（但檔案不建議太大）</p>
</li>
<li>
<p><code>write()</code> 則提供寫入檔案的功能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">source</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/file.txt&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Charset</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">Charset</span><span class="o">.</span><span class="na">defaultCharset</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllLines</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">cs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">target</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/file2.txt&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">lines</span><span class="o">,</span> <span class="n">cs</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">CREATE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">TRUNCATE_EXISTING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">WRITE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;done...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<hr>
<h2 id="使用-files-類別操作-channel-io-和-stream-io-讀寫檔案">使用 Files 類別操作 Channel I/O 和 Stream I/O 讀寫檔案</h2>
<h3 id="介面-channel-和類別-bytebuffer">介面 Channel 和類別 <code>ByteBuffer</code></h3>
<ul>
<li>搭配使用 <code>Channel</code> interface 和 <code>ByteBuffer</code> class，可提高 I/O 效率
<ol>
<li><strong>Stream I/O</strong> 每次讀取一個位元或字元；<strong>Channel I/O</strong> 每次讀取一塊記憶體（buffer）</li>
<li><code>java.nio.channels.ByteChannel</code> interface 繼承 <code>Channel</code> interface，提供基本讀寫功能</li>
<li><code>java.nio.channels.SeekableByteChannel</code> interface 繼承 <code>ByteChannel</code>
<ul>
<li>提供在 channel 中讀寫時紀錄目前位置，且改變讀寫位置的能力，讓 <strong>隨機存取</strong>（<strong>random access</strong>）變得可能</li>
</ul>
</li>
<li>使用 <code>Files.newByteChannel(Path, OpenOption...)</code> 方法回傳 <code>SeekableByteChannel</code> 實例後，也可以再轉型為 <code>java.nio.channels.FileChannel</code> 類別</li>
</ol>
</li>
</ul>
<h3 id="隨機存取檔案">隨機存取檔案</h3>
<ul>
<li>
<p><code>SeekableByteChannel</code>介面可進行檔案內容的「隨機存取」</p>
<ol>
<li><!-- raw HTML omitted -->st<!-- raw HTML omitted --> step : 打開檔案</li>
<li><!-- raw HTML omitted -->nd<!-- raw HTML omitted --> step : 找到存取位置</li>
<li><!-- raw HTML omitted -->rd<!-- raw HTML omitted --> step : 開始讀寫</li>
</ol>
</li>
<li>
<p>常用方法（以下 channel 代表檔案）</p>
<table>
<thead>
<tr>
<th>常用方法</th>
<th>敘述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>position()</strong></td>
<td>回傳在 <code>channel</code> 中的位置</td>
</tr>
<tr>
<td><strong>position(long)</strong></td>
<td>設定在 <code>channel</code> 中的位置</td>
</tr>
<tr>
<td><strong>read(ByteBuffer)</strong></td>
<td>由 <code>channel</code> 中將資料讀入 buffer</td>
</tr>
<tr>
<td><strong>write(ByteBuffer)</strong></td>
<td>將資料由 buffer 中寫入 <code>channel</code></td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 使用 SeekableByteChannel 介面，將新增字串放在檔案指定位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/file.txt&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">(</span><span class="n">SeekableByteChannel</span> <span class="n">sbc</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newByteChannel</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">StandardOpenOption</span><span class="o">.</span><span class="na">WRITE</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="cm">/* 由 Files.newByteChannel() 取得 SeekableByteChannel 介面的實作物件
</span></span></span><span class="line"><span class="cl"><span class="cm">                該物件指向 path 所在檔案，並指定屬性為 StandardOpenOption.WRITE 所以可寫入 */</span>
</span></span><span class="line"><span class="cl">			<span class="kt">long</span> <span class="n">channelSize</span> <span class="o">=</span> <span class="n">sbc</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">sbc</span><span class="o">.</span><span class="na">position</span><span class="o">(</span><span class="n">channelSize</span><span class="o">);</span>     <span class="c1">// 將檔案讀取位置移到最尾端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;position: &#34;</span> <span class="o">+</span> <span class="n">sbc</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">			<span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">((</span><span class="s">&#34;\n&#34;</span> <span class="o">+</span> <span class="s">&#34;0&#34;</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span> 
</span></span><span class="line"><span class="cl">             <span class="c1">// 建立 ByteBuffer 物件，內容: &#34;\n&#34; + &#34;0&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">sbc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;position: &#34;</span> <span class="o">+</span> <span class="n">sbc</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
</li>
</ul>
<h3 id="對文字檔提供-buffered-io-方法">對文字檔提供 Buffered I/O 方法</h3>
<ul>
<li>
<p><code>NIO.2</code> 一樣可用 <code>BufferedReader / BufferedWriter</code> 物件提高檔案讀寫效率</p>
<ol>
<li>
<p>使用 <code>Files.newBufferedReader()</code> 取得 <code>java.io.BufferedReader</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newBufferedReader</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">charset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>Files.newBufferedWriter()</code> 取得 <code>java.io.BufferedWriter</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newBufferedWriter</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">charset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<h3 id="取得位元串流物件的方法">取得位元串流物件的方法</h3>
<ul>
<li>
<p><code>NIO.2</code> 也可以取得 <code>InputStream</code> 以及 <code>OutputStream</code> 物件</p>
<ol>
<li>
<p>使用 <code>Files.newInputStream()</code> 取得 <code>java.io.InputStream</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newInputStream</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BufferedReader</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">in</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>Files.newOutputStream()</code> 取得 <code>java.io.OutputStream</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/logFile.txt&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#34;Hi, Jim...&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">byte</span> <span class="n">data</span><span class="o">[]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newOutputStream</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">CREATE</span><span class="o">,</span> <span class="n">APPEND</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">BufferedOutputStream</span> <span class="n">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<hr>
<h2 id="讀寫檔案目錄的屬性">讀寫檔案/目錄的屬性</h2>
<h3 id="使用-files-管理檔案的屬性資料">使用 Files 管理檔案的屬性資料</h3>
<p><code>Files</code> class 提供若干管理檔案 / 目錄屬性的方法</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>size</code></td>
<td>回傳檔案大小（bytes）</td>
</tr>
<tr>
<td><code>isDirectory</code></td>
<td>判斷是否為目錄</td>
</tr>
<tr>
<td><code>isRegularFile</code></td>
<td>判斷是否為檔案</td>
</tr>
<tr>
<td><code>isSymbolicLink</code></td>
<td>判斷是否為 symbolic link</td>
</tr>
<tr>
<td><code>isHidden</code></td>
<td>是否為隱藏檔</td>
</tr>
<tr>
<td><code>getLastModifiedTime</code></td>
<td>取得最後修改時間</td>
</tr>
<tr>
<td><code>setLastModifiedTime</code></td>
<td>設定最後修改時間</td>
</tr>
<tr>
<td><code>getAttribute</code></td>
<td>取得屬性</td>
</tr>
<tr>
<td><code>setAttribute</code></td>
<td>設定屬性</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">Path</span> <span class="n">basic</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/metadata&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在相對路徑下，事先建立所有測試檔案
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;basic path: &#34;</span> <span class="o">+</span> <span class="n">basic</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">Path</span> <span class="n">common</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;file.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">Path</span> <span class="n">shortcut</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;dir.shortcut&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">Path</span> <span class="n">hidden</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;hiddenFile&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">Path</span> <span class="n">symlink</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;dir.sl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;size: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isDirectory: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isRegularFile: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isRegularFile</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>     
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isSymbolicLink(dir.sl): &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">(</span><span class="n">symlink</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isSymbolicLink(dir.shortcut): &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">(</span><span class="n">shortcut</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isHidden: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isHidden</span><span class="o">(</span><span class="n">hidden</span><span class="o">));</span>    
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="c1">// 取得並修改LastModifiedTime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getLastModifiedTime: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">getLastModifiedTime</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">FileTime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">FileTime</span><span class="o">.</span><span class="na">fromMillis</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 要設定檔案的時間屬性，必須使用類別 FileTime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">Files</span><span class="o">.</span><span class="na">setLastModifiedTime</span><span class="o">(</span><span class="n">common</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getLastModifiedTime: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">getLastModifiedTime</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 使用Files.setAttribute()方法設定hidden屬性	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Path</span> <span class="n">basic</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/metadata&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;basic path: &#34;</span> <span class="o">+</span> <span class="n">basic</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">Path</span> <span class="n">common</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;file.txt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Path</span> <span class="n">shortcut</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;dir.shortcut&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Path</span> <span class="n">hidden</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;hiddenFile&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Path</span> <span class="n">symlink</span> <span class="o">=</span> <span class="n">basic</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="s">&#34;dir.sl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;size: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isDirectory: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isRegularFile: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isRegularFile</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>		
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isSymbolicLink(dir.sl): &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">(</span><span class="n">symlink</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isSymbolicLink(dir.shortcut): &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">(</span><span class="n">shortcut</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isHidden: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">isHidden</span><span class="o">(</span><span class="n">hidden</span><span class="o">));</span>	
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="c1">//取得並修改LastModifiedTime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getLastModifiedTime: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">getLastModifiedTime</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">FileTime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">FileTime</span><span class="o">.</span><span class="na">fromMillis</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">		<span class="n">Files</span><span class="o">.</span><span class="na">setLastModifiedTime</span><span class="o">(</span><span class="n">common</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;getLastModifiedTime: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">getLastModifiedTime</span><span class="o">(</span><span class="n">common</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//設定hidden屬性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Files</span><span class="o">.</span><span class="na">setAttribute</span> <span class="o">(</span><span class="n">hidden</span><span class="o">,</span> <span class="s">&#34;dos:hidden&#34;</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isHidden: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">hidden</span><span class="o">,</span> <span class="s">&#34;dos:hidden&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">Files</span><span class="o">.</span><span class="na">setAttribute</span> <span class="o">(</span><span class="n">hidden</span><span class="o">,</span> <span class="s">&#34;dos:hidden&#34;</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;isHidden: &#34;</span> <span class="o">+</span> <span class="n">Files</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">hidden</span><span class="o">,</span> <span class="s">&#34;dos:hidden&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 除了用isHidden()方法測試屬性是否為hidden，也可以用getAttribute()方法搭配字串&#34;dos:hidden&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="讀取檔案屬性">讀取檔案屬性</h3>
<ul>
<li>
<p>過去 Java I/O 讀取檔案一次只能一個，每次呼叫都必須轉呼叫系統指令（system call）</p>
</li>
<li>
<p><code>NIO.2</code> 改進以上問題，可用 <code>DosFileAttributes</code> interface 一次取回檔案 / 目錄的所有屬性</p>
</li>
<li>
<p>以 Windows 之 DOS 為例，使用 Files class 取得物件實例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">DosFileAttributes</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAttributes</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">DosFileAttributes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>注意 Java 7 的 <code>DosFileAttributes</code> interface 只能讀取屬性，不能修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Path</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/attributeTest.txt&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">DosFileAttributes</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAttributes</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">DosFileAttributes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// basic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FileTime</span> <span class="n">creation</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">creationTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">FileTime</span> <span class="n">modified</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">lastModifiedTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">FileTime</span> <span class="n">lastAccess</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">lastAccessTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">(!</span><span class="n">attrs</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">isDirectory</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">isRegularFile</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isRegularFile</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">isSymbolicLink</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">isOther</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isOther</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// only for DOS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">boolean</span> <span class="n">archive</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isArchive</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">hidden</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isHidden</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">readOnly</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isReadOnly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="n">systemFile</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">isSystem</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/i4S6rSz.png"
        data-srcset="https://i.imgur.com/i4S6rSz.png, https://i.imgur.com/i4S6rSz.png 1.5x, https://i.imgur.com/i4S6rSz.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/i4S6rSz.png"
        title="1" /></p>
</li>
</ul>
<h3 id="修改檔案屬性">修改檔案屬性</h3>
<ul>
<li>
<p>建立檔案後可用 <code>Files</code> class 更改屬性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">createFile</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">&#34;dos:hidden&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>setAttribute()</code> 方法可設定 4 種 <strong>DOS 屬性</strong>，須指定屬性字串</p>
<ol>
<li><strong>dos:hidden</strong></li>
<li><strong>dos:readonly</strong></li>
<li><strong>dos:system</strong></li>
<li><strong>dos:archive</strong></li>
</ol>
</li>
<li>
<p>介面 <code>DosFileAttributeView</code> 也提供設定屬性的相關方法</p>
<ol>
<li><code>setHidden()</code></li>
<li><code>setReadOnly()</code></li>
<li><code>setSystem()</code></li>
<li><code>setArchive()</code></li>
</ol>
</li>
<li>
<p>可以使用 class Files 取得該介面的物件實例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">DosFileAttributeView</span> <span class="n">view</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">getFileAttributeView</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">DosFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>DosFileAttributeView</code> 有直接方法可以設定檔案屬性</p>
<ul>
<li>
<p>如果要讀取屬性，需先用 <code>readAttributes()</code> 方法取得 <code>DosFileAttributes</code>物件實例，分工：</p>
<ol>
<li>
<p>interface <code>DosFileAttributeView</code> : <strong>改變</strong> 檔案屬性</p>
</li>
<li>
<p>interface <code>DosFileAttributes</code> : <strong>讀取</strong> 檔案屬性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/cel/attributeTest.md&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">DosFileAttributeView</span> <span class="n">view</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">getFileAttributeView</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">DosFileAttributeView</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 取得 DosFileAttributeView 的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="o">.</span><span class="na">setArchive</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="o">.</span><span class="na">setReadOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="o">.</span><span class="na">setHidden</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="o">.</span><span class="na">setSystem</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FileTime</span> <span class="n">lastModifiedTime</span> <span class="o">=</span> <span class="n">FileTime</span><span class="o">.</span><span class="na">fromMillis</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">FileTime</span> <span class="n">lastAccessTime</span> <span class="o">=</span> <span class="n">FileTime</span><span class="o">.</span><span class="na">fromMillis</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">FileTime</span> <span class="n">createTime</span> <span class="o">=</span> <span class="n">FileTime</span><span class="o">.</span><span class="na">fromMillis</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span><span class="o">.</span><span class="na">setTimes</span><span class="o">(</span><span class="n">lastModifiedTime</span><span class="o">,</span> <span class="n">lastAccessTime</span><span class="o">,</span> <span class="n">createTime</span><span class="o">);</span>    
</span></span><span class="line"><span class="cl"><span class="cm">/* 設定檔案相關時間，Windows每個檔案屬性都有3個時間：建立日期(createTime)、
</span></span></span><span class="line"><span class="cl"><span class="cm">   最後修改日期(lastModifiedTime)、最後存取日期(lastAccessTime) */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DosFileAttributes</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">readAttributes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 取得 DosFileAttributes 的方法
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="dos-之外的-file-attribute-views">DOS 之外的 File Attribute Views</h3>
<p>除了 DOS 之外，<code>NIO.2</code> 其它可支援的 attribute views 還包含</p>
<ol>
<li>
<p><code>BasicFileAttributeView</code> : 提供所有檔案系統都支援的基本屬性</p>
</li>
<li>
<p><code>PosixFileAttributeView</code> : 支援 <code>POSIX</code> 家族，例如 <code>UNIX</code></p>
</li>
<li>
<p><code>FileOwnerAttributeView</code> : 支援所有具備「<strong>檔案擁有者</strong>（file owner）」概念的檔案系統</p>
</li>
<li>
<p><code>AclFileAttributeView</code> : 支援讀寫檔案的「<strong>存取控制清單</strong>（access control list）」</p>
</li>
<li>
<p><code>UserDefinedFileAttributeView</code> : 讓使用者自行定義</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/IiluySs.png"
        data-srcset="https://i.imgur.com/IiluySs.png, https://i.imgur.com/IiluySs.png 1.5x, https://i.imgur.com/IiluySs.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/IiluySs.png"
        title="image-20221228143511740" /></p>
</li>
</ol>
<h3 id="posix-檔案系統的權限"><code>POSIX</code> 檔案系統的權限</h3>
<ul>
<li>
<p><code>NIO.2</code> 可以在如 MacOS、Linux、Solaris 等 POSIX（Portable Operating System Interface）檔案系統中建立檔案 / 目錄。Windows 非 POSIX 相容的作業系統</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 如何取得目前作業系統支援的所有 AttributeView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">supportedFileAttributeViews</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>POSIX 檔案系統中，使用 ACL 進行檔案 / 目錄的權限控管</p>
<ul>
<li>ACL（Access Control List 存取控制清單）: 提供對檔案 / 目錄擁有權相關的三種使用者群組
<ol>
<li>owner（檔案擁有者）</li>
<li>group（檔案擁有者所在群組）</li>
<li>other（非 owner 和 group 的其它人）</li>
</ol>
</li>
</ul>
</li>
<li>
<p>對檔案 / 目錄的 read、write、execute（讀寫執行）權限設定格式</p>
<table>
<thead>
<tr>
<th style="text-align:center">user</th>
<th style="text-align:center">group</th>
<th style="text-align:center">other</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">r    |    w    |    x</td>
<td style="text-align:center">r    |   w   |   x</td>
<td style="text-align:center">r   |   w   |    x</td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr>
<h2 id="遞迴存取目錄結構">遞迴存取目錄結構</h2>
<h3 id="對檔案目錄進行遞迴操作">對檔案目錄進行遞迴操作</h3>
<ul>
<li>
<p><code>DirectoryStream</code> 物件可拜訪目錄下所有檔案 / 目錄，但被限制在以下一層</p>
</li>
<li>
<p><code>Files.walkFileTree(Path start, FileVisitor&lt;T&gt;visitor)</code> 則可以遞迴辦訪所有層級的所有檔案 / 目錄，並對拜訪過的所有檔案 / 目錄採取「<strong>特定動作</strong>」，將由覆寫<code>FileVisitor</code>介面的方法來提供</p>
<ol>
<li><code>preVisitDirectory()</code>：拜訪目錄<strong>前</strong>要做的事</li>
<li><code>visitFile()</code>：拜訪檔案時要做的事</li>
<li><code>postVisitDirectory()</code>：拜訪目錄<strong>後</strong>要做的事</li>
<li><code>visitFileFailed()</code>：拜訪檔案若<strong>失敗</strong>要做的事</li>
</ol>
</li>
<li>
<p>藉由每次拜訪檔案 / 目錄後的回傳值（列舉型別<code>FileVisitResult</code>的列舉項目）決定是否繼續拜訪其他檔案 / 目錄</p>
<ol>
<li><code>CONTINUE</code>：繼續</li>
<li><code>SKIP_SIBLINGS</code>：略過同一層的檔案 / 目錄</li>
<li><code>SKIP_SUBTREE</code>：略過下一層檔案樹</li>
<li><code>TERMINATE</code>：結束</li>
</ol>
</li>
<li>
<p>實作 <code>FileVisitor</code> 介面的類別必須覆寫所有抽象方法，比較麻煩</p>
<ul>
<li>可考慮改繼承 <code>SimpleFileVisitor</code>類別
<ul>
<li><code>SimpleFileVisitor</code>已實作<code>FileVisitor</code>介面所有抽象方法，且都回傳 CONTINUE，因此只要覆寫真正需要的方法</li>
</ul>
</li>
</ul>
</li>
<li>
<p>範例</p>
<ol>
<li>
<p>使用<code>Files.walkFileTree()</code>搭配<code>FileVistor</code>介面地回所有目錄</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/ifqJI3C.png"
        data-srcset="https://i.imgur.com/ifqJI3C.png, https://i.imgur.com/ifqJI3C.png 1.5x, https://i.imgur.com/ifqJI3C.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/ifqJI3C.png"
        title="11" /></p>
</li>
<li>
<p>先以<strong>系統管理員</strong>身分開啟命令提示字元，再用<code>mklink</code>指令建立<em>symbolic link</em> 檔案與目錄</p>
<pre tabindex="0"><code class="language-terminal" data-lang="terminal">C:\java11\code\java11-ocp-2\dir\c06\walkFileTree&gt;mklink dir.sl dir
symbolic link created for dir.sl &lt;&lt;===&gt;&gt; dir

C:\java11\code\java11-ocp-2\dir\c06\walkFileTree&gt;mklink file.sl file.txt
symbolic link created for file.sl &lt;&lt;===&gt;&gt; file.txt
</code></pre></li>
</ol>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SimplePrintTree</span> <span class="kd">extends</span> <span class="n">SimpleFileVisitor</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">PrintTree</span> <span class="kd">implements</span> <span class="n">FileVisitor</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">FileVisitResult</span> <span class="nf">preVisitDirectory</span><span class="o">(</span><span class="n">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="n">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(++</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#34;. preVisitDirectory: &#34;</span> <span class="o">+</span> <span class="n">dir</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FileVisitResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">FileVisitResult</span> <span class="nf">visitFile</span><span class="o">(</span><span class="n">Path</span> <span class="n">file</span><span class="o">,</span> <span class="n">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(++</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#34;.visitFile: &#34;</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">attrs</span><span class="o">.</span><span class="na">isSymbolicLink</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\t --&gt; &#34;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; is SymbolicLink&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FileVisitResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">FileVisitResult</span> <span class="nf">visitFileFailed</span><span class="o">(</span><span class="n">Path</span> <span class="n">file</span><span class="o">,</span> <span class="n">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(++</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#34;. visitFileFailed: &#34;</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FileVisitResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">FileVisitResult</span> <span class="nf">postVisitDirectory</span><span class="o">(</span><span class="n">Path</span> <span class="n">dir</span><span class="o">,</span> <span class="n">IOException</span> <span class="n">exc</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(++</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#34;. postVisitDirectory: &#34;</span> <span class="o">+</span> <span class="n">dir</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FileVisitResult</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WalkFileTreeExample</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/c04/walkFileTree&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="k">new</span> <span class="n">PrintTree</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Files.walkFileTree(path, new SimplePrintTree());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Exception: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>執行順序示意圖：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/HyZY1QQ.png"
        data-srcset="https://i.imgur.com/HyZY1QQ.png, https://i.imgur.com/HyZY1QQ.png 1.5x, https://i.imgur.com/HyZY1QQ.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/HyZY1QQ.png"
        title="11" /></p>
<hr>
<h2 id="使用-pathmatcher-類別找尋符合的檔案">使用 <code>PathMatcher</code> 類別找尋符合的檔案</h2>
<h3 id="搜尋檔案">搜尋檔案</h3>
<ul>
<li>
<p>在某路徑下，若想找出所有<code>java</code>程式碼檔案，含搜尋子目錄，Windows下可使用指令<code>dir /s *.java</code></p>
</li>
<li>
<p>Java 則使用 <code>java.nio.file.PathMatcher</code>介面，用來搜尋符合特定字串的路徑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="n">PathMatcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">getPathMatcher</span><span class="o">(</span><span class="n">String</span> <span class="n">syntaxAndPattern</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>參數 <code>syntaxAndPattern</code> 的語法為「syntax:pattern」，有兩種 syntax</p>
<ol>
<li>glob 樣式（global command）
<ul>
<li>較 regex 簡單許多，廣泛應用於檔案系統中的檔案搜尋</li>
</ul>
</li>
<li>regex 樣式（regular expression）
<ul>
<li>正規表示式</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="glob-樣式語法介紹"><code>glob</code> 樣式語法介紹</h3>
<h4 id="常見字元或符號的代表意義">常見字元或符號的代表意義</h4>
<table>
<thead>
<tr>
<th>字元</th>
<th>使用方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>任何個數的萬用字元，不跨目錄</td>
</tr>
<tr>
<td><code>**</code></td>
<td>任何個數的萬用字元，跨目錄</td>
</tr>
<tr>
<td><code>?</code></td>
<td>代表 1 個字元</td>
</tr>
<tr>
<td><code>\</code></td>
<td>跳脫（Escape）符號</td>
</tr>
<tr>
<td><code>[ ]</code></td>
<td>找出符合的單一字元，例如<!-- raw HTML omitted -->1. <code>[abc]</code> 表示 a 或 b 或 c<!-- raw HTML omitted -->2. <code>[a-z]</code> 表示可以是 a~z 的任何一個字元<!-- raw HTML omitted -->3. <code>[abce-g]</code> 表示 a 或 b 或 c 或 e 或 f 或 g<!-- raw HTML omitted -->4. <code>[!a-c]</code> 表示非（a 或 b 或 c）<!-- raw HTML omitted --><code>[ ]</code> 裡面的 <code>*</code> 和 <code>?</code> 和 <code>\</code> 失去特殊意義<!-- raw HTML omitted -->符號 <code>-</code> 如果排第一個，或僅次於<code>!</code>，也只代表符號本身</td>
</tr>
<tr>
<td><code>{ }</code></td>
<td><code>{ }</code> 內可以有多個 sub-pattern，使用「,」區隔，滿足一個就成立</td>
</tr>
<tr>
<td><code>.</code></td>
<td>檔名前面以「<code>.</code>」開頭，例如「<code>.login</code>」，比較方式如同一般檔案<!-- raw HTML omitted -->這類檔案通常都是 hidden，可以使用 <code>Files.isHidden</code> 測試</td>
</tr>
</tbody>
</table>
<h4 id="global-pattern-使用範例">global pattern 使用範例</h4>
<table>
<thead>
<tr>
<th>樣式內容</th>
<th>比對符合</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*.java</code></td>
<td>檔名以 <code>.java</code> 結尾</td>
</tr>
<tr>
<td><code>*.*</code></td>
<td>檔名中間有 <code>.</code></td>
</tr>
<tr>
<td><code>*.{java,class}</code></td>
<td>檔名以 <code>.java</code> 或 <code>.class</code> 結尾</td>
</tr>
<tr>
<td><code>foo.?</code></td>
<td>檔名以 <code>foo.</code>開頭，後面接1個字元</td>
</tr>
<tr>
<td><code>C:\\</code></td>
<td><code>C:\foo</code> 或 <code>C:\bar</code> 都符合，在Java中，樣式為 <code>C:\\\\*</code></td>
</tr>
<tr>
<td><code>/home/*</code></td>
<td>滿足 <code>/home/gus</code>（未跨路徑）</td>
</tr>
<tr>
<td><code>/home/*/*</code></td>
<td>滿足 <code>/home/gus/data</code>（未跨路徑）</td>
</tr>
<tr>
<td><code>/home/**</code></td>
<td>滿足 <code>/home/gus</code> 和 <code>/home/gus/data</code>（跨路徑）</td>
</tr>
</tbody>
</table>
<h4 id="相關-api-使用釋例">相關 API 使用釋例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">publi</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FileSystem</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;D:/1/2/3/Test.java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">PathMatcher</span> <span class="n">pathMatcher1</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="na">getPathMatcher</span><span class="o">(</span><span class="s">&#34;glob:D:/*.java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pathMatcher1</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">PathMatcher</span> <span class="n">pathMatcher2</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="na">getPathMatcher</span><span class="o">(</span><span class="s">&#34;glob:D:/*/*.java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pathMatcher2</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">PathMatcher</span> <span class="n">pathMatcher3</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="na">getPathMatcher</span><span class="o">(</span><span class="s">&#34;glob:D:/**/*.java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pathMatcher3</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>Line#</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>7</td>
<td>滿足 D 磁碟機下的 java 程式檔（未跨目錄）= true</td>
</tr>
<tr>
<td>10</td>
<td>滿足 D 磁碟機下且第一層目錄裡面的 java 程式檔（未跨目錄）= false</td>
</tr>
<tr>
<td>13</td>
<td>滿足 D 磁碟機下且**跨目錄（需有目錄）**的 java 程式檔 = false</td>
</tr>
</tbody>
</table>
<h4 id="延伸案例">延伸案例</h4>
<table>
<thead>
<tr>
<th>glob 樣式內容</th>
<th><code>D:/*.java</code></th>
<th><code>D:/*/*.java</code></th>
<th><code>D:/**/*.java</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>路徑：<code>D:/Test.java</code></td>
<td><strong>TRUE</strong></td>
<td>false</td>
<td>false</td>
</tr>
<tr>
<td>路徑：<code>D:/1/Test.java</code></td>
<td>false</td>
<td><strong>TRUE</strong></td>
<td><strong>TRUE</strong></td>
</tr>
<tr>
<td>路徑：<code>D:/1/2/Test.java</code></td>
<td>false</td>
<td>false</td>
<td><strong>TRUE</strong></td>
</tr>
<tr>
<td>路徑：<code>D:/1/2/3/Test.java</code></td>
<td>false</td>
<td>false</td>
<td><strong>TRUE</strong></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>也可以用 <code>Files.walkFileTree()</code> 架構走訪所有檔案，搭配 <code>PathMather</code> 的 <code>FileVisitor</code> 介面實作類別，判斷檔名是否符合 glob 樣式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Finder</span> <span class="kd">extends</span> <span class="n">SimpleFileVisitor</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PathMatcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">getPathMatcher</span><span class="o">(</span><span class="s">&#34;glob:*.java&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">numMatches</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">find</span><span class="o">(</span><span class="n">Path</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getFileName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">numMatches</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">FileVisitResult</span> <span class="nf">visitFIle</span><span class="o">(</span><span class="n">Path</span> <span class="n">file</span><span class="o">,</span> <span class="n">BasicFileAttributes</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">find</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">CONTINUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PathMatcherTest2</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">root</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">).</span><span class="na">toAbsolutePath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;root: &#34;</span> <span class="o">+</span> <span class="n">root</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Finder</span> <span class="n">finder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Finder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">finder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Exception: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;----\n&#34;</span> <span class="o">+</span> <span class="n">finder</span><span class="o">.</span><span class="na">numMatches</span> <span class="o">+</span> <span class="s">&#34; found!!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h2 id="其它">其它</h2>
<h3 id="filestore-類別"><code>FileStore</code> 類別</h3>
<ul>
<li><code>FileStore</code> 用來提供檔案系統的使用狀況</li>
<li>可以取得總容量、已用空間、未用空間等數據
<ul>
<li>例如 Windows OS 的磁碟、磁區；Linux OS 的掛載點 mount point</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">printFileStore</span><span class="o">(</span><span class="n">FileStore</span> <span class="n">store</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">toGB</span> <span class="o">=</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getTotalSpace</span><span class="o">()</span> <span class="o">/</span> <span class="n">toGB</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">used</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getTotalSpace</span><span class="o">()</span> <span class="o">/</span> <span class="n">toGB</span> <span class="o">-</span> <span class="n">store</span><span class="o">.</span><span class="na">getUnallocatedSpace</span><span class="o">()</span> <span class="o">/</span> <span class="n">toGB</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getUsableSpace</span><span class="o">()</span> <span class="o">/</span> <span class="n">toGB</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;%-20s %12d(GB) %12d(GB) %12d(GB)\n&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">store</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">total</span><span class="o">,</span> <span class="n">used</span><span class="o">,</span> <span class="n">avail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;%-20s %12s %12s %12s\n&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                     <span class="s">&#34;Filesystem&#34;</span><span class="o">,</span> <span class="s">&#34;total&#34;</span><span class="o">,</span> <span class="s">&#34;used&#34;</span><span class="o">,</span> <span class="s">&#34;avail&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">FileStore</span> <span class="n">store</span> <span class="o">:</span> <span class="n">FileSystems</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">getFileStores</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">printFileStore</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">file</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">FileStore</span> <span class="n">store</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">getFileStore</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">printFileStore</span><span class="o">(</span><span class="n">store</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>Line#</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>11</td>
<td>取得檔案系統裡所有 <code>FileStore</code> 物件</td>
</tr>
<tr>
<td>16</td>
<td>根據 <code>Path</code> 取得 <code>FileStore</code> 物件</td>
</tr>
</tbody>
</table>
<h3 id="使用-watchservice">使用 <code>WatchService</code></h3>
<p>介面 <code>WatchService</code> 可用來監控目錄 Path 內的檔案何時被新增、刪除、修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyWatchService</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">WatchService</span> <span class="n">ws</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">MyWatchService</span><span class="o">(</span><span class="n">WatchService</span> <span class="n">ws</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">WatchKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="n">WatchEvent</span> <span class="n">event</span> <span class="o">:</span> <span class="n">key</span><span class="o">.</span><span class="na">pollEvents</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;Received event: %s for file: %s\n&#34;</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">kind</span><span class="o">(),</span> <span class="n">event</span><span class="o">.</span><span class="na">context</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">key</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WatchServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">DIRECTORY_TO_WATCH</span> <span class="o">=</span> <span class="s">&#34;D://WatchServiceTest&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">Path</span> <span class="n">watchPath</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DIRECTORY_TO_WATCH</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Files</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">watchPath</span><span class="o">)</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">watchPath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">WatchService</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">watchPath</span><span class="o">.</span><span class="na">getFileSystem</span><span class="o">().</span><span class="na">newWatchService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyWatchService</span> <span class="n">fileWatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyWatchService</span><span class="o">(</span><span class="n">ws</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">fileWatcher</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// register a file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">watchPath</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="n">ENTRY_CREATE</span><span class="o">,</span> <span class="n">ENTRY_MODIFY</span><span class="o">,</span> <span class="n">ENTRY_DELETE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>    
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="由基礎-io-轉換至-nio2">由基礎 I/O 轉換至 NIO.2</h3>
<p>JDK.7 - 在傳統的 <code>java.io.File</code> 類別中新增方法，使其可以轉換至 NIO.2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">toPath</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Path 也可以轉換至傳統的 <code>java.io.File</code> 物件，方便從基礎 I/O 升級到 NIO.2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">toFile</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h1 id="05-執行緒">05 執行緒</h1>
<h2 id="介紹">介紹</h2>
<h3 id="名詞說明">名詞說明</h3>
<h4 id="先占式多工preemptive-multitasking">先占式多工（Preemptive Multitasking）</h4>
<ul>
<li>現代電腦要執行的程式個數經常遠多於 CPU 核數，為了讓程式都可以有機會執行，每個要執行的任務會被分配到一小段 CPU 時間（time slice），使每個任務都能分享到 CPU 資源來完成工作</li>
<li>CPU 時間通常以毫秒 <code>milliseconds</code> 來計算，一旦使用完畢，任務就暫停執行，等待下次分配</li>
</ul>
<h4 id="任務排程task-scheduling">任務排程（Task Scheduling）</h4>
<ul>
<li>大部分作業系統都支援多工（multitasking），把 CPU 時間分配給所有執行程式</li>
<li>程式兩個重要組成
<ol>
<li><strong>程序 Process</strong>
<ul>
<li>擁有記憶體來儲存資料（data）和程式碼（code）</li>
<li>使用執行緒接受分配 CPU 時間以執行程式</li>
</ul>
</li>
<li><strong>執行緒 Thread</strong>
<ul>
<li>程序可同時擁有多個執行緒各司其職</li>
<li>這些執行緒共享程序的記憶體裡的資料</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="多執行緒的重要性">多執行緒的重要性</h3>
<p>要讓程式快速執行，必須避免「效能瓶頸（<em>performance bottlenecks</em>）」，常見瓶頸：</p>
<ol>
<li><strong>資源競爭</strong>（<strong>Resource Contention</strong>）：多個任務搶奪同一獨佔資源，未搶到必須等待</li>
<li><strong>輸出/輸入操作阻礙</strong>（<strong>I/O Operations Blocking</strong>）：通常為等待硬碟或網路傳輸資料</li>
<li><strong>CPU 資源未充分使用</strong>（<strong>Underutilization of CPUs</strong>）：程式只用到單核 CPU</li>
</ol>
<h3 id="執行緒類別">執行緒類別</h3>
<p>Java 類別 Thread 的兩種建立方式：</p>
<table>
<thead>
<tr>
<th>action</th>
<th>benefits/perks</th>
</tr>
</thead>
<tbody>
<tr>
<td>直接繼承 Thread 類別</td>
<td>比較簡單</td>
</tr>
<tr>
<td>實作 Runnable 介面</td>
<td>比較有彈性，可以再繼承其它類別</td>
</tr>
</tbody>
</table>
<h4 id="建立執行緒直接繼承-thread-類別">建立執行緒：直接繼承 Thread 類別</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ExampleThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>  <span class="c1">// #1 繼承 java.lang.Thread 類別
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  <span class="c1">// #2 覆寫 run() 方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;i:&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>啟用執行緒：</p>
<ul>
<li>
<p>要呼叫 <code>start()</code> 方法，Java 會啟動獨立執行緒執行 <code>run()</code> 方法內容</p>
</li>
<li>
<p>若直接呼叫 <code>run()</code> 方法，將和一般方法無異</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExampleThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h4 id="建立執行緒實作-runnable-介面">建立執行緒：實作 Runnable 介面</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ExampleRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>  <span class="c1">// #1 實作 java.lang.Runnable 介面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>   
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// #2 覆寫 run() 方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;i:&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>若要以實作 <code>Runnable</code> 的類別啟動執行緒，可將其物件放入 Thread 類別的建構子，並用 <code>start()</code> 啟動</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExampleRunnable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span> <span class="c1">// 將 ExampleRunnable 物件放入 Thread constructor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="執行緒常見問題">執行緒常見問題</h2>
<p>執行緒常遇到問題的三類原因：</p>
<ol>
<li>使用分享的資料 <em>shared data</em></li>
<li>使用可分段的方法 <em>non-atomic function</em></li>
<li>使用快取的資料 <em>cached data</em></li>
</ol>
<h3 id="使用-shared-data-可能造成的問題">使用 <code>Shared Data</code> 可能造成的問題</h3>
<p>執行緒會潛在 static 和 instance 欄位，可能造成問題如下：</p>
<ol>
<li>
<p>執行緒物件目的在執行其 <code>run()</code> 方法</p>
<ul>
<li>若多個執行緒都要執行 <code>run()</code>，就要注意該方法共用的部分</li>
<li>例如：物件實例欄位會被同時存取（concurrently accessed）</li>
</ul>
</li>
<li>
<p>static 欄位原本就是分享的資料，也無法避免同時被存取的情況</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>  <span class="c1">// 將被共用!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;i:&#34;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ExampleRunnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExampleRunnable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/h3ufiAX.png"
        data-srcset="https://i.imgur.com/h3ufiAX.png, https://i.imgur.com/h3ufiAX.png 1.5x, https://i.imgur.com/h3ufiAX.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/h3ufiAX.png"
        title="image-20221218163741687" /></p>
<ul>
<li>
<p>以上結果和預期結果有落差</p>
<p><code>i:0, i:1, i:2, i:3, i:4, i:5, i:6, i:7, i:8, i:9,</code></p>
</li>
<li>
<p>當前述類別（<strong>static</strong>）和物件實例（<strong>instance</strong>）欄位資料被多個執行緒共用，出現執行異常時，IDE 是無法警告的</p>
</li>
<li>
<p>因此 <em><strong>安全地（safely）處理被分享的資料</strong></em>，就成為程式設計師的義務</p>
</li>
<li>
<p>資料若因為多個執行緒同時存取而產生錯誤，一般不好處理</p>
<ol>
<li>Thread 的分配由作業系統決定，程式設計師無法干預</li>
<li>每一台機器的 CPU 效能、個數不盡然相同</li>
<li>其它程式也會占用 CPU 時間</li>
</ol>
</li>
<li>
<p>因此可能有在測試環境無異常，但部署到正式環境後卻經常發生奇怪狀況</p>
<ul>
<li>盡可能使用執行緒安全的設計（thread-safe），減少使用 <code>shared data</code></li>
</ul>
</li>
<li>
<p>類別內有些資料不會被多執行緒分享，永遠都 <code>thread-safe</code> 的例子</p>
<ol>
<li>區域變數 <em>local variables</em></li>
<li>方法參數 <em>method parameters</em></li>
<li>例外處理參數 <em>exception handler parameters</em></li>
</ol>
</li>
</ul>
</li>
</ol>
<h3 id="使用-non-atomic-functions-可能造成的問題">使用 <code>Non-Atomic Functions</code> 可能造成的問題</h3>
<ul>
<li><code>atomic function</code> - 用原子的概念描述一個功能
<ul>
<li>原子無法再分割，代表 <code>single function</code>，即該功能只有一個步驟</li>
</ul>
</li>
<li>Java 裡，即使程式碼只有一句敘述，也不代表它就是 <code>atomic function</code>
<ul>
<li>以整數 i 使用 遞增運算子的 <code>i++</code> 為例，Java 以 3 個步驟執行
<ol>
<li>對整數 <code>i</code> 建立暫時副本</li>
<li>暫時副本增加 1</li>
<li>將暫時副本的結果回寫 <code>i</code></li>
</ol>
</li>
<li>另外有些 64 bit 變數的存取也可以使用 2 個 32 bit 的操作完成</li>
</ul>
</li>
</ul>
<h3 id="使用-cached-data-可能造成的問題">使用 <code>Cached Data</code> 可能造成的問題</h3>
<ul>
<li>執行緒 <code>thread</code> 因為程序 <code>process</code> 需要同時執行不同工作而產生</li>
<li>為求執行效能，執行緒啟動時，會將程序中的 <code>main memory</code> 內的分享資料複製一份，放在自己的 <code>working memory</code> 作為快取複製（<code>cached copies</code>），工作結束後寫回，如此一來可以避免程式進行過程中，執行緒必須不斷向程序要求資料而造成的效率問題</li>
<li>這樣的設計，讓執行過程中的每一執行緒各自努力，無法<strong>即時</strong>和其他執行緒分享工作成果，必須等到工作結束</li>
<li>只有以下情況才能讓執行緒將各自 working memory 的異動結果寫回 main memory：
<ol>
<li>使用到 <code>volatile</code> 宣告的變數</li>
<li>使用到 <code>synchronized</code> 宣告的方法，亦即準備鎖定和解索物件 monitor</li>
<li>執行緒執行時的第一個動作或最後一個動作</li>
<li>執行緒啟動或執行緒結束時</li>
</ol>
</li>
<li>若程式設計需要多執行緒在工作過程仍然能互相溝通訊息，就必須善用上述四個條件
<ul>
<li>尤其是使用 <code>volatile</code> 關鍵字宣告，其由來和使用方式：
<ol>
<li>程式設計中，如果資料經常維持不變，可以將之固定在記憶體裡，或複製出來使用，稱之為「<strong>快取複製</strong>（cached copies）」</li>
<li>單字 <code>volatile</code> 解釋為「<strong>易變的、反覆無常的</strong>」：
<ul>
<li>加上此宣告相當於告訴 Java 該欄位經常有變化，不適合產生快取複製</li>
<li>因此所有執行緒將皆存取同一份資料，例：<code>volatile int i;</code></li>
</ul>
</li>
<li>必須了解宣告 <code>volatile</code> 只是不產生快取複製，和執行緒安全是兩回事
<ul>
<li>還是必須利用先前所提的作法來保證執行緒安全</li>
<li>volatile 宣告可以應用在「精準終止執行緒的執行」</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>  <span class="c1">// line 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread started&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread finishing&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StopThreadExample</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MyRunnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyRunnable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>       <span class="c1">// line 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r1</span><span class="o">.</span><span class="na">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// line 19 : terminate the thread immediately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>line#</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>16</td>
<td>thread <code>t1</code> 在啟動前<strong>預設</strong>會自己複製一份變數 running（值=true）作為快取複製</td>
</tr>
<tr>
<td>2</td>
<td>所以如果沒有宣告變數 running 為 <code>volatile</code></td>
</tr>
<tr>
<td>19</td>
<td>即便在 main 執行緒將 running 改為 false，執行緒 t1 不一定會馬上知道，必須等到有事件觸發，讓 working memory 和 main memory 同步，執行緒 <code>t1</code> 才會收到通知而停止</td>
</tr>
</tbody>
</table>
<p>&hellip;</p>
<h2 id="執行緒的-synchronized-與等待">執行緒的 synchronized 與等待</h2>
<h3 id="使用-synchronized-關鍵字">使用 <code>synchronized</code> 關鍵字</h3>
<ul>
<li>
<p>建立執行緒安全的程式，除了盡量使用執行緒安全的變數之外，就是使用「<strong>synchronized</strong>」關鍵字宣告<em>方法</em>或是<em>更小的程式碼區塊</em>：</p>
<ol>
<li><code>synchronized</code> 和 <code>volatile</code> 宣告有類似功用：
<ul>
<li>執行緒在執行該區塊的最初和最後時，會將變數值寫回 main memory</li>
</ul>
</li>
<li>該區塊為獨占執行（<em>exclusive execution</em>）：
<ul>
<li>亦即同一時間只允許一個執行緒使用</li>
<li>可解決 <code>non-atomic</code>問題，所以區塊內為執行緒安全</li>
</ul>
</li>
</ol>
</li>
<li>
<p>執行緒取得獨占執行權的機制：</p>
<ol>
<li>
<p>每個 Java 物件都有一個「<strong>object monitor</strong>」，執行緒可以對它進行鎖定（lock）和解鎖（unlock）</p>
<ul>
<li>若鎖定成功，表示取得該物件的獨占執行權</li>
<li>此時其它執行緒無法使用該物件的 <code>synchronized</code> 程式區塊，等同單一執行緒環境</li>
</ul>
</li>
<li>
<p>要使用宣告 <code>synchronized</code> 的方法，就必須取得「<strong>this</strong>」的 object monitor</p>
</li>
<li>
<p>要使用宣告 <code>static</code> 的方法，同理也必須取得類別的「<strong>class monitor</strong>」</p>
</li>
<li>
<p>要使用宣告 <code>synchronized</code> 區塊，必須指定要使用哪一個物件的 monitor</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>synchronized</code> 區塊可以有巢狀結構，且可以使用不同的 object monitor</p>
</li>
</ol>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SynchronizedAll</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">5000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">m1</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">sleep</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-- Run m1() at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">m2</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">sleep</span><span class="o">();</span>	
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-- Run m2() at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="cm">/* 將兩個public方法都宣告為synchronized，如此建立出的物件，
</span></span></span><span class="line"><span class="cl"><span class="cm">     m1()和m2()方法將同時只能有一個被呼叫執行 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">M1Runner</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SynchronizedAll</span> <span class="n">o</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">M1Runner</span><span class="o">(</span><span class="n">SynchronizedAll</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">o</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 建立執行緒類別M1Runner，在建構子傳入一個SynchronizedAll物件後，呼叫m1()方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">o</span><span class="o">.</span><span class="na">m1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">M2Runner</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SynchronizedAll</span> <span class="n">o</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">M2Runner</span><span class="o">(</span><span class="n">SynchronizedAll</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">o</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 建立執行緒類別M2Runner，在建構子傳入一個SynchronizedAll物件後，呼叫m2()方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">o</span><span class="o">.</span><span class="na">m2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SynchronizedAll</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SynchronizedAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 建立一個 SynchronizedAll 物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Start main at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">		<span class="n">Thread</span> <span class="n">m1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">M1Runner</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">m1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 建立 M1Runner 執行緒物件，並傳入之前建立的 SynchronizedAll 物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">		<span class="n">Thread</span> <span class="n">m2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">M2Runner</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">m2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 建立 M2Runner 執行緒物件，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 並傳入和 M1Runner 所傳入的相同的 SynchronizedAll 物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">		<span class="c1">//m1.interrupt();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;End main at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>因為 <code>SynchronizedAll</code> 內 <code>m1()</code> 及 <code>m2()</code> 方法都是 <code>synchronized</code>，要執行都要取得 this 的 object monitor，因此同時間只能有一個方法被呼叫</p>
</blockquote>
<h3 id="使用-synchronized-的時機">使用 <code>synchronized</code> 的時機</h3>
<ul>
<li><code>java.util.ConcurrentModificationException</code> :
<ul>
<li>如果 Java 偵測到集合物件的內容將被同時修改（不限定是否多執行緒所為），就會拋出 <code>ConcurrentModificationException</code>
<ul>
<li>此為「<strong>fail-fast</strong>」行為模式，亦即對於錯誤或是可能造成錯誤的情況，馬上作出反應</li>
<li>為了避免發生 <strong>fail-fast</strong> 狀況，應避免在執行 <code>getSummary()</code> 方法時，其它 2 個方法被同時呼叫
<ul>
<li>可以將這三個方法都宣告為 <code>synchronized</code>，如此要呼叫方法前，必須取得該物件的唯一 <strong>object monitor</strong>，就不會有被同時執行的可能性</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>ConcurrentModificationException</code> 不是只有在多執行緒的情況下才會發生
<ul>
<li>以下的 <strong>fail-fast_1</strong> 或 <strong>fail-fast_2</strong> 會拋出 <code>ConcurrentModificationException</code>
<ul>
<li>原因：使用 iterator 或進階 for-loop 走訪 map 物件成員，同時去刪除 map 成員</li>
<li>避免方法：
<ul>
<li>複製 map，讓新複製的 map 用於走訪成員</li>
<li>再用取得的 key 刪除另外一個 map 物件的成員</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentModificationExceptionTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="s">&#34;b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="s">&#34;c&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// fail-fast 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ConcurrentModificationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// fail-fast 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">key</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ConcurrentModificationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="縮小-synchronized-的程式區塊">縮小 synchronized 的程式區塊</h3>
<ul>
<li>
<p>物件裡所有 synchronized 方法在執行前，都必須取得 object monitor</p>
</li>
<li>
<p>因此如果越多方法使用 synchronized，或是被 synchronized 的方法內容越長，都會造成執「行等待」</p>
</li>
<li>
<p>盡可能使用 synchronized 程式區塊，而非直接 synchronized 整個方法</p>
</li>
<li>
<p>減少被 synchronized 的程式碼，有助於減少「執行等待」的情況</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">getSummary</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">StringBuilder</span> <span class="n">note</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>              <span class="c1">// line 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">cart</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Item</span> <span class="n">i</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">note</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;Item:&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="na">desc</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>  <span class="c1">// line 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">note</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>可以直接把 <code>getSummary()</code> 宣告為 synchronized 方法，</p>
<p>但比較好的做法是檢討方法內真正影響執行緒安全的程式碼。</p>
<ul>
<li>
<p>line 3 ~ line 9 : synchronized 程式碼區塊可讓影響區域縮小</p>
</li>
<li>
<p>根據 line 3 宣告 : 要執行本區塊必須取得 this 的 object monitor</p>
</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="其它執行等待的情況">其它執行等待的情況</h3>
<p>除了 synchronized 程式區塊造成的執行等待，還有以下幾種情形必須預防</p>
<h4 id="1-starvation--因搶不到資源而排隊">1. <strong>Starvation</strong> : 因搶不到資源而排隊</h4>
<ul>
<li>指兩個執行緒共搶一個資源，其中某一個經常可以取得資源（<em>貪心執行緒，greedy thread</em>）</li>
<li>另外一個經常無法取得資源（<em>飢餓執行緒，starved thread</em>）</li>
</ul>
<h4 id="2-live-lock--因太忙碌而排隊">2. Live Lock : 因太忙碌而排隊</h4>
<ul>
<li>指多個執行緒因為等待資源而排隊，thread_B 等 thread_A、thread_C 等 thread_B、thread_D 等 thread_C</li>
<li>thread_A 完成可以輪到 thread_B，thread_B 完成輪到 thread_C，以此類推</li>
</ul>
<h4 id="3-dead-lock--2-個執行緒互相絆住對方導致永遠等待">3. Dead Lock : 2 個執行緒互相絆住對方，導致永遠等待</h4>
<ul>
<li>
<p>thread_A : 必須先後取得「資源1」和「資源2」</p>
</li>
<li>
<p>thread_B : 必須先後取得「資源2」和「資源1」</p>
</li>
<li>
<p>Deadlock 情況 : A 持有資源 1，等待資源 2；此時 B 持有資源 2，等待資源 1</p>
<ul>
<li>除非 Thread-A 或 Thread-B 其中有一方讓出資源或被終止，才能結束 Deadlock</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/yoRNlvk.png"
        data-srcset="https://i.imgur.com/yoRNlvk.png, https://i.imgur.com/yoRNlvk.png 1.5x, https://i.imgur.com/yoRNlvk.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/yoRNlvk.png"
        title="image-20221219105806769" /></p>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p>要產生 dead lock 需要 2 個執行緒和 2 個被搶奪的資源物件。</p>
<p>資源可以是任何物件，使用 <code>new Object()</code> 都可以。e.g.:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">String</span> <span class="n">resource1</span> <span class="o">=</span> <span class="s">&#34;jim1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">String</span> <span class="n">resource2</span> <span class="o">=</span> <span class="s">&#34;jim2&#34;</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因為字串池有重複使用相同內容字串的機制，若改為以下內容，則兩個變數<strong>實際指向同一個字串物件</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">String</span> <span class="n">resource1</span> <span class="o">=</span> <span class="s">&#34;jim&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">String</span> <span class="n">resource2</span> <span class="o">=</span> <span class="s">&#34;jim&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 因為被搶奪的資源只有一個，無法構成 dead lock
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>&hellip;</p>
<h2 id="其它執行緒方法介紹">其它執行緒方法介紹</h2>
<h3 id="使用-interrupt-方法">使用 <code>interrupt()</code> 方法</h3>
<p>除了利用 <code>volatile</code> 宣告的變數來停止執行中的執行緒，也可以用 <code>interrupt()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">InterruptedRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread started&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(!</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 執行中的執行緒可藉由 interrupted 方法不斷確認是否收到中斷指令
</span></span></span><span class="line"><span class="cl"><span class="cm">               若是，就中斷目前執行工作 */</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;I am running...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread finishing&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InterruptThreadExample</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InterruptedRunnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InterruptedRunnable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 對執行中的執行緒下達 interrupt 指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-sleep-方法">使用 <code>sleep()</code> 方法</h3>
<p>若要使執行緒暫停，可以呼叫 class Thread 的靜態 <code>sleep()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>呼叫 <code>Thread.sleep(4000)</code> 即暫停執行 4 秒鐘，4 秒之後再等待 CPU 分配時間</p>
<ul>
<li>拿到才能繼續執行任務，停止時間「<strong>至少</strong>」為 4 秒鐘</li>
</ul>
</li>
<li>
<p>休眠中的執行緒隨時有被叫醒而中斷休眠的可能，所以被要求必須處理 <code>InterruptedException</code></p>
<ul>
<li>
<p>並在 catch block 中決定被終止休眠後要做的事</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">4000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// what to do?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Slept for &#34;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="使用其它方法">使用其它方法</h3>
<p>Class Thread 的其它常用方法：</p>
<p>以下 3 個方法繼承自 Object class：</p>
<ol>
<li>
<p><code>wait()</code>：不限時間的等待，等候 <code>notify()</code> 被呼叫後醒過來</p>
</li>
<li>
<p><code>notify()</code> 和 <code>notifyAll()</code> : 通知 <code>wait()</code> 中的執行緒</p>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p><code>daemon</code> : 在多執行緒的情形下，無法影響 JVM 的結束</p>
</blockquote>
</li>
</ol>
<p>以下示範 <code>join()</code> 和 <code>setDaemon()</code> 之使用方式與其影響</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadTest</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread T is starting...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread T is running...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread T is ending...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadMethodTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread main is starting...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">testNormal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// testJoin();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// testDaemon();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Thread main is ending...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testNormal</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadTest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// #1 thread main 和 thread t 啟動後各走各的，互不影響
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testJoin</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadTest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* #2 thread main 啟動 thread t，在執行 t.join() 時，
</span></span></span><span class="line"><span class="cl"><span class="cm">      thread t 會插隊到 main 前面，只有 thread t 結束後才會執行 thread main */</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testDaemon</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadTest</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// t.setDaemon(true);  // java.lang.IllegalThreadStateException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl"><span class="cm">/* 將執行緒 t 設為 daemon 後，一旦 non-daemon 的 thread main 結束，JVM 就關閉
</span></span></span><span class="line"><span class="cl"><span class="cm">   thread main 結束後，即便 thread t 尚未結束，JVM 也會關閉，和先前2種測試明顯不同 */</span> 
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h3 id="不建議使用的方法">不建議使用的方法</h3>
<ul>
<li>
<p>class Thread 一些不建議使用的方法：</p>
<ol>
<li>
<p>可能造成問題，避免使用</p>
<ul>
<li><code>setPriority(int)</code></li>
<li><code>getPriority()</code></li>
</ul>
</li>
<li>
<p>已經 <strong>deprecated</strong>，不該使用</p>
<ul>
<li><code>destroy()</code></li>
<li><code>resume()</code></li>
<li><code>suspend()</code></li>
<li><code>stop()</code></li>
</ul>
<blockquote>
<p>使用 deprecated 描述表示方法可能</p>
<ul>
<li>寫法不好</li>
<li>命名不符合傳統，不建議再使用</li>
<li>未來可能移除 ex.  <code>@Deprecated</code>、<del>stop</del>() {&hellip;}、<del>resume</del>();</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 註記方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Deprecated</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecurityManager</span> <span class="n">security</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">!=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">security</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">SecurityConstants</span><span class="o">.</span><span class="na">STOP_THREAD_PERMISSION</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// A zero status value corresponds to &#34;NEW&#34;, it can&#39;t change to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// not-NEW because we hold the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">threadStatus</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">resume</span><span class="o">();</span> <span class="c1">// Wake up thread if it was suspended; no-op otherwise
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The VM can handle all thread states
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">stop0</span><span class="o">(</span><span class="k">new</span> <span class="n">ThreadDeath</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
</li>
</ol>
</li>
</ul>
<hr>
<h1 id="06-執行緒與並行-api-concurrency-api">06 執行緒與並行 API <code>Concurrency API</code></h1>
<h2 id="使用並行-api">使用並行 API</h2>
<h3 id="並行-api-介紹">並行 API 介紹</h3>
<ul>
<li>Concurrency API 是套件 <code>java.util.concurrent</code> 下的相關類別和介面。</li>
<li>導入於 Java 5，陸續擴充，用於支援多執行緒執行，亦即 concurrent programming，包含
<ol>
<li>執行緒安全（thread-safe）的集合物件</li>
<li>取代傳統 <em>synchronization</em> 和 <em>locking</em> 的替代方案</li>
<li>執行緒池（thread pools），又分成：
<ul>
<li>執行緒數量「固定」或「浮動」的執行緒池</li>
<li>分進合擊的 <em>Fork-Join Framework</em></li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="atomicinteger-類別"><code>AtomicInteger</code> 類別</h3>
<ul>
<li>
<p>class <code>AtomicInteger</code> 位於<code>java.util.concurrent.atomic</code>套件裡</p>
</li>
<li>
<p>提供執行緒安全又不需要使用 <em>synchronization</em> 和 <em>locking</em> 機制來控管的物件</p>
</li>
<li>
<p>此類別裡的方法都是 atomic function，例如 <code>compareAndSet()</code>、<code>getAndIncrement()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">AtomicInteger</span> <span class="n">ai</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">ai</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">42</span><span class="o">))</span> <span class="o">{</span>  <span class="c1">// 🥨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after compareAndSet(): &#34;</span> <span class="o">+</span> <span class="n">ai</span><span class="o">);</span>  <span class="c1">// 42
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">ai</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>  <span class="c1">// 🥨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after getAndIncrement(): &#34;</span> <span class="o">+</span> <span class="n">ai</span><span class="o">);</span>   <span class="c1">// 43
</span></span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>🥨</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>compareAndSet(a,b)</code></td>
<td>判斷數值是否為 a，若是則設定為 b，亦即將 a 取代為 b</td>
</tr>
<tr>
<td><code>getAndIncrement()</code></td>
<td>取得數值後加 1。作用同遞增運算子，但 atomic function 不須使用 synchronized block</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3 id="reentrantreadwritelock-類別"><code>ReentrantReadWriteLock</code> 類別</h3>
<ul>
<li>
<p>有別於<code>synchronization</code>與<code>monitor</code>機制，<code>ReentrantReadWriteLock</code>提供另一種鎖定（locking）</p>
</li>
<li>
<p>可根據不同情況（conditions）調整執行緒等待的（wait）架構</p>
<ol>
<li>
<p>過去的 monitor 未分類，一個執行緒取得 monitor 之後，其它執行緒必須等待鎖定該 monitor</p>
</li>
<li>
<p>使用 <code>ReentrantReadWriteLock</code>，將原本由每個物件唯一的 object monitor，改提供 <strong>read lock</strong> 和 <strong>write lock</strong> 兩種鎖定機制</p>
<ul>
<li>有 thread 先取得 <strong>read lock</strong> 時，其它執行緒可以同時再取得 read lock
<ul>
<li>允許多個執行緒同時 read，但沒有執行緒可以取得 write lock</li>
</ul>
</li>
<li>一旦有執行緒取得 <strong>write lock</strong>，將排擠其它執行緒取得 read lock 和 write lock</li>
</ul>
</li>
<li>
<p>「<strong>Reentrant</strong>」</p>
<ul>
<li>
<p>如果有執行緒已經使用某個 synchronized 方法（= 取得某物件的 object monitor），則該執行緒可繼續進入其它使用相同 object monitor 的任何一個 synchronized 方法</p>
</li>
<li>
<p>申請一把鑰匙之後，可以繼續打開每一個使用相同鑰匙的門，不用每次開門後都繳回，也不用為了公平而重新申請排隊</p>
<blockquote>
<p>1️⃣ 允許多執行緒同時「holding read lock」</p>
<p>2️⃣ 同一時間一旦有一個執行緒「holding write lock」，</p>
<p>​      就不會再有其它執行緒「holding read lock」或「holding write lock」</p>
</blockquote>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="執行緒安全的集合物件">執行緒安全的集合物件</h3>
<p><code>java.util.*</code> 下的集合物件預設非執行緒安全，如果要 thread-safe，必須特別處理：</p>
<ol>
<li>
<p>對所有修改集合物件的程式碼，都必須放在 <em>synchronize</em> 區塊</p>
</li>
<li>
<p>使用特定類別及方法建立 <em>synchronized wrapper</em> class</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>改用套件 <code>java.util.concurrent</code> 套件下的集合物件</p>
<p><strong>注意</strong>：即便是執行緒安全的集合物件，不代表其成員也是</p>
</li>
</ol>
<p>常用執行緒安全的集合物件：</p>
<table>
<thead>
<tr>
<th><code>java.util.concurrent.*</code></th>
<th><code>java.util.*</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CopyOnWriteArraySet</code></td>
<td></td>
</tr>
<tr>
<td><code>CopyOnWriteArrayList</code></td>
<td><code>ArrayList</code></td>
</tr>
<tr>
<td><code>ConcurrentHashMap</code></td>
<td><code>HashMap</code></td>
</tr>
<tr>
<td><code>ConcurrentSkipListMap</code></td>
<td><code>TreeMap</code></td>
</tr>
</tbody>
</table>
<p><code>Queue</code> family 的執行緒安全集合物件：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/E0u3aAs.png"
        data-srcset="https://i.imgur.com/E0u3aAs.png, https://i.imgur.com/E0u3aAs.png 1.5x, https://i.imgur.com/E0u3aAs.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/E0u3aAs.png"
        title="1" /></p>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p>支援執行緒安全的集合物件裡，常可以看到 <code>CopyOnWrite</code> 的命名方式，暗示該集合物件如何支援執行緒安全</p>
<ol>
<li>當該集合物件要增加成員時，不直接添加，而是
<ul>
<li>先將當前集合物件複製出一個新的集合物件，然後在新的集合物件裡增加成員</li>
</ul>
</li>
<li>添加完成員之後，再將原集合物件的物件參考指向新的集合物件</li>
<li>好處：集合物件可以讀寫並行，不需要在修改的時候排除其它行為，因為當前集合物件不會添加任何元素
<ul>
<li><code>CopyOnWrite</code> 集合物件是一種讀寫分離的思想實踐，對不同的集合物件讀取和寫入</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="常用的同步器工具類別">常用的同步器工具類別</h3>
<p>套件 <code>java.util.concurrent</code> 下，提供數種支援特殊情境的同步器（<em>synchronizers</em>）類別</p>
<table>
<thead>
<tr>
<th>class</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Semaphore</code></td>
<td>傳統的 concurrency（平行執行）工具</td>
</tr>
<tr>
<td><code>CountDownLatch</code></td>
<td>暫停 thread 直到某種情境達成，例如信號數量、事件、預設條件</td>
</tr>
<tr>
<td><code>CyclicBarrier</code>（循環路障）</td>
<td>於平行執行時提供同步點，可循環使用</td>
</tr>
<tr>
<td><code>Phaser</code></td>
<td>更有彈性的 <code>CyclicBarrier</code></td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">stopUntil</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>  <span class="c1">// 設定多少個 thread 抵達才放行的條件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">totalThreadCnt</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>  <span class="c1">// 任意調整啟動的 thread 個數，測試 CyclicBarrier 類的效果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">final</span> <span class="n">CyclicBarrier</span> <span class="n">barrier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CyclicBarrier</span><span class="o">(</span><span class="n">stopUntil</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 宣告並初始化 class Cyclic 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">1</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">totalThreadCnt</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">new</span> <span class="n">Thread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before await&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">barrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>  <span class="c1">// line
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after await&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BrokenBarrierException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>await()</code> 方法：像是柵欄，平時放下。</p>
<p>只有滿足 <code>CyclicBarrier</code> 建構子設定的 <code>stopUntil</code> 個數的 thread 抵達後，才會放行</p>
</blockquote>
<h2 id="使用-executorservice-介面同時執行多樣工作">使用 <code>ExecutorService</code> 介面同時執行多樣工作</h2>
<h3 id="使用更高階的多執行緒執行方案">使用更高階的多執行緒執行方案</h3>
<p>多執行緒程式架構可同時執行工作，提升效率，但也容易衍生問題，必須小心操控。</p>
<p>傳統 <code>API</code> 不容易被適當使用，可考慮使用以下兩個更高階的替代方案：</p>
<ol>
<li><strong>執行者服務</strong>（<em>java.util.concurrent.ExecutorService</em>）
<ul>
<li>建立並重複使用多執行緒</li>
<li><code>ExecutorService</code> 介面
<ul>
<li>除了可以使用過去的 <code>Runnable</code> 介面定義工作內容</li>
<li>也可用新的 <code>Callable</code> 介面定義工作內容，允許在未來工作結束後檢視結果</li>
</ul>
</li>
</ul>
</li>
<li><strong>分進合擊程式框架</strong>（<em>Fork-Join Framework</em>）
<ul>
<li>Java 7 推出的特殊「<strong>工作竊取</strong>（work-stealing）」平行運算架構</li>
<li>用於多執行緒執行，是一種特化的 ExecutorService</li>
<li>程式運行時，除了不斷將整體工作進行切割外，也讓<strong>有能力、較有餘裕的執行緒在做完份內工作後，可以竊取（stealing）別人的工作來執行</strong>
<ul>
<li>支援 <em>能者多勞</em> 理念的多執行緒執行架構</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="executorservice概觀"><code>ExecutorService</code>概觀</h3>
<ul>
<li><code>ExecutorService</code> 介面是執行緒池（thread pool）的概念，使用過的執行緒皆可回收池內繼續下次使用</li>
<li>執行緒池也會負責管理所有執行緒的生命週期，使用 <code>ExecutorService</code>執行多執行緒工作時：
<ol>
<li>不需要自己建立和管理多執行緒，且可以平行執行</li>
<li>可分成兩種任務
<ul>
<li><code>java.lang.Runnable</code></li>
<li><code>java.util.concurrent.Callable</code></li>
</ul>
</li>
<li>使用 class <code>Executors</code> 可以取得 interface <code>ExecutorService</code> 的實作，常用兩種
<ul>
<li>快取式執行緒池 <em>cached thread pool</em></li>
<li>固定式執行緒池 <em>fixed thread pool</em></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="快取式執行緒池cached-thread-pool">快取式執行緒池（cached thread pool）</h4>
<ul>
<li>
<p>建立方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">es</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>特點</p>
<table>
<thead>
<tr>
<th>feature</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>數量控制</td>
<td>執行緒數量由執行緒池<strong>自動調控</strong></td>
</tr>
<tr>
<td>是否重複使用</td>
<td>執行緒工作完成後，回收重複使用</td>
</tr>
<tr>
<td>工作量大時</td>
<td>遇到需要大量 CPU 運算的工作，<strong>執行緒可能會一直增生</strong></td>
</tr>
<tr>
<td>生命週期</td>
<td>預設閒置超過 <strong>60 秒</strong>，就終止生命週期</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h4 id="固定式執行緒池fixed-thread-pool">固定式執行緒池（fixed thread pool）</h4>
<ul>
<li>
<p>建立方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">cpuCount</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 參考主機 CPU 數量建立執行緒數量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ExecutorService</span> <span class="n">es</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">cpuCount</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>特點</p>
<table>
<thead>
<tr>
<th>feature/category</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>數量控制</td>
<td>執行緒數量固定</td>
</tr>
<tr>
<td>是否重複使用</td>
<td>執行緒工作完成後，回收重複使用</td>
</tr>
<tr>
<td>工作量大時</td>
<td>工作太多時，必須等待忙碌的執行緒釋出</td>
</tr>
<tr>
<td>生命週期</td>
<td>數量固定，不會主動終止生命週期</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3 id="使用-javautilconcurrentcallable">使用 <code>java.util.concurrent.Callable</code></h3>
<ul>
<li>
<p><code>ExecutorService</code> 可以協助管理執行緒，但還是需要自己定義執行緒的工作內容</p>
</li>
<li>
<p>除了使用 <code>java.lang.Runnable</code> 介面，也可以使用另外一個 <code>java.util.concurrent.Callable</code> 介面實作類別來定義要執行的工作</p>
<table>
<thead>
<tr>
<th>Runnable</th>
<th>Callable</th>
</tr>
</thead>
<tbody>
<tr>
<td>public interface <code>Runnable</code> {<!-- raw HTML omitted -->       void run();<!-- raw HTML omitted -->}</td>
<td>public interface <code>Callable&lt;V&gt;</code> {<!-- raw HTML omitted -->       V call() throws Exception;<!-- raw HTML omitted -->}</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>Callable</code> 和 <code>Runnable</code> 相似，主要不同地方</p>
<ol>
<li>可以回傳結果（使用泛型）</li>
<li>可以拋出 Exception</li>
</ol>
</li>
<li>
<p>若使用傳統 <strong>Runnable</strong> 介面實作物件作為 <code>ExecutorService</code> 的執行工作內容，可用下例執行工作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">useRunnable</span><span class="o">(</span><span class="n">ExecutorService</span> <span class="n">es</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">es</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>若使用 <strong>Callable</strong> 介面實作物件作為 <code>ExecutorService</code> 的執行工作內容，則用下例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">useCallable</span><span class="o">(</span><span class="n">ExecutorService</span> <span class="n">es</span><span class="o">,</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">callable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">callable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">V</span> <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>ExecutorService.submit()</code> 方法傳入 Callable 實作物件時，可以回傳 <strong>Future</strong> 類別的物件</p>
</blockquote>
<p>&hellip;</p>
</li>
</ul>
<h3 id="使用-javautilconcurrentfuture">使用 <code>java.util.concurrent.Future</code></h3>
<ul>
<li>
<p>介面 <code>ExecutorService</code> 執行 Callable 工作後的回傳結果屬於 <code>Future&lt;V&gt;</code> class：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">callable</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>但是真正工作結果隱藏在 Future 物件裡面，必須再呼叫 <code>get()</code> 去取得結果。回傳型態 <strong>V</strong> 必須和<code>Callable&lt;V&gt;</code>裡定義的泛型物件型態一致：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">V</span> <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>原因：main thread 在前景（foreground）執行工作，而不是 main 的 thread 都在背景（background）執行工作</p>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p>餐館內用座位 &amp; 外帶領取號碼牌</p>
<p>號碼牌：隱含一種「<strong>未來交貨</strong>」之意</p>
<table>
<thead>
<tr>
<th>noodle shop</th>
<th>java program</th>
</tr>
</thead>
<tbody>
<tr>
<td>「號碼牌」</td>
<td>Java 裡的 <code>Future</code> 物件</td>
</tr>
<tr>
<td>拿「麵」需要號碼牌</td>
<td>包含在 <code>Future</code> 裡的泛型物件，呼叫 <code>Future</code> 的 <code>get()</code> 方法可取得該泛型物件</td>
</tr>
<tr>
<td>「煮麵」</td>
<td><code>Callable</code> 介面裡的 <code>call()</code> 方法定義的內容</td>
</tr>
<tr>
<td>「煮麵的師傅」</td>
<td><code>ExecutorService</code>裡的執行緒</td>
</tr>
<tr>
<td>「餐館」</td>
<td><code>ExecutorService</code></td>
</tr>
<tr>
<td>「您」</td>
<td><code>main</code> 執行緒</td>
</tr>
</tbody>
</table>
<p>如果買東西需要等待，大部分商家<code>Executor Service</code> 都會給您一張號碼牌 <code>Future</code>，等時間差不多再回來領取（<code>get</code>）購買的真正商品。</p>
<p>領取號碼牌，使用 <code>Callable</code>。</p>
<p>不領取號碼牌，即是使用 <code>Runnable</code>。</p>
</blockquote>
<ul>
<li>呼叫 <code>Future.get()</code> 方法時，若結果尚未出爐，main 執行緒就會進入等待狀態，比較好的做法：
<ol>
<li>呼叫 <code>get()</code> 方法前，應該先丟出（<strong>submit</strong>）所有工作
<ul>
<li>因為呼叫 <code>get()</code>之後只能耐心等結果</li>
</ul>
</li>
<li>呼叫 <code>get()</code> 方法前也可以先呼叫 <code>isDone()</code>方法，確認是否工作完成</li>
</ol>
<ul>
<li>取貨前先打電話確認是否完成，以免到達後還需要等待</li>
<li>呼叫多載的另外一版本 <code>get(long timeout, TimeUnit unit)</code> 方法，明確指定等待時間</li>
</ul>
</li>
</ul>
<h3 id="關閉-executorservice">關閉 <code>ExecutorService</code></h3>
<ul>
<li>
<p>因為 <code>ExecutorService</code>所建立的執行緒都是 <strong>non-daemon</strong>，JVM 會因為這些執行緒存在，而導致永遠不會結束</p>
</li>
<li>
<p>若要結束程式，必須呼叫 <code>ExecutorService</code> 介面的 <code>shutdown()</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">es</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* shutdown() 方法會在所有執行緒工作都結束後，關閉 ExecutorService 
</span></span></span><span class="line"><span class="cl"><span class="cm">   並終止所有執行緒生命週期，讓程式結束  */</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">es</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 若已執行 shutdown() 指令，但執行緒工作結束後還是無法關閉，
</span></span></span><span class="line"><span class="cl"><span class="cm">       可以使用 awaitTermination(5, TimeUnit.SECONDS) 方法傳入等待時間，時間到後會強制關閉*/</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">catch</span> <span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Stopped waiting early&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>    
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="executorservice完整範例"><code>ExecutorService</code>完整範例</h3>
<ul>
<li>
<p>應用 <code>Callable</code>介面和<code>Future</code>類別的 <code>ExecutorService</code>使用方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CallableTask</span> <span class="kd">implements</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">20000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;: finish job&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;: done&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExecutorServiceTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ExecutorService</span> <span class="n">es</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCacheThreadPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ExecutorService es = Executors.newFixedThreadPool(5);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CallableTask</span><span class="o">();</span> <span class="c1">// 建立Callable實作物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 讓es分派執行緒進行Callable實作物件定義的工作內容，並取得號碼牌Future物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>  <span class="c1">// line 17
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> 
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="c1">// ln17 ~ 22若呼叫get()方法時工作尚未結束，就會進入等待狀態
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">es</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span> <span class="c1">// shutdown()在所有執行緒工作結束後，才關閉自己
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;: service shutdown&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">es</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* 若已執行shutdown()，但所有執行緒工作結束後還是無法關閉，則可以使用
</span></span></span><span class="line"><span class="cl"><span class="cm">               awaitTermination(5,TimeUnit.SECONDS) 方法傳入等待時間，時間到後強制關閉*/</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Stopped waiting early&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="executorservice-進階範例"><code>ExecutorService</code> 進階範例</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/lXaXD7Y.png"
        data-srcset="https://i.imgur.com/lXaXD7Y.png, https://i.imgur.com/lXaXD7Y.png 1.5x, https://i.imgur.com/lXaXD7Y.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/lXaXD7Y.png"
        title="image-20221221144232769" /></p>
<ul>
<li>Java Socket 程式架構提供網路世界兩台獨立主機上的 Java 程式互相連線的機制，一般分為
<ol>
<li><strong>主機端</strong>（server）：提供網路連線的程式</li>
<li><strong>用戶端</strong>（client）：要求網路連線的程式</li>
</ol>
</li>
<li>成功建立連線有以下條件：
<ol>
<li>主機端必須提供一個固定位置（包含 IP、port 號），用戶端要連接的話需要先知道這個位置
<ul>
<li><strong>IP</strong> : 網路世界的住址，可幫助用戶端在網際網路裡找到單一主機</li>
<li><strong>Port</strong> :
<ul>
<li>主機裡可能有諸多正在執行的程式，可用 post</li>
<li>可以是 0-65535 之間的任一整數，0-1024的port號已被作業系統保留</li>
<li>其它程式通常選擇1024之後的編號作為自己程式的 port 號</li>
</ul>
</li>
</ul>
</li>
<li>Java 的 Socket 主要使用 <code>ServerSocket</code> 以及 <code>Socket</code> 兩個類別
<ul>
<li>主機端用 <code>ServerSocket</code> 物件的 <strong>listen()</strong> 方法監聽來自用戶端的連線請求</li>
<li>用戶端用 <code>Socket</code> 物件和主機端做連接</li>
<li>主機端用 <code>ServerSocket</code> 物件的 <strong>accept()</strong> 方法來串接用戶端的 <code>Socket</code> 物件</li>
</ul>
</li>
<li>主機端和用戶端連接之後，就可以用以下方法來傳輸資料
<ul>
<li><code>Socket</code> 物件的 <code>getInputStream()</code></li>
<li><code>Socket</code> 物件的 <code>getOutputStream()</code></li>
</ul>
</li>
<li>資料傳輸完成後，記得呼叫 <code>Socket</code> 物件的 <code>close()</code> 方法結束相關資源</li>
</ol>
</li>
</ul>
<h4 id="範例一socketserversstartupjava-扮演主機端程式的角色">範例一：<code>SocketServersStartup.java</code> 扮演主機端程式的角色</h4>
<ul>
<li>
<p>啟動五個執行緒，分別使用 port# 10000 - 10004 扮演主機端角色，等待/傾聽用戶端連線的要求</p>
</li>
<li>
<p>如果用戶端連線成功，主機端在停頓五秒後，將輸出 <code>feedback_from_port 號</code> 的訊息給客戶端</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SocketServerStartup</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">10000</span><span class="o">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">10005</span><span class="o">;</span> <span class="n">port</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">MySocketServer</span><span class="o">(</span><span class="n">port</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MySocketServer</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MySocketServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Server &#34;</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">&#34;: Listening...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 聆聽 port 是否被呼叫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ServerSocket</span> <span class="n">serverSock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 取得 Socket 連線
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">Socket</span> <span class="n">clientSock</span> <span class="o">=</span> <span class="n">serverSock</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 暫停 5 秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">5000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 輸出訊息給 Socket 的用戶端
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="n">clientSock</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">pw</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;feedback_from_&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 關閉 Socket 網路連線
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">serverSock</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientSock</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="範例二--建立類別-singlethreadtest-驗證使用單一執行緒依序訪問五個-socket-主機">範例二 : 建立類別 <code>SingleThreadTest</code> 驗證使用單一執行緒依序訪問五個 Socket 主機</h4>
<ul>
<li>使用單一執行緒逐 port 連線主機的結果，必須使用 <code>5sec * 5 = 25sec</code> 的時間</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;SingleThread starts at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&#34;localhost&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">10000</span><span class="o">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">10005</span><span class="o">;</span> <span class="n">port</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Socket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">               <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">sock</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">feedback</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Call &#34;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                       <span class="s">&#34;, and get: &#34;</span> <span class="o">+</span> <span class="n">feedback</span> <span class="o">+</span> <span class="s">&#34; at &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Error talking to &#34;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="範例三--建立類別-socketclientcallable-實作-callable-介面">範例三 : 建立類別 <code>SocketClientCallable</code> 實作 <code>Callable</code> 介面</h4>
<ul>
<li>用以定義多執行緒訪問 <code>Socket</code> 主機的工作內容</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SocketClientCallable</span> <span class="kd">implements</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">host</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">SocketClientCallable</span><span class="o">(</span><span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">Socket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">sock</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span> <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">feedback</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">feedback</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="範例四--建立類別-multithreadtest-驗證使用多執行緒訪問-5-個-socket-主機的情況">範例四 : 建立類別 <code>MultiThreadTest</code> 驗證使用多執行緒訪問 5 個 Socket 主機的情況</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MultiThreadTest starts at: &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">ExecutorService</span> <span class="n">es</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&#34;localhost&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">callables</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 依不同 port 號送出callable工作給執行緒池執行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">prot</span> <span class="o">=</span> <span class="n">10000</span><span class="o">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">10005</span><span class="o">;</span> <span class="n">port</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SockeClientCallable</span> <span class="n">callable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SocketClientCallable</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">callable</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">            <span class="c1">// 定義future物件承接執行結果,但先不呼叫get()方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">callables</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">port</span><span class="o">,</span> <span class="n">future</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">            <span class="c1">// 將future物件先存在callables，以Integer型別的port作為鍵值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 關閉 ExecutorService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">es</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">es</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Stopped waiting &#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 取回結果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">port</span> <span class="o">:</span> <span class="n">callables</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>  <span class="c1">// ln 26
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">callables</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">feedback</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Call &#34;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="n">port</span> <span class="o">+</span> <span class="s">&#34;, and get: &#34;</span> <span class="o">+</span> <span class="n">feedback</span> <span class="o">+</span> <span class="s">&#34; at &#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Error talking to &#34;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="c1">// ln 26~: 在callables中找出所有Future物件，並呼叫get()取回結果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h2 id="使用-fork-join-框架同時執行多樣工作">使用 Fork-Join 框架同時執行多樣工作</h2>
<h3 id="平行處理的策略">平行處理的策略</h3>
<ul>
<li>
<p>為了使多個CPU運算效能最佳化，可以讓程式同時執行工作，「平行處理（<code>parallelism</code>）」策略很重要</p>
<ol>
<li>
<p>將工作分切成小段，各自完成後工作就可以解決</p>
<ul>
<li>稱為 <code>divide and conquer</code> 處理策略</li>
<li>使用前需確認這些小段工作可以平行處理</li>
</ul>
</li>
<li>
<p>分割時注意硬體效能問題，切割太細可能有反效果</p>
<ul>
<li>
<p>如果工作內容需要大量 CPU 計算而非 I/O 存取，需考慮 CPU 數量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<blockquote>
<p>平行處理策略第一步：切割資料讓多執行緒可以平行執行</p>
<p>如何切割？</p>
<p>最理想情況：讓所有 CPU 可以充分被所有執行緒利用，直到工作結束</p>
</blockquote>
</li>
</ul>
<h4 id="使用平均分配方式發揮-cpu-計算量能">使用「平均分配」方式發揮 CPU 計算量能</h4>
<ul>
<li>讓每一個執行緒各自占用不同的 CPU 處理相同分量的工作，容易因為以下原因導致無法發揮硬體最高性能
<ol>
<li>每一個 CPU 可能效率不同</li>
<li>某些 CPU 可能也在執行其它程式</li>
</ol>
</li>
<li>讓十位同學打掃相同面積的空地，因為每個人效率不同，不會同時完成</li>
</ul>
<h4 id="使用工作竊取方式發揮-cpu-計算量能">使用「工作竊取」方式發揮 CPU 計算量能</h4>
<ul>
<li>稱為「工作竊取」的平行運算架構：平均切割工作，但數量遠多於執行緒個數
<ol>
<li>工作不會馬上完成，每一個執行緒會有很多待辦工作在自己的佇列</li>
<li>若某執行緒已完成自己的工作，可以竊取其它人的工作</li>
<li>合適的切割份量不容易達成
<ul>
<li>切太多：切割本身即是負擔</li>
<li>切太少：無法充分利用 CPU 資源</li>
</ul>
</li>
<li>能者多勞理念的實踐 — Java 7 推出 <code>Fork-Join</code>框架</li>
</ol>
</li>
</ul>
<h3 id="套用-fork-join-框架">套用 <code>Fork-Join</code> 框架</h3>
<h4 id="範例一使用單一執行緒處理">範例一：使用單一執行緒處理</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingleThreadTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">maind</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span><span class="o">[]</span> <span class="n">bigData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">256</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bigData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">bigData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">value</span> <span class="o">:</span> <span class="n">bigData</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">max</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Found max value: &#34;</span> <span class="o">+</span> <span class="n">max</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="範例二使用-fork-join-框架平行處理">範例二：使用 <code>Fork-Join</code> 框架平行處理</h4>
<ul>
<li>
<p><code>ExecutorService</code>使用 cached thread pool 或 fixed thread pool 執行 <code>Callable</code> 介面定義的工作內容</p>
</li>
<li>
<p><code>Fork-Join</code> 框架則可以直接使用 <code>ExecutorService</code> 特化的子類別 <code>java.util.concurrent.ForkJoinPool</code> 執行抽象類別 <code>java.util.concurrent.ForkJoinTask&lt;V&gt;</code> 定義的工作內容</p>
<ol>
<li>
<p><code>ForkJoinTask</code>物件代表需要執行的工作，可解釋為分進合擊</p>
<ul>
<li>一開始分頭進行，逐漸會師合併結果</li>
</ul>
</li>
<li>
<p><code>ForkJoinTask</code>物件包含要處理的資料和處理方式，類似 <code>Runnable</code> 以及 <code>Callable</code></p>
</li>
<li>
<p>巨大量工作可以由 Fork-Join pool 內少數執行緒處理</p>
<ul>
<li>每個執行緒會工作滿檔，可以發揮硬體的極致性能</li>
</ul>
</li>
<li>
<p>開發者通常繼承 <code>ForkJoinTask</code>子類別，再實作 <code>compute()</code> 方法</p>
<ul>
<li>
<p><code>RecursiveAction</code> 的 <em>compute()</em> 方法沒有回傳結果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">RecursiveAction</span> <span class="kd">extends</span> <span class="n">ForkJoinTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>RecursiveTask</code> 的 <em>compute()</em> 方法需要回傳結果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">RecursiveTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ForkJoinTask</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">V</span> <span class="nf">compute</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="方法-compute-的處理邏輯">方法 <code>compute()</code> 的處理邏輯</h4>
<ul>
<li>
<p>建立類別 <code>FindMaxTask</code> 繼承 <code>RecursiveTask</code>，使用 <code>Fork-Join</code> 框架在 <code>1G</code> 的 <code>int</code> 陣列裡找出最大的數字</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="n">RESULT</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>    <span class="c1">// pseudocode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">DATA_SMALL_ENOUGH</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PROCESS_DATA</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">RESULT</span><span class="o">;</span>    
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SPLIT_DATA_INTO_LEFT_AND_RIGHT_PARTS</span>
</span></span><span class="line"><span class="cl">        <span class="n">TASK</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TASK</span><span class="o">(</span><span class="n">LEFT_DATA</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 建立一個稱為t1的ForkJoinTask處理左半部工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">t1</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 呼叫 t1.fork() 做非同步處理（分進、分頭行事）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">TASK</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TASK</span><span class="o">(</span><span class="n">RIGHT_DATA</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 建立另一個稱為t2的ForkJoinTask處理右半部工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">COMBINE</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">compute</span><span class="o">(),</span> <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h5 id="圖解分進合擊">圖解分進合擊</h5>
<ol>
<li>
<p>原始資料處理量太大，分兩部分派給 <code>t1</code>、<code>t2</code>兩個 <code>ForkJoinTask</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/kCNCU6i.png"
        data-srcset="https://i.imgur.com/kCNCU6i.png, https://i.imgur.com/kCNCU6i.png 1.5x, https://i.imgur.com/kCNCU6i.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/kCNCU6i.png"
        title="image-20221222102832964" /></p>
</li>
<li>
<p>呼叫方法：</p>
<ul>
<li>
<p><strong>分進</strong> : 呼叫 <code>t1.fork()</code> 方法調用一個執行緒處理資料</p>
<p><strong>合擊</strong> : 呼叫 <code>join()</code> 時取回結果
→ 目前累計一個計算結果未取回</p>
</li>
<li>
<p>呼叫 <code>t2.compute()</code>時候，若資料處理量仍太大，持續進行切割工作</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/U9RbOV0.png"
        data-srcset="https://i.imgur.com/U9RbOV0.png, https://i.imgur.com/U9RbOV0.png 1.5x, https://i.imgur.com/U9RbOV0.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/U9RbOV0.png"
        title="image-20221222102858500" /></p>
</li>
</ul>
</li>
<li>
<p>累計 2 個計算結果未取回</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/ySLWUCM.png"
        data-srcset="https://i.imgur.com/ySLWUCM.png, https://i.imgur.com/ySLWUCM.png 1.5x, https://i.imgur.com/ySLWUCM.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/ySLWUCM.png"
        title="image-20221222102925858" /></p>
</li>
<li>
<p>每次切割出去的左半部資料處理結果（累計 3 個未取回）</p>
<ul>
<li>且右側資料已經夠少，將呼叫 <code>t2.compute()</code>不再切割，直接計算得到一個結果</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/GIRMKac.png"
        data-srcset="https://i.imgur.com/GIRMKac.png, https://i.imgur.com/GIRMKac.png 1.5x, https://i.imgur.com/GIRMKac.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/GIRMKac.png"
        title="image-20221222103013124" /></p>
</li>
<li>
<p>開始將處理結果合併</p>
<ul>
<li>
<p>要取得左半部資料處理結果，需要呼叫 <code>t1.join()</code> 方法</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/hcA97yC.png"
        data-srcset="https://i.imgur.com/hcA97yC.png, https://i.imgur.com/hcA97yC.png 1.5x, https://i.imgur.com/hcA97yC.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/hcA97yC.png"
        title="image-20221222104039589" /></p>
</li>
</ul>
</li>
<li>
<p>承上步驟，繼續合併結果</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/6VVcebU.png"
        data-srcset="https://i.imgur.com/6VVcebU.png, https://i.imgur.com/6VVcebU.png 1.5x, https://i.imgur.com/6VVcebU.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/6VVcebU.png"
        title="image-20221222104024864" /></p>
</li>
<li>
<p>完全合併後，得到結果</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/OgdMxoQ.png"
        data-srcset="https://i.imgur.com/OgdMxoQ.png, https://i.imgur.com/OgdMxoQ.png 1.5x, https://i.imgur.com/OgdMxoQ.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/OgdMxoQ.png"
        title="image-20221222103938211" /></p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">FindMaxTask</span> <span class="kd">extends</span> <span class="n">RecursiveTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">threshold</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">data</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">int</span> <span class="n">begin</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">int</span> <span class="n">end</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="nf">FindMaxTask</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="kt">int</span> <span class="n">begin</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">,</span> <span class="kt">int</span> <span class="n">threshold</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">begin</span> <span class="o">=</span> <span class="n">begin</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="n">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%02d&#34;</span><span class="o">,</span> <span class="o">++</span><span class="n">counter</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;: &#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34; |Range: &#34;</span> <span class="o">+</span> <span class="n">begin</span> <span class="o">+</span> <span class="s">&#34; ~ &#34;</span> <span class="o">+</span> <span class="n">end</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 顯示目前是第N個進行的運算,由哪個執行緒執行,本例切為16等分,N&lt;=16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">begin</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">max</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="c1">// 計算資料陣列裡最大值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="n">max</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="o">)</span> <span class="o">/</span> <span class="n">2</span> <span class="o">+</span> <span class="n">begin</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">FindMaxTask</span> <span class="n">a1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindMaxTask</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">begin</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">threshold</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">a1</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">FindMaxTask</span> <span class="n">a2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindMaxTask</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">end</span><span class="o">,</span> <span class="n">threshold</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">a2</span><span class="o">.</span><span class="na">compute</span><span class="o">(),</span> <span class="n">a1</span><span class="o">.</span><span class="na">join</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 不斷切割資料到門檻值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForkJoinMultiThreadTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Date</span> <span class="n">begin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 製作資料陣列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">int</span><span class="o">[]</span> <span class="n">bigData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">1024</span> <span class="o">*</span> <span class="n">1024</span> <span class="o">*</span> <span class="n">256</span><span class="o">];</span> <span class="c1">// 1G
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bigData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">bigData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* 使用fork-join框架
</span></span></span><span class="line"><span class="cl"><span class="cm">		   建立Fork-Join框架的工作內容物件FindMaxTask，且資料陣列會切割為16等分，才進行運算 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">FindMaxTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FindMaxTask</span><span class="o">(</span><span class="n">bigData</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">bigData</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">,</span> <span class="n">bigData</span><span class="o">.</span><span class="na">length</span> <span class="o">/</span> <span class="n">16</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ForkJoinPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ForkJoinPool</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">Integer</span> <span class="n">max</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 使用forkJoinPool的invoke()方法傳入要執行的工作，該方法會呼叫FindMaxTask的compute()方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;\nMax value found:&#34;</span> <span class="o">+</span> <span class="n">max</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 計時
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">begin</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Complete task within &#34;</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s">&#34; milliseconds&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h3 id="fork-join-框架的使用建議"><code>Fork-Join</code> 框架的使用建議</h3>
<p>Fork-Join 框架幾個需要注意的地方：</p>
<ol>
<li>預設每核 CPU 會建立一個對應的執行緒執行工作</li>
<li>使用時應該先排除 <code>I/O</code> 或是其它可能卡住執行緒工作的瓶頸</li>
<li>了解自己的硬體
<ul>
<li><strong>單個 CPU 時，使用 Fork-Join 框架反而會比較慢</strong></li>
<li>有些 CPU 只使用單核時，會比使用多核快，因此使用 Fork-Join 框架的成效感覺更少</li>
</ul>
</li>
<li>相較於單一執行緒的循序執行，<strong>平行執行會有先切割工作的額外負擔，延長執行時間</strong></li>
</ol>
<hr>
<h1 id="07-使用-jdbc-建立資料庫連線">07 使用 JDBC 建立資料庫連線</h1>
<h2 id="了解-databasedbms-和-sql">了解 Database、DBMS 和 SQL</h2>
<p>Java 裡保存資料 : 物件序列化技術、使用 I/O 將資料儲存於檔案中、儲存於資料庫中</p>
<h4 id="基本名詞介紹">基本名詞介紹</h4>
<ol>
<li>
<p><strong>Database</strong>：資料庫，放置電子資料的地方</p>
</li>
<li>
<p><strong>DBMS</strong>（Database Management System）：</p>
<ul>
<li>
<p>為管理資料庫設計的電腦軟體系統，具儲存、擷取、安全保障、備份等基礎功能</p>
</li>
<li>
<p>可以依據所支援的資料庫模型來作分類，例如關聯式、XML 等等</p>
</li>
</ul>
</li>
<li>
<p><strong>SQL</strong>（Structured Query Language）：結構化查詢語言，特殊目的的程式語言，用於存取資料庫中的資料</p>
</li>
<li>
<p><strong>JDBC</strong>（Java Database Connectivity）：</p>
<ul>
<li>Java 規範用戶端程式如何存取資料庫的應用程式介面</li>
<li>提供了諸如查詢和更新資料庫中資料的方法</li>
</ul>
</li>
<li>
<p><strong>Table</strong>：</p>
<ul>
<li>資料庫中呈現資料的邏輯性作法</li>
</ul>
</li>
</ol>
<h3 id="使用sql存取資料庫">使用<code>SQL</code>存取資料庫</h3>
<p>常用的兩大類 SQL（結構化查詢語言）</p>
<ol>
<li>
<p><code>DDL</code> (Data Definition Language)，常用於</p>
<ul>
<li>建立、修改、刪除資料表</li>
<li>描述資料庫中的資料，包括欄位、型態、資料結構</li>
</ul>
</li>
<li>
<p><code>DML</code>(Data Manipulation Language)，用於</p>
<ul>
<li>操作資料表</li>
<li>允許使用者存取或處理資料庫中的資料，內容包括
<ul>
<li>擷取資料庫中的資訊、新增、刪除、更新資料庫中的資料</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="createinsert-新增">Create/insert 新增</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ID</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">FIRSTNAME</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">LASTNAME</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">BIRTHDATE</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SALARY</span><span class="w"> </span><span class="nb">REAL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Troy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Hammer&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1966-03-31&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">100000</span><span class="p">.</span><span class="mi">00</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Michael&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Walton&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1966-08-25&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">90000</span><span class="p">.</span><span class="mi">20</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="readqueryselect-查詢">Read/query/select 查詢</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">SALARY</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="update-修改">Update 修改</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">UPDATE</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">SALARY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">--將ID為1的員工資料的SALARY欄位更改為0
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="delete-刪除">Delete 刪除</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="p">;</span><span class="w">  </span><span class="c1">--刪除employee表格
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-SQL" data-lang="SQL"><span class="line"><span class="cl"><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">EMPLOYEE</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">--刪除 ID為1 的員工資料
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h3 id="derby-資料庫介紹">Derby 資料庫介紹</h3>
<ul>
<li>
<p>Apache 軟體基金組織的 Derby - 純 Java 開發的關聯式資料庫</p>
</li>
<li>
<p>原為 Cloudscape，為 IBM 所有但是 2004 被捐給了 Apache軟體基金組織</p>
</li>
<li>
<p>特色</p>
<ol>
<li>100% 以 Java 開發</li>
<li>輕量級，大小 35.5 MB</li>
<li>支援 JDBC 4.0 以上版本</li>
<li>支援大部分 ANSI SQL 92 標準</li>
<li>有 Table 和 View</li>
<li>支援 BLOB 和 CLOB 資料類型</li>
<li>支援預存程序（stored procedure）</li>
</ol>
</li>
<li>
<p>Derby 運行模式</p>
<ol>
<li><strong>內嵌模式</strong>（embedded mode）
<ul>
<li>Derby 資料庫與應用程式共用<code>JVM</code>，應用程式會在啟動和關閉時，分別自動啟動或停止資料庫</li>
<li>使用「<code>derby.jar</code>」支援 Derby 資料庫引擎和嵌入式<code>JDBC</code>驅動程式</li>
</ul>
</li>
<li><strong>網路伺服器模式</strong>（network server mode）
<ul>
<li>Derby 資料庫獨占一個 <code>JVM</code>，作為伺服器上的一個獨立程序（process）運行
此模式下允許有多個應用程式來連線同一個 Derby 資料庫</li>
<li>使用 <code>derbyclient.jar</code> 支援 Derby Network Server</li>
</ul>
</li>
</ol>
</li>
<li>
<p>Derby 主要指令檔案（放在 <code>db-derby-10.14.2.0-bin / bin</code> 目錄下）用途</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>startNetworkServer.bat</code></td>
<td>可啟動網路伺服器的批次檔</td>
</tr>
<tr>
<td><code>stopNetworkServer.bat</code></td>
<td>可停止網路伺服器的批次檔</td>
</tr>
<tr>
<td><code>ij.bat</code></td>
<td>互動式 <code>JDBC</code> 批次檔工具</td>
</tr>
<tr>
<td><code>dblook.bat</code></td>
<td>可檢視資料庫全部或部分 <code>DDL</code> 的批次檔</td>
</tr>
<tr>
<td><code>sysinfo.bat</code></td>
<td>可顯示有關環境版本資訊的批次檔</td>
</tr>
<tr>
<td><code>NetworkServerControl.bat</code></td>
<td>可在 <code>NetworkServerControl API</code> 上執行指令的批次檔</td>
</tr>
</tbody>
</table>
<p>&hellip;</p>
</li>
</ul>
<h3 id="操作-derby-資料庫">操作 Derby 資料庫</h3>
<h4 id="啟動關閉-network-server">啟動/關閉 Network Server</h4>
<p>要使用 Derby 資料庫，必須先啟動 Network Server</p>
<ol>
<li><em>啟動</em>：點擊<code>startNetworkServer.bat</code>，以啟動 Network Server</li>
<li><em>關閉</em>：<code>ctrl</code> + <code>C</code> 或直接關閉啟動時出現的視窗</li>
</ol>
<h4 id="與-network-server-互動">與 Network Server 互動</h4>
<p>啟動 Network Server 之後，點擊 <code>ij.bat</code>，出現對話主控台（console），可輸入指令來和 Network Server 互動</p>
<p>指令包含建立 Derby 資料庫以及執行 DDL、DML、查詢等指令</p>
<ol>
<li>
<p>連線 Derby 資料庫</p>
<pre tabindex="0"><code>connect                             //要求連線Derby資料庫
&#39;jdbc:derby://localhost:1527/myDB;  //表述資料庫連線位址, 使用JDBC URL, 含位址、port、
create=true;                        //表示若資料庫不存在, 將自動建立, 建立在bin目錄下
user=root;                          //提供建立連線的帳號
password=sa&#39;;                       //提供建立連線的密碼
</code></pre></li>
<li>
<p>連線到目標資料庫<code>myDB</code>後，使用<code>DDL</code>建立表格，並使用<code>DML</code>進行資料新刪改查</p>
</li>
</ol>
<h2 id="eclipse-連線並存取資料庫">Eclipse 連線並存取資料庫</h2>
<ul>
<li>
<p>使用<code>ij.bat</code>雖可以連線並操作資料庫，但並非視窗畫面</p>
</li>
<li>
<p>Eclipse 提供 <strong>模組DTP</strong> 連線各式資料庫，雖然距離專業資料庫操作軟體還有距離，但已經很實用</p>
</li>
</ul>
<h3 id="連線資料庫">連線資料庫</h3>
<ol>
<li>
<p>開啟 <code>Database Development perspectives</code>，點選 <code>Database Development</code></p>
</li>
<li>
<p>視景變為 <code>Data Source Explorer</code> 以及出現 <code>SQL Results</code> 和 <code>Execution Plan</code> 頁籤</p>
</li>
<li>
<p>右鍵 <code>Database Connections</code> 資料夾，<code>New ...</code> → <code>Derby</code> (next)</p>
</li>
<li>
<p><code>New Derby Connection Profile</code> 點選右側的 <code>New Driver Definition</code> 建立連線資料庫 Derby 的驅動程式</p>
</li>
<li>
<p>在「Name/Type」頁籤裡，選擇第一筆「Derby Client JDBC Driver」</p>
</li>
<li>
<p>切到「JAR List」頁籤，點預設的「<code>derbyclient.jar</code>」檔案，再點選「<code>Remove Jar/Zip</code>」移除之</p>
</li>
<li>
<p>在此頁籤 <code>Add JAR/Zip</code>，彈出選擇連線 Derby 資料庫 JAR 檔的視窗</p>
</li>
<li>
<p>在路徑 <code>db-derby-10.14.2.0-bin\lib</code> 內，找到檔案 <code>derbyclient.jar</code>，點擊<strong>開啟</strong>按鈕</p>
</li>
<li>
<p>點選 OK，再鍵入要連線的 Derby 資料庫相關資訊</p>
</li>
<li>
<p>先以 <code>startNetworkServer.bat</code> 啟動 Derby 資料庫，再點 <code>Test Connection</code> 測試與資料庫的連線</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/b7TgyDw.png"
        data-srcset="https://i.imgur.com/b7TgyDw.png, https://i.imgur.com/b7TgyDw.png 1.5x, https://i.imgur.com/b7TgyDw.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/b7TgyDw.png"
        title="image-20230118140615040" /></p>
</li>
</ol>
<h3 id="存取資料表">存取資料表</h3>
<ol>
<li>
<p>建立連線後，「Data Source Explorer」會出現目前連線的資料庫狀態與架構</p>
</li>
<li>
<p>切到 Java EE 視景，開啟 <code>xxxTable.sql</code>，再切回 Database Development perspective</p>
</li>
<li>
<p>在 <code>xxxTable.sql</code> 檔案上方 Connection Profile 設定列裡選擇要連線的資料庫名稱，再右鍵選執行方式</p>
<pre tabindex="0"><code>Execute All
Execute Selected Text
Execute Selected Text As One Statement
Execute Current Text
</code></pre></li>
<li>
<p>點選 <code>SQL Results</code> 頁籤，查看 Status | Operation，出現 Status Result 1 頁籤可看到以框格方式查看結果</p>
</li>
</ol>
<p>&hellip;</p>
<h2 id="使用-jdbc">使用 <code>JDBC</code></h2>
<h3 id="jdbc-api--概觀"><code>JDBC API</code>  概觀</h3>
<ul>
<li>
<p>主要由 1 個 class 和 3 個 interface 組成，除了 <code>DriverManager</code> 之外皆為介面</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/GUGklX3.png"
        data-srcset="https://i.imgur.com/GUGklX3.png, https://i.imgur.com/GUGklX3.png 1.5x, https://i.imgur.com/GUGklX3.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/GUGklX3.png"
        title="image-20230118151147434" /></p>
<ol>
<li>使用 <code>DriverManager</code> 取得 <code>Connection</code></li>
<li>使用 <code>Connection</code> 取得 <code>Statement</code></li>
<li>使用 <code>Statement</code> 取得 <code>ResultSet</code></li>
</ol>
</li>
<li>
<p><code>JDBC</code> 只定義抽象介面，連線資料庫的機制與實作類別由各別廠商提供</p>
<ul>
<li>
<p>例：Derby 資料庫需要的 JAR 檔案，亦即驅動程式為 <code>derbyclient.jar</code>，</p>
<p>位於路徑 <code>db-derby-10.14.2.0-bin\lib</code>內</p>
</li>
</ul>
</li>
</ul>
<h3 id="專案引用資料庫驅動函式庫">專案引用資料庫驅動函式庫</h3>
<ul>
<li>要使用 Java 的 <code>JDBC</code> 程式直接連線 Derby 資料庫，需要在 Eclipse 專案裡引入該 JAR 檔
<ol>
<li>在專案中新建 Folder，慣例上命名為 <code>lib</code></li>
<li>將 JAR 檔 <code>derbyclient.jar</code> 以拖拉方式複製到新建的 lib 目錄中</li>
<li><code>FileOperation</code> 選擇 <code>Copy files</code></li>
<li>複製 JAR 檔至 Eclipse 專案步驟完成</li>
<li>右鍵專案節點，開啟 Project 頁籤的 <code>Properties</code> 選項</li>
<li>點視窗左側清單中的 <code>Java Build Path</code> → <code>Libraries</code> → <code>Classpath</code> → <code>Add JARs</code> → 選擇 <code>derbyclient.jar</code></li>
<li>設定完後可看到 <code>derbyclient.jar</code> 出現在專案 Libraries 中，此為專案類別路徑 <code>Classpath</code></li>
</ol>
</li>
</ul>
<h3 id="認識-jdbc-驅動函式庫-jar-的組成">認識 <code>JDBC</code> 驅動函式庫 JAR 的組成</h3>
<p>用 7-zip 開啟 <code>derbyclient.jar</code>檔案之後，可看到內容基本結構</p>
<ul>
<li>逐層點開 <code>org</code>目錄後，可以看到許多 <code>*.class</code> 的類別檔 (<code>derbyclient.jar\org\apache\derby\jdbc</code>)</li>
<li>因此除了把此 jar 檔放到專案類別路徑，還必須告訴 Java 如何在一堆類別檔案裡，找到主要入門/入口類別。
方式在 <code>JDBC</code> 4.0 前後有很大不同</li>
</ul>
<h4 id="1-jdbc-40-之前">1. <code>JDBC 4.0</code> 之前</h4>
<ul>
<li>
<p>呼叫 <code>DriverManager.getConnection()</code>前，必須用字串明確指出驅動程式主類別為何，如範例行2</p>
<ul>
<li>以 Derby drivers 為例，如以下範例行3</li>
</ul>
</li>
<li>
<p>因為有可能類別字串寫錯，或忘記將 JAR 檔加入 Eclipse 專案類別路徑中而找不到，因此必須處理例外 <code>ClassNotfoundException</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//java.lang.Class.forName(&#34;{fully qualified path of the driver}&#34;);  //ln#2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;org.apache.derby.jdbc.ClientDriver&#34;</span><span class="o">);</span>      <span class="c1">//ln#3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotfoundException</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>或是在指令列裡指定驅動程式的主類別字串</p>
<pre tabindex="0"><code class="language-terminal" data-lang="terminal">java -djdbc.drivers={fully qualified path to the driver} {class to run}
</code></pre></li>
</ul>
<h4 id="2-jdbc-40-之後">2. <code>JDBC 4.0</code> 之後</h4>
<ul>
<li>
<p>驅動程式的主類別已註記再 JAR 的 <code>META_INF/services/java.sql.Driver</code> 檔案內，為 <code>org.apache.derby.jdbc.ClientDriver</code></p>
</li>
<li>
<p>因此在 <code>DriverManager.getConnection()</code> 時，就不需要在程式碼裡特別註記驅動程式主類別</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/kDzXmEA.png"
        data-srcset="https://i.imgur.com/kDzXmEA.png, https://i.imgur.com/kDzXmEA.png 1.5x, https://i.imgur.com/kDzXmEA.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/kDzXmEA.png"
        title="image-20230118162247728" /></p>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>Little Tips:</strong> Derby 資料庫再版本 10.14.2.0 與 10.15.2.0 的差別</p>
<table>
<thead>
<tr>
<th>Derby 資料庫版本 10.14.2.0</th>
<th>Derby 資料庫版本 10.15.2.0</th>
</tr>
</thead>
<tbody>
<tr>
<td>支援 Java 8</td>
<td>建議 Java 9 以上（使用模組化技術）</td>
</tr>
<tr>
<td>版本驅動程式入口類別<!-- raw HTML omitted --><code>org.apache.derby.jdbc.ClientDriver</code></td>
<td>後來是 <!-- raw HTML omitted --><code>org.apache.derby.client.ClientAutoloadedDriver</code></td>
</tr>
<tr>
<td>設定 Eclipse 連線 Derby 資料庫的 <code>New Driver Definition</code> 時，<!-- raw HTML omitted -->第3個頁籤 Properties 之屬性「Driver Class」預設值是 <code>org.apache.derby.jdbc.ClientDriver</code></td>
<td>需要改為 <code>org.apache.derby.client.ClientAutoloadedDriver</code></td>
</tr>
<tr>
<td>加入驅動程式到 Java 專案時，<!-- raw HTML omitted -->早期版本引用 <code>derbyclient.jar</code></td>
<td>需引用 <code>derbyclient.jar</code> 與 <code>derbyshared.jar</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p>&hellip;</p>
<h3 id="開發-jdbc-程式">開發 JDBC 程式</h3>
<h4 id="jdbc-程式的組成">JDBC 程式的組成</h4>
<p>開發 <code>JDBC</code> 程式的主要步驟</p>
<ol>
<li>
<p>指定 URL (Uniform Resource Locator)</p>
<ul>
<li>
<p>URL 用來指出連線資料庫時使用的 driver 名稱/種類、資料庫位置（IP + Port）或其他建立連線時需要一併提供的屬性名稱與值</p>
<pre tabindex="0"><code>jdbc:&lt;driver&gt;:[sub_protocol:] [databaseName] [;attribute=value]
</code></pre></li>
<li>
<p>以 Derby 資料庫為例</p>
<pre tabindex="0"><code>String url = &#34;jdbc:derby://localhost:1527/EmployeeDB&#34;;
</code></pre></li>
<li>
<p>以 Oracle 資料庫為例</p>
<pre tabindex="0"><code>String url = &#34;jdbc:oracle:thin:@//myhost:1521/orcl&#34;;
</code></pre></li>
</ul>
</li>
<li>
<p>使用 <code>DriverManager</code> 取得 <code>java.sql.Connection</code> 的物件，該物件將建立與資料庫的連線 (session)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>java.sql.Connection</code> 取得 <code>java.sql.Statement</code> 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 <code>java.sql.ResultSet</code> 取得 <code>jaav.sql.Statement</code> 執行 SQL 後的查詢結果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&#34;SELECT * FROM Employee&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="resultset的特性與使用方式"><code>ResultSet</code>的特性與使用方式</h4>
<p><code>ResultSet</code>物件代表 <code>SQL</code> 查詢資料庫之後得到的結果，內部用游標（cursor）的移動代表目前所讀取的資料列</p>
<ol>
<li>
<p>游標最初指向第 0 筆資料</p>
</li>
<li>
<p>呼叫 <code>ResultSet</code> 的 <code>next()</code> 方法可移動游標，取得指向某筆資料的游標</p>
</li>
<li>
<p>若回傳 false，表示已無資料可以讀取</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/6Am5js2.png"
        data-srcset="https://i.imgur.com/6Am5js2.png, https://i.imgur.com/6Am5js2.png 1.5x, https://i.imgur.com/6Am5js2.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/6Am5js2.png"
        title="image-20230119103204455" /></p>
</li>
</ol>
<p>另外，<code>ResultSet</code> 物件具有多種屬性可以設定</p>
<table>
<thead>
<tr>
<th>分類依據</th>
<th>屬性</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>Concurrency</td>
<td><code>CONCUR_READ_ONLY</code></td>
<td>指向資料是唯讀</td>
</tr>
<tr>
<td>Concurrency</td>
<td><code>CONCUR_UPDATABLE</code></td>
<td>指向資料可修改</td>
</tr>
<tr>
<td>Type</td>
<td><code>TYPE_FORWARD_ONLY</code></td>
<td>游標只能往前</td>
</tr>
<tr>
<td>Type</td>
<td><code>TYPE_SCROLL_INSENSITIVE</code></td>
<td>游標可往前往後，無法感知資料被修改</td>
</tr>
<tr>
<td>Type</td>
<td><code>TYPE_SCROLL_SENSITIVE</code></td>
<td>游標可往前往後，可以感知資料被修改</td>
</tr>
</tbody>
</table>
<p>必須在建立 Statement 物件時設定 <code>ResultSet</code> 屬性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span><span class="n">ResultSet</span><span class="o">.</span><span class="na">TYPE_SCROLL_INSENSITIVE</span><span class="o">,</span> <span class="n">ResultSet</span><span class="o">.</span><span class="na">CONCUR_UPDATABLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s">&#34;SELECT a, b FROM TABLE2&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>設定後的實際情況，必須視該種資料庫的廠商是否實作該屬性而定</p>
<p><code>ResultSet</code> 可以使用回傳各種型態的 <code>getter</code> 方法，來取得每筆一資料的每個欄位內容</p>
<h4 id="jdbc程式完整範例"><code>JDBC</code>程式完整範例</h4>
<p>結合使用 <code>DriverManager</code>、<code>Connection</code>、<code>Statement</code> 與 <code>ResultSet</code> 的完整範例如下，可輸出資料庫 myDB 的資料表 Employee 的所有資料</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#34;jdbc:derby://localhost:1527/myDB&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">&#34;root&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&#34;sa&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&#34;SELECT * FROM Employee&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">try</span> <span class="o">(</span><span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">empID</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;ID&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;FirstName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">String</span> <span class="n">last</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;LastName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">Date</span> <span class="n">birthDate</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;BirthDate&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">float</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getFloat</span><span class="o">(</span><span class="s">&#34;Salary&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">empID</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">first</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">last</span> 
</span></span><span class="line"><span class="cl">                               <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">birthDate</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">salary</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;SQL Exception: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="結束-jdbc-相關物件的使用">結束 <code>JDBC</code> 相關物件的使用</h3>
<ul>
<li>
<p><code>JDBC</code> 存取資料庫的主要物件，<code>Connection</code>、<code>Statement</code>、<code>ResultSet</code> 都實作了 <code>java.lang.AutoCloseable</code> 介面</p>
</li>
<li>
<p>皆屬於外部資源，使用後都必須呼叫 <code>close()</code> 方法予以關閉。如下原則</p>
<ol>
<li>
<p>關閉 Connection 物件，會自動關閉相關 Statement 物件；</p>
<ul>
<li>關閉 Statement 物件，也會自動關閉相關 <code>ResultSet</code> 物件；</li>
<li>但 <code>ResultSet</code> 對應的相關資源並未被自動關閉或釋出，必須等 Java 啟動 <code>GC</code> 機制</li>
<li>只有明確呼叫 <code>ResultSet</code> 的 <code>close()</code> 方法，才能馬上釋放相關資源</li>
</ul>
</li>
<li>
<p>如果使用相同 <code>Statement</code> 物件重新執行查詢，則原先已開啟的 <code>ResultSet</code> 將自動關閉，再使用該 <code>ResultSet</code> 就會出錯</p>
</li>
<li>
<p>應該明確呼叫 <code>Connection</code>、<code>Statement</code> 和 <code>ResultSet</code> 的 <code>close()</code> 方法，或利用 <strong>try-with-resource</strong> 敘述</p>
<ul>
<li>關閉資源的順序和開啟時順序相反</li>
</ul>
</li>
<li>
<p>只有在 <strong>try-with-resource</strong> 區塊裡明確宣告的物件，才會被自動關閉</p>
<ul>
<li>
<p>以下作法只有 <code>ResultSet</code> 物件會被自動關閉</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">(</span> <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">DriverManager</span>
</span></span><span class="line"><span class="cl">     			   <span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    			   <span class="o">.</span><span class="na">createStatement</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    			   <span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">))</span> <span class="o">{</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
</li>
</ul>
<p>&hellip;</p>
<h3 id="開發可攜式的-jdbc-程式碼">開發可攜式的 <code>JDBC</code> 程式碼</h3>
<ul>
<li>
<p><code>JDBC</code> 相關 <code>API</code> 設計目的是讓 Java 程式碼可以依賴於 <code>JDBC</code> 建立的抽象層</p>
</li>
<li>
<p>而不是和底層資料庫綁定太深，太依賴資料庫</p>
</li>
<li>
<p>未來如果要抽換資料庫，可以影響最小</p>
</li>
<li>
<p>系統架構分層（insulating layer）概念：
<code>Connection</code>、<code>Statement</code>、<code>ResultSet</code> 都是介面，由資料庫廠商實作</p>
</li>
<li>
<p>美國國家標準學會（American National Standards Institute, ANSI）定義的 <strong>SQL-92 Entry-level specification</strong></p>
<ul>
<li>提倡所有資料庫廠商都能支援 <strong>SQL-92</strong> 的標準查詢語法，盡量讓相同語法可以在不同資料庫之間使用</li>
</ul>
</li>
<li>
<p>可以用 <code>DatabaseMetaData</code> 介面的 <code>supportsANSI92EntryLevelSQL()</code> 方法回傳 true 或 false，確認使用中的資料庫有沒有支援 SQL-92 語法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">showDatabaseMetaData</span><span class="o">(</span><span class="n">Connection</span> <span class="n">con</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DatabaseMetaData</span> <span class="n">dbm</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Support for entry-level SQL-92 standard: &#34;</span> 
</span></span><span class="line"><span class="cl">                       <span class="o">+</span> <span class="n">dbm</span><span class="o">.</span><span class="na">supportsANSI92EntryLevelSQL</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用資料庫原生 native SQL 的程式碼，將造成日後轉換資料庫的困難</p>
<ul>
<li>MS SQL(TSQL) : <code>SELECT TOP 10 * FROM [some_table]</code></li>
<li>Oracle (PLSQL) : <code>SELECT * FROM [some_table] WHERE ROWNUM &lt;= 10</code></li>
</ul>
</li>
</ul>
<h3 id="使用-javasqlsqlexception-類別">使用 <code>java.sql.SQLException</code> 類別</h3>
<ul>
<li>
<p><code>SQLException</code>類別和一般 Exception 不同，可得到更多存取資料庫產生的各種錯誤訊息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">ex</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;SQLState: &#34;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Error Code in DB: &#34;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getErrorCode</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Message: &#34;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Throwable</span> <span class="n">throwable</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Cause: &#34;</span> <span class="o">+</span> <span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">throwable</span> <span class="o">=</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getNextException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="statement-介面與-sql-敘述的執行">Statement 介面與 <code>SQL</code> 敘述的執行</h3>
<ul>
<li>
<p>執行 SQL 敘述 statement 時，必須有 Statement 的物件。</p>
</li>
<li>
<p>即 Statement 介面是 SQL statement 的包覆類別（wrapper class）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">sqlStatement</span> <span class="o">=</span> <span class="s">&#34;SELECT * ...&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sqlStatement</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>根據 SQL statement 不同種類，有不同執行方式</p>
<table>
<thead>
<tr>
<th>SQL敘述種類</th>
<th>方法</th>
<th>回傳</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT</td>
<td><code>executeQuery(sql)</code></td>
<td><code>ResultSet</code></td>
</tr>
<tr>
<td>INSERT、UPDATE、DELETE、DDL&hellip;</td>
<td><code>executeUpdate(sql)</code></td>
<td>int<!-- raw HTML omitted -->表示影響的資料筆數</td>
</tr>
<tr>
<td>任何 SQL 指令</td>
<td><code>execute(sql)</code></td>
<td>boolean<!-- raw HTML omitted -->表示是否有<code>ResultSet</code></td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3 id="使用-resultsetmetadata-介面">使用 <code>ResultSetMetaData</code> 介面</h3>
<p>使用 <code>ResultSetMetaData</code> 介面取得 <code>ResultSet</code> 的</p>
<ol>
<li>
<p>欄位數量 - 使用 <code>getColumnCount()</code> 方法</p>
</li>
<li>
<p>欄位名稱 - 使用 <code>getColumnName()</code> 方法</p>
</li>
<li>
<p>欄位型態 - 使用 <code>getColumnTypeName()</code> 方法</p>
<ul>
<li>
<p>須注意指定欄位的 <strong>由「1」起算</strong>，非「0」</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">showRsMetaData</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">numCols</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">().</span><span class="na">getColumnCount</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">colNames</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">numCols</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">colTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">numCols</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numCols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">colNames</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">().</span><span class="na">getColumnName</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">colTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">().</span><span class="na">getColumnTypeName</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 資料表欄位位置由1起算，但迴圈i由0開始，所以必須是 i+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<p>&hellip;</p>
<h3 id="取得查詢結果的資料筆數">取得查詢結果的資料筆數</h3>
<ul>
<li>
<p>可以利用游標（cursor）前後移動，取得查詢結果的資料筆數，在這之前須先設定屬性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">(</span><span class="n">ResultSet</span><span class="o">.</span><span class="na">TYPE_SCROLL_INSENSITIVE</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">                                                 <span class="n">ResultSet</span><span class="o">.</span><span class="na">CONCUR_READ_ONLY</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>方法一</strong>：執行查詢取得<code>ResultSet</code>物件後，可以由以下範例取得結果的資料筆數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">rowCountByCursor</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rowCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">currRow</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getRow</span><span class="o">();</span> <span class="c1">//紀錄目前 cursor 位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">rs</span><span class="o">.</span><span class="na">last</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>  <span class="c1">//使用last()方法將游標移到最後一筆資料,如發現沒資料時回傳false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rowCount</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getRow</span><span class="o">();</span>  <span class="c1">// 因為游標已移動到最後一筆資料,該所在位置即為資料筆數
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">currRow</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>        <span class="c1">// ln#7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">rs</span><span class="o">.</span><span class="na">beforeFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">rs</span><span class="o">.</span><span class="na">absolute</span><span class="o">(</span><span class="n">currRow</span><span class="o">);</span> <span class="c1">// ln#7 - 10 將 cursor 移回原先位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">rowCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>方法二</strong>：使用 SQL 語法的 <code>count()</code> 函數，直接取得滿足條件的資料筆數</p>
<ul>
<li>
<p>不用調整 cursor，用預設的 <code>Statement</code> 物件即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">rowCountBySQL</span><span class="o">(</span><span class="n">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="n">String</span> <span class="n">money</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&#34;SELECT COUNT(*) FROM Employee WHERE Salary &gt; &#34;</span> <span class="o">+</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">(</span><span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span> 
</span></span><span class="line"><span class="cl">            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 每個Statement物件只能執行一次SQL，不能重複使用
</span></span></span><span class="line"><span class="cl"><span class="cm">           所以傳入Connection物件，用它重新產生Statement物件，再執行SQL */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="控制-resultset-每次由資料庫取回的筆數">控制 <code>ResultSet</code> 每次由資料庫取回的筆數</h3>
<ul>
<li>
<p>使用 Statement 物件執行 Query 後取得 <code>ResultSet</code>物件，並不是由資料庫將資料一次全部拿回來</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Java 會從資料庫中 &#34;每次抓回一定的筆數&#34; 才進行迴圈，減少對DB的頻繁I/O
</span></span></span><span class="line"><span class="cl"><span class="cm">       筆數預設由 JDBC driver 驅動程式控制 */</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>要自行控制的作法 <code>rs.setFetchSize(25);</code></p>
<ul>
<li>每次只拿 25 筆資料，第 26 筆時再連線資料庫撈取下一批 25 筆資料</li>
<li>避免一次取太多資料而影響 JVM</li>
</ul>
</li>
</ul>
<h3 id="使用-preparedstatement">使用 <code>PreparedStatement</code></h3>
<p>先來看 Oracle SQL 使用**繫結變數（bind variables）<strong>的作法，以</strong>?**取代欄位內容，先送SQL，後送欄位內容，可避免該SQL敘述因為每次欄位內容被反覆編譯，造成資料庫主機負載</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">Employee</span><span class="p">]</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">Salary</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>這種作法在 JDBC 則稱為使用 <code>PreparedStatement</code> 介面，該介面繼承 <code>Statement</code> 介面，使預先編譯 pre-compiled SQL 可以再和傳入的參數配合</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runPreparedStatement</span><span class="o">(</span><span class="n">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="kt">double</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&#34;SELECT * FROM Employee WHERE Salary &gt; ? &#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PreparedStatement</span> <span class="n">pStmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pStmt</span><span class="o">.</span><span class="na">setDouble</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">pStmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">printResultSet</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note:</p>
<ol>
<li>SQL 裡的每一個 <strong>?</strong> 都必須有相應數值</li>
<li>藉由 <code>setXXX(index, value)</code> 的方法帶入 value，index 從 1 起算，配合 <strong>?</strong> 的出現順序</li>
<li>可避免每次執行 SQL 時候，DB重新編譯 SQL 耗費的資源</li>
</ol>
<h4 id="sql-injection">SQL injection</h4>
<p>使用 <code>PreparedStatement</code> 另一個原因是可以避免 <em>SQL injection</em> 網路駭客攻擊</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runSqlInjection</span><span class="o">(</span><span class="n">Connection</span> <span class="n">con</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">&#34;SELECT * FROM Employee WHERE Salary &gt; &#34;</span> <span class="o">+</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span> <span class="c1">// 容易被攻擊
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printResultSet</span><span class="o">(</span><span class="n">rs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>與前一個方法（傳入 <strong>double</strong> value）相比，此方法（傳入 <strong>String</strong> value）如果有駭客剛好瞭解 Employee 的資料表結構，或故意在傳入字串後面加上 <code>or 1=1</code>，會帶出 table Employee 內所有資料，讓公司營業機密或個資外洩</p>
<ul>
<li><code>SELECT * FROM Employee WHERE Salary &gt; 100;</code></li>
<li><code>SELECT * FROM Employee WHERE Salary &gt; 100 or 1=1;</code></li>
</ul>
<h2 id="使用-jdbc-進行交易">使用 <code>JDBC</code> 進行交易</h2>
<h3 id="何謂資料庫交易">何謂資料庫交易</h3>
<ul>
<li>
<p>將多個對資料庫的存取行為視為同一個，而且同進退：一起發生（commit）或一起未發生（rollback）</p>
</li>
<li>
<p>一個交易裡的行為（query, delete, insert, update）可以跨資料庫</p>
</li>
<li>
<p>交易的 ACID 特色</p>
<ol>
<li>Atomicity 原子性： 一個交易中的所有行為一起完成，或一起未完成（回復至未進行交易的狀態）</li>
<li>Consistency 一致性：系統原來一致性的狀態 &mdash;[交易]&mdash;&gt; 另一個一致性的狀態</li>
<li>Isolation 獨立性：兩個同時發生的交易，彼此互相不影響</li>
<li>Durability 持久性：已完成的交易繼續保持，如果系統毀損可以用交易紀錄日誌 transaction log 還原</li>
</ol>
</li>
<li>
<p>commit (確認交易) 、rollback (取消交易)</p>
</li>
</ul>
<h3 id="使用-jdbc-的交易">使用 JDBC 的交易</h3>
<ul>
<li>
<p>當建立 connection 物件時，預設為「auto commit」模式，此時單一 SQL 會被視為獨立交易，完成後自動 commit</p>
</li>
<li>
<p>如果要將兩個以上的 SQL 作成交易群組，必須先關 auto commit 模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>接著完成交易時必須呼叫方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>也可以取消交易</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">con</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>關於啟動交易，JDBC 沒有明確的方法，依據 JDBC JSR (221) 綱要：</p>
<ol>
<li>以關閉 auto commit 模式的時候開始，接下來的所有 SQL 都算成同一個交易，一直到 commit 或者 rollback 被執行</li>
<li>如果交易進行中 auto commit 模式被改變，則交易將自動 commit</li>
</ol>
<p>&hellip;</p>
<h2 id="使用-jdbc-41-的-rowsetprovider-和-rowsetfactory">使用 JDBC 4.1 的 RowSetProvider 和 RowSetFactory</h2>
<p>Java 7 的新版 <code>RowSet 1.1</code> 使用 <code>javax.sql.rowset.RowSetProvider</code>取得 <code>RowSetFactory</code> 物件，預設實作 <code>com.sun.rowset.RowSetFactoryImpl</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">RowSetFactory</span> <span class="n">myRowSetFactory</span> <span class="o">=</span> <span class="n">RowSetProvider</span><span class="o">.</span><span class="na">newFactory</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>回傳的 <code>RowSetFactory</code> 則用來建立 <code>RowSet 1.1</code> 中的 <code>RowSet</code> 物件，常見如下：</p>
<table>
<thead>
<tr>
<th>介面</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CachedRowSet</code></td>
<td>可以將資料庫取得的資料儲存在記憶體中，避免經常連線</td>
</tr>
<tr>
<td><code>FilteredRowSet</code></td>
<td>繼承<code>CachedRowSet</code>，可以有過濾資料的功能</td>
</tr>
<tr>
<td><code>JdbcRowSet</code></td>
<td>是 <code>ResultSet</code> 的 wrapper 物件，讓 <code>ResultSet</code> 行為像 <code>JavaBean</code><!-- raw HTML omitted -->也可以和資料庫保持連線狀態</td>
</tr>
<tr>
<td><code>JoinRowSet</code></td>
<td>可以把兩個不同 <code>RowSet</code> 合併成一個 <code>JoinRowSet</code>，功能像SQL表格的 join</td>
</tr>
<tr>
<td><code>WebRowSet</code></td>
<td>支援將 <code>RowSet</code> 以標準的 XML 格式表現</td>
</tr>
</tbody>
</table>
<h3 id="jdbcrowset介面示範"><code>JdbcRowSet</code>介面示範</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcRowSetTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#34;jdbc:derby://localhost:1527/myDB&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">&#34;root&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&#34;sa&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">RowSetFactory</span> <span class="n">myRowSetFactory</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="n">RowSetProvider</span><span class="o">.</span><span class="na">newFactory</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">(</span><span class="n">JdbcRowSet</span> <span class="n">jdbcRs</span> <span class="o">=</span> <span class="n">myRowSetFactory</span><span class="o">.</span><span class="na">createJdbcRowSet</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">jdbcRs</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">jdbcRs</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">jdbcRs</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">jdbcRs</span><span class="o">.</span><span class="na">setCommand</span><span class="o">(</span><span class="s">&#34;SELECT * FROM Employee&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">jdbcRs</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">jdbcRs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">empID</span> <span class="o">=</span> <span class="n">jdbcRs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;ID&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">jdbcRs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;FirstName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">String</span> <span class="n">last</span> <span class="o">=</span> <span class="n">jdbcRs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&#34;LastName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Date</span> <span class="n">birthDate</span> <span class="o">=</span> <span class="n">jdbcRs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">&#34;BirthDate&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">jdbcRs</span><span class="o">.</span><span class="na">getFloat</span><span class="o">(</span><span class="s">&#34;Salary&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;ID: &#34;</span> <span class="o">+</span> <span class="n">empID</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Employee Name: &#34;</span> <span class="o">+</span> <span class="n">first</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">last</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Birth Date: &#34;</span> <span class="o">+</span> <span class="n">birthDate</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Salary: &#34;</span> <span class="o">+</span> <span class="n">salary</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h2 id="回顧-dao-設計模式">回顧 DAO 設計模式</h2>
<p>幫 <code>EmployeeDAO</code> 介面增加實作類別 <code>EmployeeDAOJDBCImpl</code></p>
<ul>
<li><code>EmployeeDAO</code> <em>interface</em>
<ul>
<li><code>addEmployeeDAO()</code> : void</li>
<li><code>update(Employee e)</code> : void</li>
<li><code>delete(int id)</code> : void</li>
<li><code>findById(int id)</code> : Employee</li>
<li><code>getAllEmployees()</code> : Employee[]</li>
</ul>
</li>
<li><code>EmployeeDAOMemoryImpl</code> implements <code>EmployeeDAO</code></li>
<li><code>EmployeeDAOJDBCImpl</code> implements <code>EmployeeDAO</code></li>
<li><code>EmployeeDAOFileImpl</code> implements <code>EmployeeDAO</code></li>
</ul>
<hr>
<h1 id="08-java-的區域化-localization">08 Java 的區域化 <em>Localization</em></h1>
<h2 id="了解-java-的軟體區域化作法">了解 Java 的軟體區域化作法</h2>
<p>Java 的軟體區域化 localization 方式：藉由增加和「特定地區 / 地域」相關的元件和翻譯文字，使軟體可呈現「特定地區 / 地域」的語言文字、日期、數字、幣別等與文化相關的特殊格式</p>
<p>Java 滿足軟體區域化和支援多國語系的需要，不是藉由 (複製 -&gt; 修改文字呈現相關 codes) 的方式，這會讓程式碼越來越多份，違背 DRY 法則。</p>
<p>Java 作法：事先準備多份各國語系的文字檔，依需求載入 JVM，再嵌入（plug-in）文字呈現的畫面或功能中。需要三個核心元件 -</p>
<ol>
<li><code>Locale</code> 類別 - 代表特定地區 / 地域</li>
<li>多國語系文字檔（i.e. 資源綁定檔案）- 存放各國文字，檔案各自獨立</li>
<li><code>ResourceBundle</code>類 - 用來對應多國語系文字檔，建立物件時，檔案內容自動載入到物件裡</li>
</ol>
<h3 id="使用-locale-類別">使用 Locale 類別</h3>
<p>Java 用 Locale（場所、場域）不用國別決定不同語言，主要因為有些國家幅員廣大（可能有多個語言），所以用 Locale 類代表特定語言和國家的組合</p>
<ol>
<li><strong>語言</strong>
<ul>
<li>使用 alpha-2 或 alpha-3 ISO 639 編碼</li>
<li>小寫 (e.g. de for German，en for English，fr for French，zh for Chinese)</li>
</ul>
</li>
<li><strong>國家</strong>
<ul>
<li>使用 ISO 3166 alpha-2 country 編碼或 UN M.49 numeric area 編碼</li>
<li>大寫 (e.g. DE for Germany, US for United States, FR for France, CN for China)</li>
</ul>
</li>
</ol>
<p>常見建構 Locale 物件的方式：</p>
<ol>
<li>
<p>使用 Locale 類別已經定義的常數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Locale</span> <span class="n">twLocale1</span> <span class="o">=</span> <span class="n">Locale</span><span class="o">.</span><span class="na">TAIWAN</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>提供 language 和 country 代碼字串作為建構子的輸入參數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Locale</span> <span class="n">twLocale2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Locale</span><span class="o">(</span><span class="s">&#34;zh&#34;</span><span class="o">,</span> <span class="s">&#34;TW&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="建立多國語系文字檔">建立多國語系文字檔</h3>
<p>多國語系文字檔（資源綁定檔案_resource bundle files）的製作方式</p>
<ol>
<li>以 <code>.properties</code> 作為副檔名</li>
<li>針對程式需要支援的每種語系建立獨立檔案
<ul>
<li>每個檔案的主要檔名相同，再加上<em>語言</em> 和 <em>國家</em> 代碼做區隔</li>
<li>即需要對系統會用到的 locale 建立對應的檔案</li>
<li>如檔案上都沒有 <em>語言</em> 和 <em>國家</em> 代碼，則為預設檔（程式找不到對應多國語系文字檔的最後防線）</li>
</ul>
</li>
<li>檔案內含許多成對的 key、value
<ul>
<li>每個檔案的 key 數量、內容皆一致，會被使用於程式碼中</li>
<li>value - 各 locale 的當地文字</li>
</ul>
</li>
</ol>
<p>主要檔名為 <code>MessageBundle</code>，所以預設檔案為 <code>MessageBundle.properties</code>，再依需求建立文字檔，規則</p>
<pre tabindex="0"><code class="language-note" data-lang="note">MessageBundle_xx_YY.properties
/* xx：語言代碼，小寫
   YY：國家代碼，大寫 */
</code></pre><ul>
<li>
<p><code>MessageBundle.properties</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">menu1</span> <span class="o">=</span> <span class="s">Set to English</span>
</span></span><span class="line"><span class="cl"><span class="na">menu2</span> <span class="o">=</span> <span class="s">Set to French</span>
</span></span><span class="line"><span class="cl"><span class="na">menu3</span> <span class="o">=</span> <span class="s">Set to Chinese</span>
</span></span><span class="line"><span class="cl"><span class="na">menu4</span> <span class="o">=</span> <span class="s">Set to Russian</span>
</span></span><span class="line"><span class="cl"><span class="na">menu5</span> <span class="o">=</span> <span class="s">Show the Date</span>
</span></span><span class="line"><span class="cl"><span class="na">menu6</span> <span class="o">=</span> <span class="s">Show the money</span>
</span></span><span class="line"><span class="cl"><span class="na">menuq</span> <span class="o">=</span> <span class="s">Enter q to quit</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>MessageBundle_fr_FR.properties</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">menu1</span> <span class="o">=</span> <span class="s">Régler à l&#39;anglais </span>
</span></span><span class="line"><span class="cl"><span class="na">menu2</span> <span class="o">=</span> <span class="s">Régler au français </span>
</span></span><span class="line"><span class="cl"><span class="na">menu3</span> <span class="o">=</span> <span class="s">Réglez chinoise </span>
</span></span><span class="line"><span class="cl"><span class="na">menu4</span> <span class="o">=</span> <span class="s">Définir pour la Russie </span>
</span></span><span class="line"><span class="cl"><span class="na">menu5</span> <span class="o">=</span> <span class="s">Afficher la date </span>
</span></span><span class="line"><span class="cl"><span class="na">menu6</span> <span class="o">=</span> <span class="s">Montrez-moi l&#39;argent! </span>
</span></span><span class="line"><span class="cl"><span class="na">menuq</span> <span class="o">=</span> <span class="s">Saisissez q pour quitter </span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>以上檔案可以放在 Eclipse 的 src 路徑底下</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/5uE1dOx.png"
        data-srcset="https://i.imgur.com/5uE1dOx.png, https://i.imgur.com/5uE1dOx.png 1.5x, https://i.imgur.com/5uE1dOx.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/5uE1dOx.png"
        title="image-20230204002143295" /></p>
</li>
</ul>
<h3 id="使用-resourcebundle-類別">使用 <code>ResourceBundle</code> 類別</h3>
<ul>
<li>使用 <code>ResourceBundle</code>（資源綁定）綁定像是多國語系文字檔的資源</li>
<li>此類別又稱為 <strong>資源綁定檔案（resource bundle files）</strong></li>
<li>資源還可以是 <code>.class</code>，只是一般比較少使用</li>
</ul>
<p>使用 <code>ResourceBundle</code> 類別建立物件時，必須提供</p>
<ol>
<li>
<p>多國語系文字檔的主要檔案名稱，例如 <code>MessageBundle</code></p>
</li>
<li>
<p>物件 <code>Locale</code>：代表某一個「語言」和「國家」的組合，例如 <code>zh</code> 和 <code>TW</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Locale</span> <span class="n">twLocale</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Locale</span><span class="o">(</span><span class="s">&#34;zh&#34;</span><span class="o">,</span> <span class="s">&#34;TW&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ResourceBundle</span> <span class="n">bundle</span> <span class="o">=</span> <span class="n">ResourceBundle</span><span class="o">.</span><span class="na">getBundle</span><span class="o">(</span><span class="s">&#34;MessageBundle&#34;</span><span class="o">,</span> <span class="n">twLocale</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="使用-dateformat-類別提供日期的區域化顯示">使用 <code>DateFormat</code> 類別提供日期的區域化顯示</h2>
<p>Java 使用 <code>DateFormat</code> 類別搭配 <code>Locale</code> 物件，以提供日期的區域化顯示，如下步驟：</p>
<ol>
<li>取得 <code>java.util.Date</code> 日期物件</li>
<li>搭配 <code>Locale</code> 取得 <code>DateFormat</code> 物件，並挑選格式</li>
<li>呼叫 <code>DateFormat</code> 物件的 <code>format()</code> 方法，並傳入 <code>java.util.Date</code> 日期物件</li>
</ol>
<h3 id="日期格式選項">日期格式選項</h3>
<p>日期格式選項可以是：</p>
<ol>
<li>由類別 <code>DateFormat</code> 提供的常數指定
<ul>
<li><strong>SHORT</strong>：「12.13.52」、「3:30 pm」</li>
<li><strong>MEDIUM</strong>：「Jan 12, 1952」</li>
<li><strong>LONG</strong>：「January 12, 1952」、「3:30:32 pm」</li>
<li><strong>FULL</strong>：「Tuesday, April 12, 1952 AD」、「3:30:42 pm PST」</li>
</ul>
</li>
<li>類別 <code>DateFormat</code> 的子類別 <code>SimpleDateFormat</code> 指定特定格式
<ul>
<li><code>yyyy/MM/dd HH:mm:ss</code></li>
<li><code>yyyy/MMM/dd HH:mm:ss</code></li>
<li><code>yyyy/MMMM/dd HH:mm:ss</code></li>
</ul>
</li>
</ol>
<h2 id="使用-numberformat-類別提供幣別區域化顯示">使用 <code>NumberFormat</code> 類別提供幣別區域化顯示</h2>
<p>使用 <code>NumberFormat</code> 類別搭配 <code>Locale</code> 物件，提供幣別的區域化顯示，如下步驟：</p>
<ol>
<li><code>Locale</code>物件傳入 <code>NumberFormat</code> 類別的 static 工廠方法中，以取得幣別物件實例</li>
<li>呼叫幣別物件實例的 <code>format()</code> 方法，並傳入數字金額
<ul>
<li>數字金額可以為基本型別或者其包覆類別</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NumberFormat</span> <span class="n">nf</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">nf</span> <span class="o">=</span> <span class="n">NumberFormat</span><span class="o">.</span><span class="na">getCurrencyInstance</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Locale.US: &#34;</span> <span class="o">+</span> <span class="n">nf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">1000</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">nf</span> <span class="o">=</span> <span class="n">NumberFormat</span><span class="o">.</span><span class="na">getCurrencyInstance</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">TAIWAN</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Locale.TAIWAN: &#34;</span> <span class="o">+</span> <span class="n">nf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">1000</span><span class="o">.</span><span class="na">00</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">nf</span> <span class="o">=</span> <span class="n">NumberFormat</span><span class="o">.</span><span class="na">getCurrencyInstance</span><span class="o">(</span><span class="n">Locale</span><span class="o">.</span><span class="na">JAPAN</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Locale.JAPAN: &#34;</span> <span class="o">+</span> <span class="n">nf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">1000</span><span class="o">.</span><span class="na">00</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h1 id="09-lambda-表示式的應用">09 Lambda 表示式的應用</h1>
<h2 id="使用-lambda-表示式">使用 Lambda 表示式</h2>
<h3 id="匿名類別與功能性介面回顧">匿名類別與功能性介面回顧</h3>
<p>匿名內部類別（anonymous Inner Class）使用時機：</p>
<ol>
<li>只使用一次，所以不需要特別定義類別，可減少程式碼撰寫</li>
<li>希望把相關程式碼擺在同一地方</li>
<li>增加封裝程度</li>
<li>提高程式碼可讀性</li>
</ol>
<p>Java 8 功能性介面（functional interface）的特色：</p>
<ol>
<li>只有一個抽象方法的介面</li>
<li>該介面可以標註 <code>@FunctionalInterface</code></li>
</ol>
<p>功能性介面範例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FunctionalInterface</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StringAnalyzer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">analyze</span><span class="o">(</span><span class="n">String</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">keyStr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>實作以上介面的類別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContainsAnalyzer</span> <span class="kd">implements</span> <span class="n">StringAnalyzer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">analyze</span><span class="o">(</span><span class="n">String</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">keyStr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">terget</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">keyStr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析目標字串裡面是否含有關鍵字串，在 <code>StringAnalyzerTest</code> 建立以下方法</p>
<p>輸入字串陣列、關鍵字串和實作 <code>StringAnalyzer</code> 的子類別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">searchArr</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span><span class="o">,</span> <span class="n">String</span> <span class="n">keyStr</span><span class="o">,</span> <span class="n">StringAnalyzer</span> <span class="n">analyzer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str</span> <span class="o">:</span> <span class="n">strArr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">analyzer</span><span class="o">.</span><span class="na">analyze</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">keyStr</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以直接建立單一類別處理，不實作介面，拋棄多型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringAnalyzeTool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="n">String</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">searchStr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">searchStr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>但是如果未來需要有其他方法，像是「是否由某字串開頭（startsWith）」、「是否由某字串結尾（endsWith）」，則使用單一類別就必須不斷改程式以增加其他類似方法→違反 OCP法則、程式歡迎擴充、拒絕修改 <em>open for extension, close for modification</em></li>
</ul>
<p>比較是否使用「匿名內部類」的差異</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span> <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">searchArr</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="s">&#34;b&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">ContainsAnalyzer</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">             <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span><span class="o">[]</span> <span class="n">strArr</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&#34;abc&#34;</span><span class="o">,</span> <span class="s">&#34;bcd&#34;</span><span class="o">,</span> <span class="s">&#34;efg&#34;</span> <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">searchArr</span><span class="o">(</span><span class="n">strArr</span><span class="o">,</span> <span class="s">&#34;b&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">             <span class="k">new</span> <span class="n">StringAnalyzer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                 <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">analyze</span><span class="o">(</span><span class="n">String</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">keyStr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">keyStr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="lambda-表示式語法回顧">Lambda 表示式語法回顧</h3>
<h2 id="使用內建的功能性介面">使用內建的功能性介面</h2>
<p>Java 8 導入功能性介面的使用</p>
<ol>
<li>只能有一個抽象方法需要實作</li>
<li>Lambda 表示式必須搭配這類型的介面</li>
</ol>
<p>因為功能性介面只有一個抽象方法，能夠預期它的使用方式。Java 8 在 <code>java.util.function</code> 下內建許多功能性介面，可直接使用。基礎如下四種：</p>
<ol>
<li><strong>評斷型（predicate）</strong>：使用泛型傳入參數，回傳 boolean</li>
<li><strong>消費型（consumer）</strong>：使用泛型傳入參數，沒有回傳（void）</li>
<li><strong>功能型（function）</strong>：將傳入的參數由 T 型別轉換成 U 型別</li>
<li><strong>供應型（supplier）</strong>：如同工廠方法，提供 T 型別的實例 / 物件</li>
</ol>
<h3 id="評斷型功能性介面-predicate">評斷型功能性介面 Predicate</h3>
<p>代表介面是 Predicate</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Predicate&lt;T&gt;</code>：需要提供一個型別 T 滿足泛型，唯一方法 <code>test</code> 使用T型別作為參數</p>
<p>方法內容通常和 <strong>測試T型別的某些欄位或方法</strong> 有關，結果回傳 true 或 false</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">olderThan23</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">23</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="n">Person</span> <span class="n">p</span> <span class="o">:</span> <span class="n">Person</span><span class="o">.</span><span class="na">createList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">olderThan23</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">p</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上程式碼和以下的匿名類別是一樣的意思</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">olderThan23</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">Person</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">23</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="消費型功能性介面-consumer">消費型功能性介面 Consumer</h3>
<p>代表介面是 Consumer</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Consumer&lt;T&gt;</code>：提供一個 T 型別滿足泛型，並使用 T 型別作為參數，內容通常和 T 型別的某欄位/方法有關</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">printPerson</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">printPerson</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="n">Person</span> <span class="n">p</span> <span class="o">:</span> <span class="n">Person</span><span class="o">.</span><span class="na">createList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printPerson</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上程式碼和以下的匿名類別是一樣的意思</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">printPerson</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="n">Person</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">printPerson</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="功能型功能性介面-function">功能型功能性介面 Function</h3>
<p>代表介面是 Function</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">R</span> <span class="nf">apply</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Function&lt;T, R&gt;</code>：提供兩個型別 T、R 滿足泛型。唯一方法傳入 T 參數，回傳 R 型別 (R for result or reply)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nf">FunctionDemo</span> <span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Function</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">getNameFromPerson</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Person</span> <span class="n">p</span> <span class="o">:</span> <span class="n">Person</span><span class="o">.</span><span class="na">createList</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getNameFromPerson</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上程式碼和以下的匿名類別是一樣的意思</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Function</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">getNameFromPerson</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">String</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Person</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="供應型功能介面-supplier">供應型功能介面 Supplier</h3>
<p>代表介面是 Supplier</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Supplier&lt;T&gt;</code>：提供型別 T 滿足泛型。唯一方法沒有傳入參數，回傳 T 型別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personSupplier</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">person</span><span class="o">(</span><span class="s">&#34;Newt&#34;</span><span class="o">,</span> <span class="s">&#34;Scamander@fantastic.beasts.org&#34;</span><span class="o">,</span> <span class="n">21</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">personSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上代碼相當於下面的匿名內部類</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personSupplier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Person</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">&#34;Newt&#34;</span><span class="o">,</span> <span class="s">&#34;Scamander@fantastic.beasts.org&#34;</span><span class="o">,</span> <span class="n">21</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>&hellip;</p>
<h2 id="在泛型內使用萬用字元">在泛型內使用萬用字元</h2>
<p>泛型使用萬用字元 <code>wildcards</code>的符號為 <code>?</code></p>
<ol>
<li><code>&lt;?&gt;</code>
<ul>
<li>可以是任何型別，沒有上/下限</li>
</ul>
</li>
<li><code>&lt;? extends T&gt;</code>
<ul>
<li>泛型型別必須是 <strong>型別T</strong> 或者 <strong>T的子型別</strong></li>
<li><strong>以型別T為上邊界</strong>，但沒有下邊界</li>
</ul>
</li>
<li><code>&lt;? super T&gt;</code>
<ul>
<li>泛型型別必須是 <strong>型別T</strong> 或者 <strong>T的父型別</strong></li>
<li><strong>以型別T為下邊界</strong>，但沒有上邊界</li>
</ul>
</li>
</ol>
<h3 id="在泛型裡使用多型">在泛型裡使用多型</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/tUxMGOF.png"
        data-srcset="https://i.imgur.com/tUxMGOF.png, https://i.imgur.com/tUxMGOF.png 1.5x, https://i.imgur.com/tUxMGOF.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/tUxMGOF.png"
        title="image-20230214204322390" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ✅
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">listA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">listB</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ❌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">listA</span> <span class="o">=</span> <span class="n">listB</span><span class="o">;</span> <span class="c1">// fail to compile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">listA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;();</span> <span class="c1">// fail to compile
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>將宣告為 <code>List&lt;A&gt;</code> 的變數，指向 <code>ArrayList&lt;B&gt;</code> 的物件實例</p>
<p>(宣告: List內可放A、B、C物件) = (物件實例: 實際只能放入B的物件)</p>
<p>&hellip;</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ❌
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">listB</span> <span class="o">=</span> <span class="n">listA</span><span class="o">;</span> <span class="c1">// fail to compile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">listB</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span> <span class="c1">// fail to compile
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>將宣告為 <code>List&lt;B&gt;</code> 的變數，指向 <code>ArrayList&lt;A&gt;</code> 的物件實例</p>
<p>(只能拿出B的物件) = (物件實例: 可能拿出A、B、C的物件)</p>
<p>&hellip;</p>
</blockquote>
<h4 id="如果要在泛型使用繼承或多型必須用--super-t-或--extends-t">如果要在泛型使用繼承或多型，必須用 <code>&lt;? super T&gt;</code> 或 <code>&lt;? extends T&gt;</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;?&gt;</span> <span class="n">listUnknown0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// List裡可以是任何物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">listUnknown1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">listUnkown1Of1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 必須是 A 或者 A 的子類別
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">listUnknown2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">listUnknown2Of1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AA</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">listUnknown2Of2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 必須是 A 或者 A 的父類別
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="存取使用--的泛型的集合物件">存取使用 <code>&lt;?&gt;</code> 的泛型的集合物件</h3>
<ol>
<li>
<p>使用<code>&lt;?&gt;</code>時的注意事項</p>
<ul>
<li>
<p>不允許使用<code>add()</code> 方法加入物件</p>
</li>
<li>
<p>可以使用 Object class 作為參照型別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processElements</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;?&gt;</span> <span class="n">elements</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// elements.add(new A());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// elements.add(new B());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// elements.add(new C());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// elements.add(new Object());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">o</span> <span class="o">:</span> <span class="n">elements</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">testProcessElements</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">listA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">processElements</span><span class="o">(</span><span class="n">listA</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">listB</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">processElements</span><span class="o">(</span><span class="n">listB</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">listC</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">processElements</span><span class="o">(</span><span class="n">listC</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>使用 <code>&lt;? extends A&gt;</code> 時的注意事項</p>
<ul>
<li>
<p>表示傳入的物件泛型必須是A或A的子類別</p>
</li>
<li>
<p>因為無交集，不允許使用 <code>add()</code> 方法放入物件</p>
</li>
<li>
<p>因為 List<!-- raw HTML omitted --> 內物件一定是A或者A的子類別，可以用A類別作為參照型別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processExtendsElements</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// elements.add(new A());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// elements.add(new B());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// elements.add(new C());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// elements.add(new Object());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">A</span> <span class="n">a</span> <span class="o">:</span> <span class="n">elements</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">testProcessExtendsElements</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">listA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">processExtendsElements</span><span class="o">(</span><span class="n">listA</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">listB</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">processExtendsElements</span><span class="o">(</span><span class="n">listB</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span> <span class="n">listC</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">processExtendsElements</span><span class="o">(</span><span class="n">listC</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>使用 <code>&lt;? super A&gt;</code> 時的注意事項</p>
<ul>
<li>
<p>表示傳入的物件泛型必須是A或A的父類別</p>
<ul>
<li>傳入實例 <code>ArrayList&lt;AA&gt;</code>：可以放物件A、B、C</li>
<li>傳入實例 <code>ArrayList&lt;A&gt;</code>：可以放物件A、B、C</li>
</ul>
</li>
<li>
<p>允許使用 <code>add()</code> 方法加入 A 或 A的子類別</p>
</li>
<li>
<p>只能用Object類別作為物件參考，因為可能是 A、AA、其他A的父類別、或Object類</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">insertElements</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">A</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">B</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">C</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    for (A a : list) {
</span></span></span><span class="line"><span class="cl"><span class="cm">        System.out.println(a.getClass().getName());
</span></span></span><span class="line"><span class="cl"><span class="cm">    }
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">testInsertElements</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">listA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">insertElements</span><span class="o">(</span><span class="n">listA</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">AA</span><span class="o">&gt;</span> <span class="n">listAA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">AA</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">insertElements</span><span class="o">(</span><span class="n">listAA</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">listObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">insertElements</span><span class="o">(</span><span class="n">listObject</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th>Generics</th>
<th><code>&lt;?&gt;</code></th>
<th><code>&lt;? extends T&gt;</code></th>
<th><code>&lt;? super T&gt;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>檢視成員</td>
<td>只能用Object類檢視成員</td>
<td>可用T或其父類別檢視成員</td>
<td>只能用Object型別檢視成員</td>
</tr>
<tr>
<td>增加成員</td>
<td>無法</td>
<td>無法</td>
<td>可以增加T或者其<strong>子類別</strong>的成員</td>
</tr>
</tbody>
</table>
<h2 id="使用其它內建功能性介面">使用其它內建功能性介面</h2>
<p>常見以下三類</p>
<h4 id="1-四個基礎功能性介面的基本型別變形">1. 四個基礎功能性介面的基本型別變形</h4>
<p>方法傳入參數或回傳物件的其中一個或全部改成基本型別，例如 <code>DoubleFunction</code>、<code>ToDoubleFunction</code></p>
<h4 id="2-binary二運算元相關及其基本型別變形">2. Binary（二運算元相關）及其基本型別變形</h4>
<p>將方法參數由一個增加為兩個，例如<code>BiPredicate</code></p>
<h4 id="3-unary單一運算元相關及其基本型別變形">3. Unary（單一運算元相關）及其基本型別變形</h4>
<p>繼承介面<code>Function&lt;T, T&gt;</code>，但泛型數量由兩個降成一個</p>
<p><code>UnaryOperator</code> - 其方法傳入和回傳的型別一致</p>
<h3 id="基於4個基礎功能性介面的基本型別變形版">基於4個基礎功能性介面的基本型別變形版</h3>
<table>
<thead>
<tr>
<th>functional interface</th>
<th>input -&gt; output</th>
<th>&hellip;</th>
<th>基本型別變形版</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Predicate&lt;T&gt;</code></td>
<td></td>
<td>int, long, double -&gt; boolean</td>
<td></td>
</tr>
<tr>
<td><code>Consumer&lt;T&gt;</code></td>
<td>T -&gt; void</td>
<td>int, long, double -&gt; void</td>
<td><strong>Int</strong>Consumer<!-- raw HTML omitted --><strong>Long</strong>Consumer<!-- raw HTML omitted --><strong>Double</strong>Consumer</td>
</tr>
<tr>
<td><code>Function&lt;T, R&gt;</code></td>
<td>T -&gt; R</td>
<td>int, long, double -&gt; R</td>
<td><strong>Int</strong>Function<code>&lt;R&gt;</code><!-- raw HTML omitted --><strong>Long</strong>Function<code>&lt;R&gt;</code><!-- raw HTML omitted --><strong>Double</strong>Function<code>&lt;R&gt;</code></td>
</tr>
<tr>
<td><code>Function&lt;T, R&gt;</code></td>
<td>T -&gt; R</td>
<td>T -&gt; int, long, double</td>
<td>To<strong>Int</strong>Function<code>&lt;T&gt;</code><!-- raw HTML omitted -->To<strong>Long</strong>Function<code>&lt;T&gt;</code><!-- raw HTML omitted -->To<strong>Double</strong>Function<code>&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>Function&lt;T, R&gt;</code></td>
<td>T -&gt; R</td>
<td>int, long, double -&gt; int, long, double</td>
<td><strong>Long</strong>To<strong>Double</strong>Function<!-- raw HTML omitted --><strong>Long</strong>To<strong>Int</strong>Function<!-- raw HTML omitted --><strong>Double</strong>To<strong>Int</strong>Function<!-- raw HTML omitted --><strong>Double</strong>To<strong>Long</strong>Function<!-- raw HTML omitted --><strong>Int</strong>To<strong>Double</strong>Function<!-- raw HTML omitted --><strong>Int</strong>To<strong>Long</strong>Function</td>
</tr>
<tr>
<td><code>Supplier&lt;T&gt;</code></td>
<td>() -&gt; T</td>
<td>() -&gt; boolean, int, long, double</td>
<td><strong>Boolean</strong>Supplier<!-- raw HTML omitted --><strong>Int</strong>Supplier<!-- raw HTML omitted --><strong>Long</strong>Supplier<!-- raw HTML omitted --><strong>Double</strong>Supplier</td>
</tr>
</tbody>
</table>
<h4 id="介面-todoublefunction">介面 <code>ToDoubleFunction</code></h4>
<p>使用時，須提供一個T型別作為泛型，方法<code>applyAsDouble()</code>傳入T型別物件，回傳double基本型別</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">applyAsDouble</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用範例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">createList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Person</span> <span class="n">first</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">ToDoubleFunction</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">convertAgeToDouble</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">convertAgeToDouble</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">first</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>跟以下匿名類別同價</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ToDoubleFunction</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">convertAgeToDouble</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToDoubleFunction</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">applyAsDouble</span><span class="o">(</span><span class="n">Person</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="介面-doublefunction">介面 <code>DoubleFunction</code></h4>
<p>使用時需要提供R型別作為泛型，傳入double型別，回傳R型別的物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DoubleFunction</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">R</span> <span class="nf">apply</span><span class="o">(</span><span class="kt">double</span> <span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用範例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">DoubleFucntion</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">calc</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">3</span><span class="o">.</span><span class="na">1415926</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;New value is: &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>與以下匿名類別意思一樣</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">DoubleFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">calc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DoubleFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="n">String</span> <span class="nf">apply</span><span class="o">(</span><span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="基於-binary二運算元相關以及其基本型別變形版">基於 Binary（二運算元相關）以及其基本型別變形版</h3>
<p>以下介面的方法都有兩個傳入參數</p>
<table>
<thead>
<tr>
<th>Functional Interface</th>
<th>input -&gt; output</th>
<th>primitive variant..</th>
<th>&hellip;</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BinaryOperator&lt;T&gt;</code></td>
<td>(T, T) -&gt; T</td>
<td>將T換成 int, long, double</td>
<td><strong>Int</strong>BinaryOperator<!-- raw HTML omitted --><strong>Long</strong>BinaryOperator<!-- raw HTML omitted --><strong>Double</strong>BinaryOperator</td>
</tr>
<tr>
<td><code>BiPredicate&lt;L, R&gt;</code></td>
<td>(L, R) -&gt; boolean</td>
<td></td>
<td>None</td>
</tr>
<tr>
<td><code>BiConsumer&lt;T, U&gt;</code></td>
<td>(T, U) &gt; void</td>
<td>將U換成 int, long, double</td>
<td>Obj<strong>Int</strong>Consumer<code>&lt;T&gt;</code><!-- raw HTML omitted -->Obj<strong>Long</strong>Consumer<code>&lt;T&gt;</code><!-- raw HTML omitted -->Obj<strong>Double</strong>Consumer<code>&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>BiFunction&lt;T, U, R&gt;</code></td>
<td>(T, U) -&gt; R</td>
<td>將R換成 int, long, double</td>
<td>To<strong>Int</strong>BiFunction&lt;T, U&gt;<!-- raw HTML omitted -->To<strong>Long</strong>BiFunction&lt;T, U&gt;<!-- raw HTML omitted -->To<strong>Double</strong>BiFunction&lt;T, U&gt;</td>
</tr>
</tbody>
</table>
<h4 id="介面-bipredicate">介面 <code>BiPredicate</code></h4>
<p>使用時須提供一個T型別和一個U型別作為泛型，方法<code>test()</code>用T型別/U型別作為參數，回傳true/false</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BiPredicate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">U</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">,</span> <span class="n">U</span> <span class="n">u</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用範例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">createList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Person</span> <span class="n">first</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">testName</span> <span class="o">=</span> <span class="s">&#34;john&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BiPredicate</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">nameBiPred</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Is the first john? &#34;</span> <span class="o">+</span> <span class="n">nameBiPred</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">first</span><span class="o">,</span> <span class="n">testName</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>與以下匿名類別等價</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">BiPredicate</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">nameBiPred</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BiPredicate</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">test</span><span class="o">(</span><span class="n">Person</span> <span class="n">p</span><span class="o">,</span> <span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="基於-unary單運算元相關及其基本型別變形版">基於 Unary（單運算元相關）及其基本型別變形版</h3>
<p><code>UnaryOperator&lt;T&gt;</code></p>
<ul>
<li>繼承介面 <code>Function&lt;T,T&gt;</code>，但泛型數量降為一個</li>
<li>只傳入一個物件，傳入和回傳的型別一致</li>
<li>過程通常會改變物件T的某些型態</li>
</ul>
<table>
<thead>
<tr>
<th>functional interface</th>
<th>input -&gt; output</th>
<th>primitive variants</th>
<th>&hellip;</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UnaryOperator&lt;T&gt;</code></td>
<td>T -&gt; T</td>
<td>把T換成 int, long, double</td>
<td><strong>Int</strong>UnaryOperator<!-- raw HTML omitted --><strong>Long</strong>UnaryOperator<!-- raw HTML omitted --><strong>Double</strong>UnaryOperator</td>
</tr>
</tbody>
</table>
<p>介面定義</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">java.util.function</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UnaryOperator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">T</span> <span class="nf">apply</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用範例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">createList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Person</span> <span class="n">first</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">UnaryOperator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">unaryStr</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Before: &#34;</span> <span class="o">+</span> <span class="n">first</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;After: &#34;</span> <span class="o">+</span> <span class="n">unaryStr</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">first</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>與以下匿名類一樣意思</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">UnaryOperator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">unaryStr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UnaryOperator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">apply</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="使用方法參照">使用方法參照</h2>
<p>Lambda 匿名方法須包含三個部分</p>
<ol>
<li>方法參數（argument list）</li>
<li>箭頭符號（arrow token），即<code>-&gt;</code></li>
<li>方法內容（body）</li>
</ol>
<p>如果方法內只是呼叫另外一個方法(如委派 delegation)，可以再把lambda表達式簡化為方法參照（method reference），依被呼叫的方法種類與來源分為以下類型</p>
<ol>
<li>方法是 <strong>類別方法</strong></li>
<li>方法是 <strong>物件方法</strong>，物件參考來自Lambda表示式之外</li>
<li>方法是 <strong>物件方法</strong>，物件參考來自Lambda表示式之內</li>
<li>使用new呼叫建構子，且建構子<strong>不帶參數</strong></li>
<li>使用new呼叫建構子，且建構子<strong>帶少量參數</strong></li>
<li>使用new呼叫建構子，且建構子<strong>帶多個參數</strong></li>
</ol>
<h4 id="示範情境">示範情境</h4>
<ol>
<li>
<p>background: <code>Arrays.sort()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">sort</span><span class="o">(</span><span class="n">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">,</span> <span class="n">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>background: <code>Comparator&lt;T&gt;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FunctionalInterface</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Comparator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">T</span> <span class="n">o1</span><span class="o">,</span> <span class="n">To2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>輔助類別 <code>StringUtil</code> 與 <code>Employee</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringUtil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 類別方法: 大寫S結尾，用以區分方法以 static 宣告
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">static</span> <span class="kt">int</span> <span class="nf">compareS</span><span class="o">(</span><span class="n">String</span> <span class="n">s1</span><span class="o">,</span> <span class="n">String</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s1</span><span class="o">.</span><span class="na">compareToIgnoreCase</span><span class="o">(</span><span class="n">s2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 物件方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">String</span> <span class="n">s1</span><span class="o">,</span> <span class="n">String</span> <span class="n">s2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s1</span><span class="o">.</span><span class="na">compareToIgnoreCase</span><span class="o">(</span><span class="n">S2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Employee</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Employee</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="方法參照---使用類別方法">方法參照 - 使用類別方法</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">ContainingClass:</span><span class="o">:</span><span class="n">staticMethodName</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如下示範</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">byClassMethod</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">arr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// Arrays.sort(arr, (a, b) -&gt; StringUtil.compareS(a, b)); // lambda expr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span> <span class="n">StringUtil</span><span class="o">::</span><span class="n">compareS</span><span class="o">);</span>                <span class="c1">// 方法參照
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printArray</span><span class="o">(</span><span class="n">arr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="方法參照---使用物件方法且物件參考來自-lambda-表示式之外">方法參照 - 使用物件方法，且物件參考來自 Lambda 表示式之外</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">objectReference:</span><span class="o">:</span><span class="n">instanceMethodName</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如下示範</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">byOutsideObjectMethod</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">arr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">StringUtil</span> <span class="n">util</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringUtil</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// Arrays.sort(arr, (a, b) -&gt; util.compare(a, b));  // lambda expr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span> <span class="n">util</span><span class="o">::</span><span class="n">compare</span><span class="o">);</span>                 <span class="c1">// 方法參照
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printArray</span><span class="o">(</span><span class="n">arr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="方法參照---使用物件方法且物件參考來自-lambda-表示式之內">方法參照 - 使用物件方法，且物件參考來自 Lambda 表示式之內</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">ObjectReferenceType:</span><span class="o">:</span><span class="n">instanceMethodName</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如下示範</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">byInsideObjectMethod</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">arr</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// Arrays.sort(arr, (a, b) -&gt; a.compareToIgnoreCase(b));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">arr</span><span class="o">,</span> <span class="n">String</span><span class="o">::</span><span class="n">compareToIgnoreCase</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printArray</span><span class="o">(</span><span class="n">arr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>☕🍪 兩種使用物件參考的實例方法</p>
<ol>
<li>
<p>物件參考來自 lambda expr 表示式外面，要傳進來只能用原來的變數名稱</p>
</li>
<li>
<p>剩餘的不能再使用變數名稱，要改用類別名稱</p>
<p>這樣很像使用靜態方法，都是把類別名稱放前面</p>
<p>本例String類的 <code>compareToIgnoreCase()</code> 不是static，還是可以區分</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="使用-new-呼叫建構子且建構子不帶參數">使用 new 呼叫建構子，且建構子不帶參數</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nl">ClassName:</span><span class="o">:</span><span class="k">new</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以改用方法參照，以new呼叫建構子</p>
<p>建構子不帶參數時，可讓介面<code>Supplier&lt;T&gt;</code>作為物件提供者的角色</p>
<ol>
<li><code>T</code> Generic 為建構子建立的物件型態</li>
<li>以方法參照定義產生物件的方式，如下 line 3</li>
<li>在 line 4 使用<code>Supplier&lt;T&gt;</code>的 <code>get()</code> 方法可直接提取新建物件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">byConstructorWithSupplier</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Supplier&lt;Employee&gt; supplier1 = () -&gt; new Employee();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">supplier</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">::</span><span class="k">new</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Employee</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">supplier2</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">emp</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;Jim&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-new-呼叫建構子且建構子帶少量參數">使用 new 呼叫建構子且建構子帶少量參數</h3>
<p>當建構子帶參數時，可改用介面<code>Function&lt;T,R&gt;</code>作為物件提供者的角色</p>
<ol>
<li><code>T</code>為建構子參數，<code>R</code>為建構子建立的物件型態</li>
<li>以方法參照定義產生物件的方式，如 line 3</li>
<li>line 4 使用 Function 的 <code>apply(T)</code> 方法，傳入建構子參數，回傳新建物件型態 <code>R</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">byConstructorWithFunction</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Function&lt;String, Employee&gt; factory1 = (s) -&gt; new Employee(s);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Function</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Employee</span><span class="o">&gt;</span> <span class="n">factory2</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">::</span><span class="k">new</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Employee</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">factory2</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="s">&#34;Jim&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emp</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-new-呼叫建構子且建構子帶多參數">使用 new 呼叫建構子且建構子帶多參數</h3>
<p>如果建構子帶多參數，例如 class Student：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Student</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Student [name=]&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;, age=&#34;</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span> <span class="s">&#34;]&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可自訂功能性介面作為物件提供者的角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FunctionalInterface</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentFactory</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Student</span> <span class="nf">createStudent</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>用方法參照取代 Lambda expression：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">byConstructorWithCustomFunction</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// StudentFactory factory = (name, age) -&gt; new Student(name, age);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">StudentFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">Student</span><span class="o">::</span><span class="k">new</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Student</span> <span class="n">s</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createStudent</span><span class="o">(</span><span class="s">&#34;Jim&#34;</span><span class="o">,</span> <span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h1 id="10-使用-stream-api">10 使用 <code>Stream API</code></h1>
<h2 id="建構者設計模式和方法鏈結">建構者設計模式和方法鏈結</h2>
<p>All-args-constructors 在欄位漸多的時候可能會產生以下問題</p>
<ol>
<li>某些類別會依傳入欄位不同而建構出不同功能性的物件（Overloaded建構子）</li>
<li>建構子參數可能很多</li>
<li>漸購子參數若有多個屬於相同型別，會造成組合複雜且設計困難</li>
<li>須判斷 null 情況</li>
</ol>
<p><strong>建構者設計模式（builder design pattern）</strong>：改用建構者<code>builder</code>類別產生物件，抽出建構物件的邏輯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Person</span><span class="o">(</span><span class="n">Builder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Name=&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;, Age=&#34;</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span> <span class="s">&#34;, email=&#34;</span> <span class="o">+</span> <span class="n">email</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printPerson</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 靜態巢狀類別 Person.Builder 的定義
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Builder 的 setter() 方法，因為是 Builder 類，慣例上方法命名不以 set 開頭，
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">name</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">age</span><span class="o">(</span><span class="kt">int</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">email</span><span class="o">(</span><span class="n">String</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Person</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>範例方法 <code>createPersonList()</code>-</p>
<p>使用 <code>Person.Builder</code> 類別建構 Person 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">createPersonList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Person</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Bob&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">age</span><span class="o">(</span><span class="n">21</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">&#34;bob@x.com&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    	<span class="k">new</span> <span class="n">Person</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Jane&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">age</span><span class="o">(</span><span class="n">25</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="s">&#34;jane@x.com&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;John&#34;</span><span class="o">).</span><span class="na">age</span><span class="o">(</span><span class="n">25</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">&#34;john@x.com&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Phil&#34;</span><span class="o">).</span><span class="na">age</span><span class="o">(</span><span class="n">55</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">&#34;phil@x.com&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Betty&#34;</span><span class="o">).</span><span class="na">age</span><span class="o">(</span><span class="n">85</span><span class="o">).</span><span class="na">email</span><span class="o">(</span><span class="s">&#34;betty@x.com&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">people</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>建構者設計模式讓物件可以用「方法鏈結（method chaining）」的方式進行</p>
<p>這是Java 8 API 開始推廣的程式碼撰寫風格，特色如下</p>
<ol>
<li>多個方法可以用單一行程式碼表達，更容易理解程式碼</li>
<li>物件建立方式更有彈性</li>
<li>每一個設定屬性欄位的 <code>setter()</code> 方法都回傳物件自己</li>
<li>程式碼更加流暢（fluent）</li>
</ol>
<h2 id="使用-optional-類別">使用 Optional 類別</h2>
<h3 id="使用-null-造成的困擾">使用 null 造成的困擾</h3>
<p>情境：有個方法允許輸入不同數量整數，計算平均值。如果呼叫該方法時沒有輸入任何整數，應該回傳什麼？</p>
<p>如果回傳0，要如何區分<strong>輸入多個零</strong>以及<strong>什麼都沒有輸入</strong>的兩種情境？</p>
<p>通常會直接回傳null，同時將方法回傳的值改用基本型別的包覆類別（wrapper class）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Double</span> <span class="nf">averageWithNull</span><span class="o">(</span><span class="kt">int</span><span class="o">...</span> <span class="n">scores</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">scores</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">score</span> <span class="o">:</span> <span class="n">scores</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">sum</span> <span class="o">/</span> <span class="n">scores</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果沒有任何整數個數傳進 <code>averageWithNull()</code> 方法，會馬上回傳 null</p>
<p>處理 null 的測試方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testNull</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">str</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span> <span class="sc">&#39;D&#39;</span><span class="o">,</span> <span class="sc">&#39;u&#39;</span><span class="o">,</span> <span class="sc">&#39;k&#39;</span><span class="o">,</span> <span class="sc">&#39;e&#39;</span> <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">char</span> <span class="n">c</span> <span class="o">:</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">c</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>  <span class="c1">// 和字元相連 nullDuke
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>  <span class="c1">// 處理物件, 遇到 null 就印出 null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// System.out.println(null); // can&#39;t compiled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="類別-optional-的使用情境">類別 Optional 的使用情境</h3>
<p><code>Optional&lt;T&gt;</code>類別於 Java 8 推出，支援泛型，概念用法如下：</p>
<ol>
<li>屬於 <code>java.util</code> 套件</li>
<li>使用上像是「容器/箱子」，<code>&lt;T&gt;</code>表示箱子裡可存放 T物件也可以是空的（empty, i.e. null）</li>
<li>方法 <code>isPresent()</code> 確認內容物T是否存在
若回傳 true，則可用 <code>get()</code> 方法取得內容物件T</li>
<li>和功能性介面一樣，有其他支援基本型別的擴充版本
<ul>
<li><code>Optional</code>Double</li>
<li><code>Optional</code>Int</li>
<li><code>Optional</code>Long</li>
</ul>
</li>
</ol>
<p>建立 Optional 物件的幾種方式</p>
<table>
<thead>
<tr>
<th>方法釋例</th>
<th>物件內容</th>
<th>備註</th>
</tr>
</thead>
<tbody>
<tr>
<td>static <code>Optional.empty()</code></td>
<td>沒有內容物件</td>
<td>空Optional物件</td>
</tr>
<tr>
<td>static <code>Optional.of(value)</code></td>
<td>內含物件 value</td>
<td>該物件不可為null</td>
</tr>
<tr>
<td>static <code>Optional.ofNullable(value)</code></td>
<td>可能有/可能沒有內容物件value</td>
<td>結合前兩種方式</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">ofNullable</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">empty</span><span class="o">()</span> <span class="o">:</span> <span class="n">of</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接著把之前示範過的 <code>averageWithNull()</code> 方法由可能回傳 null 改成回傳 Optional</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">averageWithOptional</span><span class="o">(</span><span class="kt">int</span><span class="o">...</span> <span class="n">scores</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">scores</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">score</span><span class="o">;</span> <span class="n">scores</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sum</span> <span class="o">+=</span> <span class="n">score</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">sum</span> <span class="o">/</span> <span class="n">scores</span><span class="o">.</span><span class="na">length</span> <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果回傳內容有可能為 null 時，都用 <code>Optional&lt;T&gt;</code> 型態回傳，那就不用每次都加 <code>if(x != null)</code>事先檢查</p>
<h3 id="類別-optional-的常用方法">類別 Optional 的常用方法</h3>
<h4 id="java-8-的-optional-api">Java 8 的 Optional API</h4>
<p>以下是 Java 8 剛推出 <code>Optional&lt;T&gt;</code> 時常用的方法</p>
<table>
<thead>
<tr>
<th>方法簽名與回傳</th>
<th>有內含物時</th>
<th>內含物為null時</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>T get()</code></td>
<td>回傳內含物</td>
<td>throw <code>NoSuchElementException</code></td>
</tr>
<tr>
<td><code>void ifPresent(Consumer)</code></td>
<td>執行Consumer定義的方法</td>
<td>啥也不做</td>
</tr>
<tr>
<td><code>void isPresent()</code></td>
<td>回傳 true</td>
<td>回傳 false</td>
</tr>
<tr>
<td><code>T orElse(T other)</code></td>
<td>回傳內含物</td>
<td>回傳指定的 other 物件</td>
</tr>
<tr>
<td><code>T orElseGet(Supplier)</code></td>
<td>回傳內含物</td>
<td>回傳 Supplier 定義的方法執行結果</td>
</tr>
<tr>
<td><code>T orElseThow(Supplier)</code></td>
<td>回傳內含物</td>
<td>拋出 Supplier 定義的方法例外</td>
</tr>
<tr>
<td><code>Optional&lt;U&gt; map(Function&lt;T, U&gt;)</code></td>
<td>回傳 Function 定義的方法的 Optional 結果</td>
<td>回傳 <code>Optional.empty()</code></td>
</tr>
<tr>
<td><code>Optional&lt;U&gt; flatMap(Function&lt;T, Optional&lt;U&gt;&gt;)</code></td>
<td>回傳 Function 定義的方法的 Optional 結果</td>
<td>回傳 <code>Optional.empty()</code></td>
</tr>
</tbody>
</table>
<p>程式碼示例：<code>get()</code>、<code>ifPresent()</code>、<code>isPresent()</code>、<code>orElse()</code>、<code>orElseGet()</code>、<code>orElseThrow()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testOptionalOfJava8</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show01: &#34;</span> <span class="o">+</span> <span class="n">averageWithOptional</span><span class="o">(</span><span class="n">90</span><span class="o">,</span> <span class="n">100</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show02: &#34;</span> <span class="o">+</span> <span class="n">averageWithOptional</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">optOK</span> <span class="o">=</span> <span class="n">averageWithOptional</span><span class="o">(</span><span class="n">90</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">optOK</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show03: &#34;</span> <span class="o">+</span> <span class="n">optOK</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">optNG</span> <span class="o">=</span> <span class="n">averageWithOptional</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">optNG</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementElement</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show04 throws: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">opt1</span> <span class="o">=</span> <span class="n">averageWithOptional</span><span class="o">(</span><span class="n">90</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt1</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">d</span> <span class="o">-&gt;</span> <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show05: &#34;</span> <span class="o">+</span> <span class="n">d</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// there is value in Optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">opt2</span> <span class="o">=</span> <span class="n">averageWithOptional</span><span class="o">(</span><span class="n">90</span><span class="o">,</span> <span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show06: &#34;</span> <span class="o">+</span> <span class="n">opt2</span><span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="n">Double</span><span class="o">.</span><span class="na">NaN</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show07: &#34;</span> <span class="o">+</span> <span class="n">opt2</span><span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show08: &#34;</span> <span class="o">+</span> <span class="n">opt2</span><span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">MyOptionalException</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// there is no value in Optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">opt3</span> <span class="o">=</span> <span class="n">averageWithOptional</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show09: &#34;</span> <span class="o">+</span> <span class="n">opt3</span><span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="n">Double</span><span class="o">.</span><span class="na">NaN</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show10: &#34;</span> <span class="o">+</span> <span class="n">opt3</span><span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">opt3</span><span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">MyOptionalException</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MyOptionalException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;show11 throws: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>   
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>程式碼示例：<code>map()</code>、<code>flatMap()</code></p>
<ul>
<li>
<p>因為都需要傳入一個功能性介面 <strong>Function</strong> 的 Lambda 表示式</p>
</li>
<li>
<p>Lambda 表示式這裡用方法參照取代</p>
<ol>
<li>建立line 1~3 的 <code>getLength4map()</code> 方法，再以方法參照用於 <code>map()</code> 方法</li>
<li>建立line 4~6 的 <code>getLength4flatMap()</code> 方法，再以方法參照用於 <code>flatMap()</code> 方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">getLength4map</span><span class="o">(</span><span class="n">String</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">getLength4flatMap</span><span class="o">(</span><span class="n">String</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mapAndFlatMap</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;jim&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">oil</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">str</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">OptionalDemo</span><span class="o">::</span><span class="n">getLength4map</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">oi2</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">str</span><span class="o">).</span><span class="na">flatMap</span><span class="o">(</span><span class="n">OptionalDemo</span><span class="o">::</span><span class="n">getLength4flatMap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>map()</code> 與 <code>flatMap()</code> 使用方式相同/差異</p>
<table>
<thead>
<tr>
<th>方法簽名與回傳</th>
<th>相同</th>
<th>差異</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Optional&lt;U&gt; map(Function&lt;T, U&gt;)</code></td>
<td>回傳 <code>Optional&lt;U&gt;</code></td>
<td>作為參數的的功能性介面<!-- raw HTML omitted -->Function 方法回傳</td>
</tr>
<tr>
<td><code>Optional&lt;U&gt; flatMap(Function&lt;T, Optional&lt;U&gt;&gt;)</code></td>
<td>回傳 <code>Optional&lt;U&gt;</code></td>
<td>作為參數的功能性介面 Function 的方法回傳 <code>Optional&lt;U&gt;</code></td>
</tr>
</tbody>
</table>
</li>
</ul>
<h4 id="java-8-之後的新增的-optional-api">Java 8 之後的新增的 Optional API</h4>
<p><code>Optional&lt;T&gt;</code> 在 Java 8 之後推出較常用的方法如下</p>
<table>
<thead>
<tr>
<th>方法簽名與回傳</th>
<th>有內含物</th>
<th>內含物為null</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>void ifPresontOrElse(Consumer, Runnable)</code></td>
<td>使用內含物執行 Consumer 定義的方法</td>
<td>執行 Runnable 定義的方法</td>
</tr>
<tr>
<td><code>Optional&lt;T&gt;</code> or <code>(Supplier)</code></td>
<td>回傳自己（this），即原本的<code>Optional&lt;T&gt;</code></td>
<td>執行 Supplier 定義的方法，回傳型態須為<code>Optional&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>Stream&lt;T&gt; stream()</code></td>
<td>將內含物T以<code>Stream.of(T)</code>型態回傳</td>
<td>回傳 <code>Stream.empty()</code></td>
</tr>
<tr>
<td><code>T orElseThrow()</code></td>
<td>回傳內含物</td>
<td>拋出例外 <code>NoSuchElementException</code></td>
</tr>
<tr>
<td><code>boolean isEmpty()</code></td>
<td>回傳 false</td>
<td>回傳 true</td>
</tr>
</tbody>
</table>
<p>程式碼示例：<code>ifPresentOrElse()</code>、<code>or()</code>、<code>orElseThrow()</code>、<code>isEmpty()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testOptionalAfterJava8</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">o1</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">o2</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ifPresentOrElse()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">o1</span><span class="o">.</span><span class="na">ifPresentOrElse</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Found &#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">        <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Not found&#34;</span><span class="o">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">o2</span><span class="o">.</span><span class="na">ifPresentOrElse</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Found &#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">        <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Not found&#34;</span><span class="o">)};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// or()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">o1</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="na">or</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;default&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">o2</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="na">or</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;default&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// orElseThrow()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">orElseThrow</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o2</span><span class="o">.</span><span class="na">orElseThrow</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// isEmpty()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o2</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Optional 的 <code>stream()</code> 方法</p>
<ul>
<li>有內含物：<code>Stream.of(T)</code> 型態回傳</li>
<li>無內含物：<code>Stream.empty()</code>中斷串流，方便處理來源可能為null的情況</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findUsersByName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&#34;jim1&#34;</span><span class="o">,</span> <span class="n">1000</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                  <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&#34;jim2&#34;</span><span class="o">,</span> <span class="n">1000</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                  <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="s">&#34;duke&#34;</span><span class="o">,</span> <span class="n">1000</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">user</span> <span class="o">-&gt;</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 以下兩個方法都可接受輸入參數為null的情況，但getTotalSalary()的執行效率略優於getTotalSalary2()，可以在確認輸入參數為null時就停止串流 */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">getTotalSalary</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">OptionalDemo</span><span class="o">::</span><span class="n">findUsersByName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">Collection</span><span class="o">::</span><span class="n">stream</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getSalary</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">Integer</span><span class="o">::</span><span class="n">valueOf</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">getTotalSalary2</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">OptionalDemo</span><span class="o">::</span><span class="n">findUsersByName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">Collection</span><span class="o">::</span><span class="n">stream</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getSalary</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>比較三個在Collection領第一個物件之欄位name的字串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">printFirstUserName1</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">findFirst</span><span class="o">()</span>  <span class="c1">//NullPointerException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">&#34;user not found&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Optional= &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Option1 throws &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">printFirstUserName2</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">users</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">list</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">))</span> <span class="c1">//ArrayIndexOutOfBoundsException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">&#34;user not found&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Option2 = &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Option2 throws &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 可同時處理空集合物件或者null的情況 */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">printFirstUserName3</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">users</span><span class="o">)</span> <span class="c1">// prevent null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">Collection</span><span class="o">::</span><span class="n">stream</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">findFirst</span><span class="o">()</span> <span class="c1">// prevent empty collection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">User</span><span class="o">::</span><span class="n">getName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">&#34;user not found&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Option3= &#34;</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Option3 throws &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="stream-api-介紹">Stream API 介紹</h2>
<h3 id="介面-iterable-和-collection-的擴充">介面 Iterable 和 Collection 的擴充</h3>
<ul>
<li>
<p>interface <code>Iterable.forEach()</code> 允許傳入實作 Consumer 功能性介面的參考物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Persion</span><span class="o">&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">createPersonList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">p1</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>interface <code>Collection.stream()</code> 幫 Collection 容器物件裝水龍頭，流出 Stream 物件，取代用迴圈存取 Collection 成員物件的舊方法</p>
</li>
</ul>
<h4 id="stream">Stream</h4>
<p>跟建構者設計模式（builder）一樣可以流暢的使用方法鏈結（method chaining）</p>
<ol>
<li><code>filter()</code>:
<ul>
<li>接受實作 Predicate 介面的參考物件</li>
<li>對流過的集合物件成員使用 <code>Predicate.test()</code> 方法進行篩選</li>
</ul>
</li>
<li><code>forEach()</code>:
<ul>
<li>接受實作 Consumer 介面的參考物件</li>
<li>對流入的集合物件成員操作 <code>accept()</code> 方法</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="n">apples</span> <span class="o">=</span> <span class="n">getAllApples</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">apples</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">getDiameter</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">17</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">.</span><span class="na">getDiameter</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">23</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>增加程式的重複使用性：</p>
<p>將 Lambda 表示式改用參考變數的方式呈現</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="n">apples</span> <span class="o">=</span> <span class="n">getAllApples</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">getDiameter</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">17</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">.</span><span class="na">getDiameter</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">23</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">action</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">apples</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">criteria</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="stream-api">Stream API</h3>
<ol>
<li>套件 <code>java.util.stream</code></li>
<li>方法鏈結 chaining methods</li>
<li>比較 Collection 與 Stream 介面
<ul>
<li><code>Collection</code>依照成員物件屬性（List, Set, Queue）提供不同管理和存取方式</li>
<li><code>Stream</code>沒有提供直接存取特定成員的方式，只是以宣告式描述做法對 Stream 來源進行操作</li>
</ul>
</li>
</ol>
<h4 id="stream-特性">Stream 特性</h4>
<ol>
<li>不可改變的 immutable</li>
<li>Stream 介面中，定義鏈結方法的作用方式
<ul>
<li>連續的（serial / sequential）- 預設作用方式</li>
<li>平行的（parallel）- 多執行緒</li>
</ul>
</li>
<li>鏈結方法又稱為管線操作（pipeline operations）/串流方法</li>
</ol>
<h4 id="管線操作pipeline-operations的特性">管線操作（pipeline operations）的特性</h4>
<ol>
<li>Stream 在管線裡面傳輸</li>
<li>管線分多段，來源（source）定義後，每一段代表一個作業（operation）
<ul>
<li>來源（Source）- Collection 物件、檔案、Stream 物件</li>
<li>中間作業（Intermediate Operation）- 可以零或多個</li>
<li>終端作業（Intermediate Operation）- 只有一個</li>
<li>短路型終端作業（Short-Circuit Terminal Operation）- 只有一個</li>
</ul>
</li>
<li><strong>Lazy情況（懶加載）</strong>
<ul>
<li>Java 會順著每段管線依序向下執行，但會先確認終端作業的方式，才會回頭要求 Stream 開始輸送資料</li>
<li>只在開始執行時才要求輸送資料</li>
</ul>
</li>
<li>搭配短路型終端作業時，相較迴圈處理而言，有效能上優勢</li>
</ol>
<hr>
<h2 id="stream-api-操作">Stream API 操作</h2>
<p>categories of pipeline operations</p>
<table>
<thead>
<tr>
<th>分類</th>
<th>常用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>Intermediate Operation<!-- raw HTML omitted -->中間作業</td>
<td><code>filter()</code>, <code>map()</code>, <code>peek()</code>, <code>sorted()</code>, <code>flatMap()</code></td>
</tr>
<tr>
<td>Terminal Operation<!-- raw HTML omitted -->終端作業</td>
<td><code>forEach()</code>, <code>count()</code>, <code>sum()</code>, <code>average()</code>, <code>min()</code>, <code>max()</code>, <code>collect()</code></td>
</tr>
<tr>
<td>Short-Circuit Terminal Operation<!-- raw HTML omitted -->短路型終端作業</td>
<td><code>findFirst()</code>, <code>findAny()</code>, <code>anyMatch()</code>, <code>allMatch()</code>, <code>noneMatch()</code></td>
</tr>
</tbody>
</table>
<h3 id="中間作業">中間作業</h3>
<h4 id="1-使用-map-轉換-stream-內容">1. 使用 <code>map()</code> 轉換 Stream 內容</h4>
<p>Method declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="nf">map</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">mapper</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>傳入某型別，經過某些流程之後，回傳另一種型別</p>
</li>
<li>
<p>使用 Function 介面的實作物件當參數</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Function</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">timesTwoFunc</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">2</span> <span class="o">*</span> <span class="n">n</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">mapResult</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">timesTwoFunc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Object</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">mapResult</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">arr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">);</span> <span class="c1">// [2, 4, 6, 8]
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>其它基本型別的擴充版</p>
<ol>
<li><code>mapToInt()</code></li>
<li><code>mapToLong()</code></li>
<li><code>mapToDouble()</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ToIntFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">mapper</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">::</span><span class="n">parseInt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">ToIntFunction&lt;String&gt; mapper = new ToIntFunction&lt;String&gt;() {
</span></span></span><span class="line"><span class="cl"><span class="cm">    @Override
</span></span></span><span class="line"><span class="cl"><span class="cm">    public int applyAsInt(String value) {
</span></span></span><span class="line"><span class="cl"><span class="cm">        return Integer.parseInt(value);
</span></span></span><span class="line"><span class="cl"><span class="cm">    }
</span></span></span><span class="line"><span class="cl"><span class="cm">};
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">IntStream</span> <span class="n">mapResult</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;a1&#34;</span><span class="o">,</span> <span class="s">&#34;a2&#34;</span><span class="o">,</span> <span class="s">&#34;a3&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">mapper</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">mapResult</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="2-使用-peek-窺視-stream-內容">2. 使用 <code>peek()</code> 窺視 Stream 內容</h4>
<p>Method declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">peek</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以 <code>peek()</code> 方法窺視 Stream 內容</p>
<ol>
<li>
<p>使用<code>Consumer</code>介面表示需要對資料成員套用的方法為</p>
<ul>
<li>可以傳入參數，且沒有回傳（void）</li>
<li>方法結束後，成員回歸 Stream</li>
</ul>
</li>
<li>
<p><code>peek()</code>方法主要用於 debug</p>
<ul>
<li>使用情境：需要了解當 Stream 成員經過其他中間作業之後的變化情況</li>
</ul>
</li>
<li>
<p>若管線沒定義終端作業，則不會啟動 peek()</p>
<ul>
<li>反映 Stream 物件的 Lazy 特質</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">,</span> <span class="s">&#34;j&#34;</span><span class="o">,</span> <span class="s">&#34;y&#34;</span><span class="o">,</span> <span class="s">&#34;c&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">3</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Filtered value: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">String</span><span class="o">::</span><span class="n">toUpperCase</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">g</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Mapped value: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>peek()</code> 也可以更改資料成員，但不建議用來修改資料成員</p>
<ul>
<li>
<p>平行執行時可能會有執行緒安全（thread safe）問題</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">action</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* line 相當於以下程式
</span></span></span><span class="line"><span class="cl"><span class="cm">Consumer&lt;Integer&gt; action = new Consumer&lt;Integer&gt;() {
</span></span></span><span class="line"><span class="cl"><span class="cm">    public void accept(Integer t) {
</span></span></span><span class="line"><span class="cl"><span class="cm">        System.out.print(t);
</span></span></span><span class="line"><span class="cl"><span class="cm">    }
</span></span></span><span class="line"><span class="cl"><span class="cm">};
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">).</span><span class="na">peek</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Length: &#34;</span> <span class="o">+</span> <span class="n">stream</span><span class="o">.</span><span class="na">toArray</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">line2 的 peek() 不會被觸發，
</span></span></span><span class="line"><span class="cl"><span class="cm">只有執行到 toArray() 終端作業後，
</span></span></span><span class="line"><span class="cl"><span class="cm">才會觸發 peek() 方法
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h4 id="3-使用-sorted-做基本排序">3. 使用 <code>sorted()</code> 做基本排序</h4>
<p>Method Declaration - two ways</p>
<ol>
<li>
<p>依自然順序重新排序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">sorted</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>依 Comparator 定義的順序重新排序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">comparator</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testSorted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;a2&#34;</span><span class="o">,</span> <span class="s">&#34;a1&#34;</span><span class="o">,</span> <span class="s">&#34;b1&#34;</span><span class="o">,</span> <span class="s">&#34;c2&#34;</span><span class="o">,</span> <span class="s">&#34;c1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lt</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sorted</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">lt</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">String</span><span class="o">::</span><span class="n">compareTo</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">lt</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sorted</span><span class="o">((</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">s1</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">s2</span><span class="o">)</span> <span class="o">+</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-搭配-comparator-進行多段式排序">4. 搭配 Comparator 進行多段式排序</h4>
<p>常見的三段式排序情境</p>
<ol>
<li>
<p>先比較：成員特定欄位/特定條件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">comparing</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">keyExtractor</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>再比較：成員額外欄位/額外條件
(視情況而使用，通常是步驟一比較不出結果時會用的)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">thenComparing</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">keyExtractor</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>最後：視情況倒置比較結果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">reversed</span><span class="o">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testComparing</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="n">apples</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Fuji&#34;</span><span class="o">,</span> <span class="n">18</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Gourmet&#34;</span><span class="o">,</span> <span class="n">23</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Gala&#34;</span><span class="o">,</span> <span class="n">23</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">    	<span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Anna&#34;</span><span class="o">,</span> <span class="n">12</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">getAppleCultivar</span> <span class="o">=</span> <span class="n">Apple</span><span class="o">::</span><span class="n">getCultivar</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">getAppleDiameter</span> <span class="o">=</span> <span class="n">Apple</span><span class="o">::</span><span class="n">getDiameter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="n">comp</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">        <span class="n">Comparator</span><span class="o">.</span><span class="na">comparing</span><span class="o">(</span><span class="n">getAppleDiameter</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        		  <span class="o">.</span><span class="na">thenComparing</span><span class="o">(</span><span class="n">getAppleCultivar</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">apple</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">comp</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Anna, Fuji, Gala, Gourmet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="n">apple</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">comp</span><span class="o">.</span><span class="na">reversed</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">&#34;, &#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Gourmet, Gala, Fuji, Anna
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5-使用-flatmap-展開-stream-成員成子-stream-物件">5. 使用 <code>flatMap()</code> 展開 Stream 成員成子 Stream 物件</h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">flatMap</span><span class="o">(</span><span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">Stream</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">mapper</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用 Function 介面將 Stream 成員欄位以 Stream 形式再展開/呈現</li>
<li>有層層展開再將之攤平（flat）的效果</li>
</ul>
<p>Examples:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Item</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Order</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSource</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="nf">getOrdersAndItems</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayLIst</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">4</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">orders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Order</span><span class="o">(</span><span class="s">&#34;Order_&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ⭐ range(1,4) 可以決定對 forEach()操作幾次
</span></span></span><span class="line"><span class="cl"><span class="cm">               forEach() 的 i 變數會從1開始 ~ 3結束，不含4 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">orders</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">order</span> <span class="o">-&gt;</span> 
</span></span><span class="line"><span class="cl">              <span class="n">IntStream</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">4</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                  <span class="n">i</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">order</span><span class="o">.</span><span class="na">items</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="k">new</span> <span class="n">Item</span><span class="o">(</span><span class="s">&#34;Item_&#34;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&#34; , from &lt;&#34;</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">&#34;&gt;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">)</span>
</span></span><span class="line"><span class="cl">                  <span class="c1">// orders內每個Order物件中，爛位 items 各新增3個Item物件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">orders</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>flatMap()</code>的示例程式碼</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">qty</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="na">getOrdersAndItems</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span> <span class="c1">// Stream&lt;Order&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//.peek(System.out::println)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">order</span> <span class="o">-&gt;</span> <span class="n">order</span><span class="o">.</span><span class="na">items</span><span class="o">.</span><span class="na">stream</span><span class="o">())</span>  <span class="c1">// Stream&lt;Item&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//.peek(System.out::println)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">.</span><span class="na">count</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">qty</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>以下範例：</p>
<ol>
<li>
<p>將檔案 flatMap.txt 裡所有資料行讀入 <code>Stream&lt;String&gt;</code> 物件</p>
</li>
<li>
<p>再用 <code>flatMap()</code> 以每行字串裡的空白作為切割符號，<strong>攤平</strong>成更長的 <code>Stream&lt;String&gt;</code> 物件</p>
</li>
<li>
<p>最後以 <code>filter()</code> 濾出包含關鍵字的成員並計算數量</p>
<p>用 <code>peek()</code>查看每段轉換成果</p>
</li>
</ol>
</blockquote>
<h5 id="flatmaptxt">flatMap.txt</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">my apple is bought for making pies
</span></span><span class="line"><span class="cl">your apple is purchased for writing codes
</span></span><span class="line"><span class="cl">his/her apple is in the eye of beholder
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="example">Example</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">flatMapDemo2</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 取得路徑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Path</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;src/.../.../.../flatMap.txt&#34;</span><span class="o">)</span> <span class="o">.</span><span class="na">toAbsolutePath</span><span class="o">();</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 傳回符合值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">matches</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="n">p</span><span class="o">)</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// .peek(System.out::println) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">line</span> <span class="o">-&gt;</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34; &#34;</span><span class="o">)))</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// .peek(System.out::println) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">word</span> <span class="o">-&gt;</span> <span class="n">word</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;apple&#34;</span><span class="o">))</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// .peek(System.out::println) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">.</span><span class="na">count</span><span class="o">();</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 印出結果 - # of Matches: 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;# of Matches: &#34;</span> <span class="o">+</span> <span class="n">matches</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="終端作業">終端作業</h3>
<h4 id="1-使用-count-計算-stream-成員數量">1. 使用 <code>count()</code> 計算 Stream 成員數量</h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">count</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testCount</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;Hello&#34;</span><span class="o">,</span> <span class="s">&#34;World&#34;</span><span class="o">).</span><span class="na">count</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cnt</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-使用-max-和-min-取出-stream-成員的最大值與最小值">2. 使用 <code>max()</code> 和 <code>min()</code> 取出 Stream 成員的最大值與最小值</h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">max</span><span class="o">(</span><span class="n">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">comparator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">min</span><span class="o">(</span><span class="n">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">comparator</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>取得最大值 &amp; 最小值</li>
<li>回傳值以 Optional 包裹，因為 Stream 可能沒有成員</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testMaxMin</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">String</span><span class="o">::</span><span class="n">compareTo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;x&#34;</span><span class="o">,</span> <span class="s">&#34;y&#34;</span><span class="o">).</span><span class="na">max</span><span class="o">(</span><span class="n">comparator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">os</span><span class="o">);</span>  
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">max</span><span class="o">(</span><span class="n">comparator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">empty</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">OptionalInt</span> <span class="n">oi</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        				   <span class="o">.</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">.</span><span class="na">min</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">oi</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-使用-average-和-sum-計算-stream-成員的平均值與加總">3. 使用 <code>average()</code> 和 <code>sum()</code> 計算 Stream 成員的平均值與加總</h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">average</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">sum</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>必須為基礎型別的擴充型 Stream，才能用數學計算相關方法，例如<code>average()</code>、<code>sum()</code></p>
<ol>
<li>DoubleStream</li>
<li>IntStream</li>
<li>LongStream</li>
</ol>
<h5 id="example---average">Example - <code>average()</code></h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testAverage</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OptionalDouble</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        	   <span class="o">.</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        					   <span class="o">.</span><span class="na">average</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">avg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">avg</span><span class="o">.</span><span class="na">getAsDouble</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">IntStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="k">new</span> <span class="kt">int</span><span class="o">[]</span> <span class="o">{});</span>
</span></span><span class="line"><span class="cl">    <span class="n">OptionalDouble</span> <span class="n">emptyAvg</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">average</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emptyAvg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>IntStream、LongStream、DoubleStream 具備 average() 方法</p>
</blockquote>
<h5 id="example---sum">Example - <code>sum()</code></h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testSum</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Stream.of(1, 2, 3, 4).sum(); // 編譯失敗 - Stream&lt;Integer&gt; 沒有此方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// IntStream    10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">iSum</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">).</span><span class="na">mapToInt</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">iSum</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// LongStream   10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">iSum</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">).</span><span class="na">mapToLong</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">iSum</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// DoubleStream 10.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">dSum</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">3</span><span class="o">,</span> <span class="n">4</span><span class="o">).</span><span class="na">mapToDouble</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dSum</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Empty Stream 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">IntStream</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">zero</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="終端作業-collect-與-collectors-api">終端作業 <code>collect()</code> 與 Collectors API</h3>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">collect</span><span class="o">(</span><span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">collector</span><span class="o">);</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>java.util.stream.collect()</code> 方法可以彙整或轉化 Stream 成員</p>
<p>常搭配 Collectors 類的靜態方法，把以下方法傳入 collect() 方法就可以</p>
<ol>
<li>Collectors.toList()、Collectors.toSet()</li>
<li>Collectors.toMap()</li>
<li>Collectors.averagingDouble()</li>
<li>Collectors.joining()</li>
<li>Collectors.groupingBy()</li>
<li>Collectors.partitioningBy()</li>
<li>Collectors.mapping()、Collectors.flatMapping()</li>
<li>Collectors.filtering()</li>
</ol>
<h5 id="example-reference">Example reference</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Apple</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">cultivar</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">diameter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// others ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TerminalOpCollectDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="nf">getAppleList</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Apple</span><span class="o">&gt;</span> <span class="n">apples</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Fuji&#34;</span><span class="o">,</span> <span class="n">18</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Gourmet&#34;</span><span class="o">,</span> <span class="n">23</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Gala&#34;</span><span class="o">,</span> <span class="n">23</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Apple</span><span class="o">(</span><span class="s">&#34;Anna&#34;</span><span class="o">,</span> <span class="n">12</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">apples</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1-collectorstolistcollectorstoset">1. <code>Collectors.toList()</code>、<code>Collectors.toSet()</code></h4>
<p>API definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">toList</span><span class="o">()</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">toSet</span><span class="o">()</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>轉存為List之後，會保留所有字串</p>
<p>轉存為Set之後，會自動移除重複的字串</p>
</blockquote>
<h4 id="2-collectorstomap">2. <code>Collectors.toMap()</code></h4>
<p>API definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">K</span><span class="o">,</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">U</span><span class="o">&gt;&gt;</span> <span class="nf">toMap</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    			<span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">K</span><span class="o">&gt;</span> <span class="n">keyMapper</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    			<span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">valueMapper</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example - 指定 k, v 來源後，轉存為 Map 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testToMap</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getPersonList</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="n">Person</span><span class="o">::</span><span class="n">getName</span><span class="o">,</span> <span class="n">Person</span><span class="o">::</span><span class="n">getAge</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-collectorsaveragingdouble">3. <code>Collectors.averagingDouble()</code></h4>
<p>API Definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Double</span><span class="o">&gt;</span> <span class="nf">averagingDouble</span><span class="o">(</span><span class="n">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">mapper</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>ToDoubleFunction</code>定義的方法 - 將輸入物件轉換成 Double</li>
</ul>
<p>Example</p>
<blockquote>
<p>使用 collect() 方法，傳入 <code>Collectors.averagingDouble(ToDoubleFunction)</code>，可以將眾多 stream 成員的特定屬性轉換成 double，求得平均值</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testAveragingDouble</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Double</span> <span class="n">averageAge</span> <span class="o">=</span> <span class="n">getPersonList</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">averagingDouble</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">age</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">averagAge</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-collectorsjoining">4. <code>Collectors.joining()</code></h4>
<p>API Definition (3 Overloaded methods)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">CharSequence</span><span class="o">,</span> <span class="o">?,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">joining</span><span class="o">()</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">CharSequence</span><span class="o">,</span> <span class="o">?,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">joining</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">CharSequence</span> <span class="n">delimiter</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">CharSequence</span><span class="o">,</span> <span class="o">?,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">joining</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">CharSequence</span> <span class="n">delimiter</span><span class="o">,</span> <span class="n">CharSequence</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">CharSequence</span> <span class="n">suffix</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testJoining</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">,</span> <span class="s">&#34;b&#34;</span><span class="o">,</span> <span class="s">&#34;c&#34;</span><span class="o">,</span> <span class="s">&#34;d&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">s1Join</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s1Join</span><span class="o">);</span> <span class="c1">// abcd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">s2Join</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s2Join</span><span class="o">);</span> <span class="c1">// a-b-c-d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">s3Join</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">&#34;-&#34;</span><span class="o">,</span> <span class="s">&#34;/*&#34;</span><span class="o">,</span> <span class="s">&#34;*/&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s3Join</span><span class="o">);</span> <span class="c1">// /*a-b-c-d*/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5-collectorsgroupingby">5. <code>Collectors.groupingBy()</code></h4>
<p>API Definition (3 overloaded)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">K</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;&gt;</span> <span class="nf">groupingBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">K</span><span class="o">&gt;</span> <span class="n">classifier</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">	<span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">K</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">groupingBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">K</span><span class="o">&gt;</span> <span class="n">classifier</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">K</span><span class="o">,</span> <span class="n">D</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">M</span> <span class="kd">extends</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">M</span><span class="o">&gt;</span> <span class="nf">groupingBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">K</span><span class="o">&gt;</span> <span class="n">classifier</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span> <span class="n">mapFactory</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>用 collector() 方法傳入 <code>Collectors.groupingBy()</code>，可將 Stream 成員分類（grouping），如下步驟</p>
<ol>
<li>參數1使用 Function，以輸入型別T取得另一種型別K
<ul>
<li>K(分類的鍵值): 可能是T的屬性，或是T物件經處理後的某個結果</li>
</ul>
</li>
<li>參數2決定分類後的Stream成員儲存型態
<ul>
<li>使用 Collector interface 定義</li>
<li>如果是 <code>Collector.toList()</code>表示分類後以List集合物件儲存</li>
<li><code>Collector.toList()</code>即為預設值，可省略此參數</li>
</ul>
</li>
<li>結合前2參數可得分類後的key &amp; value</li>
</ol>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testGroupingBy</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">classifier</span> <span class="o">=</span> <span class="n">Person</span><span class="o">::</span><span class="n">getAge</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;&gt;</span> <span class="n">personsByAge</span> <span class="o">=</span> <span class="n">getPersonList</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">classifier</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">personsByAge</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="n">age</span><span class="o">,</span> <span class="n">personList</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;age %s: %s\n&#34;</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">personList</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6-collectorspartitioningby">6. <code>Collectors.partitioningBy()</code></h4>
<p>API Definition (2 overloaded)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">D</span><span class="o">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;&gt;</span> <span class="nf">partitioningBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">D</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">partitioningBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>使用 collect() 方法，傳入<code>Collectors.partitioningBy()</code>，可以將 stream 成員依照 Predicate 定義的方法分成兩類（滿足/不滿足），如下步驟</p>
<ol>
<li>使用 Predicate 定義之方法進行測試，再依照測試結果分成兩類(key-true/false)</li>
<li>參數2決定分類後的Stream成員儲存型態
<ul>
<li>使用 Collector interface 定義</li>
<li>如果是 <code>Collector.toList()</code>表示分類後以List集合物件儲存</li>
<li><code>Collector.toList()</code>即為預設值，可省略此參數</li>
</ul>
</li>
<li>結合前2參數可得分類後的key &amp; value，回傳 Map&lt;Boolean, Object&gt;</li>
</ol>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testPartitioningBy</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;&gt;</span> <span class="n">personByAge</span> <span class="o">=</span> <span class="n">getPersonList</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">partitioningBy</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">age</span> <span class="o">&gt;</span> <span class="n">20</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Is age &gt; 20 ?&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">personsByAge</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">key</span> <span class="o">+</span> <span class="s">&#34;:\t&#34;</span>
</span></span><span class="line"><span class="cl">            			<span class="o">+</span> <span class="n">val</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                             <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">&#34;, &#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="7-collectorsmappingcollectorsflatmapping">7. <code>Collectors.mapping()</code>、<code>Collectors.flatMapping()</code></h4>
<p><code>mapping()</code> 與 <code>flatMapping()</code> 功能相次但參數的 Function 介面定義不同，<code>flatMapping()</code> 必須回傳 Stream 物件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">U</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="nf">mapping</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">mapper</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">U</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">U</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="nf">flatMapping</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">Stream</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;&gt;</span> <span class="n">mapper</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">U</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>Collectors.mapping()</code>、<code>Collectors.flatMapping()</code> 與 <code>Collectors.groupingBy()</code>此三者目的相似，都是要進行分類</p>
<ol>
<li>對於分類的<strong>依據欄位的定義方式</strong>皆相同</li>
<li>對於分類的<strong>對象</strong>與<strong>結果</strong>則各有特色</li>
</ol>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testMappingFlatMapping</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Blog</span><span class="o">&gt;</span> <span class="n">blogs</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="na">getBlogs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// 1. groupingBy 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    參數1=分類的欄位依據, 參數2=分類之後以List儲存不同類的Blog物件
</span></span></span><span class="line"><span class="cl"><span class="cm">    key=Blog物件的authorName, val=List&lt;Blog&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Blog</span><span class="o">&gt;&gt;</span> <span class="n">authorByName</span> <span class="o">=</span> <span class="n">blogs</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">Blog</span><span class="o">::</span><span class="n">getAuthorName</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">authorByName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// 2. groupingBy + mapping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    分類的對象改由 Collectors.mapping()決定，可以不再是整個Blog物件，
</span></span></span><span class="line"><span class="cl"><span class="cm">    而是Blog物件裡的某個欄位值
</span></span></span><span class="line"><span class="cl"><span class="cm">    分類依據(key)=Blog.authorName
</span></span></span><span class="line"><span class="cl"><span class="cm">    分類對象=Blog物件的comments欄位，型態為List&lt;String&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">      又因為分類後以List存放，所以value=List&lt;List&lt;String&gt;&gt;  
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">authorComments1</span> <span class="o">=</span> <span class="n">blogs</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">Blog</span><span class="o">::</span><span class="n">getAuthorName</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="n">Blog</span><span class="o">::</span><span class="n">getComments</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">authorComments</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// 3. groupingBy + flatMapping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">authorComments2</span> <span class="o">=</span> <span class="n">blogs</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Blog</span><span class="o">::</span><span class="n">getAuthorName</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Collectors</span><span class="o">.</span><span class="na">flatMapping</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">blog</span> <span class="o">-&gt;</span> <span class="n">blog</span><span class="o">.</span><span class="na">getComments</span><span class="o">().</span><span class="na">stream</span><span class="o">(),</span> <span class="c1">//(param1)分類的對象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">())));</span> 
</span></span><span class="line"><span class="cl">                <span class="cm">/* (param2)被分類的不是Blog物件的原始 List&lt;String&gt; comments，
</span></span></span><span class="line"><span class="cl"><span class="cm">                   而是攤平後的眾多String，再以List存放，所以value=List&lt;String&gt;*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">authorComments2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>Collectors.flatMapping()</code> 使用方式類似 <code>Collectors.mapping()</code></p>
<ul>
<li>
<p>最大差異是分類的對象欄位必須可以產生 Stream 物件，因為API定義</p>
<p><code>Function&lt;? super T, ? extends Stream&lt;? extends U&gt;&gt; mapper</code></p>
</li>
<li>
<p>好處: 如果遇到前例分類的回傳結果為<code>Map&lt;String, List&lt;List&lt;String&gt;&gt;&gt;</code>時，可攤平為<code>Map&lt;String, List&lt;String&gt;&gt;</code></p>
<ul>
<li><code>{Celia=[[Not bad, Ok, Just fine, all right]], Aaron=[[Nice, Very Nice, Great]]}</code></li>
<li><code>{Celia=[Not bad, Ok, Just fine, all right], Aaron=[Nice, Very Nice, Great]} </code></li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="8-collectorsfiltering">8. <code>Collectors.filtering()</code></h4>
<p>API Definition - 跟<code>Stream.filter()</code>差不多，都用於過濾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">Collectors</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="o">?,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="nf">filtering</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Collector</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="n">A</span><span class="o">,</span> <span class="n">R</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example - 不同方法, 相同結果</p>
<blockquote>
<ol>
<li>
<p>先用<code>Stream.filter()</code>過濾，再用<code>collect(Collectors.toList())</code>彙整</p>
</li>
<li>
<p>使用<code>Stream.collect()</code>，同時以<code>Collectors.filtering()</code>、<code>Collectors.toList()</code>指定過濾條件&amp;彙整方式</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">20</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//2.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">filtering</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Collectors</span><span class="o">.</span><span class="na">filtering</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">20</span><span class="o">,</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>Example</p>
<blockquote>
<ol>
<li>
<p>先<code>Stream.filter()</code>，再<code>Collectors.groupingBy()</code>指定分組依據（<code>Person::getName</code>）、分組對象以<code>Collectors.counting()</code>表示符合的 Person 物件數量</p>
</li>
<li>
<p>使用<code>Stream.collect()</code>與<code>Collectors.groupingBy()</code>指定分組依據為<code>Person::getName</code></p>
<p>分組過程同時以<code>Collectors.filtering()</code>指定過濾條件與<code>Collectors.counting()</code>計算符合的 Person 物件數量</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//1. Stream.filter() + Collectors.groupingBy()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">filter4Grouping</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">20</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">collect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    	<span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Person</span><span class="o">::</span><span class="n">getName</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Collectors</span><span class="o">.</span><span class="na">counting</span><span class="o">()</span> <span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// {Pamela=1, Peter=1}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//2. Collectors.filtering() + Collectors.groupingBy()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">filtering4Grouping</span> <span class="o">=</span> <span class="n">persons</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">collect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    	<span class="n">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Person</span><span class="o">::</span><span class="n">getName</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">Collectors</span><span class="o">.</span><span class="na">filtering</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">20</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">Collectors</span><span class="o">.</span><span class="na">counting</span><span class="o">()</span> <span class="o">)));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// {Pamela=1, Max=0, David=0, Peter=1}
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="短路型終端作業">短路型終端作業</h3>
<p>在Stream所有成員都被接觸/處理之前，能因為某些情況而提前終止</p>
<p>作業目的：以搜尋為主，可以用最小成本執行並結束工作</p>
<p><code>Stream&lt;T&gt;</code>依搜尋後回傳結果可分為兩類：</p>
<table>
<thead>
<tr>
<th>return</th>
<th>method</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean</td>
<td>boolean <strong>allMatch</strong>(Predicate&lt;? super T&gt; predicate);<!-- raw HTML omitted -->boolean <strong>noneMatch</strong>(Predicate&lt;? super T&gt; predicate);<!-- raw HTML omitted -->boolean <strong>anyMatch</strong>(Predicate&lt;? super T&gt; predicate);<!-- raw HTML omitted --><em>以Predicate.test()判斷是否滿足搜尋條件的基準</em></td>
</tr>
<tr>
<td>Optional&lt;T&gt;</td>
<td>Optional&lt;T&gt; <strong>findFirst</strong>();<!-- raw HTML omitted -->Optional&lt;T&gt; <strong>findAny</strong>();</td>
</tr>
</tbody>
</table>
<h4 id="1-allmatch">1. <code>allMatch()</code></h4>
<p>API Definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">allMatch</span><span class="o">(</span><span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li>如果所有成員都滿足Predicate介面定義的條件，回傳true</li>
<li>一旦找到不滿足條件的成員，就結束搜尋，回傳false</li>
<li>若Stream為空，不會執行<code>Predicate.test()</code>，直接回傳true</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testAllMatch</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;jean1&#34;</span><span class="o">,</span> <span class="s">&#34;jean2&#34;</span><span class="o">,</span> <span class="s">&#34;jean3&#34;</span><span class="o">,</span> <span class="s">&#34;jean4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">containsJean</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">allMatch</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;jean&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 所有成員都包含&#34;jean&#34;，回傳true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">boolean</span> <span class="n">contains1</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">allMatch</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 第二筆資料不含&#34;1&#34;，故為false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="2-nonematch">2. <code>noneMatch()</code></h4>
<p>API Definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">nonMatch</span><span class="o">(</span><span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li>如果全部成員**「皆不」**滿足Predicate介面定義的條件，回傳true</li>
<li>一旦發現滿足條件的成員，就結束搜尋，回傳false</li>
<li>若Stream為空，不會執行<code>Predicate.test()</code>，直接回傳true</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;jean1&#34;</span><span class="o">,</span> <span class="s">&#34;jean2&#34;</span><span class="o">,</span> <span class="s">&#34;jean3&#34;</span><span class="o">,</span> <span class="s">&#34;jean4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="n">contains5</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&#34;5&#34;</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="3-anymatch">3. <code>anyMatch()</code></h4>
<p>API Definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="nf">anyMatch</span><span class="o">(</span><span class="n">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li>發現任何一個成員滿足Predicate介面定義的條件，就回傳true，結束搜尋</li>
<li>若Stream為空，不會執行<code>Predicate.test()</code>，直接回傳false</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">boolean</span> <span class="n">lengthOver5</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">,</span> <span class="s">&#34;three&#34;</span><span class="o">,</span> <span class="s">&#34;eighteen&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    	<span class="o">.</span><span class="na">anyMatch</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">5</span><span class="o">);</span> <span class="c1">// true
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="4-findfirst">4. <code>findFirst()</code></h4>
<p>API Definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">findFirst</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li>找到<code>Stream&lt;T&gt;</code>裡面<strong>第一個</strong>成員，就回傳<code>Optional&lt;T&gt;</code>，結束程式</li>
<li>每次找到的結果<strong>都為固定</strong>，稱之為「<strong>決定性（deterministic）</strong>」</li>
<li>沒成員時，回傳 empty 的 Optional 物件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">,</span> <span class="s">&#34;two&#34;</span><span class="o">).</span><span class="na">findFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Optional[one]
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="5-findany">5. <code>findAny()</code></h4>
<p>API Definition</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">findAny</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li>找到<code>Stream&lt;T&gt;</code>裡面<strong>任何一個</strong>成員，就回傳<code>Optional&lt;T&gt;</code>，結束程式</li>
<li>每次找到的結果<strong>不一定相同</strong>，稱之為「<strong>非決定性（non-deterministic）</strong>」
尤其是平行執行時，如果要得到固定結果，需改用<code>findFirst()</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;jean1&#34;</span><span class="o">,</span> <span class="s">&#34;jean2&#34;</span><span class="o">,</span> <span class="s">&#34;jean3&#34;</span><span class="o">,</span> <span class="s">&#34;jean4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">findAny</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Optional[jean1]
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<hr>
<h2 id="stream-api-和-nio2">Stream API 和 NIO.2</h2>
<p><code>java.nio.file.Files</code>有一些方法支援 Stream API，使 NIO.2 也可以用流暢的語法撰寫</p>
<h4 id="1-list">1. <code>list()</code></h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/* list() 方法可以列出 Path dir 下的所有檔案，
</span></span></span><span class="line"><span class="cl"><span class="cm">   但只在第一層，
</span></span></span><span class="line"><span class="cl"><span class="cm">   即並不是以遞迴方式列出各層的所有檔案和目錄 */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">Path</span> <span class="n">dir</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">testList</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;src/cource/c10&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stream</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">path</span> <span class="o">-&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.txt&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-find">2. <code>find()</code></h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/* 
</span></span></span><span class="line"><span class="cl"><span class="cm">   find() 方法可以找出符合條件的目錄或檔案
</span></span></span><span class="line"><span class="cl"><span class="cm">   1. Path start - 搜尋起始目錄
</span></span></span><span class="line"><span class="cl"><span class="cm">   2. int maxDepth - 搜尋指定的層數，非遞迴搜尋全部
</span></span></span><span class="line"><span class="cl"><span class="cm">   3. BiPredicate&lt;Path,BasicFileAttributes&gt; matcher - 以此定義的方法當作搜尋條件
</span></span></span><span class="line"><span class="cl"><span class="cm">   4. FileVisitOption... options - 定義其他搜尋條件(如果有需要)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Path</span> <span class="n">start</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">maxDepth</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">BiPredicate</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">,</span> <span class="n">BasicFileAttributes</span><span class="o">&gt;</span> <span class="n">matcher</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">FileVisitOption</span><span class="o">...</span> <span class="n">options</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">testFind</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">         <span class="n">Files</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Path</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;src&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">4</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">attr</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.txt&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stream</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-walk">3. <code>walk()</code></h4>
<p>Method Declaration (2 overloaded)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//1. 指定要遞迴的層數
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="nf">walk</span><span class="o">(</span><span class="n">Path</span> <span class="n">start</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">int</span> <span class="n">maxDepth</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">FileVisitOption</span><span class="o">...</span> <span class="n">options</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//2. 不指定層數，要遞迴全部
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="nf">walk</span><span class="o">(</span><span class="n">Path</span> <span class="n">start</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">FileVisitOption</span><span class="o">...</span> <span class="n">options</span><span class="o">)</span> <span class="o">{...}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>方法概念類似 NIO.2 裡面的方法，都能遞迴拜訪相關層級的所有檔案/目錄</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Files</span><span class="o">.</span><span class="na">walkFileTree</span><span class="o">(</span><span class="n">Path</span> <span class="n">start</span><span class="o">,</span> <span class="n">FileVisitor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">visitor</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但如果要對拜訪的檔案目錄採取特定動作時</p>
<ol>
<li><code>Files.walkFileTree()</code>：由 FileVisitor interface 的實作決定</li>
<li><code>Files.walk()</code>：開啟 Stream 後，再由其管線方法 (pipeline) 決定</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//只遞迴4層，如果附檔名為.txt，就將其輸出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">walk</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/NIO2Demo&#34;</span><span class="o">),</span> <span class="n">4</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">stream</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">path</span> <span class="o">-&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.txt&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//遞迴所有層數，如果附檔名為.txt，就將其輸出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">walk</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;dir/NIO2Demo&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">stream</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">path</span> <span class="o">-&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&#34;.txt&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-lines">4. <code>lines()</code></h4>
<p>Method Declaration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">lines</span><span class="o">(</span><span class="n">Path</span> <span class="n">path</span><span class="o">,</span> <span class="n">Charset</span> <span class="n">cs</span><span class="o">)</span> <span class="o">{...}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">lines</span><span class="o">(</span><span class="n">Path</span><span class="o">)</span> <span class="o">{...}</span>    <span class="c1">// 預設UTF-8 charset
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">(</span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;data.txt&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">stream</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">String</span><span class="o">::</span><span class="n">toLowerCase</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>method</th>
<th>notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Files.lines()</code></td>
<td>搭配管線作業只會處理需要的內容<!-- raw HTML omitted -->lazy、效能較佳<!-- raw HTML omitted -->回傳 Stream&lt;String&gt;</td>
</tr>
<tr>
<td><code>Files.readAllLines()</code></td>
<td>把所有檔案內容一次載入JVM<!-- raw HTML omitted -->回傳 List&lt;String&gt;</td>
</tr>
<tr>
<td><code>BufferedReader.lines()</code></td>
<td>回傳 Stream&lt;String&gt;</td>
</tr>
</tbody>
</table>
<p>Example - BufferedReader</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span> <span class="o">(</span><span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newBufferedReader</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;data.txt&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">lines</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">String</span><span class="o">::</span><span class="n">toLowerCase</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>NOTE:</p>
<p>Stream也有實作AutoCloseable介面，可以放在try-with-resource的程式區塊裡</p>
<ol>
<li>如果Stream用在Collection：不用特別在使用完後關閉</li>
<li>Stream搭配NIO.2開啟檔案：<strong>必須</strong>在結束時主動關閉，或者用try-with-resource架構處理</li>
</ol>
</blockquote>
<hr>
<h2 id="stream-api-操作平行化">Stream API 操作平行化</h2>
<h3 id="平行化的前提">平行化的前提</h3>
<p>Stream feature:</p>
<ol>
<li>無法更改內容 immutable：一旦更改都會回傳新物件，或拋出Exception</li>
<li>無法重複使用：要使用就必須再產生新物件</li>
<li>可以使用
<ul>
<li>循序處理 sequential</li>
<li>平行處理 parallel</li>
</ul>
</li>
</ol>
<p>Stream API 支援建構者設計模式的流暢撰寫風格</p>
<h4 id="撰寫風格_1指令式編程imperative-programming">撰寫風格_1：指令式編程（imperative programming）</h4>
<blockquote>
<p>特色</p>
<ol>
<li>迴圈必須經歷所有集合成員</li>
<li>知道迴圈做了哪些事（how），但不是很清楚目的（what）</li>
<li>迴圈中必須有其他變數，例如sum</li>
<li>不容易以平行處理提高效能</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="n">Employee</span> <span class="n">e</span> <span class="o">:</span> <span class="n">getEmployees</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;Jim&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span> <span class="o">&gt;=</span> <span class="n">1500</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">sum</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">sum</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="撰寫風格_2流暢式編程streaming-programming">撰寫風格_2：流暢式編程（streaming programming）</h4>
<blockquote>
<p>特色</p>
<ol>
<li>程式本身清楚陳述目的（what）</li>
<li>不需要額外變數</li>
<li>可藉由「懶人（lazy）優化機制」提升效能</li>
<li>可以平行處理提高效能</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">getEmployee</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;Jim&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span> <span class="o">&gt;=</span> <span class="n">1500</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">show</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">mapToDouble</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">sum</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="撰寫風格_3">撰寫風格_3</h4>
<blockquote>
<p>此作法少了Stream管線操作的好處（如：懶人優化法、平行化處理），故不建議</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">streamingProgramming3</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">getEmployees</span><span class="o">().</span><span class="na">stream</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">starsWith</span><span class="o">(</span><span class="s">&#34;Jim&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span> <span class="o">&gt;=</span> <span class="n">1500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="n">s4</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">show</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">DoubleStream</span> <span class="n">s5</span> <span class="o">=</span> <span class="n">s4</span><span class="o">.</span><span class="na">mapToDouble</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">s5</span><span class="o">.</span><span class="na">sum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">sum</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="平行化的作法">平行化的作法</h3>
<h4 id="基本原則">基本原則</h4>
<p>平行處理（parallel）：啟動多執行緒來減少執行時間</p>
<ol>
<li>
<p>建議硬體要具備多核心CPU或GPU</p>
</li>
<li>
<p>底層用Fork/Join架構，但不建議開發者直接使用，應該用高階API</p>
</li>
<li>
<p>有許多因素可影響平行執行的加速效果</p>
<ul>
<li><strong>平行處理</strong> 不是每次都比 <strong>循序處理</strong> 快</li>
<li>影響因素：資料大小、拆解方法、結果聚合方式、CPU核心數</li>
</ul>
</li>
<li>
<p>可以藉由以下方式啟動</p>
<ol>
<li>
<p>從 Collection（集合物件）發動，使用<code>parallelStream()</code>方法</p>
</li>
<li>
<p>由 Stream（串流物件）發動，使用<code>parallel()</code>方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">getEmployees</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;Jean&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span> <span class="o">&gt;=</span> <span class="n">1500</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">peek</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">show</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">mapToDouble</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">salary</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">parallel</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">sum</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
<li>
<p>未呼叫<code>.parallel()</code>時，預設<code>.sequential()</code></p>
</li>
<li>
<p>Stream（串流物件）發動平行化處理時，如果要<strong>各段管線操作都可以平行化</strong>，必須在尾端呼叫</p>
</li>
<li>
<p>過程中不可以修改來源物件（例如 Collection）</p>
</li>
</ol>
<h4 id="管線操作的變數必須是沒有狀態stateless">管線操作的變數必須是「沒有狀態（stateless）」</h4>
<h1 id="p-327-">p 327 🍪☕</h1>
<h4 id="平行處理可能讓結果不同">平行處理可能讓結果不同</h4>
<h3 id="reduction-操作">Reduction 操作</h3>
<h4 id="reduction-的基礎操作">Reduction 的基礎操作</h4>
<h4 id="reduction-的平行操作">Reduction 的平行操作</h4>
<h4 id="平行化處理的注意事項">平行化處理的注意事項</h4>
<ol>
<li>平行處理效能不一定比較快，有時甚至會比循序處理慢。須有硬體支援，像是多核CPU和GPU</li>
<li>平行處理必須考量<strong>最初拆解</strong>、<strong>最終合併</strong>作法是否合適。中間作業（例如<code>filter()</code>）也會影響拆解與合併的效能</li>
<li>因為自動 **開箱/裝箱（boxing/unboxing）**會降低執行效率，直接用基本型別的變形Stream會有比較好的效能表現，例如<code>IntStream</code>、<code>LongStream</code>、<code>DoubleStream</code></li>
</ol>
<hr>
<h1 id="11-datetime-api">11 Date/Time API</h1>
<h2 id="date--time-相關類別演進">Date &amp; Time 相關類別演進</h2>
<h4 id="日期date與時間time的重要性">日期（Date）與時間（Time）的重要性</h4>
<h4 id="java-8-之前的日期時間-api">Java 8 之前的日期時間 API</h4>
<h4 id="java-8-之後的日期時間-api">Java 8 之後的日期時間 API</h4>
<hr>
<h2 id="當地日期與時間">當地日期與時間</h2>
<h3 id="類別-localdate">類別 <code>LocalDate</code></h3>
<h3 id="類別-localtime">類別 <code>LocalTime</code></h3>
<h3 id="類別-localdatetime">類別 <code>LocalDateTime</code></h3>
<hr>
<h2 id="時區和日光節約時間">時區和日光節約時間</h2>
<hr>
<h2 id="描述日期與時間的數量">描述日期與時間的數量</h2>
<h3 id="時區和日光節約時間簡介">時區和日光節約時間簡介</h3>
<p>名詞簡介</p>
<h4 id="gmtgreenwich-mean-time格林威治標準時間">GMT（Greenwich Mean Time，格林威治標準時間）</h4>
<h4 id="utcuniversal-time-coordinated國際協調時間">UTC（Universal Time Coordinated，國際協調時間）</h4>
<h4 id="全球-24-個時區">全球 24 個時區</h4>
<h4 id="日光節約時間">日光節約時間</h4>
<h5 id="1-日光節約時間的定義">1. 日光節約時間的定義</h5>
<h5 id="2-日光節約時間的調整">2. 日光節約時間的調整</h5>
<h5 id="3-日光節約時間的影響">3. 日光節約時間的影響</h5>
<h3 id="java-在時區和日光節約時間的應用">Java 在時區和日光節約時間的應用</h3>
<p>Java 8 支援時區 Time Zones 的應用類別如下：</p>
<h4 id="類別-zoneid">類別 ZoneId</h4>
<h4 id="類別-zonerules">類別 ZoneRules</h4>
<p>此類別擁有的方法可取得該時區的相關規則（rules），像是</p>
<h5 id="1-isdaylightsavingsinstant">1. <code>isDaylightSavings(Instant)</code></h5>
<h5 id="2-getstandardoffsetinstant">2. <code>getStandardOffset(Instant)</code></h5>
<h5 id="3-getoffsetinstand">3. <code>getOffset(Instand)</code></h5>
<h4 id="類別-zoneoffset">類別 ZoneOffset</h4>
<h4 id="綜合示範">綜合示範</h4>
<h4 id="類別-zoneddatetime">類別 ZonedDateTime</h4>
<h4 id="類別-zoneoffsettransition">類別 ZoneOffsetTransition</h4>
<h4 id="類別-offsetdatetime">類別 OffsetDateTime</h4>
<hr>
<h2 id="描述日期與時間的數量-1">描述日期與時間的數量</h2>
<h3 id="類別-instant">類別 Instant</h3>
<p>Instant 類用來儲存時間軸上一剎那的時間，分成2部分儲存</p>
<ol>
<li><strong>epoch-seconds(long)</strong></li>
<li><strong>nanosecond-of-second(int)</strong></li>
</ol>
<h3 id="類別-period-和-duration">類別 Period 和 Duration</h3>
<ol>
<li>Period:
<ul>
<li>以 years, months, days 建構日期的差量，依 ISO-8601 規範
API文件 -&gt; <code>This class models a quantity or amount of time in terms of years, months, and days.</code></li>
<li>使用 <code>plus()</code> 與 <code>minus()</code> 方法時，皆以天為概念，可保留日光節約時間的變化</li>
</ul>
</li>
<li>Duration:
<ul>
<li>以 seconds, nanoseconds 建構時間的差量，也可以換算成 hours 和 minutes
API文件 -&gt; <code>This class models a quantity or amount of time in terms of seconds and nanoseconds. It can be accessed using other duration-based units, such as minutes and hours.</code></li>
<li>沒有日光節約時間的概念，<em>每一天</em> 被 <em>24小時</em> 的概念取代</li>
</ul>
</li>
</ol>
<h3 id="使用流暢fluent的程式風格">使用流暢（fluent）的程式風格</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FluentDemo</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LocalDate</span> <span class="n">myDay0</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1977</span><span class="o">,</span> <span class="n">6</span><span class="o">,</span> <span class="n">11</span><span class="o">);</span>            <span class="c1">// 一般語法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LocalDate</span> <span class="n">myDay1</span> <span class="o">=</span> <span class="n">Year</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">1977</span><span class="o">).</span><span class="na">atMonth</span><span class="o">(</span><span class="n">06</span><span class="o">).</span><span class="na">atDay</span><span class="o">(</span><span class="n">11</span><span class="o">);</span>  <span class="c1">// 流暢語法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="cm">/* 以下line6-19同TimeZoneAcrossDemo，但是使用流暢語法 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">LocalDateTime</span> <span class="n">meeting</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">2022</span><span class="o">,</span> <span class="n">07</span><span class="o">,</span> <span class="n">10</span><span class="o">).</span><span class="na">atTime</span><span class="o">(</span><span class="n">11</span><span class="o">,</span> <span class="n">30</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">ZonedDateTime</span> <span class="n">host</span> <span class="o">=</span> <span class="n">meeting</span><span class="o">.</span><span class="na">atZone</span><span class="o">(</span><span class="n">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">host</span><span class="o">);</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 2023-02-24T13:27+08:00[Asia/Taipei]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="n">ZonedDateTime</span> <span class="n">meetingUK</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="na">withZoneSameInstant</span><span class="o">(</span><span class="n">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;Europe/London&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">meetingUK</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2023-02-24T06:27+01:00[Europe/London]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="n">ZonedDateTime</span> <span class="n">meetingSF</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="na">withZoneSameInstant</span><span class="o">(</span><span class="n">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;America/New_York&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">meetingSF</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2023-02-24T01:27-04:00[America/New_York]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h1 id="12-標註型別-annotation">12 標註型別 <em>Annotation</em></h1>
<h2 id="認識標註型別">認識標註型別</h2>
<h2 id="建立自定義標註型別">建立自定義標註型別</h2>
<h2 id="標註型別的應用">標註型別的應用</h2>
<h2 id="自定義標註型別時使用的內建標註型別">自定義標註型別時使用的內建標註型別</h2>
<h2 id="開發一般程式碼經常使用的內建標註型別">開發一般程式碼經常使用的內建標註型別</h2>
<hr>
<h1 id="13-java-平台模組系統">13 Java 平台模組系統</h1>
<h2 id="認識-java-模組化">認識 Java 模組化</h2>
<h2 id="建立和執行模組化程式">建立和執行模組化程式</h2>
<h2 id="建立相依模組程式">建立相依模組程式</h2>
<h2 id="認識-module-infojava-的宣告關鍵字">認識 <code>module-info.java</code> 的宣告關鍵字</h2>
<h2 id="在命令列-command-line-使用模組指令選項">在命令列 <code>command line</code> 使用模組指令選項</h2>
<hr>
<h1 id="14-模組化應用程式">14 模組化應用程式</h1>
<h2 id="回顧模組指令">回顧模組指令</h2>
<h2 id="比較模組類型">比較模組類型</h2>
<h2 id="分析-jdk-依賴關係">分析 JDK 依賴關係</h2>
<h2 id="模組化既有應用程式">模組化既有應用程式</h2>
<h2 id="模組化-java-服務結構">模組化 Java 服務結構</h2>
<hr>
<h1 id="15-開發安全的-java-程式">15 開發安全的 Java 程式</h1>
<h2 id="設計安全物件">設計安全物件</h2>
<h2 id="注入-injection-攻擊與輸入-input-驗證">注入 <em>injection</em> 攻擊與輸入 <em>input</em> 驗證</h2>
<h2 id="處理機敏資訊">處理機敏資訊</h2>
<h2 id="序列化與反序列化物件">序列化與反序列化物件</h2>
<h2 id="建立保護機敏資料的安全物件">建立保護機敏資料的安全物件</h2>
<h2 id="避免服務阻斷-denial-of-service-攻擊">避免服務阻斷 <em>denial of service</em> 攻擊</h2>
<hr>
<h1 id="16-mock-exam--analysis">16 Mock exam &amp; analysis</h1>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-02-05</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)" data-via="cel_yi" data-hashtags="Java,1Z0-819"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-hashtag="Java"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/java/">Java</a>,&nbsp;<a href="/tags/1z0-819/">1Z0-819</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/encrypt_decrypt/" class="prev" rel="prev" title="Encrypt, Decrypt"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Encrypt, Decrypt</a>
            <a href="/posts/lesson_00_linux/" class="next" rel="next" title="Lesson 00: Linux 筆記">Lesson 00: Linux 筆記<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">strict with yourself; lenient with others.</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-CCS3QPVY5N', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-CCS3QPVY5N" async></script></body>
</html>
