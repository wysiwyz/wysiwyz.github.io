<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>1Z0-819 曾師筆記 (2/duology) - Ich bin yiwen.</title><meta name="Description" content="An ordinary space for storing and groups pieces of articles."><meta property="og:title" content="1Z0-819 曾師筆記 (2/duology)" />
<meta property="og:description" content="# 01 泛型和集合物件 泛型 Java 5 之後加入泛型，使型別使用多了另一種彈性。
集合物件（用來裝填物件）＋泛型，可以限制裝填物件的型別。
使用泛型的效益 提供更彈性的「型別安全 type safety」檢查機制，原本在執行時才能發現的型別錯誤，現在在編譯時期就可以預發現 在集合物件 Collections 裡大量使用，限制內涵物件之型別 減少轉型 casting 需要，使程式碼更簡潔 使用泛型設計類別 可以將程式碼裡的符號 T換成 String( 即 UseString())，或換成 Shirt (即 UseShirt()) 常見的符號及表示方式如下： T -「型別（type）」 E -「成員（element）」 K -「鍵 - 值對裡的鍵（key）」 V -「鍵 - 值對裡的值（value）」 class UseAny&lt;T&gt; { private T t; public void add(T t) { this.t = t; } public T get() { return this.t; } } class UseString { private String message; public void add(String message) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://wysiwyz.github.io/posts/ocpjp_11_2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-18T17:50:34+08:00" />
<meta property="article:modified_time" content="2022-12-18T17:50:34+08:00" /><meta property="og:site_name" content="Ich bin yiwen." />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="1Z0-819 曾師筆記 (2/duology)"/>
<meta name="twitter:description" content="# 01 泛型和集合物件 泛型 Java 5 之後加入泛型，使型別使用多了另一種彈性。
集合物件（用來裝填物件）＋泛型，可以限制裝填物件的型別。
使用泛型的效益 提供更彈性的「型別安全 type safety」檢查機制，原本在執行時才能發現的型別錯誤，現在在編譯時期就可以預發現 在集合物件 Collections 裡大量使用，限制內涵物件之型別 減少轉型 casting 需要，使程式碼更簡潔 使用泛型設計類別 可以將程式碼裡的符號 T換成 String( 即 UseString())，或換成 Shirt (即 UseShirt()) 常見的符號及表示方式如下： T -「型別（type）」 E -「成員（element）」 K -「鍵 - 值對裡的鍵（key）」 V -「鍵 - 值對裡的值（value）」 class UseAny&lt;T&gt; { private T t; public void add(T t) { this.t = t; } public T get() { return this.t; } } class UseString { private String message; public void add(String message) { this."/>
<meta name="application-name" content="Ich bin yiwen.">
<meta name="apple-mobile-web-app-title" content="Ich bin yiwen."><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/moon_icon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://wysiwyz.github.io/posts/ocpjp_11_2/" /><link rel="prev" href="http://wysiwyz.github.io/posts/ocpjp_11/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "1Z0-819 曾師筆記 (2/duology)",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/wysiwyz.github.io\/posts\/ocpjp_11_2\/"
        },"genre": "posts","keywords": "Java, 1Z0-819","wordcount":  6179 ,
        "url": "http:\/\/wysiwyz.github.io\/posts\/ocpjp_11_2\/","datePublished": "2022-12-18T17:50:34+08:00","dateModified": "2022-12-18T17:50:34+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "celine"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">1Z0-819 曾師筆記 (2/duology)</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>celine</a></span>&nbsp;<span class="post-category">included in <a href="/categories/studynote/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>StudyNote</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-12-18">2022-12-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6179 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;30 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#泛型">泛型</a>
      <ul>
        <li><a href="#使用泛型的效益">使用泛型的效益</a></li>
        <li><a href="#使用泛型設計類別">使用泛型設計類別</a></li>
      </ul>
    </li>
    <li><a href="#集合物件">集合物件</a>
      <ul>
        <li><a href="#collection-定義與種類">Collection 定義與種類</a></li>
        <li><a href="#list">List</a></li>
        <li><a href="#arraylist--list-最常使用的一種實作類別"><code>ArrayList</code> : List 最常使用的一種實作類別</a></li>
        <li><a href="#自動裝箱-boxing和開箱-unboxing">自動裝箱 <code>Boxing</code>和開箱 <code>Unboxing</code></a></li>
        <li><a href="#set">Set</a></li>
        <li><a href="#deque-queue">Deque (Queue)</a></li>
      </ul>
    </li>
    <li><a href="#map">Map</a></li>
    <li><a href="#集合物件成員的排序">集合物件成員的排序</a>
      <ul>
        <li><a href="#排序作法">排序作法</a></li>
        <li><a href="#使用-comparable-介面排序">使用 <code>Comparable</code> 介面排序</a></li>
        <li><a href="#使用-comparator-介面排序">使用 <code>Comparator</code> 介面排序</a></li>
      </ul>
    </li>
    <li><a href="#使用-of-與-copyof-方法建立-listset-與-map-物件">使用 <code>of()</code> 與 <code>copyOf()</code> 方法建立 <code>List</code>、<code>Set</code> 與 <code>Map</code> 物件</a>
      <ul>
        <li><a href="#使用of方法建立-list-set-map-物件">使用<code>of()</code>方法建立 List, Set, Map 物件</a></li>
        <li><a href="#使用copyof方法建立-list-set-map-物件">使用<code>copyOf()</code>方法建立 List, Set, Map 物件</a></li>
        <li><a href="#使用-arraysaslist建立-list-物件">使用 <code>Arrays.asList()</code>建立 List 物件</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#例外">例外</a>
      <ul>
        <li><a href="#使用try-catch程式碼區塊">使用<code>try-catch</code>程式碼區塊</a></li>
        <li><a href="#使用-try-with-resources-程式碼區塊和-autocloseable-介面">使用 <code>try-with-resources</code> 程式碼區塊和 <code>AutoCloseable</code> 介面</a></li>
        <li><a href="#suppressed-exceptions">Suppressed Exceptions</a></li>
        <li><a href="#使用-multi-catch-敘述">使用 <code>multi-catch</code> 敘述</a></li>
        <li><a href="#使用-throws-宣告">使用 <code>throws</code> 宣告</a></li>
        <li><a href="#建立客製的-exception">建立客製的 <code>Exception</code></a></li>
      </ul>
    </li>
    <li><a href="#斷言">斷言</a>
      <ul>
        <li><a href="#assertions-的簡介和語法">Assertions 的簡介和語法</a></li>
        <li><a href="#assertions-的使用">Assertions 的使用</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#io-基礎">I/O 基礎</a>
      <ul>
        <li><a href="#何謂-io">何謂 I/O</a></li>
        <li><a href="#處理串流的類別">處理串流的類別</a></li>
        <li><a href="#串流類別的串接">串流類別的串接</a></li>
        <li><a href="#使用-javaiofile-類別">使用 <code>java.io.File</code> 類別</a></li>
      </ul>
    </li>
    <li><a href="#由主控台讀寫資料">由主控台讀寫資料</a>
      <ul>
        <li><a href="#主控台的-io">主控台的 I/O</a></li>
        <li><a href="#使用標準輸出方法">使用標準輸出方法</a></li>
        <li><a href="#javaioconsole-類別介紹"><code>java.io.Console</code> 類別介紹</a></li>
      </ul>
    </li>
    <li><a href="#channel-io">Channel I/O</a></li>
    <li><a href="#使用序列化技術讀寫物件">使用序列化技術讀寫物件</a>
      <ul>
        <li><a href="#java-裡的資料保存-persistence">Java 裡的資料保存 <em>Persistence</em></a></li>
        <li><a href="#序列化和物件圖譜">序列化和物件圖譜</a></li>
        <li><a href="#不需要參加序列化的欄位">不需要參加序列化的欄位</a></li>
        <li><a href="#定義物件保存的版本號碼">定義物件保存的版本號碼</a></li>
        <li><a href="#序列化和反序列化範例">序列化和反序列化範例</a></li>
        <li><a href="#3-serialization-and-de-serialization">3. Serialization and De-serialization</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#nio2-基礎">NIO.2 基礎</a>
      <ul>
        <li><a href="#javajofile限制"><code>java.jo.File</code>限制</a></li>
        <li><a href="#java-io-套件發展歷史">Java I/O 套件發展歷史</a></li>
        <li><a href="#檔案系統路徑和檔案">檔案系統、路徑和檔案</a></li>
        <li><a href="#symbolic-link-檔案">Symbolic Link 檔案</a></li>
        <li><a href="#nio2-的基本架構">NIO.2 的基本架構</a></li>
      </ul>
    </li>
    <li><a href="#使用-path-介面操作檔案目錄">使用 Path 介面操作檔案/目錄</a>
      <ul>
        <li><a href="#path-介面">Path 介面</a></li>
        <li><a href="#path-介面主要功能">Path 介面主要功能</a></li>
        <li><a href="#移除路徑裡的多餘組成">移除路徑裡的多餘組成</a></li>
        <li><a href="#建立子路徑">建立子路徑</a></li>
        <li><a href="#結合-2-個路徑">結合 2 個路徑</a></li>
        <li><a href="#建立連接-2-個路徑的路徑">建立連接 2 個路徑的路徑</a></li>
        <li><a href="#hard-link">Hard Link</a></li>
        <li><a href="#處理-symbolic-link">處理 Symbolic Link</a></li>
      </ul>
    </li>
    <li><a href="#使用-files-類別對檔案目錄進行檢查刪除複製移動">使用 Files 類別對檔案/目錄進行檢查刪除複製移動</a>
      <ul>
        <li><a href="#處理檔案">處理檔案</a></li>
        <li><a href="#檢查檔案--目錄是否存在">檢查檔案 / 目錄是否存在</a></li>
        <li><a href="#檢查檔案--目錄屬性">檢查檔案 / 目錄屬性</a></li>
        <li><a href="#建立檔案--目錄">建立檔案 / 目錄</a></li>
        <li><a href="#刪除檔案--目錄">刪除檔案 / 目錄</a></li>
        <li><a href="#複製和移動檔案--目錄">複製和移動檔案 / 目錄</a></li>
        <li><a href="#stream-和-path-互相複製">Stream 和 Path 互相複製</a></li>
        <li><a href="#列出目錄內容">列出目錄內容</a></li>
        <li><a href="#讀取和寫入檔案">讀取和寫入檔案</a></li>
      </ul>
    </li>
    <li><a href="#使用-files-類別操作-channel-io-和-stream-io-讀寫檔案">使用 Files 類別操作 Channel I/O 和 Stream I/O 讀寫檔案</a>
      <ul>
        <li><a href="#介面-channel-和類別-bytebuffer">介面 Channel 和類別 ByteBuffer</a></li>
        <li><a href="#隨機存取檔案">隨機存取檔案</a></li>
        <li><a href="#對文字檔提供-buffered-io-方法">對文字檔提供 Buffered I/O 方法</a></li>
        <li><a href="#取得位元串流物件的方法">取得位元串流物件的方法</a></li>
      </ul>
    </li>
    <li><a href="#讀寫檔案目錄的屬性">讀寫檔案/目錄的屬性</a>
      <ul>
        <li><a href="#使用-files-管理檔案的屬性資料">使用 Files 管理檔案的屬性資料</a></li>
        <li><a href="#讀取檔案屬性">讀取檔案屬性</a></li>
        <li><a href="#修改檔案屬性">修改檔案屬性</a></li>
        <li><a href="#dos-之外的-file-attribute-views">DOS 之外的 File Attribute Views</a></li>
        <li><a href="#posix-檔案系統的權限"><code>POSIX</code> 檔案系統的權限</a></li>
      </ul>
    </li>
    <li><a href="#遞迴存取目錄結構">遞迴存取目錄結構</a>
      <ul>
        <li><a href="#對檔案目錄進行遞迴操作">對檔案目錄進行遞迴操作</a></li>
      </ul>
    </li>
    <li><a href="#使用-pathmatcher-類別找尋符合的檔案">使用 <code>PathMatcher</code> 類別找尋符合的檔案</a>
      <ul>
        <li><a href="#搜尋檔案">搜尋檔案</a></li>
        <li><a href="#glob-樣式語法介紹"><code>glob</code> 樣式語法介紹</a></li>
      </ul>
    </li>
    <li><a href="#其它">其它</a>
      <ul>
        <li><a href="#filestore-類別"><code>FileStore</code> 類別</a></li>
        <li><a href="#使用-watchservice">使用 <code>WatchService</code></a></li>
        <li><a href="#由基礎-io-轉換至-nio2">由基礎 I/O 轉換至 NIO.2</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#介紹">介紹</a>
      <ul>
        <li><a href="#名詞說明">名詞說明</a></li>
        <li><a href="#多執行緒的重要性">多執行緒的重要性</a></li>
        <li><a href="#執行緒類別">執行緒類別</a></li>
      </ul>
    </li>
    <li><a href="#執行緒常見問題">執行緒常見問題</a>
      <ul>
        <li><a href="#使用-shared-data-可能造成的問題">使用 <code>Shared Data</code> 可能造成的問題</a></li>
        <li><a href="#使用-non-atomic-functions-可能造成的問題">使用 <code>Non-Atomic Functions</code> 可能造成的問題</a></li>
        <li><a href="#使用-cached-data-可能造成的問題">使用 <code>Cached Data</code> 可能造成的問題</a></li>
      </ul>
    </li>
    <li><a href="#執行緒的-synchronized-與等待">執行緒的 synchronized 與等待</a>
      <ul>
        <li><a href="#使用-synchronized-關鍵字">使用 <code>synchronized</code> 關鍵字</a></li>
        <li><a href="#使用-synchronized-的時機">使用 <code>synchronized</code> 的時機</a></li>
        <li><a href="#縮小-synchronized-的程式區塊">縮小 synchronized 的程式區塊</a></li>
        <li><a href="#其它執行等待的情況">其它執行等待的情況</a></li>
      </ul>
    </li>
    <li><a href="#其它執行緒方法介紹">其它執行緒方法介紹</a>
      <ul>
        <li><a href="#使用-interrupt-方法">使用 <code>interrupt()</code> 方法</a></li>
        <li><a href="#使用-sleep-方法">使用 <code>sleep()</code> 方法</a></li>
        <li><a href="#使用其它方法">使用其它方法</a></li>
        <li><a href="#不建議使用的方法">不建議使用的方法</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#使用並行-api">使用並行 API</a>
      <ul>
        <li><a href="#並行-api-介紹">並行 API 介紹</a></li>
        <li><a href="#atomicinteger-類別"><code>AtomicInteger</code> 類別</a></li>
        <li><a href="#reentrantreadwritelock-類別"><code>ReentrantReadWriteLock</code> 類別</a></li>
        <li><a href="#執行緒安全的集合物件">執行緒安全的集合物件</a></li>
        <li><a href="#常用的同步器工具類別">常用的同步器工具類別</a></li>
      </ul>
    </li>
    <li><a href="#使用-executorservice-介面同時執行多樣工作">使用 <code>ExecutorService</code> 介面同時執行多樣工作</a>
      <ul>
        <li><a href="#使用更高階的多執行緒執行方案">使用更高階的多執行緒執行方案</a></li>
        <li><a href="#executorservice概觀"><code>ExecutorService</code>概觀</a></li>
        <li><a href="#使用-javautilconcurrentcallable">使用 <code>java.util.concurrent.Callable</code></a></li>
        <li><a href="#使用-javautilconcurrentfuture">使用 <code>java.util.concurrent.Future</code></a></li>
        <li><a href="#關閉-executorservice">關閉 <code>ExecutorService</code></a></li>
        <li><a href="#executorservice完整範例"><code>ExecutorService</code>完整範例</a></li>
        <li><a href="#executorservice-進階範例"><code>ExecutorService</code> 進階範例</a></li>
      </ul>
    </li>
    <li><a href="#使用-fork-join-框架同時執行多樣工作">使用 Fork-Join 框架同時執行多樣工作</a>
      <ul>
        <li><a href="#平行處理的策略">平行處理的策略</a></li>
        <li><a href="#套用-fork-join-框架">套用 <code>Fork-Join</code> 框架</a></li>
        <li><a href="#fork-join-框架的使用建議"><code>Fork-Join</code> 框架的使用建議</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#了解-databasedbms-和-sql">了解 Database、DBMS 和 SQL</a></li>
    <li><a href="#eclipse-連線並存取資料庫">Eclipse 連線並存取資料庫</a></li>
    <li><a href="#使用-jdbc">使用 JDBC</a></li>
    <li><a href="#jdbc-進行交易">JDBC 進行交易</a></li>
    <li><a href="#使用-jdbc-41-的-rowsetprovider-和-rowsetfactory">使用 JDBC 4.1 的 RowSetProvider 和 RowSetFactory</a></li>
  </ul>

  <ul>
    <li><a href="#了解-java-的軟體區域化作法">了解 Java 的軟體區域化作法</a></li>
    <li><a href="#使用-dateformat-類別提供日期的區域化顯示">使用 DateFormat 類別提供日期的區域化顯示</a></li>
    <li><a href="#使用-numberformat-類別提供幣別區域化顯示">使用 NumberFormat 類別提供幣別區域化顯示</a></li>
  </ul>

  <ul>
    <li><a href="#使用-lambda-表示式">使用 Lambda 表示式</a></li>
    <li><a href="#使用內建的功能性介面">使用內建的功能性介面</a></li>
    <li><a href="#在泛型內使用萬用字元">在泛型內使用萬用字元</a></li>
    <li><a href="#使用其它內建的功能性介面">使用其它內建的功能性介面</a></li>
    <li><a href="#使用方法參照">使用方法參照</a></li>
  </ul>

  <ul>
    <li><a href="#建構者設計模式和方法鏈結">建構者設計模式和方法鏈結</a></li>
    <li><a href="#使用-optional-類別">使用 Optional 類別</a></li>
    <li><a href="#stream-api-介紹">Stream API 介紹</a></li>
    <li><a href="#stream-api-操作">Stream API 操作</a></li>
    <li><a href="#stream-api-和-nio2">Stream API 和 NIO.2</a></li>
    <li><a href="#stream-api-操作平行化">Stream API 操作平行化</a></li>
  </ul>

  <ul>
    <li><a href="#date--time-相關類別的演進">Date &amp; Time 相關類別的演進</a></li>
    <li><a href="#當地日期與時間">當地日期與時間</a></li>
    <li><a href="#時區和日光節約時間">時區和日光節約時間</a></li>
    <li><a href="#描述日期與時間的數量">描述日期與時間的數量</a></li>
  </ul>

  <ul>
    <li><a href="#認識標註型別">認識標註型別</a></li>
    <li><a href="#建立自定義標註型別">建立自定義標註型別</a></li>
    <li><a href="#標註型別的應用">標註型別的應用</a></li>
    <li><a href="#自定義標註型別時使用的內建標註型別">自定義標註型別時使用的內建標註型別</a></li>
    <li><a href="#開發一般程式碼經常使用的內建標註型別">開發一般程式碼經常使用的內建標註型別</a></li>
  </ul>

  <ul>
    <li><a href="#認識-java-模組化">認識 Java 模組化</a></li>
    <li><a href="#建立和執行模組化程式">建立和執行模組化程式</a></li>
    <li><a href="#建立相依模組程式">建立相依模組程式</a></li>
    <li><a href="#認識-module-infojava-的宣告關鍵字">認識 <code>module-info.java</code> 的宣告關鍵字</a></li>
    <li><a href="#在命令列-command-line-使用模組指令選項">在命令列 <code>command line</code> 使用模組指令選項</a></li>
  </ul>

  <ul>
    <li><a href="#回顧模組指令">回顧模組指令</a></li>
    <li><a href="#比較模組類型">比較模組類型</a></li>
    <li><a href="#分析-jdk-依賴關係">分析 JDK 依賴關係</a></li>
    <li><a href="#模組化既有應用程式">模組化既有應用程式</a></li>
    <li><a href="#模組化-java-服務結構">模組化 Java 服務結構</a></li>
  </ul>

  <ul>
    <li><a href="#設計安全物件">設計安全物件</a></li>
    <li><a href="#注入-injection-攻擊與輸入-input-驗證">注入 <em>injection</em> 攻擊與輸入 <em>input</em> 驗證</a></li>
    <li><a href="#處理機敏資訊">處理機敏資訊</a></li>
    <li><a href="#序列化與反序列化物件">序列化與反序列化物件</a></li>
    <li><a href="#建立保護機敏資料的安全物件">建立保護機敏資料的安全物件</a></li>
    <li><a href="#避免服務阻斷-denial-of-service-攻擊">避免服務阻斷 <em>denial of service</em> 攻擊</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><pre><code># 01 泛型和集合物件
</code></pre>
<h2 id="泛型">泛型</h2>
<p>Java 5 之後加入泛型，使型別使用多了另一種彈性。</p>
<p>集合物件（用來裝填物件）＋泛型，可以限制裝填物件的型別。</p>
<h3 id="使用泛型的效益">使用泛型的效益</h3>
<ol>
<li>提供更彈性的「型別安全 type safety」檢查機制，原本在執行時才能發現的型別錯誤，現在在編譯時期就可以預發現</li>
<li>在集合物件 Collections 裡大量使用，限制內涵物件之型別</li>
<li>減少轉型 casting 需要，使程式碼更簡潔</li>
</ol>
<h3 id="使用泛型設計類別">使用泛型設計類別</h3>
<ul>
<li>可以將程式碼裡的符號 <code>T</code>換成 <code>String</code>( 即 UseString())，或換成 <code>Shirt</code> (即 UseShirt())</li>
<li>常見的符號及表示方式如下：
<ol>
<li><strong>T</strong> -「型別（type）」</li>
<li><strong>E</strong> -「成員（element）」</li>
<li><strong>K</strong> -「鍵 - 值對裡的鍵（key）」</li>
<li><strong>V</strong> -「鍵 - 值對裡的值（value）」</li>
</ol>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UseAny</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> T t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>T t<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> T <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">t</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UseString</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String message<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">message</span> <span style="color:#f92672">=</span> message<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">message</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UseShirt</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Shirt shirt<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Shirt shirt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">shirt</span> <span style="color:#f92672">=</span> shirt<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Shirt <span style="color:#a6e22e">get</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">shirt</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p>Java 7 開始，取消「參考型別」和「建構子」都必須在&lt;&gt;符號內加上置換型別的規定，因為等號右側可以由前者推斷（inference）而知其型別</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UseAny<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> shirt2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UseAny<span style="color:#f92672">&lt;</span>Shirt<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span>UseAny<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> msg2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UseAny<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// see below for simplified code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>UseAny<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> shirt2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UseAny<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>UseAny<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> msg2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> UseAny<span style="color:#f92672">&lt;&gt;();</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="集合物件">集合物件</h2>
<h3 id="collection-定義與種類">Collection 定義與種類</h3>
<p>集合物件 <em>Collection</em> 相較陣列具備更多管理功能：</p>
<ol>
<li>以 interface Collection 為代表</li>
<li>集合內物件 <code>elements</code>，簡寫為 <code>E</code></li>
<li>集合內物件必須為參考型別或基本型別的包裹類別 <em>wrapper class</em></li>
<li>有多種常見資料結構，例如 <code>stack</code>、<code>queue</code>、<code>dynamic array</code> 等</li>
<li>大量使用泛型 <code>generic</code></li>
<li>都屬於 <code>java.util.*</code> package</li>
<li>interface Collection 繼承了 interface Iterable，因此所有集合物件都具備使用 Iterator (疊代器) 的能力</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/Dm02pU2.png"
        data-srcset="https://i.imgur.com/Dm02pU2.png, https://i.imgur.com/Dm02pU2.png 1.5x, https://i.imgur.com/Dm02pU2.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/Dm02pU2.png"
        title="image-20221214143907275" /></p>
<h3 id="list">List</h3>
<p>集合物件底下最常使用的介面，具備 index 能依照放入先後區分順序 <em>order</em></p>
<ol>
<li>新增 element，使用 index 指定插入位置</li>
<li>新增 element，直接加到尾端</li>
<li>取得 element index</li>
<li>使用 index 移除或覆寫成員</li>
<li>取得 List 長度</li>
</ol>
<h3 id="arraylist--list-最常使用的一種實作類別"><code>ArrayList</code> : List 最常使用的一種實作類別</h3>
<ul>
<li>特色：
<ol>
<li>行為和陣列 <em>array</em> 相近，但長度可以自動成長，又稱為「動態陣列」(dynamic array)</li>
<li>使用 index 新增 / 存取 / 修改 element</li>
<li>可以用 index 區分，所以允許重複成員</li>
</ol>
</li>
<li>未搭配泛型設計的 List
<ol>
<li>使用 Iterator 取出的物件必須轉型</li>
<li>錯放成員時，在執行時期才能知道 (e.g. add Integer, add Integer, and then add String)</li>
</ol>
</li>
</ul>
<h3 id="自動裝箱-boxing和開箱-unboxing">自動裝箱 <code>Boxing</code>和開箱 <code>Unboxing</code></h3>
<ol>
<li>
<p>Primitive → Wrapper Class : 把基本型別裝箱 <em>Boxing</em></p>
</li>
<li>
<p>Wrapper Class → Primitive : 將基本型別由包裹類別的箱子裡取出，開箱 <em>Unboxing</em></p>
</li>
<li>
<p>在迴圈內使用 boxing / unboxing 會讓效能耗損增幅</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Integer partNumObj <span style="color:#f92672">=</span> elements<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> partNum <span style="color:#f92672">=</span> partNumObj<span style="color:#f92672">.</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// see below for concised code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> partNum <span style="color:#f92672">=</span> elements<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="set">Set</h3>
<ol>
<li>
<p>其成員 element 必須為獨一無二（unique），不能重複</p>
</li>
<li>
<p>沒有 index</p>
</li>
<li>
<p>若放入重複 element，不會出錯，但無效</p>
</li>
<li>
<p>常使用 <code>HashSet</code> 實作類別。<code>TreeSet</code> 類別會依物件特性自動排序</p>
</li>
<li>
<p>element 是否唯一，或是排序先後，取決於方法 <code>equals()</code> 和 <code>hashCode()</code> 的覆寫結果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestSet</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testHashSet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> set <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;uno&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deux&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trois&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trois&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String s <span style="color:#f92672">:</span> set<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;item: &#34;</span> <span style="color:#f92672">+</span> s<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// only prints &#34;trois&#34; once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">testTreeSet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> set <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TreeSet<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;uno&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;deux&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trois&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;trois&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;turban&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String s <span style="color:#f92672">:</span> set<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;item: &#34;</span> <span style="color:#f92672">+</span> s<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// only prints &#34;trois&#34; once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// print by String alphabetical order: d, tr-, tu-, u
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="deque-queue">Deque (Queue)</h3>
<p>Interface Deque 繼承了介面 Queue，特色如下：</p>
<ol>
<li>
<p><strong>Double-Ended Queue</strong> : 具備兩端點的 Queue</p>
</li>
<li>
<p>可同時使用於 Stack 和 Queue 兩種資料結構，只要呼叫不同方法</p>
<ul>
<li>使用<code>add()</code>、<code>remove()</code>時：Deque 物件表現出 Queue 資料結構的行為 (FIFO)</li>
<li>使用<code>push()</code>、<code>pop()</code>時：Deque 物件表現出 Stack 資料結構的行為 (FILO)<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/U7FO4qK.png"
        data-srcset="https://i.imgur.com/U7FO4qK.png, https://i.imgur.com/U7FO4qK.png 1.5x, https://i.imgur.com/U7FO4qK.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/U7FO4qK.png"
        title="image-20221214161745531" /></li>
</ul>
</li>
<li>
<p><code>Deque&lt;String&gt; deque = new ArrayDeque&lt;&gt;(); </code></p>
</li>
</ol>
<h2 id="map">Map</h2>
<ul>
<li>
<p>Map 是 key - value 成對集合，但不屬於 Collection 集合物件家族</p>
<ol>
<li><strong>key 物件</strong> : 用來尋找 value 物件，每個 key 物件須為獨特而不重複的</li>
<li><strong>value 物件</strong> : 和 key 物件有關連性（associative）</li>
</ol>
</li>
<li>
<p>在其它語言中，Map 又稱「關聯性陣列 associative arrays」，key 可構成一陣列，value 可構成另一個陣列，兩陣列有著關聯性</p>
</li>
<li>
<p>Map 泛型 &lt;<code>K</code>, <code>V</code>&gt;</p>
</li>
<li>
<p>Map 基本用法</p>
<ul>
<li><code>map.values()</code> 取得 <code>Collection&lt;T of V&gt;</code></li>
<li><code>map.keySet()</code> 取得 <code>Set&lt;T of K&gt;</code> (因為 keys 不能重複，回傳 Set 而非 Collection)</li>
</ul>
</li>
<li>
<p>Map 並未繼承於 Collection interface，Map family 如下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/talB7Y5.png"
        data-srcset="https://i.imgur.com/talB7Y5.png, https://i.imgur.com/talB7Y5.png 1.5x, https://i.imgur.com/talB7Y5.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/talB7Y5.png"
        title="image-20221214165500408" /></p>
</li>
<li>
<p>Map family 常用類別：</p>
<ol>
<li>
<p><strong>TreeMap</strong> : keys 自動依順序排序</p>
</li>
<li>
<p><strong>HashTable</strong> : <em>執行緒安全</em>，且 <em>keys 和 values 不允許為 null</em></p>
</li>
<li>
<p><strong>HashMap</strong> : <em><strong>非</strong>執行緒安全</em>，且 <em>keys 和 values <strong>可</strong>為 null</em></p>
<blockquote>
<p>執行緒安全 :</p>
<p>一個物件被一個執行緒使用和同時被多個執行緒使用時，行為或結果都一致，不會產生非預期結果</p>
</blockquote>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>LittleTips</strong> : <code>Set</code> 和 <code>Map</code> 兩者都有可以支援排序的分支</p>
<ol>
<li>支援排序的分支起源皆以 <code>Sorted</code> 作為前綴。例：<strong>Sorted</strong>Map 、 <strong>Sorted</strong>Set (interface)</li>
<li>實作類別都是以 <code>Tree</code> 為開頭。例：<strong>Tree</strong>Map 、 <strong>Tree</strong>Set</li>
</ol>
</blockquote>
<h2 id="集合物件成員的排序">集合物件成員的排序</h2>
<h3 id="排序作法">排序作法</h3>
<p>如何排序物件類別，如何定義順序，一個類別可以定義多個排序標準嗎？有以下兩個介面可選擇</p>
<ol>
<li>Comparable 介面 - 實作 <code>compareTo()</code> 方法</li>
<li>Comparator 介面 - 實作 <code>compare()</code> 方法</li>
</ol>
<p>兩種方法都回傳一個整數，表示比較結果：</p>
<ol>
<li>回傳整數 <code>= 0</code>：兩者相等</li>
<li>回傳整數 <code>&lt; 0</code>：表示「自己（this）」**小於（數值上）**或 <strong>先於（順序上）</strong>「方法參數物件」</li>
<li>回傳整數 <code>&gt; 0</code>：表示「自己（this）」**大於（數值上）**或 <strong>後於（順序上）</strong>「方法參數物件」</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Calendar today <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>Calendar tomorrow <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>tomorrow<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>today<span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>tomorrow<span style="color:#f92672">));</span>   <span style="color:#75715e">// 字串 today 先於 tomorrow，所以回傳-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">));</span>          <span style="color:#75715e">// 字串&#34;A&#34;早於字串&#34;B&#34;，所以回傳-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>5<span style="color:#f92672">).</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>6<span style="color:#f92672">)));</span>
</span></span></code></pre></div><h3 id="使用-comparable-介面排序">使用 <code>Comparable</code> 介面排序</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Comparable</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>T o<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>特色：</p>
<ol>
<li>
<p>支援泛型設計</p>
</li>
<li>
<p>必須實作 <code>compareTo()</code> 方法，比較自己（this）和方法參數物件</p>
</li>
<li>
<p>一個 class 只能實作一次 Comparable 介面，所以只能提供單一方式排序，可用於 <code>TreeSet</code> 和 <code>TreeMap</code> 等實作類別，或需要物件之間比較的地方</p>
</li>
<li>
<p>決定該物件類別要以哪一個條件決定 Student 物件的排序先後，再讓該類別實作 Comparable 介面</p>
<ol>
<li>必須提供 <code>compareTo()</code> 方法的內容</li>
<li>只能提供一種排序選擇</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Student</span> <span style="color:#66d9ef">implements</span> Comparable<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>Student s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// use method delegation 方法委派 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> sortById <span style="color:#f92672">=</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span><span style="color:#f92672">).</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">id</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> sortByName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> sortByScome <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">score</span><span style="color:#f92672">).</span><span style="color:#a6e22e">compareTO</span><span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">score</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sortById<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="使用-comparator-介面排序">使用 <code>Comparator</code> 介面排序</h3>
<ul>
<li>
<p>實作 <code>Comparable</code> interface 的類別只有提供一次 <code>compareTo()</code> 方法內容的機會，故只有一種排序能力</p>
</li>
<li>
<p>使用 <code>Comparator</code> interface 則可以提供多種選擇</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Comparator</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span><span style="color:#f92672">(</span>T o1<span style="color:#f92672">,</span> T o2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>特色：</p>
<ol>
<li>
<p>支援泛型設計</p>
</li>
<li>
<p>需實作 <code>compare()</code>，用以比較「第一個參數物件」和「第二個參數物件」</p>
</li>
<li>
<p>可藉由提供多種 Comparator 類別，達成多種排序方式。</p>
<ul>
<li>
<p>常用於搭配以下方法，以幫助 List 成員排序</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> list<span style="color:#f92672">,</span> Comparator<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T<span style="color:#f92672">&gt;</span> c<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    list<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>c<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NameSorter</span> <span style="color:#66d9ef">implements</span> Comparator<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span><span style="color:#f92672">(</span>Student s1<span style="color:#f92672">,</span> Student s2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> s1<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>s2<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScoreSorter</span> <span style="color:#66d9ef">implements</span> Comparator<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span><span style="color:#f92672">(</span>Student s1<span style="color:#f92672">,</span> Student s2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>s1<span style="color:#f92672">.</span><span style="color:#a6e22e">getScore</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>s2<span style="color:#f92672">.</span><span style="color:#a6e22e">getScore</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestComparator</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">showList</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> studentList<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> studentList<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;index#&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> studentList<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> studentList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>3<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        studentList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Student<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thomas&#34;</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">,</span> 3<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">));</span> 
</span></span><span style="display:flex;"><span>        studentList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Student<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;John&#34;</span><span style="color:#f92672">,</span> 2<span style="color:#f92672">,</span> 3<span style="color:#f92672">.</span><span style="color:#a6e22e">9</span><span style="color:#f92672">));</span> 
</span></span><span style="display:flex;"><span>        studentList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Student<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;George&#34;</span><span style="color:#f92672">,</span> 3<span style="color:#f92672">,</span> 3<span style="color:#f92672">.</span><span style="color:#a6e22e">4</span><span style="color:#f92672">));</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n------ Original ------&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        showList<span style="color:#f92672">(</span>studentList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n----- Sort by name -----&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Comparator<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> sortName <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NameSorter<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>studentList<span style="color:#f92672">,</span> sortName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        showList<span style="color:#f92672">(</span>studentList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n----- Sort by score -----&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Comparator<span style="color:#f92672">&lt;</span>Student<span style="color:#f92672">&gt;</span> sortScore <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ScoreSorter<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>studentList<span style="color:#f92672">,</span> sortScore<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        showList<span style="color:#f92672">(</span>studentList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="使用-of-與-copyof-方法建立-listset-與-map-物件">使用 <code>of()</code> 與 <code>copyOf()</code> 方法建立 <code>List</code>、<code>Set</code> 與 <code>Map</code> 物件</h2>
<h3 id="使用of方法建立-list-set-map-物件">使用<code>of()</code>方法建立 List, Set, Map 物件</h3>
<ul>
<li>
<p>自 Java 9 開始，除了傳統使用 new 呼叫子類別建構子以建立 List, Set, Map 物件外</p>
<ul>
<li>
<p>導入靜態工廠方法 <code>of()</code> 來建立不可改變（immutable）的物件</p>
<ul>
<li>
<p><code>List.of()</code> | <code>Set.of()</code> | <code>Map.of()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> List<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>t1<span style="color:#f92672">,</span> t2<span style="color:#f92672">,</span> <span style="color:#f92672">...);</span>
</span></span><span style="display:flex;"><span>Set<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> set <span style="color:#f92672">=</span> Set<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>t1<span style="color:#f92672">,</span> t2<span style="color:#f92672">,</span> <span style="color:#f92672">...);</span>
</span></span><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> Map<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>key1<span style="color:#f92672">,</span> value1<span style="color:#f92672">,</span> key2<span style="color:#f92672">,</span> value2<span style="color:#f92672">,</span> <span style="color:#f92672">...);</span>
</span></span></code></pre></div></li>
<li>
<p>line 5, 15, 26 : 以 <code>of()</code> 建立物件後，若再嘗試新增成員（<code>list.add(...)</code>、<code>set.add(...)</code>、<code>map.put(...)</code>），都會拋出 <em><strong>java.lang.UnsupportOperationException</strong></em></p>
</li>
<li>
<p>line 9, 19, 30 : 如果要將不可更改的物件轉換為可更改物件，可將其作為 <code>ArrayList</code>、<code>HashSet</code>、<code>HashMap</code> 等建構子的參數，重新建立可更改物件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createImmutablesByOf</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// List.of()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list1 <span style="color:#f92672">=</span> List<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i3&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        list1<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i4&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// line 5 : UnsupportedException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>list1<span style="color:#f92672">);</span>  <span style="color:#75715e">// line 9 : mutable w/ ArrayList
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    list2<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i4&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>list2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set.of()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> set1 <span style="color:#f92672">=</span> Set<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i3&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        set1<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i4&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// line 15 : UnsupportedException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> set2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;(</span>set1<span style="color:#f92672">);</span>  <span style="color:#75715e">// line 19 : mutable w/ HashSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    set2<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i4&#34;</span><span style="color:#f92672">);</span>  
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>set2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Map.of()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Employee<span style="color:#f92672">&gt;</span> map1 <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            Map<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jim&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jim&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;duke&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;duke&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        map1<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bill&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bill&#34;</span><span style="color:#f92672">));</span> <span style="color:#75715e">// line 26 : UnsupportedException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Employee<span style="color:#f92672">&gt;</span> map2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;(</span>map1<span style="color:#f92672">);</span>  <span style="color:#75715e">// line 30 : mutable w/ HashMap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    map2<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bill&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bill&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>map2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="使用copyof方法建立-list-set-map-物件">使用<code>copyOf()</code>方法建立 List, Set, Map 物件</h3>
<ul>
<li>
<p>從 Java 10 開始，又導入另一個靜態工廠方法 <code>copyOf()</code>，可以建立「<strong>不可改變</strong>」的「<strong>副本物件</strong>」</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createImmutablesByCopyOf</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// List.copyOf()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list1 <span style="color:#f92672">=</span> List<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i3&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list2 <span style="color:#f92672">=</span> List<span style="color:#f92672">.</span><span style="color:#a6e22e">copyOf</span><span style="color:#f92672">(</span>list1<span style="color:#f92672">);</span>     <span style="color:#75715e">// immutable copy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        list2<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i4&#34;</span><span style="color:#f92672">);</span>     <span style="color:#75715e">// UnsupportedOperationException 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set.copyOf()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> set1 <span style="color:#f92672">=</span> Set<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i3&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> set2 <span style="color:#f92672">=</span> Set<span style="color:#f92672">.</span><span style="color:#a6e22e">copyOf</span><span style="color:#f92672">(</span>set1<span style="color:#f92672">);</span>     <span style="color:#75715e">// immutable copy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        set2<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i4&#34;</span><span style="color:#f92672">);</span>     <span style="color:#75715e">// UnsupportedOperationException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Map.copyOf()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Employee<span style="color:#f92672">&gt;</span> map1 <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            Map<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jim&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jim&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;duke&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;duke&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Employee<span style="color:#f92672">&gt;</span> map2 <span style="color:#f92672">=</span> Map<span style="color:#f92672">.</span><span style="color:#a6e22e">copyOf</span><span style="color:#f92672">(</span>map1<span style="color:#f92672">);</span>     <span style="color:#75715e">// immutable copy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        map2<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bill&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Employee<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bill&#34;</span><span style="color:#f92672">));</span>     <span style="color:#75715e">// UnsupportedOperationException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="使用-arraysaslist建立-list-物件">使用 <code>Arrays.asList()</code>建立 List 物件</h3>
<p>List 另一種以「單個元素成員」作為參數建立 List 物件的方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span>t1<span style="color:#f92672">,</span> t2<span style="color:#f92672">,</span> <span style="color:#f92672">...);</span>
</span></span></code></pre></div><p>使用 <code>Arrays.asList()</code> 建立的 List 物件和陣列（Array）相似，特性：</p>
<ol>
<li>
<p>長度固定，不可以新增/刪除成員（參考 line 6）</p>
</li>
<li>
<p>可以修改成員（參考 line 4）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">createList</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list1 <span style="color:#f92672">=</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i2&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;i3&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        list1<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;iil&#34;</span><span style="color:#f92672">);</span>    <span style="color:#75715e">// line 4 : element updatable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>list1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        list1<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>        <span style="color:#75715e">// line 6 : removing or adding not permitted
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>list1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    list2<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>list2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
<hr>
<h1 id="02-例外與斷言">02 例外與斷言</h1>
<h2 id="例外">例外</h2>
<p>值得信賴的程式會優雅的處理例外狀況：</p>
<ol>
<li>處理目標是「exception（例外）」，非預期狀況</li>
<li>例外必須處理以建立可信賴的程式</li>
<li>發生原因可能是程式 bugs</li>
<li>發生原因可能是程式無法處理的狀況
<ul>
<li>資料庫無法連線</li>
<li>硬碟毀損</li>
</ul>
</li>
</ol>
<p>C語言發生錯誤的話，通常以<strong>回傳負值</strong>表示，例如 <code>int x = printf(&quot;hi&quot;)</code></p>
<p>Java 則在出現錯誤時，由 JVM 拋出例外物件，不同種類的例外，有不同處理方式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/BHInvNP.png"
        data-srcset="https://i.imgur.com/BHInvNP.png, https://i.imgur.com/BHInvNP.png 1.5x, https://i.imgur.com/BHInvNP.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/BHInvNP.png"
        title="image-20221215142633549" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/xYQBNxF.png"
        data-srcset="https://i.imgur.com/xYQBNxF.png, https://i.imgur.com/xYQBNxF.png 1.5x, https://i.imgur.com/xYQBNxF.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/xYQBNxF.png"
        title="image-20221215160311402" /></p>
<ul>
<li>當類別方法呼叫其他類別方法時，如果被呼叫的方法已宣告有拋出 <strong>checked exception</strong> 的風險，編譯器會要求呼叫者方法必須處理（handle）或是也宣告（declare）可能發生的問題：
<ol>
<li><strong>Handling Exception</strong>：表示必須有程式碼區塊來處理異常狀況，此時使用「try-catch」敘述</li>
<li><strong>Declaring Exception</strong>：在方法上註記執行可能出現的錯誤，提醒使用的方法必須處理，此時使用「throws」宣告</li>
</ol>
</li>
</ul>
<h3 id="使用try-catch程式碼區塊">使用<code>try-catch</code>程式碼區塊</h3>
<h4 id="一般例外狀況">一般例外狀況</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryCatchTest</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Opening a file...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        InputStream in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lostFile.txt&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;File is opened&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p><code>catch</code>程式碼區塊必須傳入 <code>java.lang.Exception</code> 或 <code>java.lang.Throwable</code> 的子類別參考</p>
</li>
<li>
<p>其中<code>java.lang.Throwable</code> 是例外始祖，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>把 catch 當成一種方法，則後面的 () 代表要傳入的參數</p>
</li>
<li>
<p>傳入大分類的型別（父類別或介面）為多型的應用，但不適用於此，例外處理應該對症下藥</p>
</li>
<li>
<p>catch 方法只讓 Java 在程式遇到錯誤時呼叫 / 傳入例外物件</p>
</li>
<li>
<p>捕捉例外後：</p>
<ol>
<li>紀錄錯誤訊息</li>
<li>重試一次</li>
<li>嘗試其它替代方案</li>
<li>離開（return）或結束程式（exit）</li>
</ol>
</li>
</ul>
<h4 id="複雜例外狀況">複雜例外狀況</h4>
<ul>
<li>
<p>一個程式碼區塊 / 方法，必須同時處理多種可能的例外狀況：</p>
<ol>
<li>
<p>單一「try」搭配多個「catch」：例外子類別排序應該在父類別上面，避免所有例外一開始就被例外父類別（Exception, Throwable）攔截</p>
</li>
<li>
<p>捕捉（catch）物件 Exception 時，盡可能捕捉最特定（specific type）的例外子類別</p>
</li>
<li>
<p>Java Persistence API（JPA）例外大部分繼承 RuntimeException，屬 unchecked exception</p>
<ul>
<li>
<p>慣例上為不用處理的意外，但正式環境裡還是應該處理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryCatch</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Opening a file...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        InputStream in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lostFile.txt&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;File is opened&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> data <span style="color:#f92672">=</span> in<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        in<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="紀錄logging錯誤內容">紀錄（Logging）錯誤內容</h4>
<ul>
<li>正式環境中，應移除 <code>printStackTrace()</code> 或 <code>System.out.println(e.getMessage())</code>此類程式碼</li>
<li>執行錯誤時，應該寫入紀錄 / 日誌檔（log file），相關函式庫
<ol>
<li>Simple logging facade for Java SLF4J</li>
<li>Apache&rsquo;s Log4j</li>
<li>Built-in java.util logging framework</li>
</ol>
</li>
</ul>
<h4 id="使用finally敘述">使用<code>finally</code>敘述</h4>
<ul>
<li>
<p>使用外部資源，例如開啟檔案或連線資料庫，應該在不使用時關閉資源</p>
</li>
<li>
<p>如果在 try 區塊中關閉資源，可能因為執行錯誤而導致資源開了來不及關，此時可用 finally 敘述</p>
<ol>
<li>
<p>不管是 try 或者 catch 執行結束，都一定會進入 finally 程式碼區塊</p>
</li>
<li>
<p>有時在 finally 區的程式碼也可能出錯，因此需要巢狀 try-catch 區塊來處理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryCatchFinally</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    InputStream in <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Opening a file...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lostFile.txt&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;File is opened&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> data <span style="color:#f92672">=</span> in<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        in<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>in <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                in<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>   <span style="color:#75715e">// try to close file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to close file&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ul>
<h3 id="使用-try-with-resources-程式碼區塊和-autocloseable-介面">使用 <code>try-with-resources</code> 程式碼區塊和 <code>AutoCloseable</code> 介面</h3>
<h4 id="使用-try-with-resources-敘述">使用 <code>try-with-resources</code> 敘述</h4>
<ul>
<li>
<p>Java 7 提供新的 <code>try-with-resources</code> 敘述，可自動關閉被開啟的「資源（resources）」</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span> 宣告並開啟資源 <span style="color:#f92672">[;</span> 宣告並開啟其它資源 <span style="color:#f92672">...]</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在 try 程式碼區塊之後，資源將自動關閉
</span></span></span></code></pre></div><ol>
<li>
<p>這裡定義的資源，必須為實作 <code>java.lang.AutoCloseable</code> 介面的類別</p>
</li>
<li>
<p>如果要開多個資源，可以使用「<strong>;</strong>」做區隔</p>
</li>
<li>
<p>自動關閉的順序將和使用資源的開啟順序相反</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryWithResource</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Opening a file...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>InputStream in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lostFile.txt&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;File is opened&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> data <span style="color:#f92672">=</span> in<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        in<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ul>
<p>比較 <code>tryCatchFinally</code> 與 <code>tryWithResource</code>，可以發現：</p>
<ol>
<li>移除 <code>finally</code> 程式碼區塊，如前範例行 16 - 23</li>
<li>使用 <code>try-with-resource</code> 宣告要開啟的資源</li>
</ol>
<h4 id="認識-autocloseable介面">認識 <code>AutoCloseable</code>介面</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InputStream</span> <span style="color:#66d9ef">implements</span> Closeable <span style="color:#f92672">{</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Closeable</span> <span style="color:#66d9ef">extends</span> AutoCloseable <span style="color:#f92672">{</span>
</span></span></code></pre></div><ul>
<li>
<p>資源（resource）要藉由 `try-with-resources‵ 敘述開啟和自動關閉，必須實作以下兩者任一</p>
<ol>
<li>
<p>介面 <em>java.lang.AutoCloseable</em></p>
<ul>
<li>
<p>Java 7 新增</p>
</li>
<li>
<p>唯一的抽象方法 <code>close()</code> 會拋出 Exception 物件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">AutoCloseable</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>介面 <em>java.io.Closeable</em></p>
<ul>
<li>
<p>早期的 Java 版本就存在，在 Java 7 中修改使其繼承介面 <code>AutoCloseable</code></p>
</li>
<li>
<p>唯一的抽象方法 <code>close()</code> 會拋出 <code>IOException</code> 物件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Closeable</span> <span style="color:#66d9ef">extends</span> AutoCloseable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
</li>
</ul>
<p><strong>Idempotent method</strong> - 即使重複執行多次，也不會有副作用（side effects）產生</p>
<ul>
<li>
<p><code>java.io.Closeable</code> 的 close() 方法必須滿足 idempotent 要求</p>
</li>
<li>
<p><code>java.lang.AutoCloseable</code> 並未一致要求實作之 close() 必須比照辦理</p>
<ul>
<li>
<p>即便如此仍應該要做到反覆執行多次都沒有副作用產生</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 若資源為關閉（以resource == null 判定）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>If <span style="color:#f92672">(</span>resource <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 關閉資源，並使 resource = null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="suppressed-exceptions">Suppressed Exceptions</h3>
<p>使用 try-with-resource 也衍伸出新的例外 exception 處理問題必須注意：</p>
<ol>
<li>Java 開啟資源時拋出例外，未成功開啟資源
<ul>
<li>程式碼直接跳到 catch 區，只拋出一個例外</li>
</ul>
</li>
<li>Java 成功開啟資源，但在 try 區拋出例外，在背景關閉資源時又拋出例外
<ul>
<li>共產生 2 個例外</li>
<li>catch 區必須同時接收 2 個例外物件 <strong>衍伸問題</strong></li>
</ul>
</li>
<li>Java 成功開啟資源，try 區塊內任務成功執行，但在關閉資源時出錯
<ul>
<li>和一般情況一樣，只拋出 1 個例外</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>當有兩個例外類別被先後拋出，Java會將 <strong>後發生，同時和關閉資源有關</strong> 的例外物件，隱匿/擠壓（suppressed）到「先發生、也是在 try 區塊造成」的例外物件裡，使其可被保留</p>
</li>
<li>
<p>Java 會將資源相關的例外隱匿 / 擠壓進程式碼的例外裡，只要知道如何將 suppressed 例外物件取出（參以下 line 3 ~ line 5）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Throwable t <span style="color:#f92672">:</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuppressed</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">// line 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>t<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>                                        <span style="color:#75715e">// line 5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>對例外物件呼叫 <code>e.getSuppressed()</code> 方法時，可回傳一個 Throwable 陣列</p>
<ul>
<li>在背景被擠壓 / 隱匿的例外，即使再多都能被保存並取出</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TryException</span> <span style="color:#66d9ef">extends</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FinallyException</span> <span style="color:#66d9ef">extends</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SuppressedExceptions</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        before7<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        after7<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">before7</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TryException<span style="color:#f92672">();</span>   <span style="color:#75715e">// This is lost.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> FinallyException<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;before 7: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">after7</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Throwable t <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span> <span style="color:#75715e">// 保留第一個拋出的例外物件 TryException (1/2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TryException<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                t <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>  <span style="color:#75715e">// 保留第一個拋出的例外物件 TryException (2/2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                FinallyException fe <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FinallyException<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>t <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    t<span style="color:#f92672">.</span><span style="color:#a6e22e">addSuppressed</span><span style="color:#f92672">(</span>fe<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 將 finallyException 隱匿至 t, 再拋出 tryException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">throw</span> t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">throw</span> fe<span style="color:#f92672">;</span> <span style="color:#75715e">// 若無 tryException, 單獨拋出 finallyException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;after7: &#34;</span> <span style="color:#f92672">+</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Throwable t <span style="color:#f92672">:</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuppressed</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;after7: &#34;</span> <span style="color:#f92672">+</span> t<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="使用-multi-catch-敘述">使用 <code>multi-catch</code> 敘述</h3>
<p>不建議直接捕捉例外的父類別，如 Exception 或 Throwable，因為：</p>
<ol>
<li>每種意外的處理方式應該不同</li>
<li>要清楚知道究竟有多少個例外可能產生</li>
</ol>
<p>如果每種例外處理方式皆相同，則可以使用 Java 7 <code>multi-catch</code> 敘述，優點：</p>
<ol>
<li>可清楚知道究竟有多少例外可能拋出</li>
<li>多種例外，同一種方式處理，簡潔化程式碼</li>
<li><strong>不同例外以「|」區隔時，前後例外必須「沒有繼承關係」</strong>
<ul>
<li>例如 Exception class 不能和以 multi-catch 敘述聚集的例外類別放一起</li>
</ul>
</li>
</ol>
<h3 id="使用-throws-宣告">使用 <code>throws</code> 宣告</h3>
<ul>
<li>
<p>在類別方法上宣告 <code>throws ExceptionTypes</code>，讓呼叫該方法的 caller 處理</p>
</li>
<li>
<p>覆寫子類別方法時，若父類別方法宣告拋出例外</p>
<ol>
<li>
<p><strong>checked exception</strong>，子類別覆寫方法拋出的例外必須：</p>
<ul>
<li>例外型別必須相同，或者為其子類別（覆寫後有精進）</li>
<li>數量相同或更少（表示問題已被處理 improved）</li>
</ul>
</li>
<li>
<p><strong>unchecked exception</strong>：子類別覆寫方法時可不予理會，例如 <code>RuntimeException</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Father</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fatherMethod1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fatherMethod2</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> RuntimeException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fatherMethod3</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SQLException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Child</span> <span style="color:#66d9ef">extends</span> Father <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fatherMethod1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> FileNotFoundException <span style="color:#f92672">{</span>		
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>  <span style="color:#75715e">// FileNotFoundException 為 IOException 子類別，未超出 IOException 範圍
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fatherMethod2</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span> <span style="color:#75715e">// 父類別 RuntimeException-UncheckException，子類別可以不處理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fatherMethod3</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>		
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span> <span style="color:#75715e">// SQLException 在方法內使用 try-catch 敘述，妥善處理不再拋出例外
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ul>
<h3 id="建立客製的-exception">建立客製的 <code>Exception</code></h3>
<h4 id="客製化的例外類別">客製化的例外類別</h4>
<p>建立客製化的例外子類別 DAOException，繼承 class Exception</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DAOException</span> <span style="color:#66d9ef">extends</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DAOException</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DAOException</span><span style="color:#f92672">(</span>String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>message<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p>標準 Java 不會主動拋出客製化例外子類別，必須先捕捉標準的例外類別，再拋出客製化例外子類別</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// some codes that might cause error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> DAOException<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="客製化包裹例外類別wrapper-exception">客製化包裹例外類別（Wrapper Exception）</h4>
<ul>
<li>
<p>如果希望再拋出的客製化例外子類別也能保留最初被捕捉的例外類別訊息，可使用 wrapper 例外類別，將最初的例外類別包裹在客製例外類別中</p>
<ul>
<li>
<p>設計客製例外類別</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DAOException</span> <span style="color:#66d9ef">extends</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DAOException</span><span style="color:#f92672">(</span>Throwable cause<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>cause<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DAOException</span><span style="color:#f92672">(</span>String msg<span style="color:#f92672">,</span> Throwable cause<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">,</span> cause<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>將捕捉真實例外類別作為客製例外類別的建構子參數</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// some codes might error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> DAOException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>使用 <code>getCause()</code> 方法取出被包裹的原始例外物件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// some codes might cause error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>DAOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Throwable t <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">getCause</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>使用包裹例外型別提供解決範例</p>
<ol>
<li>
<p>先設計介面的抽象方法並宣告拋出 <code>DAOException</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span>Employee <span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> DAOException<span style="color:#f92672">;</span>
</span></span></code></pre></div></li>
<li>
<p>File-based 的方法實作方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Employee <span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> DAOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> DAOException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>JDBC-based 的方法實作方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Employee <span style="color:#a6e22e">findById</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> DAOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> getEmployeeFromDatabase<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>SQLException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> DAOException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="斷言">斷言</h2>
<h3 id="assertions-的簡介和語法">Assertions 的簡介和語法</h3>
<ul>
<li>斷言若失敗被認為是嚴重的問題，表示程式執行結果和預期有出入</li>
<li>程式會拋出 AssertionError 並中斷程式執行，AssertionError 為 unchecked exception。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Syntax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">assert</span> <span style="color:#f92672">&lt;</span>boolean_expression<span style="color:#f92672">&gt;;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#f92672">&lt;</span>boolean_expression<span style="color:#f92672">&gt;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">&lt;</span>detail_expression<span style="color:#f92672">&gt;;</span>
</span></span></code></pre></div><ol>
<li>&lt;boolean_expression&gt; 若為 false，將拋出 <code>AssertionError</code></li>
<li>&lt;detail_expression&gt; 為捕捉 <code>AssertionError</code> 後呼叫 <code>getMessage()</code> 方法回傳的子串</li>
</ol>
<h4 id="assertions-使用情境">Assertions 使用情境</h4>
<ul>
<li>使用 Assertions 來驗證假設和方法的不變量（不會改變的數值或結果，invariant），通常情況：
<ol>
<li>內部的不變量（internal invariants）</li>
<li>流程控管的不變量（control flow invariants）</li>
<li>事後的狀態和類別不變量（post-conditions &amp; class invariants）</li>
</ol>
</li>
</ul>
<h4 id="assertions-的使用注意事項">Assertions 的使用注意事項</h4>
<ul>
<li>
<p>Assertions 的檢查預設關閉（disabled），使用前必須開啟</p>
</li>
<li>
<p>要避免不當的使用方式：</p>
<ol>
<li>
<p>不可用於類別方法的參數輸入檢查</p>
</li>
<li>
<p>不可影響程式正常流程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 將物件的生成放在 assertion 的判斷敘述中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SomeType s <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> <span style="color:#f92672">(</span>s <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SomeType<span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ul>
<h3 id="assertions-的使用">Assertions 的使用</h3>
<h4 id="內部的不變量-internal-invariants">內部的不變量 <em>internal invariants</em></h4>
<ul>
<li>
<p>在 else block 加上 <code>assert == 0</code>，使 x 無負值的可能</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>x <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do if x &gt; 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> <span style="color:#f92672">(</span>x <span style="color:#f92672">==</span> 0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="流程控管的不變量-control-flow-invariants">流程控管的不變量 <em>control flow invariants</em></h4>
<ul>
<li>
<p>為始 switch case 不可能進入 default block，直接在 default block 裡使用 assert false</p>
<ul>
<li>
<p>表示程式進到此不用再以 boolean 表達式判斷，而是馬上拋出 <code>AssertError</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">controlFlowInvariants</span><span style="color:#f92672">(</span>Gender g<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>g<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> MALE<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> FEMALE<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Unknown gender!!&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h4 id="事後的狀態和類別不變量-post-conditions--class-invariants">事後的狀態和類別不變量 <em>post-conditions &amp; class invariants</em></h4>
<ul>
<li>
<p>無論類別欄位經過任何改變，都應該能通過方法 rule() 的檢驗</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyTime</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> hours<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> minutes<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> seconds<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rule</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span><span style="color:#f92672">(</span>0 <span style="color:#f92672">&lt;=</span> hours <span style="color:#f92672">&amp;&amp;</span> hours <span style="color:#f92672">&lt;</span> 24<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#f92672">(</span>0 <span style="color:#f92672">&lt;=</span> minutes <span style="color:#f92672">&amp;&amp;</span> minutes <span style="color:#f92672">&lt;</span> 60<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#f92672">(</span>0 <span style="color:#f92672">&lt;=</span> seconds <span style="color:#f92672">&amp;&amp;</span> seconds <span style="color:#f92672">&lt;</span> 60<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="assertions-的開啟與關閉">Assertions 的開啟與關閉</h4>
<ul>
<li>
<p>Assertions 預設是關閉，關閉後<strong>完全不會執行</strong>，和註解（comment）類似，不影響效能</p>
<pre tabindex="0"><code class="language-terminal" data-lang="terminal">java -enableassertions HelloWord
java -ea HelloWorld
</code></pre></li>
<li>
<p><code>-ea</code>即是 <code>-enableassertions</code>之縮寫</p>
</li>
<li>
<p>若在 <code>-ea</code> 後加上其它選項，可控制 <strong>Assertions 的啟用只在某個 package 或 class</strong></p>
<p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/language/assert.html#enable-disable" target="_blank" rel="noopener noreffer ">Enable and Disable Assertions</a></p>
</li>
</ul>
<hr>
<h1 id="03-輸入與輸出">03 輸入與輸出</h1>
<h2 id="io-基礎">I/O 基礎</h2>
<ul>
<li>當輸入/輸出行為發生時，好比串流（stream）的流動，流入或流出某個地方</li>
<li>串流需要有來源及目的，ex. 主控台視窗（console）、檔案、資料庫、網路、其它程式</li>
</ul>
<h3 id="何謂-io">何謂 I/O</h3>
<p>基本認知：</p>
<ol>
<li>資料的進出像是水流 / 串流
<ul>
<li>來源流向目的，具有方向性，Java 中稱之為 <code>stream (串流)</code></li>
<li>流動內容主要分為「位元（byte）」和「字元（character）」</li>
</ul>
</li>
<li>水流的流動，若提供管道，稱為 <code>channel</code>，若使用 <code>channel</code> 支援 I/O 會更有效率</li>
</ol>
<h4 id="以-java-程式為區分基準">以 Java 程式為區分基準</h4>
<ol>
<li>
<p>輸入串流 | 來源串流（input stream, source stream）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/hz0S8PM.png"
        data-srcset="https://i.imgur.com/hz0S8PM.png, https://i.imgur.com/hz0S8PM.png 1.5x, https://i.imgur.com/hz0S8PM.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/hz0S8PM.png"
        title="image-20221218122158764" /></p>
</li>
<li>
<p>輸出串流 | 目的串流（output stream, sink stream）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/2OgU1l1.png"
        data-srcset="https://i.imgur.com/2OgU1l1.png, https://i.imgur.com/2OgU1l1.png 1.5x, https://i.imgur.com/2OgU1l1.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/2OgU1l1.png"
        title="image-20221218122209539" /></p>
</li>
</ol>
<h4 id="以程式開發最常用三種端點區分">以程式開發最常用三種端點區分</h4>
<ol>
<li>檔案（files）和目錄（directories）</li>
<li>主控台（console）：標準輸入（standard-in）和標準輸出（standard-out）</li>
<li>Socket 程式（連線遠端系統，需指定 port 通訊）</li>
</ol>
<h3 id="處理串流的類別">處理串流的類別</h3>
<p>依串流內的資料分類、流動方向、處理類別分為四個抽象類別：</p>
<table>
<thead>
<tr>
<th>方向\串流內容</th>
<th>位元（byte）</th>
<th>字元（character）</th>
</tr>
</thead>
<tbody>
<tr>
<td>輸入 Java</td>
<td><code>InputStream</code></td>
<td><code>Reader</code></td>
</tr>
<tr>
<td>輸出 Java</td>
<td><code>OutputStream</code></td>
<td><code>Writer</code></td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-inputstream">Class <code>InputStream</code></h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>int read()</code></td>
<td>每次讀取 1 個 byte</td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer)</code></td>
<td>每次讀取一個 byte[]</td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer, int offset, int length)</code></td>
<td>每次讀取一個 byte[]，可以指定偏移量（offset）和讀取長度（length）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>int available()</code></td>
<td>有多少的 bytes 可供讀取</td>
</tr>
<tr>
<td>-</td>
<td><code>long skip(long n)</code></td>
<td>讀取時略過 n 個 <strong>bytes</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>boolean markSupported()</code><!-- raw HTML omitted --><code>void mark(int readlimit)</code><!-- raw HTML omitted --><code>void reset()</code></td>
<td>合併用於改變檔案中的讀取位置，特別是回到過去某個指定的讀取位置<!-- raw HTML omitted -->又稱 push-back 操作</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-outputstream">Class <code>OutputStream</code></h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>void write(int c)</code></td>
<td>將 int 寫入 <code>OutputStream</code></td>
</tr>
<tr>
<td>-</td>
<td><code>void write(byte[] buffer)</code></td>
<td>將 byte[] 寫入 <code>OutputStream</code></td>
</tr>
<tr>
<td>-</td>
<td><code>void write(byte[] buffer, int offset, int length)</code></td>
<td>寫入 byte[] 到 <code>OutputStream</code>，指定長度（length）和偏移量（offset）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>void flush()</code></td>
<td>強制將 <code>OutputStream</code> 中的資料寫入目的地</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-reader">Class <code>Reader</code></h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>int read()</code></td>
<td>每次讀取 1 個 <strong>char</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer)</code></td>
<td>每次讀取一個 char[]</td>
</tr>
<tr>
<td>-</td>
<td><code>int read(byte[] buffer, int offset, int length)</code></td>
<td>每次讀取一個 char[]，可以指定偏移量（offset）和讀取長度（length）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>boolean ready()</code></td>
<td>確認 stream 是否已經準備好進行資料讀取</td>
</tr>
<tr>
<td>-</td>
<td><code>long skip(long n)</code></td>
<td>讀取時略過 n 個 <strong>chars</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>boolean markSupported()</code><!-- raw HTML omitted --><code>void mark(int readAheadLimit)</code><!-- raw HTML omitted --><code>void reset()</code></td>
<td>合併用於改變檔案中的讀取位置，特別是回到過去某個指定的讀取位置<!-- raw HTML omitted -->又稱 push-back 操作</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="class-writer">Class Writer</h4>
<table>
<thead>
<tr>
<th>method</th>
<th>name</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本方法</td>
<td><code>void write(int c)</code></td>
<td>將 int 寫入 <strong>Writer</strong></td>
</tr>
<tr>
<td>-</td>
<td><code>void write(char[] buffer)</code></td>
<td>將整個 char[] 寫入 Writer</td>
</tr>
<tr>
<td>-</td>
<td><code>void write(char[] buffer, int offset, int length)</code></td>
<td>寫入 char[] 到 Writer，且指定長度（length）和偏移量（offset）</td>
</tr>
<tr>
<td>其它方法</td>
<td><code>void close()</code></td>
<td>關閉 stream</td>
</tr>
<tr>
<td>-</td>
<td><code>void flush()</code></td>
<td>強制將 Writer 中的資料寫入目的地</td>
</tr>
</tbody>
</table>
<h3 id="串流類別的串接">串流類別的串接</h3>
<table>
<thead>
<tr>
<th>功能\串流內容</th>
<th>字元串流　<em>Character Streams</em></th>
<th>位元串流 <em>Byte Streams</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>Buffering（緩衝）</td>
<td><code>BufferReader</code><!-- raw HTML omitted --><code>BufferedWriter</code></td>
<td><code>BufferedInputStream</code><!-- raw HTML omitted --><code>BufferedOutputStream</code></td>
</tr>
<tr>
<td>Filtering（過濾）</td>
<td><code>FilterReader</code><!-- raw HTML omitted --><code>FilterWriter</code></td>
<td><code>FilterInputStream</code><!-- raw HTML omitted --><code>FilterOutputStream</code></td>
</tr>
<tr>
<td>Conversion（位元轉換為字元）</td>
<td><code>InputStreamReader</code><!-- raw HTML omitted --><code>OutputStreamWriter</code></td>
<td></td>
</tr>
<tr>
<td>Object serialization（物件序列化）</td>
<td></td>
<td><code>ObjectInputStream</code><!-- raw HTML omitted --><code>ObjectOutputStream</code></td>
</tr>
<tr>
<td>Data conversion（資料型態轉換）</td>
<td></td>
<td><code>DataInputStream</code><!-- raw HTML omitted --><code>DataOutputStream</code></td>
</tr>
<tr>
<td>Counting（計算行數）</td>
<td><code>LineNumberReader</code></td>
<td><code>LineNumberInputStream</code></td>
</tr>
<tr>
<td>Printing（列印）</td>
<td><code>PrintWriter</code></td>
<td><code>PrintStream</code></td>
</tr>
</tbody>
</table>
<h3 id="使用-javaiofile-類別">使用 <code>java.io.File</code> 類別</h3>
<p><code>java.io.File</code> 常用方法：</p>
<table>
<thead>
<tr>
<th>method</th>
<th>return type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getName()</code></td>
<td>String</td>
<td>取得檔案或目錄的名稱</td>
</tr>
<tr>
<td><code>getParent()</code></td>
<td>String</td>
<td>取得父目錄的名稱</td>
</tr>
<tr>
<td><code>getParentFile()</code></td>
<td>File</td>
<td>取得代表父目錄的 File 物件</td>
</tr>
<tr>
<td><code>getPath()</code></td>
<td>String</td>
<td>取得檔案或目錄的路徑</td>
</tr>
<tr>
<td><code>isAbsolute()</code></td>
<td>boolean</td>
<td>是否為絕對路徑</td>
</tr>
<tr>
<td><code>getAbsolutePath()</code></td>
<td>String</td>
<td>取得絕對路徑</td>
</tr>
<tr>
<td><code>canRead()</code></td>
<td>boolean</td>
<td>是否可讀取</td>
</tr>
<tr>
<td><code>canWrite()</code></td>
<td>boolean</td>
<td>是否可修改</td>
</tr>
<tr>
<td><code>exists()</code></td>
<td>boolean</td>
<td>是否存在</td>
</tr>
<tr>
<td><code>isDirectory()</code></td>
<td>boolean</td>
<td>是否為目錄</td>
</tr>
<tr>
<td><code>isFile()</code></td>
<td>boolean</td>
<td>是否為檔案</td>
</tr>
<tr>
<td><code>lastModified()</code></td>
<td>long</td>
<td>取得最後一次修改時間</td>
</tr>
<tr>
<td><code>length()</code></td>
<td>long</td>
<td>取得檔案大小</td>
</tr>
<tr>
<td><code>delete()</code></td>
<td>boolean</td>
<td>刪除檔案或目錄並回傳成功與否</td>
</tr>
<tr>
<td><code>list()</code></td>
<td>String[]</td>
<td>列舉目錄下的檔案與子目錄</td>
</tr>
<tr>
<td><code>listFiles()</code></td>
<td>File[]</td>
<td>列舉目錄下的檔案與子目錄的 File 物件</td>
</tr>
<tr>
<td><code>mkdir()</code></td>
<td>boolean</td>
<td>建立目錄</td>
</tr>
<tr>
<td><code>mkdirs()</code></td>
<td>boolean</td>
<td>建立目錄 + 不存在但是需要一併建立的父目錄</td>
</tr>
<tr>
<td><code>renameTo(File)</code></td>
<td>boolean</td>
<td>重新命名</td>
</tr>
<tr>
<td><code>createTempFIle()</code></td>
<td>File</td>
<td>建立暫存檔案，有多載版本</td>
</tr>
<tr>
<td><code>setLastModified(long)</code></td>
<td>boolean</td>
<td>設定最後一次修改時間</td>
</tr>
<tr>
<td><code>setReadOnly()</code></td>
<td>boolean</td>
<td>設定成唯讀</td>
</tr>
</tbody>
</table>
<h2 id="由主控台讀寫資料">由主控台讀寫資料</h2>
<h3 id="主控台的-io">主控台的 I/O</h3>
<p><code>java.lang.System</code> 類別裡的三個 static 欄位</p>
<table>
<thead>
<tr>
<th>「欄位</th>
<th>欄位型別</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>System.out</code></td>
<td><code>PrintStream</code></td>
<td>將訊息輸出至 console，又稱 <strong>標準輸出</strong>（standard output）<!-- raw HTML omitted -->可接受由主控台再經<code>&gt;</code> 或 <code>&gt;&gt;</code> 的「重新導向指令」，將輸出內容導向至另外一個檔案</td>
</tr>
<tr>
<td><code>System.in</code></td>
<td><code>InputStream</code></td>
<td>由 console 接收來自鍵盤或其他來源的訊息輸入<!-- raw HTML omitted -->又稱 <strong>標準輸入</strong>（standard input）</td>
</tr>
<tr>
<td><code>System.err</code></td>
<td><code>PrintStream</code></td>
<td>和 <code>System.out</code> 一樣都是輸出訊息至 console<!-- raw HTML omitted -->但主要用於輸出錯誤訊息，較為急迫必須立即顯示，因此「重新導向指令」無效，依然顯示在 console <!-- raw HTML omitted -->使用 Eclipse IDE 的話，輸出顏色為紅色（警示用）</td>
</tr>
</tbody>
</table>
<h3 id="使用標準輸出方法">使用標準輸出方法</h3>
<ul>
<li><code>println()</code> 輸出換行符、<code>print()</code>不輸出換行符號</li>
<li>以上兩方法對大部分基本型別以及參考型別都有多載方法支援
<ul>
<li>boolean, char, int, long, float, double、char[], <code>Object</code>, <code>String</code></li>
<li>其它參考型別則呼叫該物件的 <code>toString()</code> 方法</li>
</ul>
</li>
</ul>
<h3 id="javaioconsole-類別介紹"><code>java.io.Console</code> 類別介紹</h3>
<ul>
<li>
<p>除了使用前述 <code>System.in</code> 取得主控台標準輸入外，也可以用 <code>java.io.Console</code> 物件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsoleInput</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Console cons <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">console</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 使用 System.console() 方法取得 Console 物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> userValid <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cons <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String account<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            String passwd<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                account <span style="color:#f92672">=</span> cons<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Account: &#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// readline() 可取得指令列輸入的資料
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                passwd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>cons<span style="color:#f92672">.</span><span style="color:#a6e22e">readPassword</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Password: &#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// readPassword() 除了可以取得指令列輸入的資料，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// 還能隱藏使用者輸入內容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>account<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;joanna&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> passwd<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;password&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Correct! System quits!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    userValid <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Wrong! Try again!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>userValid<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 後測式迴圈：先輸入再驗證，失敗繼續，成功終止
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/Q8HsrVi.png"
        data-srcset="https://i.imgur.com/Q8HsrVi.png, https://i.imgur.com/Q8HsrVi.png 1.5x, https://i.imgur.com/Q8HsrVi.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/Q8HsrVi.png"
        title="image-20221218141013717" /></p>
</li>
</ul>
<h2 id="channel-io">Channel I/O</h2>
<ul>
<li>Channel : 可以指兩個設備之間傳送資訊經過的通路或連接
<ul>
<li>導入於 JDK 1.4，屬於 <code>java.nio</code> package</li>
<li>可以一次大量讀入位元和字元，不需要以迴圈每次讀取少量內容</li>
<li>程式更簡潔，程式效能更好</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.ByteBuffer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.FileChannel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CopyByteChannel</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		String source <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>FileChannel in <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>source<span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				FileChannel out <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>target<span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			ByteBuffer buff <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> in<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 建立和 source 檔案 size 大小相同的 ByteBuffer 物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			in<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>buff<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 將實體檔案一次全數讀入到 ByteBuffer 物件中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			buff<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 將 ByteBuffer 裡的標示位置移到最前面
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			out<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buff<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">/* 將 ByteBuffer 裡的資料全數輸出至 FileChannel out，再由其輸出為檔案
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          因為 FileChannel 的 read() 和 write() 方法都是透過 ByteBuffer 物件一次搞定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          所以不用迴圈（loop）分次處理 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			f<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			i<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="使用序列化技術讀寫物件">使用序列化技術讀寫物件</h2>
<p>🚧🚧🚧🚧🚧</p>
<h3 id="java-裡的資料保存-persistence">Java 裡的資料保存 <em>Persistence</em></h3>
<h3 id="序列化和物件圖譜">序列化和物件圖譜</h3>
<h3 id="不需要參加序列化的欄位">不需要參加序列化的欄位</h3>
<h3 id="定義物件保存的版本號碼">定義物件保存的版本號碼</h3>
<h3 id="序列化和反序列化範例">序列化和反序列化範例</h3>
<h4 id="1-class-shirt">1. class Shirt</h4>
<h4 id="2-class-order">2. class Order</h4>
<h3 id="3-serialization-and-de-serialization">3. Serialization and De-serialization</h3>
<hr>
<h1 id="04-nio2">04 NIO.2</h1>
<h2 id="nio2-基礎">NIO.2 基礎</h2>
<h3 id="javajofile限制"><code>java.jo.File</code>限制</h3>
<h3 id="java-io-套件發展歷史">Java I/O 套件發展歷史</h3>
<h3 id="檔案系統路徑和檔案">檔案系統、路徑和檔案</h3>
<h3 id="symbolic-link-檔案">Symbolic Link 檔案</h3>
<h3 id="nio2-的基本架構">NIO.2 的基本架構</h3>
<h2 id="使用-path-介面操作檔案目錄">使用 Path 介面操作檔案/目錄</h2>
<h3 id="path-介面">Path 介面</h3>
<h3 id="path-介面主要功能">Path 介面主要功能</h3>
<h3 id="移除路徑裡的多餘組成">移除路徑裡的多餘組成</h3>
<h3 id="建立子路徑">建立子路徑</h3>
<h3 id="結合-2-個路徑">結合 2 個路徑</h3>
<h3 id="建立連接-2-個路徑的路徑">建立連接 2 個路徑的路徑</h3>
<h3 id="hard-link">Hard Link</h3>
<h3 id="處理-symbolic-link">處理 Symbolic Link</h3>
<h2 id="使用-files-類別對檔案目錄進行檢查刪除複製移動">使用 Files 類別對檔案/目錄進行檢查刪除複製移動</h2>
<h3 id="處理檔案">處理檔案</h3>
<h3 id="檢查檔案--目錄是否存在">檢查檔案 / 目錄是否存在</h3>
<h3 id="檢查檔案--目錄屬性">檢查檔案 / 目錄屬性</h3>
<h3 id="建立檔案--目錄">建立檔案 / 目錄</h3>
<h3 id="刪除檔案--目錄">刪除檔案 / 目錄</h3>
<h3 id="複製和移動檔案--目錄">複製和移動檔案 / 目錄</h3>
<h3 id="stream-和-path-互相複製">Stream 和 Path 互相複製</h3>
<h3 id="列出目錄內容">列出目錄內容</h3>
<h3 id="讀取和寫入檔案">讀取和寫入檔案</h3>
<hr>
<h2 id="使用-files-類別操作-channel-io-和-stream-io-讀寫檔案">使用 Files 類別操作 Channel I/O 和 Stream I/O 讀寫檔案</h2>
<h3 id="介面-channel-和類別-bytebuffer">介面 Channel 和類別 ByteBuffer</h3>
<h3 id="隨機存取檔案">隨機存取檔案</h3>
<h3 id="對文字檔提供-buffered-io-方法">對文字檔提供 Buffered I/O 方法</h3>
<h3 id="取得位元串流物件的方法">取得位元串流物件的方法</h3>
<hr>
<h2 id="讀寫檔案目錄的屬性">讀寫檔案/目錄的屬性</h2>
<h3 id="使用-files-管理檔案的屬性資料">使用 Files 管理檔案的屬性資料</h3>
<h3 id="讀取檔案屬性">讀取檔案屬性</h3>
<h3 id="修改檔案屬性">修改檔案屬性</h3>
<h3 id="dos-之外的-file-attribute-views">DOS 之外的 File Attribute Views</h3>
<h3 id="posix-檔案系統的權限"><code>POSIX</code> 檔案系統的權限</h3>
<hr>
<h2 id="遞迴存取目錄結構">遞迴存取目錄結構</h2>
<h3 id="對檔案目錄進行遞迴操作">對檔案目錄進行遞迴操作</h3>
<hr>
<h2 id="使用-pathmatcher-類別找尋符合的檔案">使用 <code>PathMatcher</code> 類別找尋符合的檔案</h2>
<h3 id="搜尋檔案">搜尋檔案</h3>
<h3 id="glob-樣式語法介紹"><code>glob</code> 樣式語法介紹</h3>
<hr>
<h2 id="其它">其它</h2>
<h3 id="filestore-類別"><code>FileStore</code> 類別</h3>
<h3 id="使用-watchservice">使用 <code>WatchService</code></h3>
<h3 id="由基礎-io-轉換至-nio2">由基礎 I/O 轉換至 NIO.2</h3>
<p>🚧🚧🚧🚧🚧</p>
<hr>
<h1 id="05-執行緒">05 執行緒</h1>
<h2 id="介紹">介紹</h2>
<h3 id="名詞說明">名詞說明</h3>
<h4 id="先占式多工preemptive-multitasking">先占式多工（Preemptive Multitasking）</h4>
<ul>
<li>現代電腦要執行的程式個數經常遠多於 CPU 核數，為了讓程式都可以有機會執行，每個要執行的任務會被分配到一小段 CPU 時間（time slice），使每個任務都能分享到 CPU 資源來完成工作</li>
<li>CPU 時間通常以毫秒 <code>milliseconds</code> 來計算，一旦使用完畢，任務就暫停執行，等待下次分配</li>
</ul>
<h4 id="任務排程task-scheduling">任務排程（Task Scheduling）</h4>
<ul>
<li>大部分作業系統都支援多工（multitasking），把 CPU 時間分配給所有執行程式</li>
<li>程式兩個重要組成
<ol>
<li><strong>程序 Process</strong>
<ul>
<li>擁有記憶體來儲存資料（data）和程式碼（code）</li>
<li>使用執行緒接受分配 CPU 時間以執行程式</li>
</ul>
</li>
<li><strong>執行緒 Thread</strong>
<ul>
<li>程序可同時擁有多個執行緒各司其職</li>
<li>這些執行緒共享程序的記憶體裡的資料</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="多執行緒的重要性">多執行緒的重要性</h3>
<p>要讓程式快速執行，必須避免「效能瓶頸（<em>performance bottlenecks</em>）」，常見瓶頸：</p>
<ol>
<li><strong>資源競爭</strong>（<strong>Resource Contention</strong>）：多個任務搶奪同一獨佔資源，未搶到必須等待</li>
<li><strong>輸出/輸入操作阻礙</strong>（<strong>I/O Operations Blocking</strong>）：通常為等待硬碟或網路傳輸資料</li>
<li><strong>CPU 資源未充分使用</strong>（<strong>Underutilization of CPUs</strong>）：程式只用到單核 CPU</li>
</ol>
<h3 id="執行緒類別">執行緒類別</h3>
<p>Java 類別 Thread 的兩種建立方式：</p>
<table>
<thead>
<tr>
<th>action</th>
<th>benefits/perks</th>
</tr>
</thead>
<tbody>
<tr>
<td>直接繼承 Thread 類別</td>
<td>比較簡單</td>
</tr>
<tr>
<td>實作 Runnable 介面</td>
<td>比較有彈性，可以再繼承其它類別</td>
</tr>
</tbody>
</table>
<h4 id="建立執行緒直接繼承-thread-類別">建立執行緒：直接繼承 Thread 類別</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleThread</span> <span style="color:#66d9ef">extends</span> Thread <span style="color:#f92672">{</span>  <span style="color:#75715e">// #1 繼承 java.lang.Thread 類別
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">// #2 覆寫 run() 方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 100<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i:&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p>啟用執行緒：</p>
<ul>
<li>
<p>要呼叫 <code>start()</code> 方法，Java 會啟動獨立執行緒執行 <code>run()</code> 方法內容</p>
</li>
<li>
<p>若直接呼叫 <code>run()</code> 方法，將和一般方法無異</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Thread t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExampleThread<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    t1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h4 id="建立執行緒實作-runnable-介面">建立執行緒：實作 Runnable 介面</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleRunnable</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>  <span style="color:#75715e">// #1 實作 java.lang.Runnable 介面
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// #2 覆寫 run() 方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 100<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i:&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p>若要以實作 <code>Runnable</code> 的類別啟動執行緒，可將其物件放入 Thread 類別的建構子，並用 <code>start()</code> 啟動</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Runnable r1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExampleRunnable<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    Thread t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r1<span style="color:#f92672">);</span> <span style="color:#75715e">// 將 ExampleRunnable 物件放入 Thread constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    t1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="執行緒常見問題">執行緒常見問題</h2>
<p>執行緒常遇到問題的三類原因：</p>
<ol>
<li>使用分享的資料 <em>shared data</em></li>
<li>使用可分段的方法 <em>non-atomic function</em></li>
<li>使用快取的資料 <em>cached data</em></li>
</ol>
<h3 id="使用-shared-data-可能造成的問題">使用 <code>Shared Data</code> 可能造成的問題</h3>
<p>執行緒會潛在 static 和 instance 欄位，可能造成問題如下：</p>
<ol>
<li>
<p>執行緒物件目的在執行其 <code>run()</code> 方法</p>
<ul>
<li>若多個執行緒都要執行 <code>run()</code>，就要注意該方法共用的部分</li>
<li>例如：物件實例欄位會被同時存取（concurrently accessed）</li>
</ul>
</li>
<li>
<p>static 欄位原本就是分享的資料，也無法避免同時被存取的情況</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleRunnable</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> i<span style="color:#f92672">;</span>  <span style="color:#75715e">// 將被共用!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 10<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;i:&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ExampleRunnable r1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExampleRunnable<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Thread t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        t1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Thread t2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        t2<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/h3ufiAX.png"
        data-srcset="https://i.imgur.com/h3ufiAX.png, https://i.imgur.com/h3ufiAX.png 1.5x, https://i.imgur.com/h3ufiAX.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/h3ufiAX.png"
        title="image-20221218163741687" /></p>
<ul>
<li>
<p>以上結果和預期結果有落差</p>
<p><code>i:0, i:1, i:2, i:3, i:4, i:5, i:6, i:7, i:8, i:9,</code></p>
</li>
<li>
<p>當前述類別（<strong>static</strong>）和物件實例（<strong>instance</strong>）欄位資料被多個執行緒共用，出現執行異常時，IDE 是無法警告的</p>
</li>
<li>
<p>因此 <em><strong>安全地（safely）處理被分享的資料</strong></em>，就成為程式設計師的義務</p>
</li>
<li>
<p>資料若因為多個執行緒同時存取而產生錯誤，一般不好處理</p>
<ol>
<li>Thread 的分配由作業系統決定，程式設計師無法干預</li>
<li>每一台機器的 CPU 效能、個數不盡然相同</li>
<li>其它程式也會占用 CPU 時間</li>
</ol>
</li>
<li>
<p>因此可能有在測試環境無異常，但部署到正式環境後卻經常發生奇怪狀況</p>
<ul>
<li>盡可能使用執行緒安全的設計（thread-safe），減少使用 <code>shared data</code></li>
</ul>
</li>
<li>
<p>類別內有些資料不會被多執行緒分享，永遠都 <code>thread-safe</code> 的例子</p>
<ol>
<li>區域變數 <em>local variables</em></li>
<li>方法參數 <em>method parameters</em></li>
<li>例外處理參數 <em>exception handler parameters</em></li>
</ol>
</li>
</ul>
</li>
</ol>
<h3 id="使用-non-atomic-functions-可能造成的問題">使用 <code>Non-Atomic Functions</code> 可能造成的問題</h3>
<ul>
<li><code>atomic function</code> - 用原子的概念描述一個功能
<ul>
<li>原子無法再分割，代表 <code>single function</code>，即該功能只有一個步驟</li>
</ul>
</li>
<li>Java 裡，即使程式碼只有一句敘述，也不代表它就是 <code>atomic function</code>
<ul>
<li>以整數 i 使用 遞增運算子的 <code>i++</code> 為例，Java 以 3 個步驟執行
<ol>
<li>對整數 <code>i</code> 建立暫時副本</li>
<li>暫時副本增加 1</li>
<li>將暫時副本的結果回寫 <code>i</code></li>
</ol>
</li>
<li>另外有些 64 bit 變數的存取也可以使用 2 個 32 bit 的操作完成</li>
</ul>
</li>
</ul>
<h3 id="使用-cached-data-可能造成的問題">使用 <code>Cached Data</code> 可能造成的問題</h3>
<ul>
<li>執行緒 <code>thread</code> 因為程序 <code>process</code> 需要同時執行不同工作而產生</li>
<li>為求執行效能，執行緒啟動時，會將程序中的 <code>main memory</code> 內的分享資料複製一份，放在自己的 <code>working memory</code> 作為快取複製（<code>cached copies</code>），工作結束後寫回，如此一來可以避免程式進行過程中，執行緒必須不斷向程序要求資料而造成的效率問題</li>
<li>這樣的設計，讓執行過程中的每一執行緒各自努力，無法<strong>即時</strong>和其他執行緒分享工作成果，必須等到工作結束</li>
<li>只有以下情況才能讓執行緒將各自 working memory 的異動結果寫回 main memory：
<ol>
<li>使用到 <code>volatile</code> 宣告的變數</li>
<li>使用到 <code>synchronized</code> 宣告的方法，亦即準備鎖定和解索物件 monitor</li>
<li>執行緒執行時的第一個動作或最後一個動作</li>
<li>執行緒啟動或執行緒結束時</li>
</ol>
</li>
<li>若程式設計需要多執行緒在工作過程仍然能互相溝通訊息，就必須善用上述四個條件
<ul>
<li>尤其是使用 <code>volatile</code> 關鍵字宣告，其由來和使用方式：
<ol>
<li>程式設計中，如果資料經常維持不變，可以將之固定在記憶體裡，或複製出來使用，稱之為「<strong>快取複製</strong>（cached copies）」</li>
<li>單字 <code>volatile</code> 解釋為「<strong>易變的、反覆無常的</strong>」：
<ul>
<li>加上此宣告相當於告訴 Java 該欄位經常有變化，不適合產生快取複製</li>
<li>因此所有執行緒將皆存取同一份資料，例：<code>volatile int i;</code></li>
</ul>
</li>
<li>必須了解宣告 <code>volatile</code> 只是不產生快取複製，和執行緒安全是兩回事
<ul>
<li>還是必須利用先前所提的作法來保證執行緒安全</li>
<li>volatile 宣告可以應用在「精準終止執行緒的執行」</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyRunnable</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> running <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>  <span style="color:#75715e">// line 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread started&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread finishing&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StopThreadExample</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        MyRunnable r1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyRunnable<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Thread t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r1<span style="color:#f92672">);</span>       <span style="color:#75715e">// line 16
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        t1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        r1<span style="color:#f92672">.</span><span style="color:#a6e22e">running</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#75715e">// line 19 : terminate the thread immediately
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>line#</th>
<th>desc</th>
</tr>
</thead>
<tbody>
<tr>
<td>16</td>
<td>thread <code>t1</code> 在啟動前<strong>預設</strong>會自己複製一份變數 running（值=true）作為快取複製</td>
</tr>
<tr>
<td>2</td>
<td>所以如果沒有宣告變數 running 為 <code>volatile</code></td>
</tr>
<tr>
<td>19</td>
<td>即便在 main 執行緒將 running 改為 false，執行緒 t1 不一定會馬上知道，必須等到有事件觸發，讓 working memory 和 main memory 同步，執行緒 <code>t1</code> 才會收到通知而停止</td>
</tr>
</tbody>
</table>
<p>&hellip;</p>
<h2 id="執行緒的-synchronized-與等待">執行緒的 synchronized 與等待</h2>
<h3 id="使用-synchronized-關鍵字">使用 <code>synchronized</code> 關鍵字</h3>
<ul>
<li>
<p>建立執行緒安全的程式，除了盡量使用執行緒安全的變數之外，就是使用「<strong>synchronized</strong>」關鍵字宣告<em>方法</em>或是<em>更小的程式碼區塊</em>：</p>
<ol>
<li><code>synchronized</code> 和 <code>volatile</code> 宣告有類似功用：
<ul>
<li>執行緒在執行該區塊的最初和最後時，會將變數值寫回 main memory</li>
</ul>
</li>
<li>該區塊為獨占執行（<em>exclusive execution</em>）：
<ul>
<li>亦即同一時間只允許一個執行緒使用</li>
<li>可解決 <code>non-atomic</code>問題，所以區塊內為執行緒安全</li>
</ul>
</li>
</ol>
</li>
<li>
<p>執行緒取得獨占執行權的機制：</p>
<ol>
<li>
<p>每個 Java 物件都有一個「<strong>object monitor</strong>」，執行緒可以對它進行鎖定（lock）和解鎖（unlock）</p>
<ul>
<li>若鎖定成功，表示取得該物件的獨占執行權</li>
<li>此時其它執行緒無法使用該物件的 <code>synchronized</code> 程式區塊，等同單一執行緒環境</li>
</ul>
</li>
<li>
<p>要使用宣告 <code>synchronized</code> 的方法，就必須取得「<strong>this</strong>」的 object monitor</p>
</li>
<li>
<p>要使用宣告 <code>static</code> 的方法，同理也必須取得類別的「<strong>class monitor</strong>」</p>
</li>
<li>
<p>要使用宣告 <code>synchronized</code> 區塊，必須指定要使用哪一個物件的 monitor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>使用 <code>synchronized</code> 區塊可以有巢狀結構，且可以使用不同的 object monitor</p>
</li>
</ol>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SynchronizedAll</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sleep</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>5000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">m1</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		sleep<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;-- Run m1() at: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">m2</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		sleep<span style="color:#f92672">();</span>	
</span></span><span style="display:flex;"><span>		System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;-- Run m2() at: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#75715e">/* 將兩個public方法都宣告為synchronized，如此建立出的物件，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     m1()和m2()方法將同時只能有一個被呼叫執行 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">M1Runner</span> <span style="color:#66d9ef">extends</span> Thread <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	SynchronizedAll o<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	M1Runner<span style="color:#f92672">(</span>SynchronizedAll o<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">o</span> <span style="color:#f92672">=</span> o<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 建立執行緒類別M1Runner，在建構子傳入一個SynchronizedAll物件後，呼叫m1()方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		o<span style="color:#f92672">.</span><span style="color:#a6e22e">m1</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">M2Runner</span> <span style="color:#66d9ef">extends</span> Thread <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	SynchronizedAll o<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	M2Runner<span style="color:#f92672">(</span>SynchronizedAll o<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">o</span> <span style="color:#f92672">=</span> o<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 建立執行緒類別M2Runner，在建構子傳入一個SynchronizedAll物件後，呼叫m2()方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		o<span style="color:#f92672">.</span><span style="color:#a6e22e">m2</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SynchronizedTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		SynchronizedAll o <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SynchronizedAll<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 建立一個 SynchronizedAll 物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>		System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Start main at: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>		Thread m1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> M1Runner<span style="color:#f92672">(</span>o<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		m1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 建立 M1Runner 執行緒物件，並傳入之前建立的 SynchronizedAll 物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>		Thread m2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> M2Runner<span style="color:#f92672">(</span>o<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		m2<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 建立 M2Runner 執行緒物件，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 並傳入和 M1Runner 所傳入的相同的 SynchronizedAll 物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//m1.interrupt();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;End main at: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>因為 <code>SynchronizedAll</code> 內 <code>m1()</code> 及 <code>m2()</code> 方法都是 <code>synchronized</code>，要執行都要取得 this 的 object monitor，因此同時間只能有一個方法被呼叫</p>
</blockquote>
<h3 id="使用-synchronized-的時機">使用 <code>synchronized</code> 的時機</h3>
<ul>
<li><code>java.util.ConcurrentModificationException</code> :
<ul>
<li>如果 Java 偵測到集合物件的內容將被同時修改（不限定是否多執行緒所為），就會拋出 <code>ConcurrentModificationException</code>
<ul>
<li>此為「<strong>fail-fast</strong>」行為模式，亦即對於錯誤或是可能造成錯誤的情況，馬上作出反應</li>
<li>為了避免發生 <strong>fail-fast</strong> 狀況，應避免在執行 <code>getSummary()</code> 方法時，其它 2 個方法被同時呼叫
<ul>
<li>可以將這三個方法都宣告為 <code>synchronized</code>，如此要呼叫方法前，必須取得該物件的唯一 <strong>object monitor</strong>，就不會有被同時執行的可能性</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>ConcurrentModificationException</code> 不是只有在多執行緒的情況下才會發生
<ul>
<li>以下的 <strong>fail-fast_1</strong> 或 <strong>fail-fast_2</strong> 會拋出 <code>ConcurrentModificationException</code>
<ul>
<li>原因：使用 iterator 或進階 for-loop 走訪 map 物件成員，同時去刪除 map 成員</li>
<li>避免方法：
<ul>
<li>複製 map，讓新複製的 map 用於走訪成員</li>
<li>再用取得的 key 刪除另外一個 map 物件的成員</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConcurrentModificationExceptionTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>3<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// fail-fast 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Iterator<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> iter <span style="color:#f92672">=</span> map<span style="color:#f92672">.</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">().</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iter<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Integer key <span style="color:#f92672">=</span> iter<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">&gt;=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    map<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ConcurrentModificationException</span> e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// fail-fast 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Integer key <span style="color:#f92672">:</span> map<span style="color:#f92672">.</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">&gt;=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    map<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ConcurrentModificationException</span> e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="縮小-synchronized-的程式區塊">縮小 synchronized 的程式區塊</h3>
<ul>
<li>
<p>物件裡所有 synchronized 方法在執行前，都必須取得 object monitor</p>
</li>
<li>
<p>因此如果越多方法使用 synchronized，或是被 synchronized 的方法內容越長，都會造成執「行等待」</p>
</li>
<li>
<p>盡可能使用 synchronized 程式區塊，而非直接 synchronized 整個方法</p>
</li>
<li>
<p>減少被 synchronized 的程式碼，有助於減少「執行等待」的情況</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getSummary</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    StringBuilder note <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>              <span style="color:#75715e">// line 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Iterator<span style="color:#f92672">&lt;</span>Item<span style="color:#f92672">&gt;</span> iter <span style="color:#f92672">=</span> cart<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iter<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Item i <span style="color:#f92672">=</span> iter<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            note<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Item:&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">.</span><span style="color:#a6e22e">desc</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>  <span style="color:#75715e">// line 9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> note<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>可以直接把 <code>getSummary()</code> 宣告為 synchronized 方法，</p>
<p>但比較好的做法是檢討方法內真正影響執行緒安全的程式碼。</p>
<ul>
<li>
<p>line 3 ~ line 9 : synchronized 程式碼區塊可讓影響區域縮小</p>
</li>
<li>
<p>根據 line 3 宣告 : 要執行本區塊必須取得 this 的 object monitor</p>
</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="其它執行等待的情況">其它執行等待的情況</h3>
<p>除了 synchronized 程式區塊造成的執行等待，還有以下幾種情形必須預防</p>
<h4 id="1-starvation--因搶不到資源而排隊">1. <strong>Starvation</strong> : 因搶不到資源而排隊</h4>
<ul>
<li>指兩個執行緒共搶一個資源，其中某一個經常可以取得資源（<em>貪心執行緒，greedy thread</em>）</li>
<li>另外一個經常無法取得資源（<em>飢餓執行緒，starved thread</em>）</li>
</ul>
<h4 id="2-live-lock--因太忙碌而排隊">2. Live Lock : 因太忙碌而排隊</h4>
<ul>
<li>指多個執行緒因為等待資源而排隊，thread_B 等 thread_A、thread_C 等 thread_B、thread_D 等 thread_C</li>
<li>thread_A 完成可以輪到 thread_B，thread_B 完成輪到 thread_C，以此類推</li>
</ul>
<h4 id="3-dead-lock--2-個執行緒互相絆住對方導致永遠等待">3. Dead Lock : 2 個執行緒互相絆住對方，導致永遠等待</h4>
<ul>
<li>
<p>thread_A : 必須先後取得「資源1」和「資源2」</p>
</li>
<li>
<p>thread_B : 必須先後取得「資源2」和「資源1」</p>
</li>
<li>
<p>Deadlock 情況 : A 持有資源 1，等待資源 2；此時 B 持有資源 2，等待資源 1</p>
<ul>
<li>除非 Thread-A 或 Thread-B 其中有一方讓出資源或被終止，才能結束 Deadlock</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/yoRNlvk.png"
        data-srcset="https://i.imgur.com/yoRNlvk.png, https://i.imgur.com/yoRNlvk.png 1.5x, https://i.imgur.com/yoRNlvk.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/yoRNlvk.png"
        title="image-20221219105806769" /></p>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p>要產生 dead lock 需要 2 個執行緒和 2 個被搶奪的資源物件。</p>
<p>資源可以是任何物件，使用 <code>new Object()</code> 都可以。e.g.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> String resource1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jim1&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> String resource2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jim2&#34;</span><span style="color:#f92672">;</span>
</span></span></code></pre></div><p>因為字串池有重複使用相同內容字串的機制，若改為以下內容，則兩個變數<strong>實際指向同一個字串物件</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> String resource1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jim&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> String resource2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jim&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 因為被搶奪的資源只有一個，無法構成 dead lock
</span></span></span></code></pre></div></blockquote>
<p>&hellip;</p>
<h2 id="其它執行緒方法介紹">其它執行緒方法介紹</h2>
<h3 id="使用-interrupt-方法">使用 <code>interrupt()</code> 方法</h3>
<p>除了利用 <code>volatile</code> 宣告的變數來停止執行中的執行緒，也可以用 <code>interrupt()</code> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InterruptedRunnable</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread started&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* 執行中的執行緒可藉由 interrupted 方法不斷確認是否收到中斷指令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">               若是，就中斷目前執行工作 */</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;I am running...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread finishing&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InterruptThreadExample</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        InterruptedRunnable r1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InterruptedRunnable<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Thread t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        t1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>        t1<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 對執行中的執行緒下達 interrupt 指令
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="使用-sleep-方法">使用 <code>sleep()</code> 方法</h3>
<p>若要使執行緒暫停，可以呼叫 class Thread 的靜態 <code>sleep()</code> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">native</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> millis<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException<span style="color:#f92672">;</span>
</span></span></code></pre></div><ul>
<li>
<p>呼叫 <code>Thread.sleep(4000)</code> 即暫停執行 4 秒鐘，4 秒之後再等待 CPU 分配時間</p>
<ul>
<li>拿到才能繼續執行任務，停止時間「<strong>至少</strong>」為 4 秒鐘</li>
</ul>
</li>
<li>
<p>休眠中的執行緒隨時有被叫醒而中斷休眠的可能，所以被要求必須處理 <code>InterruptedException</code></p>
<ul>
<li>
<p>並在 catch block 中決定被終止休眠後要做的事</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>4000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// what to do?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">long</span> time <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> start<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Slept for &#34;</span> <span style="color:#f92672">+</span> time <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;ms&#34;</span><span style="color:#f92672">);</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="使用其它方法">使用其它方法</h3>
<p>Class Thread 的其它常用方法：</p>
<p>以下 3 個方法繼承自 Object class：</p>
<ol>
<li>
<p><code>wait()</code>：不限時間的等待，等候 <code>notify()</code> 被呼叫後醒過來</p>
</li>
<li>
<p><code>notify()</code> 和 <code>notifyAll()</code> : 通知 <code>wait()</code> 中的執行緒</p>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p><code>daemon</code> : 在多執行緒的情形下，無法影響 JVM 的結束</p>
</blockquote>
</li>
</ol>
<p>以下示範 <code>join()</code> 和 <code>setDaemon()</code> 之使用方式與其影響</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadTest</span> <span style="color:#66d9ef">extends</span> Thread <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread T is starting...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> 3<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>1000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread T is running...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread T is ending...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadMethodTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread main is starting...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        testNormal<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// testJoin();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// testDaemon();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Thread main is ending...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testNormal</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Thread t <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadTest<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// #1 thread main 和 thread t 啟動後各走各的，互不影響
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testJoin</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Thread t <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadTest<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            t<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* #2 thread main 啟動 thread t，在執行 t.join() 時，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      thread t 會插隊到 main 前面，只有 thread t 結束後才會執行 thread main */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testDaemon</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Thread t <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadTest<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span><span style="color:#a6e22e">setDaemon</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        t<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// t.setDaemon(true);  // java.lang.IllegalThreadStateException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 將執行緒 t 設為 daemon 後，一旦 non-daemon 的 thread main 結束，JVM 就關閉
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   thread main 結束後，即便 thread t 尚未結束，JVM 也會關閉，和先前2種測試明顯不同 */</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>&hellip;</p>
<h3 id="不建議使用的方法">不建議使用的方法</h3>
<ul>
<li>
<p>class Thread 一些不建議使用的方法：</p>
<ol>
<li>
<p>可能造成問題，避免使用</p>
<ul>
<li><code>setPriority(int)</code></li>
<li><code>getPriority()</code></li>
</ul>
</li>
<li>
<p>已經 <strong>deprecated</strong>，不該使用</p>
<ul>
<li><code>destroy()</code></li>
<li><code>resume()</code></li>
<li><code>suspend()</code></li>
<li><code>stop()</code></li>
</ul>
<blockquote>
<p>使用 deprecated 描述表示方法可能</p>
<ul>
<li>寫法不好</li>
<li>命名不符合傳統，不建議再使用</li>
<li>未來可能移除 ex.  <code>@Deprecated</code>、<del>stop</del>() {&hellip;}、<del>resume</del>();</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 註記方式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@Deprecated</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">stop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    SecurityManager security <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>security <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        checkAccess<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span> <span style="color:#f92672">!=</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            security<span style="color:#f92672">.</span><span style="color:#a6e22e">checkPermission</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                SecurityConstants<span style="color:#f92672">.</span><span style="color:#a6e22e">STOP_THREAD_PERMISSION</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// A zero status value corresponds to &#34;NEW&#34;, it can&#39;t change to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// not-NEW because we hold the lock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>threadStatus <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        resume<span style="color:#f92672">();</span> <span style="color:#75715e">// Wake up thread if it was suspended; no-op otherwise
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// The VM can handle all thread states
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    stop0<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ThreadDeath<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></blockquote>
</li>
</ol>
</li>
</ul>
<hr>
<h1 id="06-執行緒與並行-api-concurrency-api">06 執行緒與並行 API <code>Concurrency API</code></h1>
<h2 id="使用並行-api">使用並行 API</h2>
<h3 id="並行-api-介紹">並行 API 介紹</h3>
<ul>
<li>Concurrency API 是套件 <code>java.util.concurrent</code> 下的相關類別和介面。</li>
<li>導入於 Java 5，陸續擴充，用於支援多執行緒執行，亦即 concurrent programming，包含
<ol>
<li>執行緒安全（thread-safe）的集合物件</li>
<li>取代傳統 <em>synchronization</em> 和 <em>locking</em> 的替代方案</li>
<li>執行緒池（thread pools），又分成：
<ul>
<li>執行緒數量「固定」或「浮動」的執行緒池</li>
<li>分進合擊的 <em>Fork-Join Framework</em></li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="atomicinteger-類別"><code>AtomicInteger</code> 類別</h3>
<ul>
<li>
<p>class <code>AtomicInteger</code> 位於<code>java.util.concurrent.atomic</code>套件裡</p>
</li>
<li>
<p>提供執行緒安全又不需要使用 <em>synchronization</em> 和 <em>locking</em> 機制來控管的物件</p>
</li>
<li>
<p>此類別裡的方法都是 atomic function，例如 <code>compareAndSet()</code>、<code>getAndIncrement()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>AtomicInteger ai <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger<span style="color:#f92672">(</span>5<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ai<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>5<span style="color:#f92672">,</span> 42<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">// 🥨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;after compareAndSet(): &#34;</span> <span style="color:#f92672">+</span> ai<span style="color:#f92672">);</span>  <span style="color:#75715e">// 42
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>ai<span style="color:#f92672">.</span><span style="color:#a6e22e">getAndIncrement</span><span style="color:#f92672">();</span>  <span style="color:#75715e">// 🥨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;after getAndIncrement(): &#34;</span> <span style="color:#f92672">+</span> ai<span style="color:#f92672">);</span>   <span style="color:#75715e">// 43
</span></span></span></code></pre></div><table>
<thead>
<tr>
<th>🥨</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>compareAndSet(a,b)</code></td>
<td>判斷數值是否為 a，若是則設定為 b，亦即將 a 取代為 b</td>
</tr>
<tr>
<td><code>getAndIncrement()</code></td>
<td>取得數值後加 1。作用同遞增運算子，但 atomic function 不須使用 synchronized block</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3 id="reentrantreadwritelock-類別"><code>ReentrantReadWriteLock</code> 類別</h3>
<ul>
<li>
<p>有別於<code>synchronization</code>與<code>monitor</code>機制，<code>ReentrantReadWriteLock</code>提供另一種鎖定（locking）</p>
</li>
<li>
<p>可根據不同情況（conditions）調整執行緒等待的（wait）架構</p>
<ol>
<li>
<p>過去的 monitor 未分類，一個執行緒取得 monitor 之後，其它執行緒必須等待鎖定該 monitor</p>
</li>
<li>
<p>使用 <code>ReentrantReadWriteLock</code>，將原本由每個物件唯一的 object monitor，改提供 <strong>read lock</strong> 和 <strong>write lock</strong> 兩種鎖定機制</p>
<ul>
<li>有 thread 先取得 <strong>read lock</strong> 時，其它執行緒可以同時再取得 read lock
<ul>
<li>允許多個執行緒同時 read，但沒有執行緒可以取得 write lock</li>
</ul>
</li>
<li>一旦有執行緒取得 <strong>write lock</strong>，將排擠其它執行緒取得 read lock 和 write lock</li>
</ul>
</li>
<li>
<p>「<strong>Reentrant</strong>」</p>
<ul>
<li>
<p>如果有執行緒已經使用某個 synchronized 方法（= 取得某物件的 object monitor），則該執行緒可繼續進入其它使用相同 object monitor 的任何一個 synchronized 方法</p>
</li>
<li>
<p>申請一把鑰匙之後，可以繼續打開每一個使用相同鑰匙的門，不用每次開門後都繳回，也不用為了公平而重新申請排隊</p>
<blockquote>
<p>1️⃣ 允許多執行緒同時「holding read lock」</p>
<p>2️⃣ 同一時間一旦有一個執行緒「holding write lock」，</p>
<p>​      就不會再有其它執行緒「holding read lock」或「holding write lock」</p>
</blockquote>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="執行緒安全的集合物件">執行緒安全的集合物件</h3>
<p><code>java.util.*</code> 下的集合物件預設非執行緒安全，如果要 thread-safe，必須特別處理：</p>
<ol>
<li>
<p>對所有修改集合物件的程式碼，都必須放在 <em>synchronize</em> 區塊</p>
</li>
<li>
<p>使用特定類別及方法建立 <em>synchronized wrapper</em> class</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Collections</span><span style="color:#f92672">.</span><span style="color:#a6e22e">synchronizedList</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;)</span>
</span></span></code></pre></div></li>
<li>
<p>改用套件 <code>java.util.concurrent</code> 套件下的集合物件</p>
<p><strong>注意</strong>：即便是執行緒安全的集合物件，不代表其成員也是</p>
</li>
</ol>
<p>常用執行緒安全的集合物件：</p>
<table>
<thead>
<tr>
<th><code>java.util.concurrent.*</code></th>
<th><code>java.util.*</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CopyOnWriteArraySet</code></td>
<td></td>
</tr>
<tr>
<td><code>CopyOnWriteArrayList</code></td>
<td><code>ArrayList</code></td>
</tr>
<tr>
<td><code>ConcurrentHashMap</code></td>
<td><code>HashMap</code></td>
</tr>
<tr>
<td><code>ConcurrentSkipListMap</code></td>
<td><code>TreeMap</code></td>
</tr>
</tbody>
</table>
<p><code>Queue</code> family 的執行緒安全集合物件：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/E0u3aAs.png"
        data-srcset="https://i.imgur.com/E0u3aAs.png, https://i.imgur.com/E0u3aAs.png 1.5x, https://i.imgur.com/E0u3aAs.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/E0u3aAs.png"
        title="1" /></p>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p>支援執行緒安全的集合物件裡，常可以看到 <code>CopyOnWrite</code> 的命名方式，暗示該集合物件如何支援執行緒安全</p>
<ol>
<li>當該集合物件要增加成員時，不直接添加，而是
<ul>
<li>先將當前集合物件複製出一個新的集合物件，然後在新的集合物件裡增加成員</li>
</ul>
</li>
<li>添加完成員之後，再將原集合物件的物件參考指向新的集合物件</li>
<li>好處：集合物件可以讀寫並行，不需要在修改的時候排除其它行為，因為當前集合物件不會添加任何元素
<ul>
<li><code>CopyOnWrite</code> 集合物件是一種讀寫分離的思想實踐，對不同的集合物件讀取和寫入</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="常用的同步器工具類別">常用的同步器工具類別</h3>
<p>套件 <code>java.util.concurrent</code> 下，提供數種支援特殊情境的同步器（<em>synchronizers</em>）類別</p>
<table>
<thead>
<tr>
<th>class</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Semaphore</code></td>
<td>傳統的 concurrency（平行執行）工具</td>
</tr>
<tr>
<td><code>CountDownLatch</code></td>
<td>暫停 thread 直到某種情境達成，例如信號數量、事件、預設條件</td>
</tr>
<tr>
<td><code>CyclicBarrier</code>（循環路障）</td>
<td>於平行執行時提供同步點，可循環使用</td>
</tr>
<tr>
<td><code>Phaser</code></td>
<td>更有彈性的 <code>CyclicBarrier</code></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> stopUntil <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span>  <span style="color:#75715e">// 設定多少個 thread 抵達才放行的條件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> totalThreadCnt <span style="color:#f92672">=</span> 3<span style="color:#f92672">;</span>  <span style="color:#75715e">// 任意調整啟動的 thread 個數，測試 CyclicBarrier 類的效果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">final</span> CyclicBarrier barrier <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CyclicBarrier<span style="color:#f92672">(</span>stopUntil<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 宣告並初始化 class Cyclic 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>1<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;=</span>totalThreadCnt<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;before await&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					barrier<span style="color:#f92672">.</span><span style="color:#a6e22e">await</span><span style="color:#f92672">();</span>  <span style="color:#75715e">// line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;after await&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BrokenBarrierException <span style="color:#f92672">|</span> InterruptedException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p><code>await()</code> 方法：像是柵欄，平時放下。</p>
<p>只有滿足 <code>CyclicBarrier</code> 建構子設定的 <code>stopUntil</code> 個數的 thread 抵達後，才會放行</p>
</blockquote>
<h2 id="使用-executorservice-介面同時執行多樣工作">使用 <code>ExecutorService</code> 介面同時執行多樣工作</h2>
<h3 id="使用更高階的多執行緒執行方案">使用更高階的多執行緒執行方案</h3>
<p>多執行緒程式架構可同時執行工作，提升效率，但也容易衍生問題，必須小心操控。</p>
<p>傳統 <code>API</code> 不容易被適當使用，可考慮使用以下兩個更高階的替代方案：</p>
<ol>
<li><strong>執行者服務</strong>（<em>java.util.concurrent.ExecutorService</em>）
<ul>
<li>建立並重複使用多執行緒</li>
<li><code>ExecutorService</code> 介面
<ul>
<li>除了可以使用過去的 <code>Runnable</code> 介面定義工作內容</li>
<li>也可用新的 <code>Callable</code> 介面定義工作內容，允許在未來工作結束後檢視結果</li>
</ul>
</li>
</ul>
</li>
<li><strong>分進合擊程式框架</strong>（<em>Fork-Join Framework</em>）
<ul>
<li>Java 7 推出的特殊「<strong>工作竊取</strong>（work-stealing）」平行運算架構</li>
<li>用於多執行緒執行，是一種特化的 ExecutorService</li>
<li>程式運行時，除了不斷將整體工作進行切割外，也讓<strong>有能力、較有餘裕的執行緒在做完份內工作後，可以竊取（stealing）別人的工作來執行</strong>
<ul>
<li>支援 <em>能者多勞</em> 理念的多執行緒執行架構</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="executorservice概觀"><code>ExecutorService</code>概觀</h3>
<ul>
<li><code>ExecutorService</code> 介面是執行緒池（thread pool）的概念，使用過的執行緒皆可回收池內繼續下次使用</li>
<li>執行緒池也會負責管理所有執行緒的生命週期，使用 <code>ExecutorService</code>執行多執行緒工作時：
<ol>
<li>不需要自己建立和管理多執行緒，且可以平行執行</li>
<li>可分成兩種任務
<ul>
<li><code>java.lang.Runnable</code></li>
<li><code>java.util.concurrent.Callable</code></li>
</ul>
</li>
<li>使用 class <code>Executors</code> 可以取得 interface <code>ExecutorService</code> 的實作，常用兩種
<ul>
<li>快取式執行緒池 <em>cached thread pool</em></li>
<li>固定式執行緒池 <em>fixed thread pool</em></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="快取式執行緒池cached-thread-pool">快取式執行緒池（cached thread pool）</h4>
<ul>
<li>
<p>建立方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ExecutorService es <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newCachedThreadPool</span><span style="color:#f92672">();</span>
</span></span></code></pre></div></li>
<li>
<p>特點</p>
<table>
<thead>
<tr>
<th>feature</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>數量控制</td>
<td>執行緒數量由執行緒池<strong>自動調控</strong></td>
</tr>
<tr>
<td>是否重複使用</td>
<td>執行緒工作完成後，回收重複使用</td>
</tr>
<tr>
<td>工作量大時</td>
<td>遇到需要大量 CPU 運算的工作，<strong>執行緒可能會一直增生</strong></td>
</tr>
<tr>
<td>生命週期</td>
<td>預設閒置超過 <strong>60 秒</strong>，就終止生命週期</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h4 id="固定式執行緒池fixed-thread-pool">固定式執行緒池（fixed thread pool）</h4>
<ul>
<li>
<p>建立方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> cpuCount <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">availableProcessors</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 參考主機 CPU 數量建立執行緒數量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ExecutorService es <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>cpuCount<span style="color:#f92672">);</span>
</span></span></code></pre></div></li>
<li>
<p>特點</p>
<table>
<thead>
<tr>
<th>feature/category</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>數量控制</td>
<td>執行緒數量固定</td>
</tr>
<tr>
<td>是否重複使用</td>
<td>執行緒工作完成後，回收重複使用</td>
</tr>
<tr>
<td>工作量大時</td>
<td>工作太多時，必須等待忙碌的執行緒釋出</td>
</tr>
<tr>
<td>生命週期</td>
<td>數量固定，不會主動終止生命週期</td>
</tr>
</tbody>
</table>
</li>
</ul>
<h3 id="使用-javautilconcurrentcallable">使用 <code>java.util.concurrent.Callable</code></h3>
<ul>
<li>
<p><code>ExecutorService</code> 可以協助管理執行緒，但還是需要自己定義執行緒的工作內容</p>
</li>
<li>
<p>除了使用 <code>java.lang.Runnable</code> 介面，也可以使用另外一個 <code>java.util.concurrent.Callable</code> 介面實作類別來定義要執行的工作</p>
<table>
<thead>
<tr>
<th>Runnable</th>
<th>Callable</th>
</tr>
</thead>
<tbody>
<tr>
<td>public interface <code>Runnable</code> {<!-- raw HTML omitted -->       void run();<!-- raw HTML omitted -->}</td>
<td>public interface <code>Callable&lt;V&gt;</code> {<!-- raw HTML omitted -->       V call() throws Exception;<!-- raw HTML omitted -->}</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>Callable</code> 和 <code>Runnable</code> 相似，主要不同地方</p>
<ol>
<li>可以回傳結果（使用泛型）</li>
<li>可以拋出 Exception</li>
</ol>
</li>
<li>
<p>若使用傳統 <strong>Runnable</strong> 介面實作物件作為 <code>ExecutorService</code> 的執行工作內容，可用下例執行工作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">useRunnable</span><span style="color:#f92672">(</span>ExecutorService es<span style="color:#f92672">,</span> Runnable runnable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    es<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>runnable<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>若使用 <strong>Callable</strong> 介面實作物件作為 <code>ExecutorService</code> 的執行工作內容，則用下例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">useCallable</span><span style="color:#f92672">(</span>ExecutorService es<span style="color:#f92672">,</span> Callable<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> callable<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Future<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> es<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>callable<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        V result <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ex<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p><code>ExecutorService.submit()</code> 方法傳入 Callable 實作物件時，可以回傳 <strong>Future</strong> 類別的物件</p>
</blockquote>
<p>&hellip;</p>
</li>
</ul>
<h3 id="使用-javautilconcurrentfuture">使用 <code>java.util.concurrent.Future</code></h3>
<ul>
<li>
<p>介面 <code>ExecutorService</code> 執行 Callable 工作後的回傳結果屬於 <code>Future&lt;V&gt;</code> class：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Future<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> es<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>callable<span style="color:#f92672">);</span>
</span></span></code></pre></div></li>
<li>
<p>但是真正工作結果隱藏在 Future 物件裡面，必須再呼叫 <code>get()</code> 去取得結果。回傳型態 <strong>V</strong> 必須和<code>Callable&lt;V&gt;</code>裡定義的泛型物件型態一致：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>V result <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span></code></pre></div></li>
<li>
<p>原因：main thread 在前景（foreground）執行工作，而不是 main 的 thread 都在背景（background）執行工作</p>
</li>
</ul>
<blockquote>
<p>🍪☕ <strong>Little Tips</strong></p>
<p>餐館內用座位 &amp; 外帶領取號碼牌</p>
<p>號碼牌：隱含一種「<strong>未來交貨</strong>」之意</p>
<table>
<thead>
<tr>
<th>noodle shop</th>
<th>java program</th>
</tr>
</thead>
<tbody>
<tr>
<td>「號碼牌」</td>
<td>Java 裡的 <code>Future</code> 物件</td>
</tr>
<tr>
<td>拿「麵」需要號碼牌</td>
<td>包含在 <code>Future</code> 裡的泛型物件，呼叫 <code>Future</code> 的 <code>get()</code> 方法可取得該泛型物件</td>
</tr>
<tr>
<td>「煮麵」</td>
<td><code>Callable</code> 介面裡的 <code>call()</code> 方法定義的內容</td>
</tr>
<tr>
<td>「煮麵的師傅」</td>
<td><code>ExecutorService</code>裡的執行緒</td>
</tr>
<tr>
<td>「餐館」</td>
<td><code>ExecutorService</code></td>
</tr>
<tr>
<td>「您」</td>
<td><code>main</code> 執行緒</td>
</tr>
</tbody>
</table>
<p>如果買東西需要等待，大部分商家<code>Executor Service</code> 都會給您一張號碼牌 <code>Future</code>，等時間差不多再回來領取（<code>get</code>）購買的真正商品。</p>
<p>領取號碼牌，使用 <code>Callable</code>。</p>
<p>不領取號碼牌，即是使用 <code>Runnable</code>。</p>
</blockquote>
<ul>
<li>呼叫 <code>Future.get()</code> 方法時，若結果尚未出爐，main 執行緒就會進入等待狀態，比較好的做法：
<ol>
<li>呼叫 <code>get()</code> 方法前，應該先丟出（<strong>submit</strong>）所有工作
<ul>
<li>因為呼叫 <code>get()</code>之後只能耐心等結果</li>
</ul>
</li>
<li>呼叫 <code>get()</code> 方法前也可以先呼叫 <code>isDone()</code>方法，確認是否工作完成</li>
</ol>
<ul>
<li>取貨前先打電話確認是否完成，以免到達後還需要等待</li>
<li>呼叫多載的另外一版本 <code>get(long timeout, TimeUnit unit)</code> 方法，明確指定等待時間</li>
</ul>
</li>
</ul>
<h3 id="關閉-executorservice">關閉 <code>ExecutorService</code></h3>
<ul>
<li>
<p>因為 <code>ExecutorService</code>所建立的執行緒都是 <strong>non-daemon</strong>，JVM 會因為這些執行緒存在，而導致永遠不會結束</p>
</li>
<li>
<p>若要結束程式，必須呼叫 <code>ExecutorService</code> 介面的 <code>shutdown()</code> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>es<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdown</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* shutdown() 方法會在所有執行緒工作都結束後，關閉 ExecutorService 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   並終止所有執行緒生命週期，讓程式結束  */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    es<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitTermination</span><span style="color:#f92672">(</span>5<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* 若已執行 shutdown() 指令，但執行緒工作結束後還是無法關閉，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       可以使用 awaitTermination(5, TimeUnit.SECONDS) 方法傳入等待時間，時間到後會強制關閉*/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stopped waiting early&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>    
</span></span></code></pre></div></li>
</ul>
<h3 id="executorservice完整範例"><code>ExecutorService</code>完整範例</h3>
<ul>
<li>
<p>應用 <code>Callable</code>介面和<code>Future</code>類別的 <code>ExecutorService</code>使用方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CallableTask</span> <span style="color:#66d9ef">implements</span> Callable<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">call</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>20000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: finish job&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: done&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExecutorServiceTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ExecutorService es <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newCacheThreadPool</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ExecutorService es = Executors.newFixedThreadPool(5);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        Callable<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> task <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CallableTask<span style="color:#f92672">();</span> <span style="color:#75715e">// 建立Callable實作物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Future<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> es<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>task<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 讓es分派執行緒進行Callable實作物件定義的工作內容，並取得號碼牌Future物件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">// line 17
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            String result <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ex<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#75715e">// ln17 ~ 22若呼叫get()方法時工作尚未結束，就會進入等待狀態
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        es<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdown</span><span style="color:#f92672">();</span> <span style="color:#75715e">// shutdown()在所有執行緒工作結束後，才關閉自己
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: service shutdown&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            es<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitTermination</span><span style="color:#f92672">(</span>5<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* 若已執行shutdown()，但所有執行緒工作結束後還是無法關閉，則可以使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">               awaitTermination(5,TimeUnit.SECONDS) 方法傳入等待時間，時間到後強制關閉*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stopped waiting early&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="executorservice-進階範例"><code>ExecutorService</code> 進階範例</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/lXaXD7Y.png"
        data-srcset="https://i.imgur.com/lXaXD7Y.png, https://i.imgur.com/lXaXD7Y.png 1.5x, https://i.imgur.com/lXaXD7Y.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/lXaXD7Y.png"
        title="image-20221221144232769" /></p>
<ul>
<li>Java Socket 程式架構提供網路世界兩台獨立主機上的 Java 程式互相連線的機制，一般分為
<ol>
<li><strong>主機端</strong>（server）：提供網路連線的程式</li>
<li><strong>用戶端</strong>（client）：要求網路連線的程式</li>
</ol>
</li>
<li>成功建立連線有以下條件：
<ol>
<li>主機端必須提供一個固定位置（包含 IP、port 號），用戶端要連接的話需要先知道這個位置
<ul>
<li><strong>IP</strong> : 網路世界的住址，可幫助用戶端在網際網路裡找到單一主機</li>
<li><strong>Port</strong> :
<ul>
<li>主機裡可能有諸多正在執行的程式，可用 post</li>
<li>可以是 0-65535 之間的任一整數，0-1024的port號已被作業系統保留</li>
<li>其它程式通常選擇1024之後的編號作為自己程式的 port 號</li>
</ul>
</li>
</ul>
</li>
<li>Java 的 Socket 主要使用 <code>ServerSocket</code> 以及 <code>Socket</code> 兩個類別
<ul>
<li>主機端用 <code>ServerSocket</code> 物件的 <strong>listen()</strong> 方法監聽來自用戶端的連線請求</li>
<li>用戶端用 <code>Socket</code> 物件和主機端做連接</li>
<li>主機端用 <code>ServerSocket</code> 物件的 <strong>accept()</strong> 方法來串接用戶端的 <code>Socket</code> 物件</li>
</ul>
</li>
<li>主機端和用戶端連接之後，就可以用以下方法來傳輸資料
<ul>
<li><code>Socket</code> 物件的 <code>getInputStream()</code></li>
<li><code>Socket</code> 物件的 <code>getOutputStream()</code></li>
</ul>
</li>
<li>資料傳輸完成後，記得呼叫 <code>Socket</code> 物件的 <code>close()</code> 方法結束相關資源</li>
</ol>
</li>
</ul>
<h4 id="範例一socketserversstartupjava-扮演主機端程式的角色">範例一：<code>SocketServersStartup.java</code> 扮演主機端程式的角色</h4>
<ul>
<li>
<p>啟動五個執行緒，分別使用 port# 10000 - 10004 扮演主機端角色，等待/傾聽用戶端連線的要求</p>
</li>
<li>
<p>如果用戶端連線成功，主機端在停頓五秒後，將輸出 <code>feedback_from_port 號</code> 的訊息給客戶端</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocketServerStartup</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> port <span style="color:#f92672">=</span> 10000<span style="color:#f92672">;</span> port <span style="color:#f92672">&lt;</span> 10005<span style="color:#f92672">;</span> port<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MySocketServer<span style="color:#f92672">(</span>port<span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MySocketServer</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> port<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    MySocketServer<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> port<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Server &#34;</span> <span style="color:#f92672">+</span> port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: Listening...&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 聆聽 port 是否被呼叫
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                ServerSocket serverSock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerSocket<span style="color:#f92672">(</span>port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 取得 Socket 連線
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                Socket clientSock <span style="color:#f92672">=</span> serverSock<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 暫停 5 秒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>5000<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 輸出訊息給 Socket 的用戶端
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                PrintWriter pw <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PrintWriter<span style="color:#f92672">(</span>clientSock<span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputStream</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                pw<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;feedback_from_&#34;</span> <span style="color:#f92672">+</span> port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 關閉 Socket 網路連線
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                serverSock<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                clientSock<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="範例二--建立類別-singlethreadtest-驗證使用單一執行緒依序訪問五個-socket-主機">範例二 : 建立類別 <code>SingleThreadTest</code> 驗證使用單一執行緒依序訪問五個 Socket 主機</h4>
<ul>
<li>使用單一執行緒逐 port 連線主機的結果，必須使用 <code>5sec * 5 = 25sec</code> 的時間</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SingleThread starts at: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    String host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> port <span style="color:#f92672">=</span> 10000<span style="color:#f92672">;</span> port <span style="color:#f92672">&lt;</span> 10005<span style="color:#f92672">;</span> port<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>Socket sock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Socket<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> port<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>               Scanner scanner <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Scanner<span style="color:#f92672">(</span>sock<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">());)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String feedback <span style="color:#f92672">=</span> scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Call &#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> port <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#e6db74">&#34;, and get: &#34;</span> <span style="color:#f92672">+</span> feedback <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; at &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchElementException <span style="color:#f92672">|</span> IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            out<span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Error talking to &#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="範例三--建立類別-socketclientcallable-實作-callable-介面">範例三 : 建立類別 <code>SocketClientCallable</code> 實作 <code>Callable</code> 介面</h4>
<ul>
<li>用以定義多執行緒訪問 <code>Socket</code> 主機的工作內容</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocketClientCallable</span> <span style="color:#66d9ef">implements</span> Callable<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String host<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SocketClientCallable</span><span style="color:#f92672">(</span>String host<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> host<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> port<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">call</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>Socket sock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Socket<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>              Scanner scanner <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Scanner<span style="color:#f92672">(</span>sock<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">());</span> <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String feedback <span style="color:#f92672">=</span> scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> feedback<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="範例四--建立類別-multithreadtest-驗證使用多執行緒訪問-5-個-socket-主機的情況">範例四 : 建立類別 <code>MultiThreadTest</code> 驗證使用多執行緒訪問 5 個 Socket 主機的情況</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MultiThreadTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MultiThreadTest starts at: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        ExecutorService es <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newCachedThreadPool</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        String host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> Future<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span> callables <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 依不同 port 號送出callable工作給執行緒池執行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> prot <span style="color:#f92672">=</span> 10000<span style="color:#f92672">;</span> port <span style="color:#f92672">&lt;</span> 10005<span style="color:#f92672">;</span> port<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            SockeClientCallable callable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SocketClientCallable<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span> port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Future<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> es<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>callable<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 定義future物件承接執行結果,但先不呼叫get()方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            callables<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>port<span style="color:#f92672">,</span> future<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 將future物件先存在callables，以Integer型別的port作為鍵值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 關閉 ExecutorService
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        es<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdown</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            es<span style="color:#f92672">.</span><span style="color:#a6e22e">awaitTermination</span><span style="color:#f92672">(</span>5<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stopped waiting &#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 取回結果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Integer port <span style="color:#f92672">:</span> callables<span style="color:#f92672">.</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">// ln 26
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Future<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> callables<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                String feedback <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Call &#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, and get: &#34;</span> <span style="color:#f92672">+</span> feedback <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; at &#34;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException <span style="color:#f92672">|</span> InterruptedException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Error talking to &#34;</span> <span style="color:#f92672">+</span> host <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#75715e">// ln 26~: 在callables中找出所有Future物件，並呼叫get()取回結果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>&hellip;</p>
<h2 id="使用-fork-join-框架同時執行多樣工作">使用 Fork-Join 框架同時執行多樣工作</h2>
<h3 id="平行處理的策略">平行處理的策略</h3>
<ul>
<li>
<p>為了使多個CPU運算效能最佳化，可以讓程式同時執行工作，「平行處理（<code>parallelism</code>）」策略很重要</p>
<ol>
<li>
<p>將工作分切成小段，各自完成後工作就可以解決</p>
<ul>
<li>稱為 <code>divide and conquer</code> 處理策略</li>
<li>使用前需確認這些小段工作可以平行處理</li>
</ul>
</li>
<li>
<p>分割時注意硬體效能問題，切割太細可能有反效果</p>
<ul>
<li>
<p>如果工作內容需要大量 CPU 計算而非 I/O 存取，需考慮 CPU 數量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">availableProcessors</span><span style="color:#f92672">();</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
<blockquote>
<p>平行處理策略第一步：切割資料讓多執行緒可以平行執行</p>
<p>如何切割？</p>
<p>最理想情況：讓所有 CPU 可以充分被所有執行緒利用，直到工作結束</p>
</blockquote>
</li>
</ul>
<h4 id="使用平均分配方式發揮-cpu-計算量能">使用「平均分配」方式發揮 CPU 計算量能</h4>
<ul>
<li>讓每一個執行緒各自占用不同的 CPU 處理相同分量的工作，容易因為以下原因導致無法發揮硬體最高性能
<ol>
<li>每一個 CPU 可能效率不同</li>
<li>某些 CPU 可能也在執行其它程式</li>
</ol>
</li>
<li>讓十位同學打掃相同面積的空地，因為每個人效率不同，不會同時完成</li>
</ul>
<h4 id="使用工作竊取方式發揮-cpu-計算量能">使用「工作竊取」方式發揮 CPU 計算量能</h4>
<ul>
<li>稱為「工作竊取」的平行運算架構：平均切割工作，但數量遠多於執行緒個數
<ol>
<li>工作不會馬上完成，每一個執行緒會有很多待辦工作在自己的佇列</li>
<li>若某執行緒已完成自己的工作，可以竊取其它人的工作</li>
<li>合適的切割份量不容易達成
<ul>
<li>切太多：切割本身即是負擔</li>
<li>切太少：無法充分利用 CPU 資源</li>
</ul>
</li>
<li>能者多勞理念的實踐 — Java 7 推出 <code>Fork-Join</code>框架</li>
</ol>
</li>
</ul>
<h3 id="套用-fork-join-框架">套用 <code>Fork-Join</code> 框架</h3>
<h4 id="範例一使用單一執行緒處理">範例一：使用單一執行緒處理</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SingleThreadTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">maind</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span><span style="color:#f92672">[]</span> bigData <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">[</span>1024 <span style="color:#f92672">*</span> 1024 <span style="color:#f92672">*</span> 256<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> bigData<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            bigData<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> ThreadLocalRandom<span style="color:#f92672">.</span><span style="color:#a6e22e">current</span><span style="color:#f92672">().</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> max <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> value <span style="color:#f92672">:</span> bigData<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>value <span style="color:#f92672">&gt;</span> max<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                max <span style="color:#f92672">=</span> value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Found max value: &#34;</span> <span style="color:#f92672">+</span> max<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="範例二使用-fork-join-框架平行處理">範例二：使用 <code>Fork-Join</code> 框架平行處理</h4>
<ul>
<li>
<p><code>ExecutorService</code>使用 cached thread pool 或 fixed thread pool 執行 <code>Callable</code> 介面定義的工作內容</p>
</li>
<li>
<p><code>Fork-Join</code> 框架則可以直接使用 <code>ExecutorService</code> 特化的子類別 <code>java.util.concurrent.ForkJoinPool</code> 執行抽象類別 <code>java.util.concurrent.ForkJoinTask&lt;V&gt;</code> 定義的工作內容</p>
<ol>
<li>
<p><code>ForkJoinTask</code>物件代表需要執行的工作，可解釋為分進合擊</p>
<ul>
<li>一開始分頭進行，逐漸會師合併結果</li>
</ul>
</li>
<li>
<p><code>ForkJoinTask</code>物件包含要處理的資料和處理方式，類似 <code>Runnable</code> 以及 <code>Callable</code></p>
</li>
<li>
<p>巨大量工作可以由 Fork-Join pool 內少數執行緒處理</p>
<ul>
<li>每個執行緒會工作滿檔，可以發揮硬體的極致性能</li>
</ul>
</li>
<li>
<p>開發者通常繼承 <code>ForkJoinTask</code>子類別，再實作 <code>compute()</code> 方法</p>
<ul>
<li>
<p><code>RecursiveAction</code> 的 <em>compute()</em> 方法沒有回傳結果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RecursiveAction</span> <span style="color:#66d9ef">extends</span> ForkJoinTask<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">compute</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>RecursiveTask</code> 的 <em>compute()</em> 方法需要回傳結果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RecursiveTask</span><span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> ForkJoinTask<span style="color:#f92672">&lt;</span>V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> V <span style="color:#a6e22e">compute</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ol>
</li>
</ul>
<h4 id="方法-compute-的處理邏輯">方法 <code>compute()</code> 的處理邏輯</h4>
<ul>
<li>
<p>建立類別 <code>FindMaxTask</code> 繼承 <code>RecursiveTask</code>，使用 <code>Fork-Join</code> 框架在 <code>1G</code> 的 <code>int</code> 陣列裡找出最大的數字</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> RESULT <span style="color:#a6e22e">compute</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>    <span style="color:#75715e">// pseudocode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DATA_SMALL_ENOUGH<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        PROCESS_DATA
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> RESULT<span style="color:#f92672">;</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SPLIT_DATA_INTO_LEFT_AND_RIGHT_PARTS
</span></span><span style="display:flex;"><span>        TASK t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TASK<span style="color:#f92672">(</span>LEFT_DATA<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 建立一個稱為t1的ForkJoinTask處理左半部工作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        t1<span style="color:#f92672">.</span><span style="color:#a6e22e">fork</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 呼叫 t1.fork() 做非同步處理（分進、分頭行事）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        TASK t2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TASK<span style="color:#f92672">(</span>RIGHT_DATA<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 建立另一個稱為t2的ForkJoinTask處理右半部工作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> COMBINE<span style="color:#f92672">(</span>t2<span style="color:#f92672">.</span><span style="color:#a6e22e">compute</span><span style="color:#f92672">(),</span> t1<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h5 id="圖解分進合擊">圖解分進合擊</h5>
<ol>
<li>
<p>原始資料處理量太大，分兩部分派給 <code>t1</code>、<code>t2</code>兩個 <code>ForkJoinTask</code></p>
</li>
<li>
<p>呼叫方法：</p>
<ul>
<li>
<p><strong>分進</strong> : 呼叫 <code>t1.fork()</code> 方法調用一個執行緒處理資料</p>
<p><strong>合擊</strong> : 呼叫 <code>join()</code> 時取回結果
→ 目前累計一個計算結果未取回</p>
</li>
<li>
<p>呼叫 <code>t2.compute()</code>時候，若資料處理量仍太大，持續進行切割工作</p>
</li>
</ul>
</li>
<li>
<p>累計 2 個計算結果未取回</p>
</li>
<li></li>
</ol>
<h3 id="fork-join-框架的使用建議"><code>Fork-Join</code> 框架的使用建議</h3>
<p>Fork-Join 框架幾個需要注意的地方：</p>
<ol>
<li>預設每核 CPU 會建立一個對應的執行緒執行工作</li>
<li>使用時應該先排除 <code>I/O</code> 或是其它可能卡住執行緒工作的瓶頸</li>
<li>了解自己的硬體
<ul>
<li><strong>單個 CPU 時，使用 Fork-Join 框架反而會比較慢</strong></li>
<li>有些 CPU 只使用單核時，會比使用多核快，因此使用 Fork-Join 框架的成效感覺更少</li>
</ul>
</li>
<li>相較於單一執行緒的循序執行，<strong>平行執行會有先切割工作的額外負擔，延長執行時間</strong></li>
</ol>
<hr>
<h1 id="07-使用-jdbc-建立資料庫連線">07 使用 JDBC 建立資料庫連線</h1>
<h2 id="了解-databasedbms-和-sql">了解 Database、DBMS 和 SQL</h2>
<h2 id="eclipse-連線並存取資料庫">Eclipse 連線並存取資料庫</h2>
<h2 id="使用-jdbc">使用 JDBC</h2>
<h2 id="jdbc-進行交易">JDBC 進行交易</h2>
<h2 id="使用-jdbc-41-的-rowsetprovider-和-rowsetfactory">使用 JDBC 4.1 的 RowSetProvider 和 RowSetFactory</h2>
<hr>
<h1 id="08-java-的區域化-localization">08 Java 的區域化 <em>Localization</em></h1>
<h2 id="了解-java-的軟體區域化作法">了解 Java 的軟體區域化作法</h2>
<h2 id="使用-dateformat-類別提供日期的區域化顯示">使用 DateFormat 類別提供日期的區域化顯示</h2>
<h2 id="使用-numberformat-類別提供幣別區域化顯示">使用 NumberFormat 類別提供幣別區域化顯示</h2>
<hr>
<h1 id="09-lambda-表示式的應用">09 Lambda 表示式的應用</h1>
<h2 id="使用-lambda-表示式">使用 Lambda 表示式</h2>
<h2 id="使用內建的功能性介面">使用內建的功能性介面</h2>
<h2 id="在泛型內使用萬用字元">在泛型內使用萬用字元</h2>
<h2 id="使用其它內建的功能性介面">使用其它內建的功能性介面</h2>
<h2 id="使用方法參照">使用方法參照</h2>
<hr>
<h1 id="10-使用-stream-api">10 使用 <code>Stream API</code></h1>
<h2 id="建構者設計模式和方法鏈結">建構者設計模式和方法鏈結</h2>
<h2 id="使用-optional-類別">使用 Optional 類別</h2>
<h2 id="stream-api-介紹">Stream API 介紹</h2>
<h2 id="stream-api-操作">Stream API 操作</h2>
<h2 id="stream-api-和-nio2">Stream API 和 NIO.2</h2>
<h2 id="stream-api-操作平行化">Stream API 操作平行化</h2>
<hr>
<h1 id="11-datetime-api">11 Date/Time API</h1>
<h2 id="date--time-相關類別的演進">Date &amp; Time 相關類別的演進</h2>
<h2 id="當地日期與時間">當地日期與時間</h2>
<h2 id="時區和日光節約時間">時區和日光節約時間</h2>
<h2 id="描述日期與時間的數量">描述日期與時間的數量</h2>
<hr>
<h1 id="12-標註型別-annotation">12 標註型別 <em>Annotation</em></h1>
<h2 id="認識標註型別">認識標註型別</h2>
<h2 id="建立自定義標註型別">建立自定義標註型別</h2>
<h2 id="標註型別的應用">標註型別的應用</h2>
<h2 id="自定義標註型別時使用的內建標註型別">自定義標註型別時使用的內建標註型別</h2>
<h2 id="開發一般程式碼經常使用的內建標註型別">開發一般程式碼經常使用的內建標註型別</h2>
<hr>
<h1 id="13-java-平台模組系統">13 Java 平台模組系統</h1>
<h2 id="認識-java-模組化">認識 Java 模組化</h2>
<h2 id="建立和執行模組化程式">建立和執行模組化程式</h2>
<h2 id="建立相依模組程式">建立相依模組程式</h2>
<h2 id="認識-module-infojava-的宣告關鍵字">認識 <code>module-info.java</code> 的宣告關鍵字</h2>
<h2 id="在命令列-command-line-使用模組指令選項">在命令列 <code>command line</code> 使用模組指令選項</h2>
<hr>
<h1 id="14-模組化應用程式">14 模組化應用程式</h1>
<h2 id="回顧模組指令">回顧模組指令</h2>
<h2 id="比較模組類型">比較模組類型</h2>
<h2 id="分析-jdk-依賴關係">分析 JDK 依賴關係</h2>
<h2 id="模組化既有應用程式">模組化既有應用程式</h2>
<h2 id="模組化-java-服務結構">模組化 Java 服務結構</h2>
<hr>
<h1 id="15-開發安全的-java-程式">15 開發安全的 Java 程式</h1>
<h2 id="設計安全物件">設計安全物件</h2>
<h2 id="注入-injection-攻擊與輸入-input-驗證">注入 <em>injection</em> 攻擊與輸入 <em>input</em> 驗證</h2>
<h2 id="處理機敏資訊">處理機敏資訊</h2>
<h2 id="序列化與反序列化物件">序列化與反序列化物件</h2>
<h2 id="建立保護機敏資料的安全物件">建立保護機敏資料的安全物件</h2>
<h2 id="避免服務阻斷-denial-of-service-攻擊">避免服務阻斷 <em>denial of service</em> 攻擊</h2>
<hr>
<h1 id="16-mock-exam--analysis">16 Mock exam &amp; analysis</h1>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-12-18</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)" data-via="cel_yi" data-hashtags="Java,1Z0-819"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-hashtag="Java"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://wysiwyz.github.io/posts/ocpjp_11_2/" data-title="1Z0-819 曾師筆記 (2/duology)"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/java/">Java</a>,&nbsp;<a href="/tags/1z0-819/">1Z0-819</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/ocpjp_11/" class="prev" rel="prev" title="1Z0-819 曾師筆記 (1/duology)"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>1Z0-819 曾師筆記 (1/duology)</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">strict with yourself; lenient with others.</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-CCS3QPVY5N', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-CCS3QPVY5N" async></script></body>
</html>
