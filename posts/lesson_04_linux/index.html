<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Lesson 04: Linux 筆記 - CA憑證、SELinux - Ich bin yiwen.</title><meta name="Description" content="An ordinary space for storing and groups pieces of articles."><meta property="og:url" content="http://localhost:1313/posts/lesson_04_linux/">
  <meta property="og:site_name" content="Ich bin yiwen.">
  <meta property="og:title" content="Lesson 04: Linux 筆記 - CA憑證、SELinux">
  <meta property="og:description" content="Strict Transport Security (HSTS) Apache Nginx HTTPS 加密流程 Client 連到 Server 時，Server 將 Public key 傳給 Client Client 使用 Public key 產生隨機碼，和 Server 建立加密通道。 Client 用 Public key 進行傳輸資料加解密，Server 用 Private key 進行傳輸資料加解密 實際的資料使用對稱式加密方式，透過已經建好的加密通道進行傳輸 https 使用了非對稱式與對稱式加密 Khoor, Olqxa 怎麼在廣大的領域中發現小小的弱點，突破當前使用之演算法的弱點 – Dr. Mathematics
凱薩加密演算法
字母位移預設三個字 @Desktop
1 2 root# mkdir demo; cd demo/ root# vi caesar-cipher.sh shellscript
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 #!">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-08T09:15:16+08:00">
    <meta property="article:modified_time" content="2023-04-08T09:15:16+08:00">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Security">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Lesson 04: Linux 筆記 - CA憑證、SELinux">
  <meta name="twitter:description" content="Strict Transport Security (HSTS) Apache Nginx HTTPS 加密流程 Client 連到 Server 時，Server 將 Public key 傳給 Client Client 使用 Public key 產生隨機碼，和 Server 建立加密通道。 Client 用 Public key 進行傳輸資料加解密，Server 用 Private key 進行傳輸資料加解密 實際的資料使用對稱式加密方式，透過已經建好的加密通道進行傳輸 https 使用了非對稱式與對稱式加密 Khoor, Olqxa 怎麼在廣大的領域中發現小小的弱點，突破當前使用之演算法的弱點 – Dr. Mathematics
凱薩加密演算法
字母位移預設三個字 @Desktop
1 2 root# mkdir demo; cd demo/ root# vi caesar-cipher.sh shellscript
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 #!">
<meta name="application-name" content="Ich bin yiwen.">
<meta name="apple-mobile-web-app-title" content="Ich bin yiwen."><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/moon_icon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/posts/lesson_04_linux/" /><link rel="prev" href="http://localhost:1313/posts/suzume_no_tojimari/" /><link rel="next" href="http://localhost:1313/posts/cascading_style_sheet/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Lesson 04: Linux 筆記 - CA憑證、SELinux",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/posts\/lesson_04_linux\/"
        },"genre": "posts","keywords": "linux, security","wordcount":  2830 ,
        "url": "http:\/\/localhost:1313\/posts\/lesson_04_linux\/","datePublished": "2023-04-08T09:15:16+08:00","dateModified": "2023-04-08T09:15:16+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "celine"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Ich bin yiwen.">Ich bin yiwen.</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Lesson 04: Linux 筆記 - CA憑證、SELinux</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>celine</a></span>&nbsp;<span class="post-category">included in <a href="/categories/studynote/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>StudyNote</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-04-08">2023-04-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2830 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;14 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#strict-transport-security-hsts">Strict Transport Security (HSTS)</a></li>
        <li><a href="#https-加密流程">HTTPS 加密流程</a></li>
        <li><a href="#khoor-olqxa">Khoor, Olqxa</a></li>
        <li><a href="#演算法與選擇">演算法與選擇</a></li>
        <li><a href="#弱演算法應完全不用">弱演算法應完全不用?</a></li>
        <li><a href="#非對稱式加密">非對稱式加密</a></li>
        <li><a href="#對稱式加密">對稱式加密</a></li>
        <li><a href="#憑證特性">憑證特性</a></li>
        <li><a href="#憑證架構">憑證架構</a></li>
        <li><a href="#根憑證說明">根憑證說明</a></li>
        <li><a href="#查看憑證內容">查看憑證內容</a></li>
        <li><a href="#建立內部pki">建立內部PKI</a></li>
        <li><a href="#selinux-簡述">SELinux 簡述</a></li>
        <li><a href="#檔案與目錄權限">檔案與目錄權限</a></li>
        <li><a href="#網路連接埠">網路連接埠</a></li>
        <li><a href="#apache-功能">Apache 功能</a></li>
        <li><a href="#selinux">SELinux</a></li>
      </ul>
    </li>
    <li><a href="#目標">目標</a></li>
    <li><a href="#ssh-改-port">SSH 改 Port</a></li>
    <li><a href="#apache-預設目錄">Apache 預設目錄</a></li>
    <li><a href="#apache-mount-nfs">Apache Mount NFS</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="strict-transport-security-hsts">Strict Transport Security (HSTS)</h3>
<h5 id="apache">Apache</h5>
<h5 id="nginx">Nginx</h5>
<hr>
<h3 id="https-加密流程">HTTPS 加密流程</h3>
<ul>
<li>Client 連到 Server 時，Server 將 Public key 傳給 Client</li>
<li>Client 使用 Public key 產生隨機碼，和 Server 建立加密通道。
<ul>
<li>Client 用 Public key 進行傳輸資料加解密，Server 用 Private key 進行傳輸資料加解密</li>
</ul>
</li>
<li>實際的資料使用對稱式加密方式，透過已經建好的加密通道進行傳輸</li>
<li>https 使用了非對稱式與對稱式加密</li>
</ul>
<hr>
<h3 id="khoor-olqxa">Khoor, Olqxa</h3>
<blockquote>
<p>怎麼在廣大的領域中發現小小的弱點，突破當前使用之演算法的弱點 &ndash; Dr. Mathematics</p>
</blockquote>
<p>凱薩加密演算法</p>
<ul>
<li>字母位移預設三個字</li>
</ul>
<p>@Desktop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# mkdir demo<span class="p">;</span> <span class="nb">cd</span> demo/
</span></span><span class="line"><span class="cl">root# vi caesar-cipher.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>shellscript</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl">#<span class="p">!</span><span class="sr">/bin/</span><span class="nx">bash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">宣告加密和解密時使用的位移表</span>
</span></span><span class="line"><span class="cl"><span class="nx">declare</span> <span class="p">-</span><span class="nx">A</span> <span class="nx">shift_table</span><span class="p">=(</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;a&#34;</span>]<span class="p">=</span><span class="s2">&#34;d&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;b&#34;</span>]<span class="p">=</span><span class="s2">&#34;e&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;c&#34;</span>]<span class="p">=</span><span class="s2">&#34;f&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;d&#34;</span>]<span class="p">=</span><span class="s2">&#34;g&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;e&#34;</span>]<span class="p">=</span><span class="s2">&#34;h&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;f&#34;</span>]<span class="p">=</span><span class="s2">&#34;i&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;g&#34;</span>]<span class="p">=</span><span class="s2">&#34;j&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;h&#34;</span>]<span class="p">=</span><span class="s2">&#34;k&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;i&#34;</span>]<span class="p">=</span><span class="s2">&#34;l&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;j&#34;</span>]<span class="p">=</span><span class="s2">&#34;m&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;k&#34;</span>]<span class="p">=</span><span class="s2">&#34;n&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;l&#34;</span>]<span class="p">=</span><span class="s2">&#34;o&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;m&#34;</span>]<span class="p">=</span><span class="s2">&#34;p&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;n&#34;</span>]<span class="p">=</span><span class="s2">&#34;q&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;o&#34;</span>]<span class="p">=</span><span class="s2">&#34;r&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;p&#34;</span>]<span class="p">=</span><span class="s2">&#34;s&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;q&#34;</span>]<span class="p">=</span><span class="s2">&#34;t&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;r&#34;</span>]<span class="p">=</span><span class="s2">&#34;u&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;s&#34;</span>]<span class="p">=</span><span class="s2">&#34;v&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;t&#34;</span>]<span class="p">=</span><span class="s2">&#34;w&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;u&#34;</span>]<span class="p">=</span><span class="s2">&#34;x&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;v&#34;</span>]<span class="p">=</span><span class="s2">&#34;y&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;w&#34;</span>]<span class="p">=</span><span class="s2">&#34;z&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;x&#34;</span>]<span class="p">=</span><span class="s2">&#34;a&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;y&#34;</span>]<span class="p">=</span><span class="s2">&#34;b&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;z&#34;</span>]<span class="p">=</span><span class="s2">&#34;c&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;A&#34;</span>]<span class="p">=</span><span class="s2">&#34;D&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;B&#34;</span>]<span class="p">=</span><span class="s2">&#34;E&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;C&#34;</span>]<span class="p">=</span><span class="s2">&#34;F&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;D&#34;</span>]<span class="p">=</span><span class="s2">&#34;G&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;E&#34;</span>]<span class="p">=</span><span class="s2">&#34;H&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;F&#34;</span>]<span class="p">=</span><span class="s2">&#34;I&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;G&#34;</span>]<span class="p">=</span><span class="s2">&#34;J&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;H&#34;</span>]<span class="p">=</span><span class="s2">&#34;K&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;I&#34;</span>]<span class="p">=</span><span class="s2">&#34;L&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;J&#34;</span>]<span class="p">=</span><span class="s2">&#34;M&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;K&#34;</span>]<span class="p">=</span><span class="s2">&#34;N&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;L&#34;</span>]<span class="p">=</span><span class="s2">&#34;O&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;M&#34;</span>]<span class="p">=</span><span class="s2">&#34;P&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;N&#34;</span>]<span class="p">=</span><span class="s2">&#34;Q&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;O&#34;</span>]<span class="p">=</span><span class="s2">&#34;R&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;P&#34;</span>]<span class="p">=</span><span class="s2">&#34;S&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;Q&#34;</span>]<span class="p">=</span><span class="s2">&#34;T&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;R&#34;</span>]<span class="p">=</span><span class="s2">&#34;U&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;S&#34;</span>]<span class="p">=</span><span class="s2">&#34;V&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;T&#34;</span>]<span class="p">=</span><span class="s2">&#34;W&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;U&#34;</span>]<span class="p">=</span><span class="s2">&#34;X&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;V&#34;</span>]<span class="p">=</span><span class="s2">&#34;Y&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;W&#34;</span>]<span class="p">=</span><span class="s2">&#34;Z&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;X&#34;</span>]<span class="p">=</span><span class="s2">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;Y&#34;</span>]<span class="p">=</span><span class="s2">&#34;B&#34;</span>
</span></span><span class="line"><span class="cl">  [<span class="s2">&#34;Z&#34;</span>]<span class="p">=</span><span class="s2">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">宣告加密和解密的函數</span>
</span></span><span class="line"><span class="cl"><span class="nx">encrypt</span><span class="p">()</span> {
</span></span><span class="line"><span class="cl">  <span class="nx">encrypted</span><span class="p">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">for</span> <span class="p">((</span> <span class="nx">i</span><span class="p">=</span><span class="m">0</span>; <span class="nx">i</span><span class="p">&lt;</span>${#<span class="m">1</span>}; <span class="nx">i</span><span class="p">++</span> <span class="p">))</span>; <span class="nx">do</span>
</span></span><span class="line"><span class="cl">    <span class="nx">char</span><span class="p">=</span><span class="s2">&#34;${1:$i:1}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> [[ $<span class="nx">char</span> <span class="p">=~</span> [<span class="nx">a</span><span class="p">-</span><span class="nx">zA</span><span class="p">-</span><span class="nx">Z</span>] ]]; <span class="nx">then</span>
</span></span><span class="line"><span class="cl">      <span class="nx">shifted_char</span><span class="p">=</span><span class="s2">&#34;${shift_table[$char]}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">encrypted</span><span class="p">=</span><span class="s2">&#34;$encrypted$shifted_char&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nx">encrypted</span><span class="p">=</span><span class="s2">&#34;$encrypted$char&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nx">done</span>
</span></span><span class="line"><span class="cl">  <span class="nx">echo</span> <span class="s2">&#34;$encrypted&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">decrypt</span><span class="p">()</span> {
</span></span><span class="line"><span class="cl">  <span class="nx">decrypted</span><span class="p">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">for</span> <span class="p">((</span> <span class="nx">i</span><span class="p">=</span><span class="m">0</span>; <span class="nx">i</span><span class="p">&lt;</span>${#<span class="m">1</span>}; <span class="nx">i</span><span class="p">++</span> <span class="p">))</span>; <span class="nx">do</span>
</span></span><span class="line"><span class="cl">    <span class="nx">char</span><span class="p">=</span><span class="s2">&#34;${1:$i:1}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> [[ $<span class="nx">char</span> <span class="p">=~</span> [<span class="nx">a</span><span class="p">-</span><span class="nx">zA</span><span class="p">-</span><span class="nx">Z</span>] ]]; <span class="nx">then</span>
</span></span><span class="line"><span class="cl">      <span class="nx">for</span> <span class="nx">shifted_char</span> <span class="nx">in</span> <span class="s2">&#34;${!shift_table[@]}&#34;</span>; <span class="nx">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> [[ ${<span class="nx">shift_table</span>[$<span class="nx">shifted_char</span>]} <span class="p">==</span> <span class="s2">&#34;$char&#34;</span> ]]; <span class="nx">then</span>
</span></span><span class="line"><span class="cl">          <span class="nx">decrypted</span><span class="p">=</span><span class="s2">&#34;$decrypted$shifted_char&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">break</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fi</span>
</span></span><span class="line"><span class="cl">      <span class="nx">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nx">decrypted</span><span class="p">=</span><span class="s2">&#34;$decrypted$char&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nx">done</span>
</span></span><span class="line"><span class="cl">  <span class="nx">echo</span> <span class="s2">&#34;$decrypted&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">判斷是要加密還是解密</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> [[ $# <span class="p">-</span><span class="nx">lt</span> <span class="m">2</span> ]]; <span class="nx">then</span>
</span></span><span class="line"><span class="cl">  <span class="nx">echo</span> <span class="s2">&#34;Usage: $0 (encrypt|decrypt) text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nx">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> [[ <span class="s2">&#34;$1&#34;</span> <span class="p">==</span> <span class="s2">&#34;encrypt&#34;</span> ]]; <span class="nx">then</span>
</span></span><span class="line"><span class="cl">  <span class="nx">encrypt</span> <span class="s2">&#34;${2}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">elif</span> [[ <span class="s2">&#34;$1&#34;</span> <span class="p">==</span> <span class="s2">&#34;decrypt&#34;</span> ]]; <span class="nx">then</span>
</span></span><span class="line"><span class="cl">  <span class="nx">decrypt</span> <span class="s2">&#34;${2}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="nx">echo</span> <span class="s2">&#34;Usage: $0 (encrypt|decrypt) text&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nx">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>chmod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# chmod +x caesar-cipher.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>加密字串</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ./caesar-cipher.sh decrypt <span class="s2">&#34;Khoor, Olqxa&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="演算法與選擇">演算法與選擇</h3>
<ul>
<li>大部分演算法為數學公式的集合</li>
<li>世界上沒有永遠破解不了的演算法，主要在於時間與算力</li>
<li>加密使用的演算法，應在不同目的選擇合適而非嚴謹的方法</li>
</ul>
<h3 id="弱演算法應完全不用">弱演算法應完全不用?</h3>
<ul>
<li>已經被證實容易被破解的演算法，而非不能用</li>
<li>MD5被認為是比較弱的演算法，但是是不是代表不能用？
<ul>
<li>檔案一致性</li>
<li>資訊內容遮罩</li>
<li>密碼加密</li>
</ul>
</li>
</ul>
<h3 id="非對稱式加密">非對稱式加密</h3>
<ul>
<li>可用演算法
<ul>
<li>SHA256/348</li>
<li>ECC</li>
<li>在Server, Client都支援的情況下，加密傳輸優先權：
<ul>
<li>ECDHE &gt; ECDH(Client) &gt; DH(Server提供dhparm)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="對稱式加密">對稱式加密</h3>
<ul>
<li>可用演算法
<ul>
<li>AES</li>
<li>ChaCha20</li>
<li>GCM</li>
</ul>
</li>
</ul>
<h3 id="憑證特性">憑證特性</h3>
<ul>
<li>憑證在資安的CIA上具有不可否認性</li>
</ul>
<h3 id="憑證架構">憑證架構</h3>
<pre tabindex="0"><code>根憑證(PKI, root) → 中繼憑證 → 終端憑證
   └─────────憑證鏈(chain)─────────┘
</code></pre><h3 id="根憑證說明">根憑證說明</h3>
<ul>
<li>預先儲存於作業系統中</li>
<li>可以透過系統更新修改可信任的憑證（經由憑證廠商申請）</li>
</ul>
<h5 id="憑證詳細資料">憑證詳細資料</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/OSu9VzW.png"
        data-srcset="https://i.imgur.com/OSu9VzW.png, https://i.imgur.com/OSu9VzW.png 1.5x, https://i.imgur.com/OSu9VzW.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/OSu9VzW.png"
        title="image-20230408111756496" /></p>
<hr>
<h3 id="查看憑證內容">查看憑證內容</h3>
<p>@Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# <span class="nb">cd</span> /etc/httpd/conf/ssl/
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# openssl x509 -in server58.linux.class.crt -text -noout
</span></span><span class="line"><span class="cl">Certificate:
</span></span><span class="line"><span class="cl">    Data:
</span></span><span class="line"><span class="cl">        ....
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Desktop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ <span class="nb">cd</span> /etc/pki/ca-trust/source/anchors/
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ openssl x509 -in ca.crt -text -noout
</span></span><span class="line"><span class="cl">Certificate:
</span></span><span class="line"><span class="cl">    Data:
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="建立內部pki">建立內部PKI</h3>
<h4 id="rootca-憑證設定檔">RootCA 憑證設定檔</h4>
<p>@Desktop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# <span class="nb">cd</span>
</span></span><span class="line"><span class="cl">root# mkdir ssl-ca
</span></span><span class="line"><span class="cl">root# <span class="nb">cd</span> ssl-ca
</span></span></code></pre></td></tr></table>
</div>
</div><p>建立 CA v3 設定檔案</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# vi v3.cfg
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"># <span class="nx">OpenSSL</span> <span class="nx">root</span> <span class="nx">CA</span> <span class="nx">configuration</span> <span class="nx">file</span>.
</span></span><span class="line"><span class="cl"># <span class="nx">Copy</span> <span class="nx">to</span> `<span class="sr">/root/</span><span class="nx">ca</span>/<span class="nx">openssl</span>.<span class="nx">cnf</span>`.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">ca</span> ]
</span></span><span class="line"><span class="cl"># `<span class="nx">man</span> <span class="nx">ca</span>`
</span></span><span class="line"><span class="cl"><span class="nx">default_ca</span> <span class="p">=</span> <span class="nx">CA_default</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">CA_default</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Directory</span> <span class="nx">and</span> <span class="nx">file</span> <span class="nx">locations</span>.
</span></span><span class="line"><span class="cl"><span class="nx">dir</span>               <span class="p">=</span> <span class="sr">/home/</span><span class="nx">centos</span><span class="sr">/tmp/</span><span class="nx">linuxclass</span>/<span class="nx">RootCA</span>
</span></span><span class="line"><span class="cl"><span class="nx">certs</span>             <span class="p">=</span> $<span class="nx">dir</span>/<span class="nx">certs</span>
</span></span><span class="line"><span class="cl"><span class="nx">crl_dir</span>           <span class="p">=</span> $<span class="nx">dir</span>/<span class="nx">crl</span>
</span></span><span class="line"><span class="cl"><span class="nx">new_certs_dir</span>     <span class="p">=</span> $<span class="nx">dir</span>/<span class="nx">newcerts</span>
</span></span><span class="line"><span class="cl"><span class="nx">database</span>          <span class="p">=</span> $<span class="nx">dir</span>/<span class="nx">index</span>.<span class="nx">txt</span>
</span></span><span class="line"><span class="cl"><span class="nx">serial</span>            <span class="p">=</span> $<span class="nx">dir</span>/<span class="nx">serial</span>
</span></span><span class="line"><span class="cl"><span class="nx">RANDFILE</span>          <span class="p">=</span> $<span class="nx">dir</span><span class="sr">/private/</span>.<span class="nx">rand</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">The</span> <span class="nx">root</span> <span class="nx">key</span> <span class="nx">and</span> <span class="nx">root</span> <span class="nx">certificate</span>.
</span></span><span class="line"><span class="cl"><span class="nx">private_key</span>       <span class="p">=</span> $<span class="nx">dir</span><span class="sr">/private/</span><span class="nx">ca</span>.<span class="nx">key</span>.<span class="nx">pem</span>
</span></span><span class="line"><span class="cl"><span class="nx">certificate</span>       <span class="p">=</span> $<span class="nx">dir</span><span class="sr">/certs/</span><span class="nx">ca</span>.<span class="nx">cert</span>.<span class="nx">pem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">For</span> <span class="nx">certificate</span> <span class="nx">revocation</span> <span class="nx">lists</span>.
</span></span><span class="line"><span class="cl"><span class="nx">crlnumber</span>         <span class="p">=</span> $<span class="nx">dir</span>/<span class="nx">crlnumber</span>
</span></span><span class="line"><span class="cl"><span class="nx">crl</span>               <span class="p">=</span> $<span class="nx">dir</span><span class="sr">/crl/</span><span class="nx">ca</span>.<span class="nx">crl</span>.<span class="nx">pem</span>
</span></span><span class="line"><span class="cl"><span class="nx">crl_extensions</span>    <span class="p">=</span> <span class="nx">crl_ext</span>
</span></span><span class="line"><span class="cl"><span class="nx">default_crl_days</span>  <span class="p">=</span> <span class="m">30</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">SHA</span><span class="m">-1</span> <span class="nx">is</span> <span class="nx">deprecated</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">use</span> <span class="nx">SHA</span><span class="m">-2</span> <span class="nx">instead</span>.
</span></span><span class="line"><span class="cl"><span class="nx">default_md</span>        <span class="p">=</span> <span class="nx">sha256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">name_opt</span>          <span class="p">=</span> <span class="nx">ca_default</span>
</span></span><span class="line"><span class="cl"><span class="nx">cert_opt</span>          <span class="p">=</span> <span class="nx">ca_default</span>
</span></span><span class="line"><span class="cl"><span class="nx">default_days</span>      <span class="p">=</span> <span class="m">7500</span>
</span></span><span class="line"><span class="cl"><span class="nx">preserve</span>          <span class="p">=</span> <span class="nx">no</span>
</span></span><span class="line"><span class="cl"><span class="nx">policy</span>            <span class="p">=</span> <span class="nx">policy_strict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">policy_strict</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">The</span> <span class="nx">root</span> <span class="nx">CA</span> <span class="nx">should</span> <span class="nx">only</span> <span class="nx">sign</span> <span class="nx">intermediate</span> <span class="nx">certificates</span> <span class="nx">that</span> <span class="nx">match</span>.
</span></span><span class="line"><span class="cl"># <span class="nx">See</span> <span class="nx">the</span> <span class="nx">POLICY</span> <span class="nx">FORMAT</span> <span class="nx">section</span> <span class="nx">of</span> `<span class="nx">man</span> <span class="nx">ca</span>`.
</span></span><span class="line"><span class="cl"><span class="nx">countryName</span>             <span class="p">=</span> <span class="nx">match</span>
</span></span><span class="line"><span class="cl"><span class="nx">stateOrProvinceName</span>     <span class="p">=</span> <span class="nx">match</span>
</span></span><span class="line"><span class="cl"><span class="nx">organizationName</span>        <span class="p">=</span> <span class="nx">match</span>
</span></span><span class="line"><span class="cl"><span class="nx">organizationalUnitName</span>  <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl"><span class="nx">commonName</span>              <span class="p">=</span> <span class="nx">supplied</span>
</span></span><span class="line"><span class="cl"><span class="nx">emailAddress</span>            <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">policy_loose</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Allow</span> <span class="nx">the</span> <span class="nx">intermediate</span> <span class="nx">CA</span> <span class="nx">to</span> <span class="nx">sign</span> <span class="nx">a</span> <span class="nx">more</span> <span class="nx">diverse</span> <span class="nx">range</span> <span class="nx">of</span> <span class="nx">certificates</span>.
</span></span><span class="line"><span class="cl"># <span class="nx">See</span> <span class="nx">the</span> <span class="nx">POLICY</span> <span class="nx">FORMAT</span> <span class="nx">section</span> <span class="nx">of</span> <span class="nx">the</span> `<span class="nx">ca</span>` <span class="nx">man</span> <span class="nx">page</span>.
</span></span><span class="line"><span class="cl"><span class="nx">countryName</span>             <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl"><span class="nx">stateOrProvinceName</span>     <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl"><span class="nx">localityName</span>            <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl"><span class="nx">organizationName</span>        <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl"><span class="nx">organizationalUnitName</span>  <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl"><span class="nx">commonName</span>              <span class="p">=</span> <span class="nx">supplied</span>
</span></span><span class="line"><span class="cl"><span class="nx">emailAddress</span>            <span class="p">=</span> <span class="nx">optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">req</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Options</span> <span class="nx">for</span> <span class="nx">the</span> `<span class="nx">req</span>` <span class="nx">tool</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">req</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">default_bits</span>        <span class="p">=</span> <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="nx">distinguished_name</span>  <span class="p">=</span> <span class="nx">req_distinguished_name</span>
</span></span><span class="line"><span class="cl"><span class="nx">string_mask</span>         <span class="p">=</span> <span class="nx">utf8only</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">SHA</span><span class="m">-1</span> <span class="nx">is</span> <span class="nx">deprecated</span><span class="p">,</span> <span class="nx">so</span> <span class="nx">use</span> <span class="nx">SHA</span><span class="m">-2</span> <span class="nx">instead</span>.
</span></span><span class="line"><span class="cl"><span class="nx">default_md</span>          <span class="p">=</span> <span class="nx">sha256</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">Extension</span> <span class="nx">to</span> <span class="nx">add</span> <span class="nx">when</span> <span class="nx">the</span> <span class="p">-</span><span class="nx">x509</span> <span class="nx">option</span> <span class="nx">is</span> <span class="nx">used</span>.
</span></span><span class="line"><span class="cl"><span class="nx">x509_extensions</span>     <span class="p">=</span> <span class="nx">v3_ca</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">req_distinguished_name</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">See</span> <span class="p">&lt;</span><span class="nx">https</span>:<span class="sr">//</span><span class="nx">en</span>.<span class="nx">wikipedia</span>.<span class="nx">org</span><span class="sr">/wiki/</span><span class="nx">Certificate_signing_request</span><span class="p">&gt;</span>.
</span></span><span class="line"><span class="cl"><span class="nx">countryName</span>                     <span class="p">=</span> <span class="nx">Country</span> <span class="nx">Name</span> <span class="p">(</span><span class="m">2</span> <span class="nx">letter</span> <span class="nx">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">stateOrProvinceName</span>             <span class="p">=</span> <span class="nx">State</span> <span class="nx">or</span> <span class="nx">Province</span> <span class="nx">Name</span> <span class="p">(</span><span class="nx">full</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">localityName</span>                    <span class="p">=</span> <span class="nx">Locality</span> <span class="nx">Name</span> <span class="p">(</span><span class="nx">eg</span><span class="p">,</span> <span class="nx">city</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>.<span class="nx">organizationName</span>              <span class="p">=</span> <span class="nx">Organization</span> <span class="nx">Name</span> <span class="p">(</span><span class="nx">eg</span><span class="p">,</span> <span class="nx">company</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">organizationalUnitName</span>          <span class="p">=</span> <span class="nx">Organizational</span> <span class="nx">Unit</span> <span class="nx">Name</span> <span class="p">(</span><span class="nx">eg</span><span class="p">,</span> <span class="nx">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">commonName</span>                      <span class="p">=</span> <span class="nx">Common</span> <span class="nx">Name</span> <span class="p">(</span><span class="nx">eg</span><span class="p">,</span> <span class="nx">your</span> <span class="nx">name</span> <span class="nx">or</span> <span class="nx">your</span> <span class="nx">server</span>&#39;<span class="nx">s</span> <span class="nx">hostname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">emailAddress</span>                    <span class="p">=</span> <span class="nx">Email</span> <span class="nx">Address</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># <span class="nx">Optionally</span><span class="p">,</span> <span class="nx">specify</span> <span class="nx">some</span> <span class="nx">defaults</span>.
</span></span><span class="line"><span class="cl"><span class="nx">countryName_default</span>             <span class="p">=</span> <span class="nx">TW</span>
</span></span><span class="line"><span class="cl"><span class="nx">stateOrProvinceName_default</span>     <span class="p">=</span> <span class="nx">Zhongshan</span> <span class="nx">Dist</span>
</span></span><span class="line"><span class="cl"><span class="nx">localityName_default</span>            <span class="p">=</span> <span class="nx">Taipei</span> <span class="nx">City</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>.<span class="nx">organizationName_default</span>      <span class="p">=</span> <span class="nx">LinuxClass</span>
</span></span><span class="line"><span class="cl"><span class="nx">organizationalUnitName_default</span>  <span class="p">=</span> <span class="nx">Class</span>
</span></span><span class="line"><span class="cl"><span class="nx">emailAddress_default</span>            <span class="p">=</span> <span class="nx">ca</span>@<span class="nx">linux</span>.<span class="nx">class</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">v3_ca</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Extensions</span> <span class="nx">for</span> <span class="nx">a</span> <span class="nx">typical</span> <span class="nx">CA</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">x509v3_config</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">subjectKeyIdentifier</span> <span class="p">=</span> <span class="nx">hash</span>
</span></span><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span> <span class="p">=</span> <span class="nx">keyid</span>:<span class="nx">always</span><span class="p">,</span><span class="nx">issuer</span>
</span></span><span class="line"><span class="cl"><span class="nx">basicConstraints</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">CA</span>:<span class="nx">true</span>
</span></span><span class="line"><span class="cl"><span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">digitalSignature</span><span class="p">,</span> <span class="nx">cRLSign</span><span class="p">,</span> <span class="nx">keyCertSign</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">v3_intermediate_ca</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Extensions</span> <span class="nx">for</span> <span class="nx">a</span> <span class="nx">typical</span> <span class="nx">intermediate</span> <span class="nx">CA</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">x509v3_config</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">subjectKeyIdentifier</span> <span class="p">=</span> <span class="nx">hash</span>
</span></span><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span> <span class="p">=</span> <span class="nx">keyid</span>:<span class="nx">always</span><span class="p">,</span><span class="nx">issuer</span>
</span></span><span class="line"><span class="cl"><span class="nx">basicConstraints</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">CA</span>:<span class="nx">true</span><span class="p">,</span> <span class="nx">pathlen</span>:<span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">digitalSignature</span><span class="p">,</span> <span class="nx">cRLSign</span><span class="p">,</span> <span class="nx">keyCertSign</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">usr_cert</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Extensions</span> <span class="nx">for</span> <span class="nx">client</span> <span class="nx">certificates</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">x509v3_config</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">basicConstraints</span> <span class="p">=</span> <span class="nx">CA</span>:<span class="nx">FALSE</span>
</span></span><span class="line"><span class="cl"><span class="nx">nsCertType</span> <span class="p">=</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">email</span>
</span></span><span class="line"><span class="cl"><span class="nx">nsComment</span> <span class="p">=</span> <span class="s2">&#34;OpenSSL Generated Client Certificate&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">subjectKeyIdentifier</span> <span class="p">=</span> <span class="nx">hash</span>
</span></span><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span> <span class="p">=</span> <span class="nx">keyid</span><span class="p">,</span><span class="nx">issuer</span>
</span></span><span class="line"><span class="cl"><span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">nonRepudiation</span><span class="p">,</span> <span class="nx">digitalSignature</span><span class="p">,</span> <span class="nx">keyEncipherment</span>
</span></span><span class="line"><span class="cl"><span class="nx">extendedKeyUsage</span> <span class="p">=</span> <span class="nx">clientAuth</span><span class="p">,</span> <span class="nx">emailProtection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">server_cert</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Extensions</span> <span class="nx">for</span> <span class="nx">server</span> <span class="nx">certificates</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">x509v3_config</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">basicConstraints</span> <span class="p">=</span> <span class="nx">CA</span>:<span class="nx">FALSE</span>
</span></span><span class="line"><span class="cl"><span class="nx">nsCertType</span> <span class="p">=</span> <span class="nx">server</span>
</span></span><span class="line"><span class="cl"><span class="nx">nsComment</span> <span class="p">=</span> <span class="s2">&#34;OpenSSL Generated Server Certificate&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">subjectKeyIdentifier</span> <span class="p">=</span> <span class="nx">hash</span>
</span></span><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span> <span class="p">=</span> <span class="nx">keyid</span><span class="p">,</span><span class="nx">issuer</span>:<span class="nx">always</span>
</span></span><span class="line"><span class="cl"><span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">digitalSignature</span><span class="p">,</span> <span class="nx">keyEncipherment</span>
</span></span><span class="line"><span class="cl"><span class="nx">extendedKeyUsage</span> <span class="p">=</span> <span class="nx">serverAuth</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">crl_ext</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Extension</span> <span class="nx">for</span> <span class="nx">CRLs</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">x509v3_config</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span><span class="p">=</span><span class="nx">keyid</span>:<span class="nx">always</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ <span class="nx">ocsp</span> ]
</span></span><span class="line"><span class="cl"># <span class="nx">Extension</span> <span class="nx">for</span> <span class="nx">OCSP</span> <span class="nx">signing</span> <span class="nx">certificates</span> <span class="p">(</span>`<span class="nx">man</span> <span class="nx">ocsp</span>`<span class="p">)</span>.
</span></span><span class="line"><span class="cl"><span class="nx">basicConstraints</span> <span class="p">=</span> <span class="nx">CA</span>:<span class="nx">FALSE</span>
</span></span><span class="line"><span class="cl"><span class="nx">subjectKeyIdentifier</span> <span class="p">=</span> <span class="nx">hash</span>
</span></span><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span> <span class="p">=</span> <span class="nx">keyid</span><span class="p">,</span><span class="nx">issuer</span>
</span></span><span class="line"><span class="cl"><span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">digitalSignature</span>
</span></span><span class="line"><span class="cl"><span class="nx">extendedKeyUsage</span> <span class="p">=</span> <span class="nx">critical</span><span class="p">,</span> <span class="nx">OCSPSigning</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="產-ca-憑證">產 ca 憑證</h4>
<p>產生 CA Private/Public Key</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# openssl req -config v3.config -new -x509 -days <span class="m">7500</span> -keyout ca.key -out ca.crt
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ls -l
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="建立新憑證組">建立新憑證組</h4>
<p>建立用戶端 Private 與 Request 檔案</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# openssl req -nodes -newkey rsa:2048 -sha256 -keyout lab-server58.linux.class.key -nodes -utf8 -out lab-server58.linux.class.csr
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>CommonName 設定 lab-server58.linux.class</p>
</blockquote>
<h4 id="簽憑證">簽憑證</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# <span class="nb">cd</span> ~/ssl-ca
</span></span></code></pre></td></tr></table>
</div>
</div><p>設定簽證設定檔</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# vi csr-v3.cfg
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="nx">authorityKeyIdentifier</span><span class="p">=</span><span class="nx">keyid</span><span class="p">,</span><span class="nx">issuer</span>
</span></span><span class="line"><span class="cl"><span class="nx">basicConstraints</span><span class="p">=</span><span class="nx">CA</span>:<span class="nx">FALSE</span>
</span></span><span class="line"><span class="cl"><span class="nx">keyUsage</span> <span class="p">=</span> <span class="nx">digitalSignature</span><span class="p">,</span> <span class="nx">nonRepudiation</span><span class="p">,</span> <span class="nx">keyEncipherment</span><span class="p">,</span> <span class="nx">dataEncipherment</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用CA簽屬用戶端憑證</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# openssl x509 -req -days <span class="m">365</span> -in lab-server58.linux.class.csr -extfile csr-v3.cfg -CA ca.crt -CAkey ca.key -CAcreateserial -out lab-server58.linux.class.crt -sha256
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ls -l
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# cp lab-server58.crt /etc/httpd/conf/ssl
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>CA 簽 CSR，get CRT</p>
</blockquote>
<h4 id="套新憑證">套新憑證</h4>
<ol>
<li>
<p>將<code>lab-server58.linux.class.crt</code>與<code>lab-server58.linux.class.key</code>複製到<code>Server</code>
@Desktop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# <span class="nb">echo</span> <span class="s2">&#34;put lab-server58.linux.class.crt&#34;</span> <span class="p">|</span> sftp root@server58:/etc/httpd/conf/ssl/
</span></span><span class="line"><span class="cl">root# <span class="nb">echo</span> <span class="s2">&#34;put lab-server58.linux.class.key&#34;</span> <span class="p">|</span> sftp root@server58:/etc/httpd/conf/ssl/
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>參考 Apache + SSL 設定 Apache 憑證</p>
<blockquote>
<p>有重置的話要再裝一次 Apache &amp; SSL</p>
</blockquote>
</li>
</ol>
<h4 id="client-驗證">Client 驗證</h4>
<p>@Desktop</p>
<ol>
<li>
<p>把新的 ca.crt 放到 <code>/etc/pki/ca-trust/source/anchors/</code>，執行 update-ca-trust</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# <span class="nb">cd</span> ~/ssl-ca
</span></span><span class="line"><span class="cl">root# cp ca.crt /etc/pki/ca-trust/source/anchors/
</span></span><span class="line"><span class="cl">root# sudo update-ca-trust
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在 <code>/etc/hosts</code> 新增 lab-server58.linux.class 對應</p>
</li>
<li>
<p>FireFox:
<a href="https://lab-server58.linux.class/" target="_blank" rel="noopener noreffer ">https://lab-server58.linux.class</a></p>
</li>
</ol>
<hr>
<h3 id="selinux-簡述">SELinux 簡述</h3>
<ul>
<li>SELinux: 系統安全防禦的預設值</li>
<li>因為處理網頁無法開啟的問題更為複雜，所以一開始導入時，管理人員傾向於關閉SELinux，以讓服務正常運作</li>
</ul>
<p>本文使用 Apache <code>httpd</code> 服務來說明 SELinux 對於行程的影響，其邏輯也能在其它服務中適用。</p>
<p>有關於 SELinux 對 <code>httpd</code> 運作的影響，大致有如下範圍：</p>
<ul>
<li>目錄能否有權限存取</li>
<li>程式把檔案寫入指定的目錄位置</li>
<li>程式能否經由網路和別的系統服務交換資料</li>
<li><code>httpd</code> 能否在其它自訂的連埠服提供服務</li>
</ul>
<p>要處理 SELinux 對 httpd 的運作影響，必須先區分幾個類別：</p>
<ol>
<li>
<p>檔案與目錄權限</p>
<p>檔案或目錄只有在正確的 SELinux 安全標籤才可以操作。</p>
</li>
<li>
<p>網路連接埠</p>
<p>程式只有在 SELinux 允許的連接埠才能提供服務。</p>
</li>
<li>
<p>Apache 功能</p>
<p>針對服務所提供的特別功能，必須要在 SELinux 中設定開關才能使用。</p>
</li>
</ol>
<p>Apache 在 SELinux 中的關鍵字，多以 <code>http_</code> 字眼出現，在操作 SELinux 條入之前，大部份使用 <code>semanage</code> 與 <code>setsebool</code> 進行設定。<code>semenage</code> 為查修條件的工具，另一個則是用來開關 <code>httpd</code> 可用功能的開關。</p>
<p><code>semanage</code> 預設並不會安裝，主要是期望管理者能夠依標準原則來處理系統服務，比如檔案應放在預先設好的路徑而非另行指定。話雖如此仍可以另行設定 SELinux 條件來新增或修改其條件，讓系統管理更有彈性。</p>
<p>若要安裝 <code>semanage</code> 指令工具可以進行如下操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo dnf -y install policycoreutils-python-utils
</span></span></code></pre></td></tr></table>
</div>
</div><p>除了 <code>semanage</code> 之外，我們還需要 <code>sesearch</code> 工具來找出作業行程能夠存取目錄與檔案的相關資訊，<code>sesearch</code> 被收錄在 <code>setools-console</code> 套件中，使用下列方式可以將它安裝好：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo dnf install -y setools-console
</span></span></code></pre></td></tr></table>
</div>
</div><p>由於 SELinux 對於行程的規範非常多，在此小節上，僅針對檔案與目錄權限、網路連接埠與 Apaache 功能做示範。</p>
<h3 id="檔案與目錄權限">檔案與目錄權限</h3>
<p>檔案與目錄權限是受 SELinux 規範最多的部份，在設定 SELinux 政策之前，必須以行程為首往下找出可以用的標籤規則，再從這些規則中找出有哪些目錄是符合的。</p>
<p>使用下列方式找出有關 <code>httpd</code> 的 SELinux 標籤：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo ps -uxZ <span class="p">|</span> grep -w httpd
</span></span><span class="line"><span class="cl">system_u:system_r:httpd_t:s0    root     <span class="m">19053</span>  0.0  0.5 <span class="m">230556</span>  <span class="m">5352</span> ?        Ss    3月03   0:38 /usr/sbin/httpd -DFOREGROUND
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述結果中找到有關 <code>httpd</code> 行程所被設定的行程標籤為 <code>httpd_t</code>，接著再利用找出來的標籤找出所符合的行程可以存取哪些目錄檔案標籤，使用 <code>sesearch</code> 工具可以找出這些項目：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo sesearch -s httpd_t --allow
</span></span><span class="line"><span class="cl">~~ 以上略 ~~
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t : lnk_file <span class="o">{</span> <span class="nb">read</span> getattr <span class="o">}</span> <span class="p">;</span> 
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t : dir <span class="o">{</span> ioctl <span class="nb">read</span> getattr lock search open <span class="o">}</span> <span class="p">;</span> 
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t : file <span class="o">{</span> ioctl <span class="nb">read</span> getattr lock map open <span class="o">}</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">~~ 以下略 ~~
</span></span></code></pre></td></tr></table>
</div>
</div><p>因為找出的項目有成千上萬，但經由確認後可以發現有關 <code>httpd_sys_content_t</code> 可以針對目錄與檔案進行開啟的行為（<code>open</code>）。接下來我們可以使用 <code>httpd_sys_content_t</code> 為關鍵，找出符合該檔案標籤有哪些路徑。</p>
<p>使用 <code>semanage</code> 再指定的標簽可以找出相關資訊，如下範例所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo semanage fcontext -l <span class="p">|</span> grep httpd_sys_content_t
</span></span><span class="line"><span class="cl">/srv/<span class="o">([</span>^/<span class="o">]</span>*/<span class="o">)</span>?www<span class="o">(</span>/.*<span class="o">)</span>?                            all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/www<span class="o">(</span>/.*<span class="o">)</span>?                                     all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/etc/htdig<span class="o">(</span>/.*<span class="o">)</span>?                                   all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/srv/gallery2<span class="o">(</span>/.*<span class="o">)</span>?                                all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/lib/trac<span class="o">(</span>/.*<span class="o">)</span>?                                all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/lib/htdig<span class="o">(</span>/.*<span class="o">)</span>?                               all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/www/icons<span class="o">(</span>/.*<span class="o">)</span>?                               all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/glpi<span class="o">(</span>/.*<span class="o">)</span>?                              all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/htdig<span class="o">(</span>/.*<span class="o">)</span>?                             all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/drupal.*                                all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/z-push<span class="o">(</span>/.*<span class="o">)</span>?                            all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/www/svn/conf<span class="o">(</span>/.*<span class="o">)</span>?                            all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/icecast<span class="o">(</span>/.*<span class="o">)</span>?                           all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/lib/cacti/rra<span class="o">(</span>/.*<span class="o">)</span>?                           all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/ntop/html<span class="o">(</span>/.*<span class="o">)</span>?                         all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/nginx/html<span class="o">(</span>/.*<span class="o">)</span>?                        all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/doc/ghc/html<span class="o">(</span>/.*<span class="o">)</span>?                      all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/openca/htdocs<span class="o">(</span>/.*<span class="o">)</span>?                     all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/selinux-policy<span class="o">[</span>^/<span class="o">]</span>*/html<span class="o">(</span>/.*<span class="o">)</span>?          all files          system_u:object_r:httpd_sys_content_t:s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上找到的結果，就是預設可以放置網頁檔案的位置（如: <code>/var/www(/.*)?</code> 項目），這些位置可以讓 Apache 行程讀取目錄與檔案的內容。</p>
<h3 id="網路連接埠">網路連接埠</h3>
<p><code>httpd</code> 所能佔用的網路連接埠被 SELinux 的 <code>http_port_t</code> 所規範，必須在項目所允許的列表中才能夠啟用該連接埠，否則在 <code>httpd</code> 啟動的時候就會發生錯誤。</p>
<p>要檢查目前 <code>httpd</code> 被允許使用哪些連接埠，可以使用下列方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo semanage port -l <span class="p">|</span> grep http_port_t
</span></span><span class="line"><span class="cl">http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, <span class="m">9000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>從上列所顯示的連接埠中，除了眾所皆知的 80、443 之外，還包含了如 81、488⋯⋯等項目可以使用。</p>
<p>如果要增加可用連接埠，一樣必須使用 <code>semanage</code> 工具進行設定，為 <code>http_port_t</code> 標籤新增一個連接埠讓 <code>httpd</code> 可以使用。</p>
<p>假設預計要為 <code>http_port_t</code> 新增一個 tcp 8888 的連接埠，可以使用下列方式達成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo semanage port -a -p tcp <span class="m">8888</span> -t http_port_t
</span></span></code></pre></td></tr></table>
</div>
</div><p>完成後再重新列表一次，確認 tcp 8888 已經被加入到 <code>http_port_t</code> 標籤中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo semanage port -l <span class="p">|</span> grep http_port_t
</span></span><span class="line"><span class="cl">http_port_t                    tcp      8888, 80, 81, 443, 488, 8008, 8009, 8443, <span class="m">9000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完成之後，您可以在 <code>httpd</code> 的設定檔（如 <code>/etc/httpd/conf/httpd.conf</code>）中，將 Listen 8888 加入讓 <code>httpd</code> 可以使用 TCP/8888 的連接埠。</p>
<blockquote>
<p>若要刪除先前所指定的可用連接埠，將 <code>-a</code> 參數改為 <code>-d</code> 就可以將該項目刪除。</p>
</blockquote>
<h3 id="apache-功能">Apache 功能</h3>
<p>Apache 提供了多個功能，某些功能會被 SELinux 所規範，SELinux 將 Apache 的功能設成多個開關，若有必要時再開啟讓 Apache 能夠正常提供。</p>
<p>這些功能開啟與關閉的關鍵字為 <code>on</code> 與 <code>off</code>，使用 <code>boolean</code> 的型態所指示。</p>
<p>若要顯示 SELinux 規範的 Apache 功能有哪些，可以使用 <code>semanager</code> 來檢視：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo semanage boolean -l <span class="p">|</span> grep -w httpd
</span></span><span class="line"><span class="cl">httpd_can_network_relay        <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to can network relay
</span></span><span class="line"><span class="cl">httpd_can_connect_mythtv       <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to can connect mythtv
</span></span><span class="line"><span class="cl">httpd_can_network_connect_db   <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to can network connect db
</span></span><span class="line"><span class="cl">httpd_use_gpg                  <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to use gpg
</span></span><span class="line"><span class="cl">httpd_dbus_sssd                <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to dbus sssd
</span></span><span class="line"><span class="cl">httpd_enable_cgi               <span class="o">(</span>on   ,   on<span class="o">)</span>  Allow httpd to <span class="nb">enable</span> cgi
</span></span><span class="line"><span class="cl">httpd_verify_dns               <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to verify dns
</span></span><span class="line"><span class="cl">httpd_dontaudit_search_dirs    <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to dontaudit search <span class="nb">dirs</span>
</span></span><span class="line"><span class="cl">httpd_use_cifs                 <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to use cifs
</span></span><span class="line"><span class="cl">httpd_manage_ipa               <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow httpd to manage ipa
</span></span><span class="line"><span class="cl">~~ 以下略 ~~
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上所列的訊息中，在第 2 欄位使用括弧所包起來的項目，分別為 <strong>現行狀態</strong> 與 <strong>預設值</strong>。假設要讓 <code>httpd</code> 可以使用 cifs 協定進行檔案存取，那麼就必須把 <code>httpd_use_cifs</code> 設定為 <code>on</code>。</p>
<p>設定 SELinux boolean 可以使用 <code>setsebool</code> 工具進行設定：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo setsebool httpd_use_cifs on
</span></span></code></pre></td></tr></table>
</div>
</div><p>完成後再次檢查 <code>httpd_use_cifs</code> 是否被正確設定：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo  semanage boolean -l <span class="p">|</span> grep -w httpd <span class="p">|</span> grep -w httpd_use_cifs
</span></span><span class="line"><span class="cl">httpd_use_cifs                 <span class="o">(</span>on   ,  off<span class="o">)</span>  Allow httpd to use cifs
</span></span></code></pre></td></tr></table>
</div>
</div><p>請注意所輸出之項目，第二欄位由括弧所包起來的項目中，現行狀態若為 <code>on</code> 代表已啟用功能，若是預設狀值仍為 <code>off</code> 的話代表在下次系統重開機時會關閉該功能，必須再次執行啟用的設定。</p>
<p>如果經過測試後確定要讓指定的功能永久啟用（重開機時也會啟用）那麼就可以使用 <code>-P</code> 參數讓該設定永久生效，使用的方式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">student$ sudo setsebool -P httpd_use_cifs on
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>針對 SELinux 對 Apache 各功能的項目，可以參考 httpd_selinux(8) 有完整的說明。</p>
</blockquote>
<hr>
<h3 id="selinux">SELinux</h3>
<p>查看目前系統的 SELinux 有沒有跑起來</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# sestatus
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://i.imgur.com/nLSA6jJ.png"
        data-srcset="https://i.imgur.com/nLSA6jJ.png, https://i.imgur.com/nLSA6jJ.png 1.5x, https://i.imgur.com/nLSA6jJ.png 2x"
        data-sizes="auto"
        alt="https://i.imgur.com/nLSA6jJ.png"
        title="image-20230408151627269" /></p>
<hr>
<h2 id="目標">目標</h2>
<ul>
<li>瞭解 SELinux 對於 File Context/Port/Function 的管理方法。</li>
<li>使用工具確認是否違反 SELinux 政策。</li>
<li>使用 <code>-Z</code> 參數、semanager、sesearch、getsebool、setsebool、chcon、restorecon 等 SELinux 工具的使用。</li>
</ul>
<h2 id="ssh-改-port">SSH 改 Port</h2>
<p>這個 LAB 用來演練修改服務的使用 Port 與 SELinux 需要調配的項目。</p>
<p>@Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# dnf install -y policycoreutils-python-utils-2.9-20.el8.noarch
</span></span><span class="line"><span class="cl">root# cp /etc/ssh/sshd_config<span class="o">{</span>,_backup<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>設定將 Port 改成 <code>8866</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# vi /etc/ssh/sshd_config
</span></span><span class="line"><span class="cl">修改 Port
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Port <span class="m">8866</span>
</span></span><span class="line"><span class="cl">root# systemctl restart sshd
</span></span><span class="line"><span class="cl">FAIL
</span></span><span class="line"><span class="cl">root# ausearch -m avc
</span></span></code></pre></td></tr></table>
</div>
</div><p>列出 sshd 能夠使用的 Port</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# semanage port -l <span class="p">|</span> grep ssh_port_t
</span></span></code></pre></td></tr></table>
</div>
</div><p>新增 sshd 能夠使用的 Port</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# semanage port -a -p tcp <span class="m">8866</span> -t ssh_port_t
</span></span></code></pre></td></tr></table>
</div>
</div><p>重新啟動服務</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# systemctl restart sshd
</span></span><span class="line"><span class="cl">OK
</span></span></code></pre></td></tr></table>
</div>
</div><p>設定防火牆允許 tcp/p8866 連入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ss -ntulp <span class="p">|</span> grep <span class="m">8866</span>
</span></span><span class="line"><span class="cl">root# firewall-cmd --permanent --add-port<span class="o">=</span>8866/tcp
</span></span><span class="line"><span class="cl">root# firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>將 Port 改為原本的 22</p>
<p>@Desktop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ssh -p <span class="m">8866</span> root@server58
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# vi /etc/ssh/sshd_config
</span></span><span class="line"><span class="cl">修改 Port
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Port <span class="m">22</span>
</span></span><span class="line"><span class="cl">root# systemctl restart sshd
</span></span></code></pre></td></tr></table>
</div>
</div><p>移除防火牆可連入 tcp/8866</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# firewall-cmd --permanent --remove-port<span class="o">=</span>8866/tcp
</span></span><span class="line"><span class="cl">root# firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>移除 sshd 可使用 Port 8866 的設定</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# semanage port -l <span class="p">|</span> grep ssh_port_t
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# semanage port -d -p tcp <span class="m">8866</span> -t ssh_port_t
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# semanage port -l <span class="p">|</span> grep ssh_port_t
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="apache-預設目錄">Apache 預設目錄</h2>
<p>這個 LAB 用來演練修改網頁服務對於 檔案/目錄 的 <code>fcontext</code> 操作方法。</p>
<p>@Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# dnf install -y policycoreutils-python-utils
</span></span><span class="line"><span class="cl">root# dnf install -y setools-console
</span></span></code></pre></td></tr></table>
</div>
</div><p>安裝與啟用 httpd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# dnf install -y httpd
</span></span><span class="line"><span class="cl">root# systemctl <span class="nb">enable</span> --now httpd
</span></span><span class="line"><span class="cl">root# firewall-cmd --permanent --add-service<span class="o">=</span>http
</span></span><span class="line"><span class="cl">root# firewall-cmd --reload
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# <span class="nb">echo</span> HelloX &gt; /var/www/html/index.html
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Desktop</p>
<p>Firefox: <a href="http://server58/" target="_blank" rel="noopener noreffer ">http://server58/</a>
HelloX</p>
<p>@Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# mkdir /web
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# <span class="nb">echo</span> HelloX &gt; /web/index.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# <span class="nb">cd</span> /etc/httpd/conf
</span></span><span class="line"><span class="cl">root# cp httpd.conf httpd.conf_backup
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改網頁根目錄</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# vi httpd.conf
</span></span><span class="line"><span class="cl">修改下列行
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Line 122: DocumentRoot <span class="s2">&#34;/web&#34;</span>
</span></span><span class="line"><span class="cl">Line 127: &lt;Directory <span class="s2">&#34;/web&#34;</span>&gt;
</span></span><span class="line"><span class="cl">Line 134: &lt;Directory <span class="s2">&#34;/web&#34;</span>&gt;
</span></span><span class="line"><span class="cl">root# mv /etc/httpd/conf.d/welcome.conf<span class="o">{</span>,_disable<span class="o">}</span>
</span></span><span class="line"><span class="cl">root# systemctl restart httpd
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Desktop</p>
<p>Firefox: <a href="http://server58/" target="_blank" rel="noopener noreffer ">http://server58</a>
Forbidden</p>
<p>@Server</p>
<p>檢查存取檔案是否被 SELinux 阻擋。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ausearch -m avc <span class="p">|</span> tail
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">time-&gt;Tue Aug <span class="m">24</span> 22:34:49 <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>PROCTITLE <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629815689.260:493<span class="o">)</span>: <span class="nv">proctitle</span><span class="o">=</span>2F7573722F7362696E2F6874747064002D44464F524547524F554E44
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>SYSCALL <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629815689.260:493<span class="o">)</span>: <span class="nv">arch</span><span class="o">=</span>c000003e <span class="nv">syscall</span><span class="o">=</span><span class="m">4</span> <span class="nv">success</span><span class="o">=</span>no <span class="nv">exit</span><span class="o">=</span>-13 <span class="nv">a0</span><span class="o">=</span>7f67b4045630 <span class="nv">a1</span><span class="o">=</span>7f67ac7ef890 <span class="nv">a2</span><span class="o">=</span>7f67ac7ef890 <span class="nv">a3</span><span class="o">=</span>7f67ac7f04f0 <span class="nv">items</span><span class="o">=</span><span class="m">0</span> <span class="nv">ppid</span><span class="o">=</span><span class="m">13555</span> <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">auid</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">uid</span><span class="o">=</span><span class="m">48</span> <span class="nv">gid</span><span class="o">=</span><span class="m">48</span> <span class="nv">euid</span><span class="o">=</span><span class="m">48</span> <span class="nv">suid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsuid</span><span class="o">=</span><span class="m">48</span> <span class="nv">egid</span><span class="o">=</span><span class="m">48</span> <span class="nv">sgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">tty</span><span class="o">=(</span>none<span class="o">)</span> <span class="nv">ses</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">exe</span><span class="o">=</span><span class="s2">&#34;/usr/sbin/httpd&#34;</span> <span class="nv">subj</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">key</span><span class="o">=(</span>null<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>AVC <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629815689.260:493<span class="o">)</span>: avc:  denied  <span class="o">{</span> getattr <span class="o">}</span> <span class="k">for</span>  <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/web/index.html&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;dm-0&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">254636</span> <span class="nv">scontext</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">tcontext</span><span class="o">=</span>unconfined_u:object_r:default_t:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">time-&gt;Tue Aug <span class="m">24</span> 22:34:49 <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>PROCTITLE <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629815689.260:494<span class="o">)</span>: <span class="nv">proctitle</span><span class="o">=</span>2F7573722F7362696E2F6874747064002D44464F524547524F554E44
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>SYSCALL <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629815689.260:494<span class="o">)</span>: <span class="nv">arch</span><span class="o">=</span>c000003e <span class="nv">syscall</span><span class="o">=</span><span class="m">6</span> <span class="nv">success</span><span class="o">=</span>no <span class="nv">exit</span><span class="o">=</span>-13 <span class="nv">a0</span><span class="o">=</span>7f67b4045700 <span class="nv">a1</span><span class="o">=</span>7f67ac7ef890 <span class="nv">a2</span><span class="o">=</span>7f67ac7ef890 <span class="nv">a3</span><span class="o">=</span><span class="m">1</span> <span class="nv">items</span><span class="o">=</span><span class="m">0</span> <span class="nv">ppid</span><span class="o">=</span><span class="m">13555</span> <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">auid</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">uid</span><span class="o">=</span><span class="m">48</span> <span class="nv">gid</span><span class="o">=</span><span class="m">48</span> <span class="nv">euid</span><span class="o">=</span><span class="m">48</span> <span class="nv">suid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsuid</span><span class="o">=</span><span class="m">48</span> <span class="nv">egid</span><span class="o">=</span><span class="m">48</span> <span class="nv">sgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">tty</span><span class="o">=(</span>none<span class="o">)</span> <span class="nv">ses</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">exe</span><span class="o">=</span><span class="s2">&#34;/usr/sbin/httpd&#34;</span> <span class="nv">subj</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">key</span><span class="o">=(</span>null<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>AVC <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629815689.260:494<span class="o">)</span>: avc:  denied  <span class="o">{</span> getattr <span class="o">}</span> <span class="k">for</span>  <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/web/index.html&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;dm-0&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">254636</span> <span class="nv">scontext</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">tcontext</span><span class="o">=</span>unconfined_u:object_r:default_t:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>SELinux 擋住 <code>/web/index.html</code> 存取</p>
</blockquote>
<p>查看 httpd 使用的 process 被貼上的 <code>context</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ps auxZ <span class="p">|</span> grep httpd
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看預設根目錄中的 <code>context</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ls -lhdZ /var/www/html
</span></span><span class="line"><span class="cl">drwxr-xr-x. <span class="m">2</span> root root system_u:object_r:httpd_sys_content_t:s0 <span class="m">24</span> Aug <span class="m">22</span> 11:40 /var/www/html
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 <code>httpd</code> 行程 context 對於哪些指定的 <code>檔案/目錄</code> context 有哪些已知的權限。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# sesearch -s httpd_t --allow <span class="p">|</span> grep httpd_sys_content_t
</span></span><span class="line"><span class="cl">allow daemon httpd_sys_content_t:dir <span class="o">{</span> getattr open search <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t:dir <span class="o">{</span> add_name getattr ioctl lock open <span class="nb">read</span> remove_name search write <span class="o">}</span><span class="p">;</span> <span class="o">[</span> <span class="o">(</span> httpd_builtin_scripting <span class="o">&amp;&amp;</span> httpd_unified <span class="o">&amp;&amp;</span> httpd_enable_cgi <span class="o">)</span> <span class="o">]</span>:True
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t:dir <span class="o">{</span> getattr ioctl lock open <span class="nb">read</span> search <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t:file <span class="o">{</span> getattr ioctl lock map open <span class="nb">read</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">allow httpd_t httpd_sys_content_t:lnk_file <span class="o">{</span> getattr <span class="nb">read</span> <span class="o">}</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>列出 fcontext 中預設被貼上 context 的目錄規則。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# semanage fcontext -l <span class="p">|</span> grep httpd_sys_content_t
</span></span><span class="line"><span class="cl">/etc/htdig<span class="o">(</span>/.*<span class="o">)</span>?                                   all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/srv/<span class="o">([</span>^/<span class="o">]</span>*/<span class="o">)</span>?www<span class="o">(</span>/.*<span class="o">)</span>?                            all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/srv/gallery2<span class="o">(</span>/.*<span class="o">)</span>?                                all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/doc/ghc/html<span class="o">(</span>/.*<span class="o">)</span>?                      all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/drupal.*                                all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/glpi<span class="o">(</span>/.*<span class="o">)</span>?                              all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/htdig<span class="o">(</span>/.*<span class="o">)</span>?                             all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/icecast<span class="o">(</span>/.*<span class="o">)</span>?                           all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/nginx/html<span class="o">(</span>/.*<span class="o">)</span>?                        all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/ntop/html<span class="o">(</span>/.*<span class="o">)</span>?                         all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/openca/htdocs<span class="o">(</span>/.*<span class="o">)</span>?                     all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/selinux-policy<span class="o">[</span>^/<span class="o">]</span>*/html<span class="o">(</span>/.*<span class="o">)</span>?          all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/usr/share/z-push<span class="o">(</span>/.*<span class="o">)</span>?                            all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/lib/cacti/rra<span class="o">(</span>/.*<span class="o">)</span>?                           all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/lib/htdig<span class="o">(</span>/.*<span class="o">)</span>?                               all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/lib/trac<span class="o">(</span>/.*<span class="o">)</span>?                                all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/www<span class="o">(</span>/.*<span class="o">)</span>?                                     all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/www/icons<span class="o">(</span>/.*<span class="o">)</span>?                               all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span><span class="line"><span class="cl">/var/www/svn/conf<span class="o">(</span>/.*<span class="o">)</span>?                            all files          system_u:object_r:httpd_sys_content_t:s0 
</span></span></code></pre></td></tr></table>
</div>
</div><p>將新的位置加入 httpd 可使用的規則中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# semanage fcontext -a -t httpd_sys_content_t <span class="s1">&#39;/web(/.*)?&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# semanage fcontext -l <span class="p">|</span> grep httpd_sys_content_t <span class="p">|</span> grep web
</span></span><span class="line"><span class="cl">/web<span class="o">(</span>/.*<span class="o">)</span>?                                         all files          system_u:object_r:httpd_sys_content_t:s0
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 restorecon 還原並檢查結果。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# ls -ldZ /web
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# restorecon -R /web
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# ls -ldZ /web
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Desktop</p>
<p>Firefox: <a href="http://server58/" target="_blank" rel="noopener noreffer ">http://server58</a>
HelloX</p>
<h2 id="apache-mount-nfs">Apache Mount NFS</h2>
<p>這個 LAB 用來演練啟用服務功能對於 SELinux 需要進行開關的項目。</p>
<p>在 Desktop 中建立 NFS 服務並啟用。</p>
<p>@Desktop</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# dnf install -y nfs-utils
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root# mkdir /web
</span></span><span class="line"><span class="cl">root# <span class="nb">echo</span> HelloX from Desktop &gt; /web/index.html
</span></span><span class="line"><span class="cl">root# vi /etc/exports
</span></span><span class="line"><span class="cl">/web 172.16.2.X<span class="o">(</span>ro<span class="o">)</span>
</span></span><span class="line"><span class="cl">root# systemctl <span class="nb">enable</span> --now nfs-server
</span></span><span class="line"><span class="cl">root# firewall-cmd --permanent --add-service<span class="o">=</span>nfs
</span></span><span class="line"><span class="cl">root# firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 Server 中掛載 Desktop 的 NFS 分享目錄。</p>
<p>@Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# dnf install -y nfs-utils
</span></span><span class="line"><span class="cl">root# mount -t nfs 172.16.1.X:/web /web
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Desktop</p>
<p>Firefox: <a href="http://server58/" target="_blank" rel="noopener noreffer ">http://server58</a>
Forbidden</p>
<p>@Server</p>
<p>在 Server 中查看 SELinux 阻檔原因</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# <span class="c1"># ausearch -m avc | tail</span>
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">time-&gt;Tue Aug <span class="m">24</span> 22:54:35 <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>PROCTITLE <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629816875.274:575<span class="o">)</span>: <span class="nv">proctitle</span><span class="o">=</span>2F7573722F7362696E2F6874747064002D44464F524547524F554E44
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>SYSCALL <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629816875.274:575<span class="o">)</span>: <span class="nv">arch</span><span class="o">=</span>c000003e <span class="nv">syscall</span><span class="o">=</span><span class="m">4</span> <span class="nv">success</span><span class="o">=</span>no <span class="nv">exit</span><span class="o">=</span>-13 <span class="nv">a0</span><span class="o">=</span>7f67b40436d0 <span class="nv">a1</span><span class="o">=</span>7f67ad7f1890 <span class="nv">a2</span><span class="o">=</span>7f67ad7f1890 <span class="nv">a3</span><span class="o">=</span>7f67ad7f24f0 <span class="nv">items</span><span class="o">=</span><span class="m">0</span> <span class="nv">ppid</span><span class="o">=</span><span class="m">13555</span> <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">auid</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">uid</span><span class="o">=</span><span class="m">48</span> <span class="nv">gid</span><span class="o">=</span><span class="m">48</span> <span class="nv">euid</span><span class="o">=</span><span class="m">48</span> <span class="nv">suid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsuid</span><span class="o">=</span><span class="m">48</span> <span class="nv">egid</span><span class="o">=</span><span class="m">48</span> <span class="nv">sgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">tty</span><span class="o">=(</span>none<span class="o">)</span> <span class="nv">ses</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">exe</span><span class="o">=</span><span class="s2">&#34;/usr/sbin/httpd&#34;</span> <span class="nv">subj</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">key</span><span class="o">=(</span>null<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>AVC <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629816875.274:575<span class="o">)</span>: avc:  denied  <span class="o">{</span> getattr <span class="o">}</span> <span class="k">for</span>  <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/web/index.html&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;0:48&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">68301488</span> <span class="nv">scontext</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">tcontext</span><span class="o">=</span>system_u:object_r:nfs_t:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">time-&gt;Tue Aug <span class="m">24</span> 22:54:35 <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>PROCTITLE <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629816875.275:576<span class="o">)</span>: <span class="nv">proctitle</span><span class="o">=</span>2F7573722F7362696E2F6874747064002D44464F524547524F554E44
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>SYSCALL <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629816875.275:576<span class="o">)</span>: <span class="nv">arch</span><span class="o">=</span>c000003e <span class="nv">syscall</span><span class="o">=</span><span class="m">6</span> <span class="nv">success</span><span class="o">=</span>no <span class="nv">exit</span><span class="o">=</span>-13 <span class="nv">a0</span><span class="o">=</span>7f67b40437a0 <span class="nv">a1</span><span class="o">=</span>7f67ad7f1890 <span class="nv">a2</span><span class="o">=</span>7f67ad7f1890 <span class="nv">a3</span><span class="o">=</span><span class="m">1</span> <span class="nv">items</span><span class="o">=</span><span class="m">0</span> <span class="nv">ppid</span><span class="o">=</span><span class="m">13555</span> <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">auid</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">uid</span><span class="o">=</span><span class="m">48</span> <span class="nv">gid</span><span class="o">=</span><span class="m">48</span> <span class="nv">euid</span><span class="o">=</span><span class="m">48</span> <span class="nv">suid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsuid</span><span class="o">=</span><span class="m">48</span> <span class="nv">egid</span><span class="o">=</span><span class="m">48</span> <span class="nv">sgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">fsgid</span><span class="o">=</span><span class="m">48</span> <span class="nv">tty</span><span class="o">=(</span>none<span class="o">)</span> <span class="nv">ses</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">exe</span><span class="o">=</span><span class="s2">&#34;/usr/sbin/httpd&#34;</span> <span class="nv">subj</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">key</span><span class="o">=(</span>null<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>AVC <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1629816875.275:576<span class="o">)</span>: avc:  denied  <span class="o">{</span> getattr <span class="o">}</span> <span class="k">for</span>  <span class="nv">pid</span><span class="o">=</span><span class="m">13559</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;httpd&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/web/index.html&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;0:48&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">68301488</span> <span class="nv">scontext</span><span class="o">=</span>system_u:system_r:httpd_t:s0 <span class="nv">tcontext</span><span class="o">=</span>system_u:object_r:nfs_t:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>SELinux 拒絕 httpd 存取 nfs</p>
</blockquote>
<p>檢視 SELinux 針對 httpd 的功能開關。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# getsebool -a <span class="p">|</span> grep httpd_use_nfs
</span></span><span class="line"><span class="cl">httpd_use_nfs --&gt; off
</span></span></code></pre></td></tr></table>
</div>
</div><p>啟用 httpd 可使用 NFS 的功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root# setsebool -P httpd_use_nfs on
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Desktop</p>
<p>Firefox: <a href="http://server58/" target="_blank" rel="noopener noreffer ">http://server58</a>
HelloX from Desktop</p>
<hr>
<blockquote>
<h1 id="很值得參考的文檔">很值得參考的文檔</h1>
<p>如果以上lab太多錯難以除去，那就看這篇吧🥲</p>
<p><a href="https://linux.die.net/man/8/httpd_selinux" target="_blank" rel="noopener noreffer ">httpd_selinux(8) - Linux man page</a></p>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-04-08</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/lesson_04_linux/" data-hashtag="linux"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/posts/lesson_04_linux/" data-title="Lesson 04: Linux 筆記 - CA憑證、SELinux"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/linux/">Linux</a>,&nbsp;<a href="/tags/security/">Security</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/suzume_no_tojimari/" class="prev" rel="prev" title="すずめの戸締(toji)まり- 我出門了，我回來了 "><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>すずめの戸締(toji)まり- 我出門了，我回來了 </a>
            <a href="/posts/cascading_style_sheet/" class="next" rel="next" title="Cascading style sheet">Cascading style sheet<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">strict with yourself; lenient with others.</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
